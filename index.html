<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>AIOS Chat Ultimate (Unlimited Storage)</title>
    <style>
        /* --- 1. å…¨å±€å¸ƒå±€é‡ç½® --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        :root {
            --chat-scale: 1;
            --chat-font-size: 16px;
        }

        body {
            margin: 0; padding: 0; 
            background: #1e1e1e; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100dvh; width: 100vw;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
            user-select: none;
        }

        /* --- 2. æ‰‹æœºå®¹å™¨ --- */
        .phone-case {
            background: #000; position: relative; overflow: hidden;
            display: flex; flex-direction: column;
            box-shadow: 0 0 0 0 rgba(0,0,0,0);
        }
        @media (min-width: 481px) {
            .phone-case {
                width: 390px; height: 844px; border-radius: 48px;
                border: 8px solid #1a1a1a; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            }
            .screen { border-radius: 40px; }
        }
        @media (max-width: 480px) {
            .phone-case { width: 100%; height: 100%; border: none; border-radius: 0; }
            .screen { border-radius: 0; }
        }

        /* --- 3. å±å¹•å†…éƒ¨ --- */
        .screen {
            width: 100%; height: 100%; background: #f2f2f7; 
            position: relative; overflow: hidden; display: flex; flex-direction: column;
        }

        .status-bar {
            height: 47px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            display: flex; justify-content: space-between; align-items: flex-end;
            padding: 0 22px 8px; font-size: 14px; font-weight: 600; color: #000;
            position: absolute; top: 0; width: 100%; z-index: 1000;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        /* --- 4. è§†å›¾ç³»ç»Ÿ (ä¿®æ”¹ç‰ˆï¼šæ— åŠ¨ç”») --- */
        /* ================= ğŸš€ é¡µé¢è½¬åœºåŠ¨ç”» (iOSé£æ ¼) ================= */

/* --- 4. è§†å›¾ç³»ç»Ÿ (Keyframes åŠ¨ç”»ç‰ˆ - å½»åº•æ ¹é™¤é—ªçƒ) --- */

/* --- 4. è§†å›¾ç³»ç»Ÿ (iOS å®Œç¾è¦†ç›–ç‰ˆ) --- */
        
        /* --- 4. è§†å›¾ç³»ç»Ÿ (è½»é‡çº§ä½ç§» + æ·¡å…¥æ·¡å‡º) --- */

/* 1. è¿›åœºåŠ¨ç”»ï¼šä»å³è¾¹ä¸€ç‚¹ç‚¹(15%) + é€æ˜ -> æ»‘åˆ°ä¸­é—´(0) + å®å¿ƒ */
/* --- 4. è§†å›¾ç³»ç»Ÿ (ç»ˆæä¿®å¤ç‰ˆï¼šæµç•…ä¸”ä¸é®æŒ¡) --- */
        
        /* è¿›åœºï¼šå³ä¾§æ»‘å…¥ + æ·¡å…¥ */
        @keyframes slideInRight {
            from { transform: translateX(20%); opacity: 0; }
            to   { transform: translateX(0);   opacity: 1; }
        }

        /* é€€åœºï¼šå‘å³æ»‘å‡º + æ·¡å‡º */
        @keyframes slideOutRight {
            from { transform: translateX(0);   opacity: 1; }
            to   { transform: translateX(20%); opacity: 0; }
        }

        /* è§†å›¾åŸºç¡€å®¹å™¨ */
        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #f2f2f7;
            transform: translateZ(0); /* ç¡¬ä»¶åŠ é€Ÿ */
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column; 
            padding-top: 47px; /* é¿å¼€çŠ¶æ€æ  */
            box-shadow: -5px 0 15px rgba(0,0,0,0.1); /* é¡µé¢è¾¹ç¼˜é˜´å½± */
        }

        /* æ¿€æ´»çŠ¶æ€ï¼šæ­£åœ¨æ˜¾ç¤ºçš„é¡µé¢ */
        .view.active {
            display: flex;
            z-index: 10; /* æ­£å¸¸å±‚çº§ */
            opacity: 1;
            transform: translateX(0);
        }

        /* è¿›åœºçŠ¶æ€ï¼šæ–°é¡µé¢ */
        .view.entering {
            display: flex;
            z-index: 20; /* å¿…é¡»æœ€é«˜ï¼Œç›–ä½æ—§é¡µé¢ */
            animation: slideInRight 0.25s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        /* é€€åœºçŠ¶æ€ï¼šè¢«å…³é—­çš„é¡µé¢ */
        .view.exit {
            display: flex;
            z-index: 20; /* ä¹Ÿè¦é«˜ï¼Œä¿è¯æ»‘å‡ºæ—¶èƒ½è¢«çœ‹è§ */
            pointer-events: none; /* å…³é”®ï¼šé€€åœºæ—¶ä¸è®¸ç‚¹ï¼Œé˜²æ­¢è¯¯è§¦ */
            animation: slideOutRight 0.15s ease-out forwards;
        }

        /* èƒŒæ™¯çŠ¶æ€ï¼šè¢«å‹åœ¨åº•ä¸‹çš„æ—§é¡µé¢ */
        .view.background {
            display: flex;
            z-index: 1; /* æœ€åº•å±‚ï¼Œä¸æŒ¡è·¯ */
            transform: translateX(0);
            filter: brightness(0.98); 
            pointer-events: none; /* å…³é”®ï¼šå˜æˆèƒŒæ™¯åå®Œå…¨ç¦æ­¢ç‚¹å‡»ï¼Œé˜²æ­¢ç©¿é€ */
        }

        /* é¦–é¡µç‰¹æ®ŠèƒŒæ™¯ */
        .view.home {
            background: url('https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1000&auto=format&fit=crop') no-repeat center/cover;
        }

        .nav-bar {
            height: 44px; background: rgba(255,255,255,0.95); 
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 12px; border-bottom: 1px solid #e0e0e0; flex-shrink: 0;
        }
        .nav-title { font-size: 17px; font-weight: 600; color: #000; }
        .nav-btn { border: none; background: none; color: #007AFF; font-size: 16px; cursor: pointer; padding: 8px 12px; }
        .nav-btn.danger { color: #ff3b30; }

        .scroll-content { flex: 1; overflow-y: auto; padding: 16px; -webkit-overflow-scrolling: touch; }

        /* --- 5. ç»„ä»¶æ ·å¼ --- */
        .home-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 30px 15px; padding: 40px 20px; margin-top: 20px; }
        .app-icon { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; transition: 0.1s; }
        .app-icon:active { transform: scale(0.95); }
        .icon-box { width: 62px; height: 62px; border-radius: 16px; color: white; display: flex; justify-content: center; align-items: center; font-size: 32px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .app-name { font-size: 12px; color: white; text-shadow: 0 1px 4px rgba(0,0,0,0.6); font-weight: 500; }

        .form-group { background: #fff; border-radius: 12px; padding: 0 16px; margin-bottom: 16px; }
        .form-row { display: flex; align-items: center; padding: 14px 0; border-bottom: 1px solid #f2f2f2; }
        .form-row:last-child { border-bottom: none; }
        .form-row label { width: 80px; font-size: 15px; font-weight: 500; }
        .form-row input, .form-row textarea, .form-row select { flex: 1; border: none; outline: none; font-size: 15px; background: transparent; resize:none; }
        
        .btn-block { width: 100%; padding: 14px; background: #007AFF; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; margin-top: 10px; cursor:pointer;}
        .btn-block.danger { background: #ff3b30; color: white; margin-top: 20px; }
        .btn-block.secondary { background: #5856d6; margin-top: 10px; }

        .list-item { 
            background: #fff; padding: 8px 12px; border-radius: 12px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
        }
        .item-main { display: flex; align-items: center; gap: 12px; flex: 1; overflow: hidden; cursor: pointer; }
        .avatar { width: 44px; height: 44px; border-radius: 8px; object-fit: cover; background: #eee; border: 1px solid #f5f5f5; flex-shrink:0;}
        .item-text h3 { margin:0 0 4px; font-size:16px; font-weight:600;}
        .item-text p { margin:0; font-size:13px; color:#888; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;}
        /* --- ä»¿æˆªå›¾çš„ç©ºé—´åˆ—è¡¨æ ·å¼ --- */
        .space-search-bar {
            background: #f5f5f5; border-radius: 20px; 
            margin-bottom: 15px; padding: 8px; 
            text-align: center; color: #999; font-size: 14px;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .space-list { background: #fff; }
        .space-item { 
            display: flex; align-items: center; 
            padding: 16px 5px; 
            cursor: pointer; transition: 0.2s;
        }
        .space-item:active { background-color: #f9f9f9; }
        .space-icon { 
            font-size: 24px; margin-right: 12px; 
            width: 30px; text-align: center;
        }
        .space-text { flex: 1; font-size: 16px; font-weight: 500; color: #333; }
        .space-arrow { color: #c7c7cc; font-size: 18px; font-weight: bold; font-family: monospace; }

        /* --- 6. èŠå¤©æ ·å¼ --- */
        /* --- åˆ†äº«å¡ç‰‡æ ·å¼ --- */
.msg-bubble.is-card {
    padding: 0 !important;       /* å»æ‰é»˜è®¤æ°”æ³¡å†…è¾¹è· */
    background: #fff !important; /* å¼ºåˆ¶ç™½è‰²èƒŒæ™¯ */
    color: #000 !important;
    border-radius: 8px !important;
    overflow: hidden;
    width: 240px;               /* å›ºå®šå¡ç‰‡å®½åº¦ */
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
}

.card-content {
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.card-header {
    display: flex;
    align-items: center;
    gap: 8px;
}

.card-avatar {
    width: 20px; height: 20px;
    border-radius: 4px;
    object-fit: cover;
}

.card-title {
    font-size: 14px;
    font-weight: 600;
    color: #333;
    overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
}

.card-text {
    font-size: 13px;
    color: #666;
    display: -webkit-box;
    -webkit-line-clamp: 2; /* æœ€å¤šæ˜¾ç¤º2è¡Œ */
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.4;
}

.card-footer {
    border-top: 1px solid #f0f0f0;
    padding: 6px 12px;
    font-size: 10px;
    color: #999;
    display: flex;
    align-items: center;
    gap: 4px;
}
        .chat-bg { 
            flex: 1; 
            background-color: #ededed; 
            background-size: cover; background-position: center; background-repeat: no-repeat;
            overflow-y: auto; padding: 15px; 
            display: flex; flex-direction: column; gap: 15px; 
        }

        .msg-row { display: flex; width: 100%; align-items: flex-start; gap: 10px; margin-bottom: 5px; transition: all 0.2s; }
        .msg-row.me { flex-direction: row-reverse; }
        
        .msg-avatar { 
            width: calc(42px * var(--chat-scale)); 
            height: calc(42px * var(--chat-scale)); 
            border-radius: 6px; object-fit: cover; background-color: #ddd; flex-shrink: 0; cursor: pointer; 
            transition: transform 0.2s;
        }
        .msg-avatar:active { transform: scale(0.9); }

        .msg-bubble {
            max-width: 70%; 
            padding: calc(10px * var(--chat-scale)) calc(14px * var(--chat-scale)); 
            font-size: calc(var(--chat-font-size) * var(--chat-scale)); 
            line-height: 1.5;
            position: relative; word-wrap: break-word; white-space: pre-wrap;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
            min-height: calc(42px * var(--chat-scale)); 
            display: block;
            cursor: pointer;
        }
        .msg-row.ai .msg-bubble { background: #fff; color: #000; border-radius: 6px; border-top-left-radius: 2px; }
        .msg-row.me .msg-bubble { background: #95ec69; color: #000; border-radius: 6px; border-top-right-radius: 2px; }
        
        .msg-bubble.is-image { background: transparent !important; box-shadow: none !important; padding: 0 !important; border: none !important; }
        
        .sticker-img { 
            display: block; 
            max-width: calc(140px * var(--chat-scale)); 
            border-radius: 8px; 
            margin-top: 5px; 
            /* ğŸ‘‡ æ–°å¢ä¸‹é¢è¿™å‡ è¡Œ */
            min-height: 50px;       /* ç»™ä¸ªæœ€å°é«˜åº¦ï¼Œé˜²æ­¢å¡Œé™· */
            background: #f0f0f0;    /* ç»™ä¸ªæµ…ç°åº•è‰² */
            object-fit: cover;      /* ä¿æŒæ¯”ä¾‹ */
            transition: opacity 0.3s; /* å‡ºæ¥çš„æ—¶å€™åŠ ä¸ªæ·¡å…¥æ•ˆæœ */
        }

        /* å¤šé€‰æ¨¡å¼ */
        .chat-bg.selection-mode .msg-row { pointer-events: none; }
        .chat-bg.selection-mode .msg-bubble { pointer-events: auto; }
        .msg-checkbox {
            width: 24px; height: 24px; border: 2px solid #ccc; border-radius: 50%;
            display: none; align-items: center; justify-content: center;
            margin-top: 10px; flex-shrink: 0;
        }
        .msg-row.selected .msg-checkbox { background: #007AFF; border-color: #007AFF; }
        .msg-row.selected .msg-checkbox::after { content: 'âœ“'; color: white; font-size: 14px; font-weight: bold; }
        .chat-bg.selection-mode .msg-checkbox { display: flex; }
        
        .selection-toolbar {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 60px;
            background: #fff; border-top: 1px solid #eee;
            display: none; justify-content: space-between; align-items: center;
            padding: 0 30px; z-index: 2000; animation: slideUp 0.2s;
        }
        .selection-toolbar.show { display: flex; }
        .toolbar-btn { font-size: 16px; font-weight: 600; cursor: pointer; }
        .toolbar-btn.cancel { color: #333; }
        .toolbar-btn.delete { color: #ff3b30; }

        /* --- ğŸ’¬ åº•éƒ¨è¾“å…¥æ  (ä¼˜åŒ–é—´è·ç‰ˆ) --- */
        /* --- ğŸ’¬ åº•éƒ¨è¾“å…¥æ  (å¤§ç•™ç™½ç‰ˆ) --- */
        /* --- ğŸ’¬ åº•éƒ¨è¾“å…¥æ  (è¶…å¤§é—´è·ç‰ˆ) --- */
/* --- ğŸ’¬ åº•éƒ¨è¾“å…¥æ  (ç»ˆæè°ƒæ•´ç‰ˆ) --- */


        

/* æŒ‰ä¸‹å»çš„æ—¶å€™ç¼©å°ä¸€ç‚¹ç‚¹ï¼Œè½¯è½¯çš„æ„Ÿè§‰ */
.mini-btn:active {
    transform: scale(0.9);   /* ç¼©å° */
    box-shadow: 0 1px 2px rgba(0,0,0,0.1); /* é˜´å½±å˜æµ… */
}

        .action-sheet {
            position: absolute; bottom: 60px; left: 10px;
            background: #4c4c4c; color: white; border-radius: 12px;
            width: auto; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 100; padding: 10px; animation: slideUpFade 0.2s ease-out;
        }
        .action-sheet.show { display: flex; gap: 15px; }
        .action-item { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; width: 60px; }
        .action-icon-box { width: 48px; height: 48px; background: #fff; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .action-label { font-size: 12px; color: #ddd; }

        .chat-tabs {
            background: #fff; border-top: 1px solid #d1d1d1;
            display: flex; justify-content: space-around; align-items: center;
            flex-shrink: 0; height: 55px; padding-bottom: max(5px, env(safe-area-inset-bottom));
        }
        .tab-btn { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #8e8e93; cursor: pointer; width: 33%; }
        .tab-btn.active { color: #007AFF; }
        .tab-btn span { font-size: 24px; margin-bottom: 3px; }

        .typing { display: flex; gap: 4px; padding: 8px 4px; }
        .dot { width: 6px; height: 6px; background: #aaa; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        /* --- æœ‹å‹åœˆåŠ¨æ€æ ·å¼ (ä¿®å¤å¸ƒå±€ç‰ˆ) --- */
        .moment-card {
            background: #fff; 
            padding: 15px; 
            border-radius: 16px; /* åœ†è§’ */
            margin: 10px 12px;   /* æ‚¬æµ®é—´è· */
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); /* æ·¡æ·¡é˜´å½± */
            border: none;
            display: flex;       /* å…³é”®ï¼šè®©æ•´ä¸ªå¡ç‰‡ç«–ç€æ’ */
            flex-direction: column; 
        }
        /* --- æœ‹å‹åœˆäº’åŠ¨æ ·å¼ --- */
        .moment-actions {
            display: flex; align-items: center; gap: 20px;
            margin-top: 12px; padding-top: 10px;
            border-top: 1px solid #f9f9f9;
        }
        .action-btn {
            cursor: pointer; font-size: 15px; color: #ccc; /* é»˜è®¤ç°è‰² */
            display: flex; align-items: center; gap: 5px; transition: 0.2s;
        }
        .action-btn.liked { color: #ff3b30; }
        
        .comment-area {
            background: #f7f7f7; border-radius: 6px;
            margin-top: 10px; padding: 8px 10px;
            font-size: 14px; display: none; /* æœ‰è¯„è®ºæ‰æ˜¾ç¤º */
        }
        /* --- è¯„è®ºè¾“å…¥æ¡†æ ·å¼ --- */
        .comment-input-box {
            display: none; /* é»˜è®¤éšè— */
            margin-top: 10px;
            padding: 5px;
            background: #f9f9f9;
            border-radius: 8px;
            align-items: center;
            gap: 8px;
        }
        .comment-input-box.show { display: flex; } /* åŠ ä¸Šè¿™ä¸ªç±»å°±æ˜¾ç¤º */
        
        .comment-input-box input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            font-size: 14px;
            background: #fff;
            outline: none;
        }
        .comment-send-btn {
            background: #07C160;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
        }
        .comment-area.show { display: block; }
        
        .comment-row { margin-bottom: 5px; line-height: 1.4; }
        .comment-user { color: #576b95; font-weight: 600; cursor: pointer; } /* è“è‰²åå­— */
        .comment-content { color: #333; }
        
        .reading-status {
            float: right; font-size: 12px; color: #999;
            font-style: italic; animation: pulse 1.5s infinite;
        }

        /* å¤´éƒ¨ï¼šå¤´åƒå’Œåå­—æ¨ªç€æ’ */
        .moment-header { 
            display: flex; 
            align-items: center; /* å‚ç›´å±…ä¸­ */
            width: 100%;
            margin-bottom: 8px; 
        }

        /* å¤´åƒï¼šå¼ºåˆ¶å›ºå®šå¤§å°ï¼Œä¸è®¸å˜å¤§ */
        .moment-avatar { 
            width: 42px !important;  /* !important å¼ºåˆ¶ç”Ÿæ•ˆ */
            height: 42px !important; 
            border-radius: 6px;      /* å¾®ä¿¡é£æ ¼çš„å°åœ†è§’ */
            object-fit: cover;       /* è£å‰ªå›¾ç‰‡ï¼Œä¸è¦å˜å½¢ */
            background: #eee; 
            flex-shrink: 0;          /* å…³é”®ï¼šç¦æ­¢è¢«æŒ¤å‹ */
            margin-right: 12px;      /* å¤´åƒå’Œåå­—çš„è·ç¦» */
            border: 1px solid #f0f0f0;
        }

        /* åå­—æ ·å¼ */
        .moment-name { 
            font-size: 16px; 
            font-weight: 600; 
            color: #576b95; /* æ˜µç§°è“è‰² */
            line-height: 1.2;
        }

        /* å†…å®¹æ ·å¼ */
        .moment-content { 
            font-size: 15px; 
            color: #333; 
            line-height: 1.6; 
            white-space: pre-wrap; 
            margin-left: 0; /* å¯¹é½å·¦è¾¹ */
        }

        /* åº•éƒ¨æ—¶é—´ */
        .moment-time { 
            font-size: 12px; 
            color: #b0b0b0; 
            margin-top: 10px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            }
        /* å³ä¸Šè§’çš„å°èœå• */
        .moment-menu {
            position: absolute; top: 50px; right: 10px;
            background: #fff; border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            width: 180px; padding: 10px; z-index: 200;
            display: none; animation: fadeIn 0.2s;
        }
        .moment-menu.show { display: block; }
        .moment-menu h4 { margin: 0 0 10px; font-size: 14px; text-align: center; color: #666; }
        .menu-scroll { max-height: 200px; overflow-y: auto; }
        .menu-item { display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid #f5f5f5; }
        .menu-item:last-child { border-bottom: none; }
        /* --- 1. ä¿®æ”¹ï¼šè®©å¡ç‰‡æ“ä½œæ å›¾æ ‡é å³ --- */
        /* ä¿®æ”¹åçš„æ“ä½œæ ï¼šä¸¤ç«¯å¯¹é½ */
.moment-actions {
    display: flex; 
    align-items: center; 
    justify-content: space-between; /* âœ¨ å…³é”®ï¼šå·¦è¾¹æ–‡å­—ï¼Œå³è¾¹å›¾æ ‡ */
    margin-top: 12px; 
    padding-top: 10px;
    border-top: 1px solid #f9f9f9;
}

/* æ–°å¢ï¼šç‚¹èµäººæ•°çš„æ–‡å­—æ ·å¼ */
.like-stat {
    font-size: 12px;
    color: #999;
    font-weight: 500;
}

        /* --- 2. æ–°å¢ï¼šå¡ç‰‡å³ä¸Šè§’çš„ä¸‰ç‚¹å›¾æ ‡ --- */
        .moment-more-btn {
            font-size: 18px; color: #999; 
            padding: 0 10px; cursor: pointer;
            font-weight: bold; letter-spacing: 2px;
        }

        /* --- 3. æ–°å¢ï¼šåº•éƒ¨åˆ†äº«å¼¹çª—æ ·å¼ (iOSé£æ ¼) --- */
        .share-sheet-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 3000;
            display: none; flex-direction: column; justify-content: flex-end;
        }
        .share-sheet-mask.show { display: flex; }
        
        .share-panel {
            background: #f2f2f7; border-top-left-radius: 16px; border-top-right-radius: 16px;
            overflow: hidden; animation: slideUp 0.3s;
        }
        .share-header {
            padding: 15px; font-size: 14px; color: #666; font-weight: 500;
            background: #fff; border-bottom: 1px solid #eee;
        }
        .share-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); 
            gap: 15px 10px; padding: 20px 10px; background: #fff;
            max-height: 300px; overflow-y: auto;
        }
        .share-item {
            display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer;
        }
        .share-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; background:#eee; }
        .share-name { font-size: 11px; color: #333; width: 100%; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .share-cancel {
            background: #fff; padding: 15px; text-align: center; 
            font-size: 16px; font-weight: 600; margin-top: 8px; cursor: pointer;
        }

        /* --- 7. å¼¹çª—æ ·å¼ --- */
        .modal-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; display: none;
            justify-content: center; align-items: center;
        }
        .modal-mask.show { display: flex; }
        .modal-panel {
            width: 85%; max-height: 85%; background: #f2f2f7; border-radius: 16px;
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal-header { padding: 15px; background: #fff; text-align: center; font-weight: 600; border-bottom: 1px solid #eee; flex-shrink: 0;}
        .modal-body { padding: 15px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 15px; background: #fff; border-top: 1px solid #eee; display: flex; gap: 10px; flex-shrink: 0;}
        .modal-footer button { flex: 1; padding: 12px; border-radius: 10px; border: none; font-size: 16px; font-weight: 600; cursor: pointer;}
        .btn-cancel { background: #e5e5ea; color: #333; }
        .btn-confirm { background: #007AFF; color: #fff; }
        
        .avatar-upload { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        .avatar-prev { width: 80px; height: 80px; border-radius: 50%; background: #e1e1e1; object-fit: cover; border: 4px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; }

        .bg-preview { width: 100%; height: 120px; background: #e1e1e1; object-fit: cover; border-radius: 10px; border: 2px solid #fff; cursor: pointer; margin-top: 5px; }

        .pop-menu { position: absolute; top: 50px; right: 10px; background: #333; color: white; border-radius: 10px; width: 140px; display: none; z-index: 101; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .pop-menu.show { display: block; }
        .pop-item { padding: 12px 15px; border-bottom: 1px solid #444; font-size: 14px; cursor: pointer; }

        .select-list { background: #fff; border-radius: 10px; max-height: 200px; overflow-y: auto; }
        .select-row { padding: 12px; border-bottom: 1px solid #f5f5f5; display: flex; align-items: center; gap: 10px; }

        .memory-box { background: #fff; border-radius: 10px; border: 1px solid #ddd; padding: 10px; max-height: 150px; overflow-y: auto; margin-bottom: 10px; }
        .memory-item { padding: 8px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: flex-start; gap: 8px; font-size: 13px; color: #555; }
        .memory-item:last-child { border-bottom: none; }
        .memory-item input { margin-top: 3px; }

        .thought-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 3000; display: none;
            justify-content: center; align-items: center;
            animation: fadeIn 0.3s;
        }
        .thought-modal.show { display: flex; }
        .thought-card {
            width: 80%; background: linear-gradient(135deg, #ffffff 0%, #f0f8ff 100%);
            border-radius: 20px; padding: 25px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            position: relative; border: 2px solid #fff;
            animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .thought-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .thought-content { font-size: 15px; color: #555; line-height: 1.6; font-family: 'Georgia', serif; font-style: italic; }
        .thought-close { position: absolute; top: 10px; right: 15px; font-size: 24px; color: #999; cursor: pointer; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        @keyframes slideUp { from{transform:translateY(50px);opacity:0} to{transform:translateY(0);opacity:1} }
        @keyframes slideUpFade { from{transform:translateY(10px);opacity:0} to{transform:translateY(0);opacity:1} }

        input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; margin: 10px 0; }
        /* ä¿®æ”¹åçš„æ»‘åŠ¨æ¡å°çƒæ ·å¼ */
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            height: 16px; /* åŸæ¥æ˜¯ 24pxï¼Œæ”¹æˆäº† 16pxï¼Œå˜å°å·§äº† */
            width: 16px;  /* å®½åº¦ä¹Ÿä¸€èµ·å˜å° */
            border-radius: 50%; 
            background: #007AFF; 
            cursor: pointer; 
            margin-top: -6px; /* ä½ç½®å¾®è°ƒï¼Œä¿è¯å®ƒæŒ‚åœ¨æ¨ªçº¿æ­£ä¸­é—´ */
            box-shadow: 0 1px 3px rgba(0,0,0,0.3); /* é˜´å½±ä¹Ÿç¨å¾®æ·¡ä¸€ç‚¹ï¼Œæ›´ç²¾è‡´ */
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #ddd; border-radius: 2px; }
        
        /* --- å¼¹çª—é›·è¾¾åŠ¨ç”» --- */
        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.7; }
        }
        /* --- æœç´¢è·³è½¬ï¼šå³ä¾§çˆ±å¿ƒè·³åŠ¨åŠ¨ç”» --- */
        @keyframes heart-pop {
            0% { opacity: 0; transform: translateY(-50%) scale(0); }
            20% { opacity: 1; transform: translateY(-50%) scale(1.4); } /* å˜å¤§ */
            40% { transform: translateY(-50%) scale(1); }   /* æ­£å¸¸ */
            60% { transform: translateY(-50%) scale(1.4); } /* å†è·³ä¸€ä¸‹ */
            100% { opacity: 0; transform: translateY(-50%) scale(0); } /* æ¶ˆå¤± */
        }
        
        /* ç»™æ°”æ³¡åŠ ä¸€ä¸ªä¼ªå…ƒç´ ï¼ˆå°±æ˜¯é‚£ä¸ªçˆ±å¿ƒï¼‰ */
        .msg-row.flash-highlight .msg-bubble::after {
            content: 'â¤ï¸';           /* æ˜¾ç¤ºçˆ±å¿ƒå›¾æ ‡ */
            position: absolute;
            right: -35px;            /* æ”¾åœ¨æ°”æ³¡å³è¾¹ 35px çš„åœ°æ–¹ */
            top: 50%;                /* å‚ç›´å±…ä¸­ */
            transform: translateY(-50%);
            font-size: 24px;         /* çˆ±å¿ƒå¤§å° */
            animation: heart-pop 1.5s ease-in-out forwards; /* æ‰§è¡ŒåŠ¨ç”» */
            pointer-events: none;    /* é¼ æ ‡ç©¿é€ï¼Œä¸å½±å“ç‚¹å‡» */
        }
        
        /* æœç´¢è¾“å…¥æ¡†çš„æ ·å¼ä¼˜åŒ– */
        .real-search-bar {
            display: flex; align-items: center;
            background: #f5f5f5; border-radius: 20px; padding: 5px 15px;
            margin-bottom: 15px;
        }
        .real-search-bar input {
            flex: 1; border: none; background: transparent;
            font-size: 14px; padding: 8px; outline: none;
        }
        .search-btn {
            font-size: 18px; padding: 5px; cursor: pointer;
        }
        /* --- è½¬å‘åŠŸèƒ½çš„æ ·å¼ --- */

/* 1. é•¶åµŒåœ¨åŠ¨æ€é‡Œçš„ç°è‰²å¡ç‰‡ */
.forward-box {
    background: #f7f7f7;
    padding: 10px;
    margin-top: 8px;
    border-radius: 6px;
    font-size: 14px;
    color: #666;
    display: flex;
    flex-direction: column;
    gap: 4px;
    border-left: 3px solid #dcdcdc; /* å·¦è¾¹åŠ æ ¹çº¿ï¼Œæ›´æœ‰å¼•ç”¨æ„Ÿ */
}
.fwd-name { font-weight: 600; color: #576b95; } /* è“è‰²åå­— */
.fwd-content { color: #666; }

/* 2. è½¬å‘è¾“å…¥å¼¹çª— */
.modal-forward-input {
    width: 100%; 
    border: 1px solid #ddd; 
    border-radius: 8px; 
    padding: 10px; 
    font-size: 15px; 
    margin: 10px 0;
    resize: none; 
    background: #f9f9f9;
}
/* --- ä¸ªäººç©ºé—´å¤´éƒ¨æ ·å¼ (QQç©ºé—´é£æ ¼) --- */

/* 1. é¡¶éƒ¨å¤§èƒŒæ™¯å›¾ */
.zone-header-bg {
    width: 100%;
    height: 220px;
    background-image: url('https://images.unsplash.com/photo-1490750967868-58cb7506aed6?q=80&w=1000&auto=format&fit=crop'); /* é»˜è®¤ä¸€å¼ æ¸…æ–°çš„å›¾ */
    background-size: cover;
    background-position: center;
    position: relative;
}

/* 2. ä¸ªäººä¿¡æ¯åŒºåŸŸ (å¤´åƒã€åå­—ã€è®¿å®¢) */
.zone-profile-box {
    padding: 0 20px;
    position: relative;
    margin-top: -40px; /* è®©å¤´åƒå¾€ä¸Šå åœ¨èƒŒæ™¯å›¾ä¸Š */
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.zone-avatar-big {
    width: 80px; 
    height: 80px;
    border-radius: 50%;
    border: 3px solid #fff; /* ç™½è¾¹æ¡† */
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    object-fit: cover;
    background: #fff;
    z-index: 2;
}

.zone-username {
    font-size: 20px;
    font-weight: bold;
    color: #333;
    margin-top: 5px;
    display: flex; 
    align-items: center; 
    gap: 5px;
}

/* è®¿å®¢é‡æ ·å¼ */
.zone-visitors {
    font-size: 13px;
    color: #666;
    font-family: monospace; /* æ•°å­—ç”¨ç­‰å®½å­—ä½“å¥½çœ‹ç‚¹ */
}
.zone-visitors b {
    color: #333;
    font-size: 14px;
    margin-left: 4px;
}

/* 3. ä¸‰ä¸ªåŠŸèƒ½æŒ‰é’®æ  */
.zone-nav-bar {
    display: flex;
    justify-content: space-around; /* å¹³å‡åˆ†å¸ƒ */
    align-items: center;
    padding: 20px 10px;
    background: #fff;
    margin-bottom: 10px;
    border-bottom: 1px solid #f5f5f5;
}

.zone-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: #333;
    font-weight: 500;
    cursor: pointer;
}

.zone-nav-icon {
    width: 40px; height: 40px;
    background: #f2f2f7;
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
}
/* --- é¡µé¢å…¨å±€é€æ˜åŒ–æ”¹é€  --- */

/* 1. è®©åŠŸèƒ½æŒ‰é’®æ å˜æˆâ€œç£¨ç ‚ç»ç’ƒâ€é€æ˜ï¼Œè€Œä¸æ˜¯çº¯ç™½ */
.zone-nav-bar {
    background: rgba(255, 255, 255, 0.5) !important; /* åŠé€æ˜ */
    backdrop-filter: blur(10px); /* ç£¨ç ‚æ•ˆæœ */
    border-bottom: none !important;
    margin-bottom: 0 !important;
    border-radius: 0 0 16px 16px; /* åº•éƒ¨åœ†è§’ */
}

/* 2. åˆ—è¡¨å®¹å™¨å®Œå…¨é€æ˜ */
#list-moments {
    background: transparent !important;
    padding-top: 20px !important; /* ç¨å¾®æ‹‰å¼€ç‚¹è·ç¦» */
}

/* 3. åŠ¨æ€å¡ç‰‡ä¹Ÿç¨å¾®é€šé€ä¸€ç‚¹ç‚¹ (å¯é€‰) */
/* --- æ ¸å¿ƒä¿®æ”¹ï¼šè®©å¡ç‰‡æ”¯æŒå…¨é€æ˜ (è”åŠ¨é˜´å½±å’Œæ¨¡ç³Š) --- */
:root {
    --moment-opacity: 1; 
}

.moment-card {
    /* 1. èƒŒæ™¯è‰²ï¼šä½¿ç”¨å˜é‡æ§åˆ¶é€æ˜åº¦ */
    background: rgba(255, 255, 255, var(--moment-opacity)) !important;
    
    /* 2. å…³é”®ä¿®æ”¹ï¼šé˜´å½±é¢œè‰²ä¹Ÿä¹˜ä¸Šé€æ˜åº¦ã€‚å½“ opacity ä¸º 0 æ—¶ï¼Œé˜´å½± alpha ä¹Ÿå°±å˜æˆ 0 äº† */
    box-shadow: 0 2px 8px rgba(0, 0, 0, calc(var(--moment-opacity) * 0.1)) !important;
    
    /* 3. å…³é”®ä¿®æ”¹ï¼šæ¨¡ç³Šç¨‹åº¦ä¹Ÿä¹˜ä¸Šé€æ˜åº¦ã€‚0 * 5px = 0px (æ— æ¨¡ç³Š) */
    backdrop-filter: blur(calc(var(--moment-opacity) * 5px));
    -webkit-backdrop-filter: blur(calc(var(--moment-opacity) * 5px)); /* å…¼å®¹è‹¹æœæ‰‹æœº */

    /* 4. å…¶ä»–ä¿æŒä¸å˜ */
    color: #000 !important;
    padding: 15px; 
    border-radius: 16px;
    margin: 10px 12px;
    border: none;
    display: flex;
    flex-direction: column; 
}
/* --- å…¨å±èƒŒæ™¯æ²‰æµ¸å¼æ”¹é€  --- */

/* 1. æ•´ä¸ªåŠ¨æ€é¡µé¢å®¹å™¨ï¼šå‡†å¤‡å¥½æ¥å—å…¨å±èƒŒæ™¯å›¾ */
#view-moments {
    background-color: #f2f2f7; /* é»˜è®¤åº•è‰² */
    background-repeat: no-repeat;
    background-position: center;
    background-size: cover; /* å…³é”®ï¼šå…¨å±é“ºæ»¡ */
    background-attachment: fixed; /* èƒŒæ™¯å›ºå®šï¼Œå†…å®¹æ»šåŠ¨ */
}

/* 2. åŸæ¥çš„å¤´å›¾åŒºåŸŸï¼šå˜æˆé€æ˜å ä½ç¬¦ */
/* (å®ƒç°åœ¨åªæ˜¯ä¸ºäº†æŠŠå¤´åƒæŒ¤ä¸‹æ¥ï¼Œä¸å†è´Ÿè´£æ˜¾ç¤ºå›¾ç‰‡äº†) */
.zone-header-bg {
    background: transparent !important; 
    height: 220px; /* é«˜åº¦ä¿ç•™ï¼Œç»´æŒå¸ƒå±€ */
    border: none;
}

/* 3. æ»šåŠ¨åŒºåŸŸå’Œåˆ—è¡¨ï¼šå…¨éƒ¨é€æ˜ï¼Œéœ²å‡ºåº•ä¸‹çš„å£çº¸ */
#view-moments .scroll-content,
#list-moments {
    background: transparent !important;
}

/* 4. åŠŸèƒ½æ ï¼šåŠé€æ˜ç£¨ç ‚ç»ç’ƒï¼Œå¥½çœ‹ï¼ */
.zone-nav-bar {
    background: rgba(255, 255, 255, 0.3) !important;
    backdrop-filter: blur(10px);
    border: none;
}

/* 5. é‡ç‚¹ï¼šå¡ç‰‡ä¿æŒç™½è‰²ä¸é€æ˜ï¼Œä¸”å­—è‰²æ­£å¸¸ */
.moment-card {
    opacity: 1 !important;
    color: #000 !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
}

/* 6. ä¸ªäººä¿¡æ¯æ–‡å­—é¢œè‰²ä¼˜åŒ– */
/* å› ä¸ºèƒŒæ™¯å›¾å¯èƒ½æ˜¯æ·±è‰²ï¼Œç»™åå­—åŠ ä¸ªé˜´å½±é˜²çœ‹ä¸æ¸… */
.zone-username, .zone-visitors {
    color: #333;
    text-shadow: 0 1px 2px rgba(255,255,255,0.8); /* ç™½æè¾¹æ•ˆæœ */
}
/* --- è°ƒæ•´å¡ç‰‡åˆ—è¡¨çš„é¡¶éƒ¨é—´è· --- */

#list-moments {
    /* åŸæ¥æ˜¯ 20pxï¼Œæ”¹æˆ 0ï¼Œç›´æ¥ç´§è´´å¯¼èˆªæ  */
    padding-top: 0 !important; 
}

/* å¦‚æœè§‰å¾—è¿˜æ˜¯ä¸å¤Ÿè¿‘ï¼Œç”šè‡³å¯ä»¥è®©ç¬¬ä¸€å¼ å¡ç‰‡çš„ä¸Šè¾¹è·ä¹Ÿæ¶ˆå¤± */
#list-moments .moment-card:first-child {
    margin-top: 5px !important; /* ç¬¬ä¸€å¼ å¡ç‰‡åªç•™ä¸€ç‚¹ç‚¹ç¼éš™ */
}

/* ä¹Ÿå¯ä»¥é¡ºä¾¿æŠŠå¯¼èˆªæ çš„åº•éƒ¨å†…è¾¹è·ç¨å¾®æ”¶ä¸€ç‚¹ï¼Œæ˜¾å¾—æ›´ç´§å‡‘ */
.zone-nav-bar {
    padding-bottom: 10px !important; /* åŸæ¥æ˜¯ 20px */
}
/* --- æ•´ä½“å†…å®¹ä¸Šç§»è°ƒæ•´ --- */

/* 1. å‹ç¼©é¡¶éƒ¨é€æ˜å ä½å—çš„é«˜åº¦ */
/* åŸæ¥æ˜¯ 220pxï¼Œæˆ‘ä»¬æŠŠå®ƒæ”¹çŸ®åˆ° 120px */
/* è¿™æ ·ä¸‹é¢çš„å¤´åƒã€æŒ‰é’®ã€å¡ç‰‡éƒ½ä¼šè·Ÿç€ä¸€èµ·å¾€ä¸Šè·‘ 100px */
.zone-header-bg {
    height: 120px !important;
    min-height: 120px !important;
}

/* 2. ä¿®æ­£å¤´åƒçš„åç§» */
/* å› ä¸ºä¸Šé¢å˜çŸ®äº†ï¼Œå¤´åƒåŸæœ¬çš„ -40px è´Ÿè¾¹è·å¯èƒ½ä¼šè®©å®ƒè·‘å¤ªé«˜è¢«é®ä½ */
/* æˆ‘ä»¬æŠŠå®ƒå½’é›¶ï¼Œæˆ–è€…ç¨å¾®è°ƒæ•´ä¸€ä¸‹ */
.zone-profile-box {
    margin-top: -20px !important; /* å¾®è°ƒä¸€ä¸‹ï¼Œè®©å®ƒè‡ªç„¶è¡”æ¥ */
}
/* --- ä¿®æ­£å¤´åƒå’Œåå­—çš„å±…ä¸­å¯¹é½ --- */

.zone-profile-box {
    align-items: center !important; /* å…³é”®ï¼šè®©æ‰€æœ‰å­å…ƒç´ ï¼ˆå¤´åƒã€åå­—ã€è®¿å®¢ï¼‰æ°´å¹³å±…ä¸­ */
    text-align: center !important;  /* è®©æ–‡å­—å†…å®¹ä¹Ÿå±…ä¸­ */
}

/* ä¿®æ­£åå­—é‚£ä¸€è¡Œçš„å¯¹é½ */
.zone-username {
    justify-content: center !important; /* è®©åå­—å’Œæ—è¾¹çš„è£…é¥°å›¾æ ‡å±…ä¸­ */
    width: 100%; /* å æ»¡å®½åº¦ï¼Œç¡®ä¿å±…ä¸­ç”Ÿæ•ˆ */
}

/* ä¿®æ­£è®¿å®¢æ•°çš„å¯¹é½ */
.zone-visitors {
    width: 100%;
    text-align: center !important;
}
/* --- åŠŸèƒ½æ é å·¦å¯¹é½ --- */

.zone-nav-bar {
    justify-content: flex-start !important; /* å…³é”®ï¼šæ”¹æˆé å·¦å¼€å§‹æ’ */
    padding-left: 20px !important;          /* å·¦è¾¹ç•™å‡º 20px çš„è¾¹è·ï¼Œä¸è´´å±å¹• */
    gap: 30px !important;                   /* æ¯ä¸ªæŒ‰é’®ä¹‹é—´éš”å¼€ 30pxï¼Œä½ å¯ä»¥è‡ªå·±è°ƒå¤§è°ƒå° */
}
/* --- å¤´åƒã€åå­—ã€è®¿å®¢æ•°ï¼šé å·¦å¯¹é½ --- */

.zone-profile-box {
    align-items: flex-start !important; /* è®©å¤´åƒå’Œæ–‡å­—å—é å·¦ */
    text-align: left !important;        /* æ–‡å­—å†…å®¹é å·¦ */
    padding-left: 30px !important;      /* å·¦è¾¹ç•™å‡º 30px è·ç¦»ï¼Œä¸è¦ç´§è´´å±å¹•è¾¹ç¼˜ */
}

/* åå­—é‚£ä¸€è¡Œçš„å¯¹é½ */
.zone-username {
    justify-content: flex-start !important; /* è®©åå­—å’Œå›¾æ ‡é å·¦æ’åˆ— */
}

/* è®¿å®¢æ•°çš„å¯¹é½ */
.zone-visitors {
    text-align: left !important;
}
/* --- åŠŸèƒ½æ æ•´ä½“ç¼©å° --- */

/* 1. ç¼©å°å¤–éƒ¨å®¹å™¨çš„é«˜åº¦å’Œç•™ç™½ */
.zone-nav-bar {
    padding-top: 5px !important;
    padding-bottom: 5px !important;
}

/* 2. ç¼©å°é‚£ä¸ªå½©è‰²çš„å°æ–¹å—å›¾æ ‡ */
.zone-nav-icon {
    width: 32px !important;       /* åŸæ¥æ˜¯ 40pxï¼Œæ”¹æˆ 32px */
    height: 32px !important;
    font-size: 16px !important;   /* é‡Œé¢çš„ Emoji ä¹Ÿå˜å° */
    border-radius: 10px !important; /* åœ†è§’ä¹Ÿç¨å¾®æ”¶ä¸€ç‚¹ */
}

/* 3. ç¼©å°å›¾æ ‡ä¸‹é¢çš„æ–‡å­— */
.zone-nav-item {
    font-size: 11px !important;   /* æ–‡å­—å˜å° */
    gap: 3px !important;          /* æ–‡å­—ç¦»å›¾æ ‡æ›´è¿‘ä¸€ç‚¹ */
}
/* --- ä¸ªäººä¿¡æ¯å¸ƒå±€ç»ˆææ”¹é€ ï¼šå·¦å›¾å³æ–‡ --- */

.zone-profile-box {
    display: grid !important;
    /* å®šä¹‰ä¸¤åˆ—ï¼šç¬¬1åˆ—æ˜¯å¤´åƒ(è‡ªåŠ¨å®½åº¦)ï¼Œç¬¬2åˆ—æ˜¯æ–‡å­—(å æ»¡å‰©ä½™ç©ºé—´) */
    grid-template-columns: max-content 1fr !important;
    /* å®šä¹‰ä¸¤è¡Œï¼šåå­—ä¸€è¡Œï¼Œè®¿å®¢æ•°ä¸€è¡Œ */
    grid-template-rows: auto auto !important;
    
    /* å¤´åƒå’Œæ–‡å­—ä¹‹é—´çš„è·ç¦» */
    column-gap: 12px !important;
    
    /* æ•´ä½“ä½ç½®å¾®è°ƒ */
    padding-left: 20px !important; /* ç¦»å·¦å±å¹•çš„è·ç¦» */
    margin-top: -25px !important;  /* è®©å¤´åƒç¨å¾®å åœ¨èƒŒæ™¯å›¾ä¸Šä¸€ç‚¹ç‚¹ */
    align-items: center !important;
}

/* 1. å¤´åƒï¼šè®©å®ƒè·¨è¶Šä¸¤è¡Œçš„é«˜åº¦ */
.zone-avatar-big {
    grid-row: 1 / span 2 !important; /* çºµè·¨ä¸¤è¡Œ */
    grid-column: 1 !important;
    margin: 0 !important; /* å»æ‰ä»¥å‰çš„å±…ä¸­è¾¹è· */
    width: 64px !important; /* ç¨å¾®è°ƒå°ä¸€ç‚¹ç‚¹ï¼Œæ˜¾å¾—æ›´ç²¾è‡´ */
    height: 64px !important;
}

/* 2. åå­—ï¼šæ”¾åœ¨å³ä¸Š */
.zone-username {
    grid-row: 1 !important;
    grid-column: 2 !important;
    align-self: end !important; /* é ä¸‹å¯¹é½ï¼Œç´§æŒ¨ç€ä¸‹é¢çš„è®¿å®¢æ•° */
    margin-bottom: 2px !important;
    font-size: 17px !important; 
    font-weight: 700 !important;
    justify-content: flex-start !important; /* æ–‡å­—é å·¦ */
    text-shadow: 0 1px 3px rgba(255,255,255,0.8); /* é˜²æ­¢èƒŒæ™¯å¤ªèŠ±çœ‹ä¸æ¸… */
}

/* 3. è®¿å®¢ï¼šæ”¾åœ¨å³ä¸‹ */
.zone-visitors {
    grid-row: 2 !important;
    grid-column: 2 !important;
    align-self: start !important; /* é ä¸Šå¯¹é½ï¼Œç´§æŒ¨ç€ä¸Šé¢çš„åå­— */
    text-align: left !important;
    font-size: 11px !important;
    color: #666 !important;
    opacity: 0.8;
}
/* --- è´µæ—ä¼šå‘˜é¡µé¢æ ·å¼ (ä»¿QQè´µæ—) --- */

/* 1. é¡µé¢èƒŒæ™¯ */
#view-vip {
    background: #f5f5f5; /* æµ…ç°åº•è‰² */
}

/* 2. é¡¶éƒ¨å¹¿å‘Šå›¾æ¨¡æ‹Ÿ */
.vip-banner {
    width: 100%;
    height: 140px;
    background: linear-gradient(135deg, #FFD700 0%, #FFAA00 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 24px;
    font-weight: bold;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    position: relative;
}
.vip-banner::after {
    content: 'âœ¨ å°é¼ æœºè´µæ— âœ¨';
    font-family: "PingFang SC", sans-serif;
    letter-spacing: 2px;
}

/* 3. ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ (æµ®åœ¨å¹¿å‘Šå›¾ä¸‹é¢) */
.vip-user-card {
    background: #fff;
    margin: -20px 15px 15px; /* å¾€ä¸Šæï¼Œç›–ä½ä¸€ç‚¹å¹¿å‘Šå›¾ */
    border-radius: 12px;
    padding: 15px;
    display: flex;
    align-items: center;
    position: relative;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    z-index: 2;
}
.vip-avatar {
    width: 50px; height: 50px;
    border-radius: 50%;
    margin-right: 12px;
    border: 1px solid #eee;
}
.vip-info h3 { margin: 0; font-size: 16px; font-weight: 600; }
.vip-info p { margin: 4px 0 0; font-size: 12px; color: #999; }
.vip-close { position: absolute; top: 10px; right: 15px; color: #ccc; font-size: 20px; }

/* 4. é’»ç±»é€‰æ‹© Tab */
.vip-tabs {
    display: flex;
    background: #fff;
    padding: 15px 20px 0;
    border-bottom: 1px solid #f0f0f0;
}
.vip-tab-item {
    margin-right: 30px;
    padding-bottom: 10px;
    font-size: 15px;
    font-weight: 600;
    color: #333;
    position: relative;
    display: flex; align-items: center; gap: 5px;
}
.vip-tab-item.active { color: #D4A048; }
.vip-tab-item.active::after {
    content: ''; position: absolute; bottom: 0; left: 20%; width: 60%; height: 3px;
    background: #D4A048; border-radius: 2px;
}

/* 5. ä»·æ ¼å¡ç‰‡åŒºåŸŸ */
.vip-price-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    padding: 20px 15px;
    background: #fff;
}
.price-card {
    border: 1px solid #eee;
    border-radius: 10px;
    padding: 20px 5px;
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
    transition: 0.2s;
    cursor: pointer;
    background: #fff;
    position: relative;
    overflow: hidden;
}
/* é€‰ä¸­çŠ¶æ€ */
.price-card.active {
    border-color: #D4A048;
    background: #FFFAF0; /* æ·¡æ·¡çš„é‡‘è‰²èƒŒæ™¯ */
}
.price-month { font-size: 14px; color: #333; margin-bottom: 5px; }
.price-num { font-size: 28px; color: #D4A048; font-weight: bold; font-family: 'DIN', sans-serif; }
.price-num::before { content: 'Â¥'; font-size: 14px; vertical-align: super; margin-right: 2px; }
.price-save { 
    font-size: 10px; background: #ff5252; color: white; 
    padding: 2px 6px; border-radius: 4px; 
    position: absolute; top: 0; left: 0; border-bottom-right-radius: 8px;
    display: none;
}
.price-card.recommend .price-save { display: block; }

/* 6. åº•éƒ¨æ”¯ä»˜æ  */
.vip-footer {
    position: absolute; bottom: 0; left: 0; width: 100%;
    background: #fff;
    padding: 15px 20px;
    padding-bottom: max(15px, env(safe-area-inset-bottom));
    box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
    display: flex; flex-direction: column; gap: 15px;
}
.auto-renew-row {
    display: flex; justify-content: space-between; align-items: center;
    font-size: 14px; font-weight: 600; color: #333;
}
/* å¼€å…³æ ·å¼ */
.switch { position: relative; display: inline-block; width: 46px; height: 26px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: #D4A048; }
input:checked + .slider:before { transform: translateX(20px); }

.pay-btn {
    width: 100%;
    background: linear-gradient(90deg, #F6D398 0%, #F2C375 100%);
    color: #5c3b00;
    border: none;
    padding: 14px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 25px;
    cursor: pointer;
}
.pay-tips { font-size: 11px; color: #999; text-align: center; transform: scale(0.9); }
/* --- ğŸ’° è½¬è´¦å¡ç‰‡æ ·å¼ (æ–°å¢) --- */
.msg-bubble.is-transfer {
    padding: 0 !important;
    background: #fff !important;
    border-radius: 8px !important;
    overflow: hidden;
    width: 230px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    display: flex; flex-direction: column;
    cursor: default !important;
}

/* é¡¶éƒ¨æ©™è‰²åŒºåŸŸ */
.transfer-top {
    background: #ff9c00; 
    padding: 15px;
    display: flex; align-items: center; gap: 12px;
    color: white;
}
/* æ¥æ”¶/é€€è¿˜åçš„çŠ¶æ€ï¼šå˜æµ…è‰² */
.msg-bubble.is-transfer.done .transfer-top {
    background: #f7dcb6; 
}

.transfer-icon-circle {
    width: 40px; height: 40px; border-radius: 50%; border: 2px solid white;
    display: flex; align-items: center; justify-content: center; font-size: 20px;
}
.transfer-info { flex: 1; display: flex; flex-direction: column; }
.transfer-amount { font-size: 16px; font-weight: bold; }
.transfer-desc { font-size: 12px; opacity: 0.9; }

/* åº•éƒ¨ç™½è‰²åŒºåŸŸ */
.transfer-bottom {
    padding: 8px 15px; background: #fff;
    font-size: 10px; color: #999;
    display: flex; justify-content: space-between; align-items: center;
}

/* æ“ä½œæŒ‰é’®åŒº */
.transfer-actions { display: flex; gap: 10px; margin-top: 5px; }
.trans-btn {
    border: 1px solid white; border-radius: 4px; padding: 2px 8px; 
    font-size: 12px; cursor: pointer; background: rgba(255,255,255,0.2); color: white;
}
.trans-btn:active { background: rgba(255,255,255,0.4); }

/* ç³»ç»Ÿå°ç°æ¡ */
.system-msg-row { display: flex; justify-content: center; margin: 10px 0; width: 100%; pointer-events: none;}
.system-msg-bubble { background: rgba(0,0,0,0.2); color: white; font-size: 12px; padding: 4px 10px; border-radius: 4px; }
/* --- â° èŠå¤©æ—¶é—´æˆ³æ ·å¼ --- */
.chat-time-stamp {
    text-align: center;
    font-size: 12px;
    color: #b0b0b0;    /* æµ…ç°è‰² */
    margin: 20px 0 10px; /* ä¸Šä¸‹ç•™ç‚¹è·ç¦» */
    width: 100%;
    pointer-events: none; /* é˜²æ­¢è¯¯è§¦ */
}
/* --- ğŸ’° é’±åŒ…é¡µé¢æ ·å¼ (ä¿®å¤ç‰ˆ) --- */
.wallet-card {
    background: #fff;
    color: #333;
    padding: 50px 20px;
    text-align: center;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    margin-bottom: 10px;
}
.wallet-icon { 
    font-size: 50px; 
    margin-bottom: 15px; 
    color: #FF9500; 
}
.wallet-label { font-size: 14px; color: #666; margin-bottom: 10px; }
.wallet-num { font-size: 48px; font-weight: bold; font-family: DIN, sans-serif; color: #000; }
.wallet-num::before { content: 'Â¥'; font-size: 28px; margin-right: 4px; vertical-align: baseline; }

/* ğŸ‘‡ğŸ‘‡ğŸ‘‡ è¯·é‡ç‚¹æ£€æŸ¥å¹¶è¡¥å……è¿™ä¸€æ®µ ğŸ‘‡ğŸ‘‡ğŸ‘‡ */
.wallet-menu { 
    background: #fff; 
    width: 100%; /* ç¡®ä¿å æ»¡å®½åº¦ */
}

.wallet-menu-item {
    padding: 15px 20px;          /* ç»™å®ƒé«˜åº¦ï¼Œä¸å†çª„çª„çš„ */
    border-bottom: 1px solid #f5f5f5;
    display: flex;               /* å¼€å¯å¼¹æ€§å¸ƒå±€ */
    justify-content: space-between; /* âœ¨ å…³é”®ï¼šè®©æ–‡å­—åœ¨å·¦ï¼Œç®­å¤´åœ¨å³ */
    align-items: center;         /* å‚ç›´å±…ä¸­ */
    font-size: 16px; 
    color: #333; 
    cursor: pointer;
}
.wallet-menu-item:active { 
    background: #f9f9f9; 
}
/* ğŸ‘†ğŸ‘†ğŸ‘† è¡¥å……åˆ°è¿™é‡Œä¸ºæ­¢ ğŸ‘†ğŸ‘†ğŸ‘† */

/* --- ğŸ“œ é›¶é’±æ˜ç»†åˆ—è¡¨æ ·å¼ --- */
.bill-item {
    background: #fff; padding: 15px;
    border-bottom: 1px solid #f5f5f5;
    display: flex; justify-content: space-between; align-items: center;
}
.bill-left { display: flex; flex-direction: column; gap: 4px; }
.bill-title { font-size: 16px; color: #000; font-weight: 500; }
.bill-time { font-size: 12px; color: #999; }

.bill-right { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
.bill-amount { font-size: 18px; font-weight: bold; }
.bill-amount.add { color: #fa9d3b; } /* æ”¶å…¥æ©™è‰² */
.bill-amount.minus { color: #333; }   /* æ”¯å‡ºé»‘è‰² */
.bill-status { font-size: 12px; color: #999; }
/* --- ğŸ“‚ èœå•ç»„æ ·å¼ (è®©é€‰é¡¹ç´§è´´) --- */
.menu-group {
    background: #fff;
    border-radius: 12px;
    overflow: hidden; /* ä¿è¯åœ†è§’ */
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

/* è¦†ç›– list-item åœ¨èœå•ç»„é‡Œçš„æ ·å¼ */
.menu-group .list-item {
    margin-bottom: 0 !important;       /* å»æ‰ä¸‹é—´è· */
    border-radius: 0 !important;       /* å»æ‰åœ†è§’ */
    border-bottom: 1px solid #f5f5f5;  /* åŠ åˆ†å‰²çº¿ */
    box-shadow: none !important;       /* å»æ‰é˜´å½± */
    background: transparent !important;
}

.menu-group .list-item:last-child {
    border-bottom: none; /* æœ€åä¸€ä¸ªå»æ‰åˆ†å‰²çº¿ */
}

/* ç‚¹å‡»æ—¶çš„åé¦ˆé¢œè‰² */
.menu-group .list-item:active {
    background-color: #f9f9f9 !important;
}
/* --- ğŸ‘‘ è´µæ—ç‰¹æƒæ ·å¼ --- */
.moment-name.is-vip {
    color: #ff0000 !important; /* å¼ºåˆ¶å˜çº¢ */
    text-shadow: 0 1px 2px rgba(255,0,0,0.1);
}

.vip-crown-icon {
    display: inline-block;
    margin-left: 4px;
    font-size: 14px;
    vertical-align: middle;
    animation: pulse 2s infinite; /* è®©çš‡å† å‘¼å¸è·³åŠ¨ */
}
/* --- â­ æˆ‘çš„ç­‰çº§é¡µé¢æ ·å¼ --- */
.level-card {
    /* ä»¿æˆªå›¾çš„æ¢¦å¹»æ¸å˜èƒŒæ™¯ */
    background: linear-gradient(135deg, #E0C3FC 0%, #8EC5FC 100%);
    border-radius: 20px;
    padding: 25px 20px;
    margin: 15px;
    color: #333;
    position: relative;
    box-shadow: 0 10px 30px rgba(142, 197, 252, 0.4);
    display: flex;
    justify-content: space-between;
    align-items: center;
    overflow: hidden;
}

/* ç»ç’ƒå…‰æ³½è£…é¥° */
.level-card::after {
    content: ''; position: absolute; top: -50%; right: -50%;
    width: 200px; height: 200px; background: rgba(255,255,255,0.2);
    border-radius: 50%; filter: blur(40px); pointer-events: none;
}

.level-user-info {
    display: flex; align-items: center; gap: 15px; z-index: 2;
}

.level-avatar {
    width: 60px; height: 60px; border-radius: 50%;
    border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.level-text-box { display: flex; flex-direction: column; gap: 5px; }
.level-name { font-size: 18px; font-weight: bold; color: #333; }

/* è¾¾äººå›¾æ ‡ */
.talent-badge {
    display: inline-flex; align-items: center; gap: 2px;
    background: #FF9500; color: white;
    font-size: 10px; padding: 2px 6px; border-radius: 10px;
    font-weight: bold; box-shadow: 0 2px 5px rgba(255, 149, 0, 0.4);
    transition: filter 0.3s;
}
/* å˜ç°çŠ¶æ€ */
.talent-badge.gray {
    filter: grayscale(100%); /* å®Œå…¨å˜ç° */
    background: #ccc;
    box-shadow: none;
}

/* å³ä¾§ç­‰çº§å¤§å­— */
.level-display {
    text-align: right; z-index: 2;
}
.level-star-img { font-size: 40px; margin-bottom: -10px; display: block; text-align: center;}
.level-num {
    font-size: 42px; font-weight: 800; font-family: 'DIN', sans-serif;
    background: linear-gradient(to bottom, #333, #666);
    -webkit-background-clip: text; color: transparent;
}
.level-num::before { content: 'Lv'; font-size: 20px; margin-right: 2px; }

/* ç­¾åˆ°æŒ‰é’® */
.sign-in-btn {
    width: 90%; margin: 20px auto; display: block;
    padding: 15px; border-radius: 30px; border: none;
    background: linear-gradient(90deg, #FF9A9E 0%, #FECFEF 99%, #FECFEF 100%);
    color: #fff; font-size: 18px; font-weight: bold;
    box-shadow: 0 5px 15px rgba(255, 154, 158, 0.4);
    cursor: pointer; transition: 0.2s;
}
.sign-in-btn:active { transform: scale(0.98); }
.sign-in-btn.disabled {
    background: #e0e0e0; color: #999; box-shadow: none; cursor: not-allowed;
}
/* --- ğŸ“ å‘å¸ƒåŠ¨æ€é¡µé¢æ ·å¼ --- */
.publish-textarea {
    width: 100%; border: none; outline: none;
    font-size: 16px; line-height: 1.5; resize: none;
    min-height: 120px; background: transparent;
    padding: 10px 0;
}

/* å›¾ç‰‡é¢„è§ˆåŒº */
.publish-img-grid {
    display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;
}
.publish-img-item {
    width: 100px; height: 100px; object-fit: cover;
    border-radius: 4px; background: #eee;
}

/* åº•éƒ¨å·¥å…·æ  */
.publish-toolbar {
    border-top: 1px solid #f0f0f0;
    padding-top: 10px; display: flex; flex-direction: column; gap: 15px;
}
.toolbar-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 0; border-bottom: 1px solid #f9f9f9;
    font-size: 15px; color: #333; cursor: pointer;
}
.toolbar-icon { width: 24px; text-align: center; margin-right: 10px; font-size: 20px; }
.toolbar-right { color: #999; font-size: 13px; display: flex; align-items: center; }

/* --- ğŸ–¼ï¸ æœ‹å‹åœˆæ˜¾ç¤ºæ ·å¼æ›´æ–° --- */
/* --- ğŸ–¼ï¸ æœ‹å‹åœˆå›¾ç‰‡æ ·å¼ (ç²¾è‡´ç‰ˆ) --- */
.moment-photo {
    width: 120px !important;       /* å®½åº¦ç¼©å°ï¼šåŸæ¥æ˜¯ 180px -> æ”¹ä¸º 120px */
    max-height: 160px !important;  /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼šé˜²æ­¢é•¿å›¾éœ¸å± */
    height: auto;                  /* é«˜åº¦è‡ªåŠ¨ï¼Œä¿æŒæ¯”ä¾‹ä¸æ‹‰ä¼¸ */
    object-fit: cover;             /* å¦‚æœå›¾ç‰‡å¤ªé•¿ï¼Œè¶…å‡ºçš„éƒ¨åˆ†åˆ‡æ‰ */
    border-radius: 6px;            /* åœ†è§’ç¨å¾®æŸ”å’Œä¸€ç‚¹ */
    margin-top: 8px;
    display: block;
    cursor: pointer;
    border: 1px solid #f0f0f0;     /* åŠ ä¸ªæç»†çš„è¾¹æ¡†ï¼Œæ˜¾å¾—ç²¾è‡´ */
}
.moment-location {
    font-size: 12px; color: #576b95;
    margin-top: 8px; margin-bottom: 4px;
}
/* ================= ğŸ‘‡ å¿…é¡»æ”¾åœ¨ style çš„æœ€åé¢ ğŸ‘‡ ================= */
/* ================= ğŸ§¼ åº•éƒ¨æŒ‰é’®é‡åˆ¶æ ·å¼ (æ”¾åœ¨ style æœ€å) ================= */

/* 1. è¾“å…¥æ å®¹å™¨ï¼šæŠŠä¹‹å‰çš„ padding ä¹±ä¸ƒå…«ç³Ÿçš„éƒ½å»æ‰ï¼Œç”¨ flex å¸ƒå±€è‡ªåŠ¨æ’ */
.chat-input-bar {
    background: #f7f7f7 !important;
    padding: 10px 12px !important; /* ä¸Šä¸‹10ï¼Œå·¦å³12ï¼Œå‰©ä¸‹çš„é å ä½å—æ’‘ */
    border-top: 1px solid #dcdcdc;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
    padding-bottom: max(10px, env(safe-area-inset-bottom));
}

/* 2. æŒ‰é’®æ ·å¼ï¼šå¼ºåˆ¶å˜åœ†ã€å˜å°ã€Qå¼¹ */
.mini-btn {
    height: 30px !important;       /* é«˜åº¦æ”¹å°åˆ° 30px */
    padding: 0 12px !important;    /* ä¸¤è¾¹å†…è¾¹è· */
    border-radius: 999px !important; /* âœ¨ ç»å¯¹çš„èƒ¶å›Šåœ†è§’ */
    border: none !important;
    color: #fff !important;
    font-size: 12px !important;    /* å­—ä½“å°å·§ä¸€ç‚¹ */
    font-weight: bold !important;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15) !important; /* æµ®èµ·çš„å°é˜´å½± */
    transition: transform 0.1s !important;
    flex-shrink: 0; /* ç¦æ­¢æŒ‰é’®è¢«æŒ¤æ‰ */
}

/* 3. ç‚¹å‡»æ—¶çš„ Qå¼¹æ•ˆæœ */
.mini-btn:active {
    transform: scale(0.85) !important; /* æŒ‰ä¸‹å»ç¼©å°æ˜æ˜¾ä¸€ç‚¹ */
    box-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
}
/* ================= ğŸš‘ ç»ˆæä¿®å¤è¡¥ä¸ (æ”¾åœ¨ style æœ€å) ================= */

/* 1. è¾“å…¥æ å®¹å™¨ */
.chat-input-bar {
    background: #f7f7f7 !important;
    /* ä¸Š10ï¼Œå³20(ç•™å‡ºç©ºéš™)ï¼Œä¸‹10ï¼Œå·¦12 */
    padding: 10px 20px 10px 12px !important; 
    border-top: 1px solid #dcdcdc;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important; /* å…ƒç´ ä¹‹é—´çš„é—´è· */
    flex-shrink: 0;
    padding-bottom: max(10px, env(safe-area-inset-bottom));
}

/* 2. âœ¨ å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶è¾“å…¥æ¡†å æ»¡å‰©ä½™ç©ºé—´ */
.chat-input-bar input {
    flex: 1 !important; /* è¿™ä¸€å¥è®©è¾“å…¥æ¡†è‡ªåŠ¨å˜é•¿ï¼ */
    width: 100% !important; /* åŒé‡ä¿é™© */
    height: 36px !important;
    border-radius: 8px !important;
    border: 1px solid #ddd !important;
    padding: 0 10px !important;
    font-size: 16px !important;
    background: #fff !important;
    outline: none;
}

/* 3. æŒ‰é’®æ ·å¼ï¼šä¿æŒåœ†æ¶¦å¯çˆ± */
.mini-btn {
    height: 32px !important;
    padding: 0 14px !important;
    border-radius: 20px !important; /* åœ†è§’ */
    border: none !important;
    color: #fff !important;
    font-size: 13px !important;
    font-weight: 600 !important;
    cursor: pointer;
    flex-shrink: 0 !important; /* ç¦æ­¢æŒ‰é’®è¢«æŒ¤æ‰ */
    box-shadow: 0 2px 5px rgba(0,0,0,0.15) !important;
    margin: 0 !important; /* å»æ‰å¤šä½™è¾¹è·ï¼Œé  gap æ§åˆ¶ */
}

.mini-btn:active {
    transform: scale(0.9);
}
/* ================= â• åŠ å·æŒ‰é’®ä¿®å¤è¡¥ä¸ (å˜åœ†å˜ç¾) ================= */
.plus-btn {
    width: 30px !important;
    height: 30px !important;
    border-radius: 50% !important;   /* âœ¨ æ ¸å¿ƒï¼šå¼ºåˆ¶å˜åœ† */
    border: 1.5px solid #7f7f7f !important; /* ç°è‰²åœ†åœˆè¾¹æ¡† */
    color: #7f7f7f !important;       /* åŠ å·é¢œè‰² */
    background: transparent !important; /* èƒŒæ™¯é€æ˜ï¼Œä¸è¦ç°è‰²åº• */
    font-size: 22px !important;
    font-weight: 300 !important;     /* ç¬¦å·ç»†ä¸€ç‚¹å¥½çœ‹ */
    line-height: 1 !important;
    cursor: pointer;
    
    /* å±…ä¸­å¯¹é½ */
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    
    padding: 0 !important;           /* å»æ‰å¤šä½™å†…è¾¹è· */
    margin-right: 5px !important;    /* è·Ÿè¾“å…¥æ¡†ä¿æŒç‚¹è·ç¦» */
    flex-shrink: 0 !important;
}

/* æŒ‰ä¸‹å»çš„æ•ˆæœ */
.plus-btn:active {
    opacity: 0.6;
    transform: scale(0.95);
}
/* ================= ğŸ® æœå†»Qå¼¹ç‰¹æ•ˆ ================= */

/* å®šä¹‰æœå†»åŠ¨ç”»çš„å…³é”®å¸§ */
@keyframes jelly-jump {
    0%   { transform: scale(1, 1); }
    30%  { transform: scale(1.25, 0.75); } /* å‹æ‰ï¼šå˜å®½å˜çŸ® */
    40%  { transform: scale(0.75, 1.25); } /* æ‹‰é•¿ï¼šå˜çª„å˜é«˜ */
    50%  { transform: scale(1.15, 0.85); } /* å›å¼¹ */
    65%  { transform: scale(0.95, 1.05); } /* å¾®è°ƒ */
    75%  { transform: scale(1.05, 0.95); }
    100% { transform: scale(1, 1); }       /* æ¢å¤åŸçŠ¶ */
}

/* æ¿€æ´»æ—¶ï¼Œåªè®©é‡Œé¢çš„å›¾æ ‡(span)è·³åŠ¨ï¼Œæ–‡å­—ä¸è¦åŠ¨ï¼Œä¸ç„¶çœ¼æ™• */
.tab-btn.jelly-active span {
    animation: jelly-jump 0.5s ease; /* 0.5ç§’è·³å®Œ */
    display: inline-block; /* å¿…é¡»åŠ è¿™ä¸ªï¼Œä¸ç„¶ transform ä¸ç”Ÿæ•ˆ */
}
/* ---  åŒé¢‘ (Tongpin) é¡µé¢æ ·å¼ --- */

/* 1. é¡¶éƒ¨ä¸ªäººä¿¡æ¯æ¡ */
.tp-header-bar {
    padding: 10px 20px;
    background: #fff;
    display: flex;
    align-items: center;
    gap: 10px;
    /* ç¨å¾®ç»™ç‚¹é˜´å½±åŒºåˆ† */
    box-shadow: 0 1px 0 rgba(0,0,0,0.03); 
}
.tp-my-avatar {
    width: 36px; height: 36px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid #f0f0f0;
}
.tp-my-name {
    font-size: 16px;
    font-weight: bold;
    color: #333;
}
.tp-decoration {
    font-size: 18px;
}

/* 2. åˆ†ç±»å¯¼èˆªæ  (å¸¦åˆ·æ–°) */
.tp-nav-container {
    background: #fff;
    padding: 10px 0 10px 15px;
    display: flex;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 10;
}
.tp-scroll-tabs {
    flex: 1;
    display: flex;
    gap: 20px;
    overflow-x: auto;
    white-space: nowrap;
    /* éšè—æ»šåŠ¨æ¡ */
    scrollbar-width: none; 
    -ms-overflow-style: none;
    padding-right: 10px;
}
.tp-scroll-tabs::-webkit-scrollbar { display: none; }

.tp-tab-item {
    font-size: 15px;
    color: #666;
    font-weight: 500;
    cursor: pointer;
    position: relative;
    padding-bottom: 6px;
    transition: 0.2s;
}
/* é€‰ä¸­çŠ¶æ€ï¼šå­—ä½“å˜å¤§å˜é»‘ï¼Œä¸‹é¢åŠ æ¨ªçº¿ */
.tp-tab-item.active {
    color: #333;
    font-size: 17px;
    font-weight: 800;
}
.tp-tab-item.active::after {
    content: '';
    position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
    width: 16px; height: 3px;
    background: #FF5C5C; /* æˆªå›¾é‡Œçš„ç²‰çº¢è‰² */
    border-radius: 2px;
}

/* åˆ·æ–°æŒ‰é’® */
.tp-refresh-btn {
    padding: 0 15px;
    font-size: 18px;
    color: #999;
    border-left: 1px solid #f0f0f0;
    background: #fff;
    cursor: pointer;
}
.tp-refresh-btn:active { transform: rotate(180deg); transition: 0.3s; }

/* 3. å°ç»„å¡ç‰‡åˆ—è¡¨ */
.tp-feed-list {
    padding: 10px;
    background: #f7f7f7; /* æµ…ç°åº•è‰² */
}

/* å¡ç‰‡æœ¬ä½“ */
.tp-card {
    background: #fff;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.03);
}

/* å¡ç‰‡å¤´éƒ¨ï¼šå°ç»„å + åŠ å…¥æŒ‰é’® */
.tp-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.tp-group-info {
    display: flex;
    align-items: center;
    gap: 8px;
}
.tp-group-icon {
    width: 32px; height: 32px;
    border-radius: 8px;
    object-fit: cover;
    background: #eee;
}
.tp-group-text h4 { margin: 0; font-size: 14px; font-weight: 600; color: #333; }
.tp-group-text p { margin: 0; font-size: 11px; color: #999; }

/* ä»¿æˆªå›¾çš„â€œåŠ å…¥â€æŒ‰é’® (ç²‰åº•çº¢å­—) */
.btn-join-group {
    background: #FFF0F0;
    color: #FF4D4F;
    border: none;
    padding: 5px 14px;
    border-radius: 14px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
}
.btn-join-group.joined {
    background: #f5f5f5;
    color: #ccc;
}

/* å›¾ç‰‡å±•ç¤ºåŒº */
.tp-card-imgs {
    display: flex;
    gap: 5px;
    border-radius: 8px;
    overflow: hidden;
}
.tp-img-lg {
    flex: 1;
    height: 140px;
    object-fit: cover;
    background: #eee;
    border-radius: 6px;
}
.tp-img-sm {
    width: 33%;
    height: 140px;
    object-fit: cover;
    background: #eee;
    border-radius: 6px;
}

/* å¡ç‰‡åº•éƒ¨æ–‡æ¡ˆ */
.tp-card-desc {
    font-size: 14px;
    color: #333;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.tp-card-footer {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
    color: #999;
    margin-top: 5px;
}
/* --- AI åŠ è½½åŠ¨ç”»æ ·å¼ --- */
.tp-loading-box {
    text-align: center;
    padding: 40px 20px;
    color: #999;
}
.tp-loading-icon {
    font-size: 32px;
    display: inline-block;
    margin-bottom: 10px;
    animation: tp-spin 1s infinite linear;
}
@keyframes tp-spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
/* --- ğŸ“¡ å°ç»„è¯¦æƒ…é¡µæ ·å¼ (ä»¿æˆªå›¾) --- */

/* é¡¶éƒ¨å°ç»„ä¿¡æ¯æ  */
.tp-group-header-bar {
    background: #fff;
    padding: 15px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid #f5f5f5;
    position: sticky; top: 0; z-index: 10;
}
.tp-gh-avatar {
    width: 48px; height: 48px;
    border-radius: 10px;
    object-fit: cover;
    border: 1px solid #eee;
}
.tp-gh-info h3 { margin: 0; font-size: 17px; font-weight: bold; color: #333; }
.tp-gh-info p { margin: 2px 0 0; font-size: 12px; color: #999; }
.tp-btn-join-sm {
    margin-left: auto; /* é å³ */
    background: #2D68FF; /* æˆªå›¾é‡Œçš„è“è‰²æŒ‰é’® */
    color: white;
    border: none;
    padding: 6px 18px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
}

/* å¸–å­å¡ç‰‡ */
.tp-post-card {
    background: #fff;
    padding: 15px;
    margin-bottom: 8px; /* å¸–å­ä¹‹é—´çš„é—´éš” */
}

/* å‘å¸–äººä¿¡æ¯ */
.tp-poster-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}
.tp-poster-avatar {
    width: 36px; height: 36px;
    border-radius: 50%;
    object-fit: cover;
    background: #eee;
}
.tp-poster-name { font-size: 15px; font-weight: 600; color: #333; }
.tp-post-time { font-size: 12px; color: #ccc; margin-left: auto; }

/* å¸–å­å†…å®¹é¢„è§ˆ */
.tp-post-content {
    font-size: 15px;
    color: #333;
    line-height: 1.6;
    margin-bottom: 12px;
    /* é™åˆ¶æ˜¾ç¤ºè¡Œæ•°ï¼Œç±»ä¼¼é¢„è§ˆ */
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* æ•°æ®æ  (ç‚¹èµ è¯„è®º è½¬å‘) */
.tp-post-stats {
    display: flex;
    gap: 25px;
    margin-bottom: 12px;
}
.tp-stat-item {
    display: flex; align-items: center; gap: 5px;
    font-size: 14px; color: #666;
}

/* ç°è‰²ç¥è¯„è®ºæ¡† (ä»¿æˆªå›¾æ ¸å¿ƒ) */
.tp-comment-preview-box {
    background: #F7F7F7;
    border-radius: 8px;
    padding: 10px;
    font-size: 13px;
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.tp-cmt-row {
    line-height: 1.4;
    color: #555;
}
.tp-cmt-user {
    font-weight: bold;
    color: #333;
    margin-right: 4px;
}
.tp-cmt-more {
    font-size: 12px;
    color: #2D68FF;
    margin-top: 4px;
    font-weight: 500;
}

/* --- ğŸ“ å¸–å­è¯¦æƒ…é¡µ (è¯„è®ºåˆ—è¡¨) --- */
.tp-detail-content {
    padding: 20px;
    background: #fff;
    font-size: 16px;
    line-height: 1.7;
    border-bottom: 8px solid #f5f5f5;
}
.tp-comment-list {
    background: #fff;
    padding: 0 15px;
}
.tp-full-cmt-item {
    padding: 15px 0;
    border-bottom: 1px solid #f9f9f9;
    display: flex;
    gap: 10px;
}
.tp-cmt-avatar-lg {
    width: 36px; height: 36px;
    border-radius: 50%;
    background: #eee;
}
/* --- ğŸ”´ çº¢ç‚¹é€šçŸ¥æ ·å¼ --- */
.red-badge {
    position: absolute;
    top: -5px;
    right: -8px;
    min-width: 16px;
    height: 16px;
    background: #ff3b30;
    color: white;
    border-radius: 8px;
    font-size: 10px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
    z-index: 100;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    display: none; /* é»˜è®¤éšè—ï¼Œæœ‰æ•°å­—æ—¶é€šè¿‡JSæ˜¾ç¤º */
}
/* ç‰¹æ®Šä½ç½®å¾®è°ƒ */
.nav-btn .red-badge { top: 5px; right: 5px; } /* èŠå¤©é¡µè¿”å›æŒ‰é’®æ— */
.tab-btn .red-badge { top: 2px; right: 20%; } /* åº•éƒ¨å¯¼èˆªæ  */
.space-item .red-badge { position: relative; top: auto; right: auto; margin-left: auto; margin-right: 10px; } /* ç©ºé—´åˆ—è¡¨é‡Œ */

/* --- åº•éƒ¨åŠŸèƒ½é¢æ¿æ ·å¼ (ä»¿å¾®ä¿¡/QQ) --- */
.chat-tool-panel {
    height: 0;             /* é»˜è®¤é«˜åº¦ä¸º0ï¼Œéšè— */
    overflow: hidden;      /* å†…å®¹è¶…å‡ºéšè— */ /* ä¸æ»‘çš„å‡èµ·åŠ¨ç”» */
    background: #f7f7f7;   /* é¢æ¿èƒŒæ™¯è‰² */
}

/* æ¿€æ´»çŠ¶æ€ï¼šç»™ä¸€ä¸ªå›ºå®šé«˜åº¦ */
.chat-tool-panel.show {
    height: 260px;         /* é¢æ¿é«˜åº¦ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´ */
    border-top: 1px solid #e5e5e5;
}

/* ç½‘æ ¼å¸ƒå±€ï¼šä¸€è¡Œ4ä¸ª */
.tool-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* 4åˆ— */
    gap: 20px 15px;        /* é—´è· */
    padding: 25px 20px;    /* å†…è¾¹è· */
}

/* å•ä¸ªå›¾æ ‡æŒ‰é’® */
.tool-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

/* å›¾æ ‡çš„ç™½è‰²æ–¹å—èƒŒæ™¯ */
.tool-icon-box {
    width: 60px;
    height: 60px;
    background: #fff !important; /* å¼ºåˆ¶ç™½è‰²èƒŒæ™¯ */
    border-radius: 16px;         /* å¤§åœ†è§’ */
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.03); /* å¾®å¾®çš„é˜´å½± */
    transition: 0.1s;
}

.tool-item:active .tool-icon-box {
    background: #e0e0e0 !important; /* æŒ‰ä¸‹å˜ç° */
    transform: scale(0.95);
}

.tool-name {
    font-size: 12px;
    color: #666;
}
/* --- ğŸ˜œ è¡¨æƒ…åŒ…ç³»ç»Ÿæ ·å¼ --- */
.sticker-grid-display {
    display: grid; 
    grid-template-columns: repeat(4, 1fr); 
    gap: 10px; 
    padding: 10px;
}
.sticker-item-view {
    display: flex; flex-direction: column; align-items: center;
    background: #f9f9f9; border-radius: 8px; padding: 5px;
}
.sticker-img-view {
    width: 60px; height: 60px; object-fit: contain;
}
.sticker-id-text {
    font-size: 10px; color: #999; margin-top: 4px; 
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; text-align: center;
}
/* èŠå¤©é¢æ¿é‡Œçš„è¡¨æƒ… */
.chat-sticker-img {
    width: 70px; height: 70px; object-fit: contain; 
    background: #fff; border-radius: 8px; 
    cursor: pointer;
}
.chat-sticker-img:active { transform: scale(0.9); }
/* ================= ğŸ”˜ åˆ—è¡¨æŒ‰å‹é«˜äº®è¡¥ä¸ (è¶…æ·¡é›…ç‰ˆ) ================= */

/* 1. è¦†ç›–æ‰€æœ‰åˆ—è¡¨é¡¹ï¼Œè®¾ç½®æ¾æ‰‹æ—¶çš„è¤ªè‰²åŠ¨ç”» */
.list-item, 
.space-item, 
.menu-group .list-item,
.wallet-menu-item,
.bill-item,
.action-item {
    transition: background-color 0.3s ease-out;
}

/* 2. æŒ‰ä¸‹å»çš„çŠ¶æ€ (Active) */
.list-item:active, 
.space-item:active, 
.menu-group .list-item:active,
.wallet-menu-item:active,
.bill-item:active,
.action-item:active {
    /* å˜æˆéå¸¸æµ…çš„ç°ç™½è‰² */
    background-color: #f2f2f2 !important; 
    
    /* ç«‹å³å˜è‰²ï¼Œä¸è¦åŠ¨ç”» */
    transition: none !important; 
}
/* ================= ğŸ“ åˆ—è¡¨ç˜¦èº«è¡¥ä¸ (å˜çª„å˜ç²¾è‡´) ================= */

/* 1. æ¶ˆæ¯åˆ—è¡¨ & é€šç”¨åˆ—è¡¨é¡¹ï¼šä¸Šä¸‹å˜çª„ */
.list-item {
    /* åŸæ¥æ˜¯ 12pxï¼Œæ”¹æˆ 8pxï¼Œå·¦å³ä¿æŒ 12px */
    padding: 8px 12px !important; 
    
    /* é…åˆå¤´åƒå¤§å°(44px)ï¼Œè¿™æ ·æ€»é«˜åº¦å¤§æ¦‚åœ¨ 60px å·¦å³ï¼Œå¾ˆç§€æ°” */
    min-height: 60px; 
}

/* 2. ç©ºé—´é¡µé¢çš„åˆ—è¡¨é¡¹ï¼šå¤§å¹…å˜çª„ */
.space-item {
    /* åŸæ¥æ˜¯ 16pxï¼Œæ”¹æˆ 10pxï¼Œå·¦å³ç¨å¾®åŠ å®½åˆ° 10px æ›´å¥½çœ‹ */
    padding: 10px 10px !important; 
    
    /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è·å¾®è°ƒï¼Œé˜²æ­¢æŒ¤åœ¨ä¸€èµ· */
    gap: 10px; 
}

/* 3. å¦‚æœè§‰å¾—åˆ—è¡¨ä¹‹é—´çš„ç©ºéš™å¤ªå¤§ï¼Œå¯ä»¥é¡ºä¾¿æŠŠä¸‹è¾¹è·ä¹Ÿæ”¶ä¸€ç‚¹ (å¯é€‰) */
.list-item {
    margin-bottom: 5px !important; /* åŸæ¥æ˜¯ 12px */
}
/* ================= ğŸ“ åˆ—è¡¨é—´è·å‹ç¼©è¡¥ä¸ (å¡ç‰‡é å¾—æ›´è¿‘) ================= */

/* 1. æ¶ˆæ¯åˆ—è¡¨ï¼šæŠŠå¡ç‰‡ä¹‹é—´çš„ç¼éš™ç¼©å° */
.list-item {
    /* åŸæ¥æ˜¯ 12pxï¼Œæ”¹æˆ 4pxï¼Œè¿™æ ·å¡ç‰‡ä¹‹é—´å°±è´´å¾—å¾ˆè¿‘äº† */
    margin-bottom: 4px !important;
    
    /* é¡ºä¾¿æŠŠå¡ç‰‡å†…éƒ¨çš„é«˜åº¦ä¹Ÿå‹æ‰ä¸€ç‚¹ç‚¹ï¼Œè¿™æ ·æ•´ä½“çœ‹èµ·æ¥æ›´ç´§å‡‘ */
    padding: 10px 12px !important;
}

/* 2. ç©ºé—´åˆ—è¡¨ï¼šæŠŠæ¯ä¸€è¡Œçš„é«˜åº¦å‹æ‰ */
.space-item {
    /* åŸæ¥æ˜¯ 16pxï¼Œæ”¹æˆ 10pxï¼Œè¿™æ ·è¿™ä¸€è¡Œå’Œä¸‹ä¸€è¡Œçš„è·ç¦»å°±è¿‘äº† */
    padding: 10px 5px !important;
}
/* æ·»åŠ åˆ° CSS æ–‡ä»¶æœ€åæ¥è¦†ç›–ç°æœ‰æ ·å¼ */
.list-item {
    padding: 8px 12px !important;
    margin-bottom: 8px !important;
    min-height: 50px;
}

.list-item .avatar {
    width: 36px !important;
    height: 36px !important;
}

.item-text h3 {
    font-size: 15px !important;
    margin: 0 0 2px 0 !important;
}

.item-text p {
    font-size: 12px !important;
}
/* ================= ğŸ¨ å…¨å±€å­—ä½“æ§åˆ¶ç³»ç»Ÿ (V2.0 å…¨é¢è¦†ç›–ç‰ˆ) ================= */

:root {
    --app-global-size: 15px; /* é»˜è®¤åŸºå‡†å¤§å° */
}

/* 1. ã€æ­£æ–‡çº§ã€‘åº”ç”¨æ ‡å‡†å¤§å° */
body, 
.view, 
.scroll-content,
.nav-title,
.list-item, 
.item-text h3, 
.item-text p,
.btn-block, 
.mini-btn,
.form-row label, 
.form-row input, 
.form-row textarea,
/* æœ‹å‹åœˆæ ¸å¿ƒ */
.moment-content, 
.comment-content,
.forward-box,
/* åŒé¢‘æ ¸å¿ƒ */
.tp-post-content,
.tp-tab-item,
/* é’±åŒ… */
.wallet-label,
/* ç©ºé—´åˆ—è¡¨ */
.space-text {
    font-size: var(--app-global-size) !important;
}

/* 2. ã€å°å­—çº§ã€‘æ¯”æ ‡å‡†å° 2px (é¦–é¡µå›¾æ ‡ã€æ—¶é—´ã€çŠ¶æ€æ ) */
.app-name,          /* é¦–é¡µå›¾æ ‡æ–‡å­— */
.status-bar,        /* é¡¶æ æ—¶é—´ç”µé‡ */
.moment-time,       /* åŠ¨æ€æ—¶é—´ */
.like-stat,         /* ç‚¹èµäººæ•° */
.comment-user,      /* è¯„è®ºäººå */
.tp-post-time,      /* å¸–å­æ—¶é—´ */
.tp-cmt-user,       /* å¸–å­è¯„è®ºäºº */
.bill-time,         /* è´¦å•æ—¶é—´ */
.pay-tips,          /* æ”¯ä»˜æç¤º */
.zone-visitors,     /* è®¿å®¢æ•° */
.sticker-id-text,   /* è¡¨æƒ…åŒ…ID */
.reading-status {   /* æ­£åœ¨é˜…è¯»çŠ¶æ€ */
    font-size: calc(var(--app-global-size) - 2px) !important;
}

/* 3. ã€å¤§å­—çº§ã€‘æ¯”æ ‡å‡†å¤§ 2px (åå­—ã€æ ‡é¢˜) */
.moment-name,       /* åŠ¨æ€å‘å¸ƒè€…åå­— */
.zone-username,     /* ç©ºé—´å¤§å */
.tp-poster-name,    /* å¸–å­å‘å¸ƒè€… */
.vip-info h3 {
    font-size: calc(var(--app-global-size) + 2px) !important;
}

/* 4. ã€è¶…å¤§å­—ã€‘ä½™é¢ã€æ¨ªå¹… */
.vip-banner,
.wallet-num,
.level-num {
    font-size: calc(var(--app-global-size) + 10px) !important;
}

/* 5. âœ¨ æ ¸å¿ƒï¼šä¿æŠ¤èŠå¤©æ°”æ³¡ä¸è¢«æ³¢åŠ */
.msg-bubble {
    font-size: calc(var(--chat-font-size) * var(--chat-scale)) !important;
}

/* 6. ä¿æŠ¤å›¾æ ‡å¤§å° (é˜²æ­¢å›¾æ ‡å˜å¤§å˜æ¨¡ç³Š) */
.icon-box, 
.tab-btn span,
.toolbar-icon,
.space-icon,
.zone-nav-icon {
    font-size: 24px !important; 
}
/* å¼ºåˆ¶é¦–é¡µé»˜è®¤å¯è§ï¼Œé˜²æ­¢ JS æŒ‚æ‰åé»‘å± */
/* --- ğŸ“· æ„å¿µç…§ç‰‡/æ¨¡æ‹Ÿæ‹ç…§æ ·å¼ --- */
/* --- ğŸ“· æ„å¿µç…§ç‰‡/æ¨¡æ‹Ÿæ‹ç…§æ ·å¼ --- */
        /* --- ğŸ“· æ„å¿µç…§ç‰‡/æ¨¡æ‹Ÿæ‹ç…§æ ·å¼ --- */
        .sim-photo-frame {
            width: 150px;           /* ä¿æŒå˜çª„ */
            min-height: 120px;
            
            background: #fff;       /* âœ¨ ä¿®æ”¹ç‚¹ï¼šèƒŒæ™¯æ”¹æˆçº¯ç™½ */
            
            border: 1px solid #f0f0f0; /* âœ¨ å¾®è°ƒï¼šå› ä¸ºèƒŒæ™¯ç™½äº†ï¼ŒåŠ ä¸ªææ·¡çš„è¾¹æ¡†é˜²æ­¢å’ŒèŠå¤©èƒŒæ™¯æ··åœ¨ä¸€èµ· */
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            margin-top: 0 !important; /* ä¿æŒé¡¶éƒ¨å¯¹é½ */
        }

        /* è¦†ç›–æ°”æ³¡é»˜è®¤æ ·å¼ */
        

/* ä¸­é—´çš„å›¾æ ‡ */
.sim-photo-icon {
    font-size: 32px;
    color: #999;
    margin-bottom: 8px;
}

/* æ–‡å­—æè¿° */
.sim-photo-text {
    font-size: 13px;
    color: #555;
    font-weight: 500;
    line-height: 1.4;
    font-style: italic; /* æ–œä½“æ›´æœ‰æè¿°æ„Ÿ */
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

        /* è¦†ç›–æ°”æ³¡é»˜è®¤æ ·å¼ */
        .msg-bubble.is-sim-photo {
            background: transparent !important;
            padding: 0 !important;
            box-shadow: none !important;
            border: none !important;
            
            /* âœ¨ ä¿®æ”¹ç‚¹3ï¼šæ¶ˆé™¤è¡Œé«˜å¸¦æ¥çš„éšå½¢é—´éš™ï¼Œç¡®ä¿ç»å¯¹é¡¶å¯¹é½ */
            line-height: 0 !important; 
            font-size: 0 !important;
        }
        
        /* ================= ğŸ™ï¸ è¯­éŸ³å½•åˆ¶ç•Œé¢æ ·å¼ ================= */
.voice-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); /* æ·±è‰²é®ç½© */
    z-index: 5000;
    display: none;
    flex-direction: column;
    justify-content: flex-end;
    align-items: center;
    backdrop-filter: blur(5px);
    user-select: none;
}
.voice-overlay.show { display: flex; }

/* ä¸­é—´æ˜¾ç¤ºåŒº */
.voice-center-display {
    position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
    display: flex; flex-direction: column; align-items: center; gap: 15px;
    width: 80%; pointer-events: none; /* è®©è§¦æ‘¸ç©¿é€ */
}

/* ç»¿è‰²æ³¢å½¢æ°”æ³¡ */
.voice-wave-box {
    background: #59f059; /* é²œç»¿è‰² */
    width: 140px; height: 80px;
    border-radius: 16px;
    display: flex; justify-content: center; align-items: center; gap: 5px;
    box-shadow: 0 0 20px rgba(89, 240, 89, 0.4);
    opacity: 0; transform: scale(0.8); transition: 0.2s;
}
.voice-wave-box.recording { opacity: 1; transform: scale(1); }

/* æ³¢çº¹åŠ¨ç”»æ¡ */
.wave-bar {
    width: 6px; height: 20px; background: #224a22; border-radius: 3px;
    animation: waveJump 0.5s infinite ease-in-out alternate;
}
.wave-bar:nth-child(1) { animation-delay: 0s; }
.wave-bar:nth-child(2) { animation-delay: 0.1s; }
.wave-bar:nth-child(3) { animation-delay: 0.2s; }
.wave-bar:nth-child(4) { animation-delay: 0.1s; }
.wave-bar:nth-child(5) { animation-delay: 0s; }
@keyframes waveJump { 0% { height: 15px; } 100% { height: 45px; } }

/* çŠ¶æ€æ–‡å­— */
.voice-status-text { color: #fff; font-size: 16px; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
.voice-realtime-text { color: #ccc; font-size: 14px; text-align: center; min-height: 20px; margin-top: 5px;}

/* åº•éƒ¨æ§åˆ¶åŒº */
.voice-controls-area {
    width: 100%; height: 250px;
    position: relative;
    display: flex; justify-content: center;
}

/* åº•éƒ¨åŠåœ†æŒ‰é”® */
.voice-record-arc {
    width: 100%; height: 200px;
    background: #333;
    position: absolute; bottom: -80px; left: 0;
    border-radius: 50% 50% 0 0; /* åŠåœ† */
    display: flex; justify-content: center; align-items: flex-start;
    padding-top: 30px;
    box-shadow: 0 -5px 15px rgba(0,0,0,0.3);
    cursor: pointer; transition: 0.2s;
}
.voice-record-arc:active, .voice-record-arc.active { background: #444; transform: scale(1.02); }
.voice-mic-icon { font-size: 40px; color: #fff; pointer-events: none; }

/* ä¸¤ä¾§åŠŸèƒ½æŒ‰é’® */
.voice-action-btn {
    position: absolute; bottom: 80px;
    display: flex; flex-direction: column; align-items: center; gap: 8px;
    transition: 0.3s; opacity: 0.6;
}
.voice-action-btn.hover { opacity: 1; transform: scale(1.2); }
#btn-voice-cancel { left: 50px; }
#btn-voice-trans { right: 50px; }

.v-btn-icon {
    width: 60px; height: 60px;
    border-radius: 50%; background: rgba(255,255,255,0.2);
    display: flex; justify-content: center; align-items: center;
    color: #fff; font-size: 24px; font-weight: bold;
}
.v-btn-label { color: #fff; font-size: 14px; }

/* ================= ğŸ’¬ èŠå¤©æ°”æ³¡ï¼šè¯­éŸ³æ¶ˆæ¯ ================= */
.msg-bubble.is-voice {
    display: flex; flex-direction: column; gap: 4px;
    min-width: 100px; cursor: pointer;
}
.voice-content-row {
    display: flex; align-items: center; gap: 8px;
}
.voice-icon { font-size: 18px; }
.voice-duration { font-size: 14px; font-weight: 500; }
.voice-to-text-btn {
    font-size: 10px; color: rgba(0,0,0,0.4); 
    background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px;
    margin-left: auto;
}
.voice-trans-result {
    font-size: 13px; color: #333;
    background: #fff; padding: 8px; border-radius: 6px;
    margin-top: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    display: none; /* é»˜è®¤éšè— */
    position: relative;
}
/* å°ä¸‰è§’ç®­å¤´ */
.voice-trans-result::before {
    content: ''; position: absolute; top: -5px; left: 15px;
    border-width: 0 5px 5px 5px; border-style: solid;
    border-color: transparent transparent #fff transparent;
}
    </style>
</head>
<body>

<div class="phone-case">
    <div class="status-bar">
        <span id="status-time">12:00</span>
        <div style="display:flex; gap:5px; align-items:center;">
            <span style="font-size:12px">5G</span>
            <span id="status-battery">100%</span>
            <span style="font-size:16px">ğŸ¬</span>
        </div>
    </div>
    <!-- ğŸ’° é¡µé¢1ï¼šæˆ‘çš„é’±åŒ… (ç™½åº•ç‰ˆ) -->
<div class="view" id="view-wallet">
    <!-- 1. æ¢å¤é»˜è®¤æ ·å¼çš„å¯¼èˆªæ  -->
    <div class="nav-bar">
        <button class="nav-btn" onclick="navTo('view-chat-app')">â® è¿”å›</button>
        <span class="nav-title">é’±åŒ…</span>
        <div style="width:40px"></div>
    </div>
    
    <!-- 2. å†…å®¹åŒºåŸŸ -->
    <div class="scroll-content" style="padding:0; background:#f5f5f5;">
        
        <!-- é¡¶éƒ¨ä½™é¢å±•ç¤º (æ ·å¼å·²æ”¹ä¸ºç™½åº•) -->
        <div class="wallet-card">
            <div class="wallet-icon">ğŸ’°</div>
            <div class="wallet-label">æˆ‘çš„ä½™é¢</div>
            <div class="wallet-num" id="my-wallet-balance">100.00</div>
        </div>

        <!-- èœå• -->
        <div class="wallet-menu">
            <div class="wallet-menu-item" onclick="openWalletHistory()">
                <span>ğŸ“„ é›¶é’±æ˜ç»†</span>
                <span style="color:#ccc;">â¯</span>
            </div>
        </div>
    </div>
</div>

<!-- ğŸ“œ é¡µé¢2ï¼šé›¶é’±æ˜ç»† -->
<div class="view" id="view-wallet-history">
    <div class="nav-bar">
        <button class="nav-btn" onclick="navTo('view-wallet')">â® è¿”å›</button>
        <span class="nav-title">é›¶é’±æ˜ç»†</span>
        <div style="width:40px"></div>
    </div>
    <div class="scroll-content" id="wallet-history-list" style="padding:0; background:#fff;">
        <!-- JS ä¼šåœ¨è¿™é‡Œæ’å…¥æ˜ç»† -->
    </div>
</div>
<!-- â­ é¡µé¢ï¼šæˆ‘çš„ç­‰çº§ -->
<div class="view" id="view-level">
    <div class="nav-bar">
        <button class="nav-btn" onclick="navBackToMe()">â® è¿”å›</button>
        <span class="nav-title">æˆ‘çš„ç­‰çº§</span>
        <div style="width:40px"></div>
    </div>
    <div class="scroll-content" style="padding:0; background:#fff;">
        
        <!-- ä»¿æˆªå›¾çš„å¡ç‰‡ -->
        <div class="level-card">
            <div class="level-user-info">
                <img src="" id="level-user-avatar" class="level-avatar">
                <div class="level-text-box">
                    <div class="level-name" id="level-user-name">æˆ‘</div>
                    <!-- è¾¾äººå›¾æ ‡ -->
                    <div id="talent-icon" class="talent-badge">
                        <span>ğŸ¥‡</span> <span>ç©ºé—´è¾¾äºº</span>
                    </div>
                </div>
            </div>
            
            <div class="level-display">
                <div class="level-star-img">ğŸŒŸ</div>
                <div class="level-num" id="level-num-display">1</div>
            </div>
        </div>

        <!-- è£…é¥°æ€§æ–‡å­— -->
        <div style="padding:0 20px; font-size:12px; color:#999; margin-bottom:30px;">
            <p>è·ç¦»ä¸‹æ¬¡å‡çº§è¿˜éœ€ç­¾åˆ° 1 å¤©</p>
            <div style="width:100%; height:4px; background:#f0f0f0; border-radius:2px; margin-top:5px;">
                <div style="width:60%; height:100%; background:#8EC5FC; border-radius:2px;"></div>
            </div>
        </div>

        <!-- ç­¾åˆ°æŒ‰é’® -->
        <button id="btn-sign-in" class="sign-in-btn" onclick="doSignIn()">âœ¨ ç«‹å³ç­¾åˆ° (+1çº§)</button>

        <div style="text-align:center; font-size:12px; color:#ccc; margin-top:20px;">
            è¿ç»­ç™»å½•ä¿æŒè¾¾äººå›¾æ ‡ç‚¹äº®å“¦~
        </div>
    </div>
</div>
<!-- ğŸ“‚ æ–°å¢é¡µé¢ï¼šäººè®¾ç®¡ç†åˆ—è¡¨ -->
<div class="view" id="view-persona-list">
    <div class="nav-bar">
        <button class="nav-btn" onclick="navBackToMe()">â® è¿”å›</button>
        <span class="nav-title">æˆ‘çš„äººè®¾</span>
        <!--æŠŠæ·»åŠ æŒ‰é’®æ”¾åˆ°å³ä¸Šè§’äº† -->
        <button class="nav-btn" onclick="openUserPersonaModal()">â•</button>
    </div>
    <div class="scroll-content">
        <div style="font-size:12px; color:#999; padding:10px 15px;">ç‚¹å‡»åˆ—è¡¨å¯ç¼–è¾‘ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ æ–°èº«ä»½</div>
        <!-- åˆ—è¡¨å®¹å™¨ ID ç§»åŠ¨åˆ°äº†è¿™é‡Œ -->
        <div id="list-user-personas"></div>
    </div>
</div>

    <div class="screen">

        <!-- 1. é¦–é¡µ -->
        <div class="view home active" id="view-home">
            <div class="home-grid">
                <div class="app-icon" onclick="navTo('view-api')">
                    <div class="icon-box" style="background:#007AFF">âš™ï¸</div>
                    <span class="app-name">APIè®¾ç½®</span>
                </div>
                <div class="app-icon" onclick="navTo('view-instruction')">
                    <div class="icon-box" style="background:#FF9500">ğŸ“œ</div>
                    <span class="app-name">æŒ‡ä»¤</span>
                </div>
                <div class="app-icon" onclick="navTo('view-chat-app')">
                    <div class="icon-box" style="background:#07C160">ğŸ’¬</div>
                    <span class="app-name">èŠå¤©</span>
                </div>
                <div class="app-icon" onclick="navTo('view-beautify'); renderSavedFonts();"> <div class="icon-box" style="background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%); font-size:28px;">ğŸ¨</div> <span class="app-name">ç¾åŒ–</span> </div>
            </div>
        </div>

       <!-- 2. API è®¾ç½® (é‡åˆ¶ç‰ˆ) -->
<div class="view" id="view-api">
    <div class="nav-bar">
        <button class="nav-btn" onclick="navBack()">â® è¿”å›</button>
        <span class="nav-title">API è¿æ¥è®¾ç½®</span>
        <div style="width:40px"></div>
    </div>
    <div class="scroll-content">
        <!-- é¡¶éƒ¨æç¤º -->
        <div style="background:#e8f4fd; color:#0d529d; font-size:12px; padding:10px; border-radius:8px; margin-bottom:15px; line-height:1.4;">
            ğŸ’¡ <b>æç¤ºï¼š</b><br>
            1. æ”¯æŒ OpenAI æ ¼å¼çš„ä¸­è½¬æ¥å£ã€‚<br>
            2. å¦‚æœæ‹‰å–å¤±è´¥ï¼Œ<b>è¯·ç›´æ¥åœ¨æ¨¡å‹æ¡†é‡Œæ‰‹åŠ¨è¾“å…¥</b> (å¦‚ gpt-4o, gemini-1.5-flash)ã€‚
        </div>

        <div class="form-group">
            <div class="form-row">
                <label>æ¥å£åœ°å€</label>
                <input type="text" id="api-url" placeholder="ä¾‹å¦‚ https://api.deepseek.com">
            </div>
            <div class="form-row">
                <label>API Key</label>
                <input type="password" id="api-key" placeholder="sk-...">
            </div>
        </div>

        <!-- ğŸ‘‡ é‡ç‚¹ä¿®æ”¹ï¼šæ¨¡å‹é€‰æ‹©åŒº ğŸ‘‡ -->
        <div class="form-group">
            <div style="padding:10px 0 5px; font-weight:500; font-size:15px;">æ¨¡å‹åç§°</div>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <!-- è¾“å…¥æ¡†ï¼šæ—¢èƒ½æ˜¾ç¤ºæ‹‰å–çš„ï¼Œä¹Ÿèƒ½æ‰‹åŠ¨æ”¹ -->
                <input type="text" id="api-model-input" placeholder="æ‰‹åŠ¨è¾“å…¥æˆ–ç‚¹å‡»å³ä¾§æ‹‰å–" 
                       style="flex:1; background:#f5f5f5; border:1px solid #ddd; padding:10px; border-radius:8px;">
                
                <!-- æ‹‰å–æŒ‰é’® -->
                <button onclick="smartFetchModels()" style="background:#007AFF; color:#fff; border:none; border-radius:8px; padding:0 15px; font-size:13px; font-weight:600; white-space:nowrap;">
                     æ‹‰å–åˆ—è¡¨
                </button>
            </div>
            
            <!-- è¿™é‡Œç”¨æ¥æ˜¾ç¤ºæ‹‰å–åˆ°çš„åˆ—è¡¨ (é»˜è®¤éšè—) -->
            <div id="model-select-panel" style="display:none; background:#f9f9f9; border:1px solid #eee; border-radius:8px; max-height:200px; overflow-y:auto; margin-bottom:10px;">
                <!-- JS ä¼šå¾€è¿™é‡Œå¡åˆ—è¡¨ -->
            </div>
        </div>
        <!-- ğŸ‘† ä¿®æ”¹ç»“æŸ ğŸ‘† -->

        <button class="btn-block" onclick="saveApiConfig()">ğŸ’¾ ä¿å­˜å½“å‰é…ç½®</button>
        
        <div style="margin-top:30px; border-top:1px solid #eee; padding-top:15px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span style="font-size:16px; font-weight:600;">æˆ‘çš„é¢„è®¾</span>
                <button class="mini-btn" style="background:#5856d6;" onclick="saveApiPreset()">+ æ–°å»ºé¢„è®¾</button>
            </div>
            <div id="api-preset-list">
                <!-- é¢„è®¾åˆ—è¡¨ -->
            </div>
        </div>
    </div>
</div>

        <!-- 3. æŒ‡ä»¤ç®¡ç† -->
        <div class="view" id="view-instruction">
            <div class="nav-bar">
                <button class="nav-btn" onclick="navBack()">â® è¿”å›</button>
                <span class="nav-title">æŒ‡ä»¤ç®¡ç†</span>
                <button class="nav-btn" onclick="openModal('modal-instruction')">+</button>
            </div>
            <div class="scroll-content" id="list-instruction"></div>
        </div>

        <!-- 5. èŠå¤© APP -->
        <div class="view" id="view-chat-app" style="background:#fff;">
            <!-- æ¶ˆæ¯ Tab -->
            <div id="tab-view-msg" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
                <div class="nav-bar" style="background:#f9f9f9; border-bottom:none;">
                    <button class="nav-btn" onclick="navBack()">â†</button>
                    <span class="nav-title">æ¶ˆæ¯</span>
                    <button class="nav-btn" onclick="togglePopMenu()">+</button>
                </div>
                <div class="pop-menu" id="chat-pop-menu">
                    <div class="pop-item" onclick="openSelectChatModal()">å‘èµ·å¯¹è¯</div>
                    <div class="pop-item" onclick="openCreateGroupModal()">åˆ›å»ºç¾¤èŠ</div>
                </div>
                <div class="scroll-content" id="list-sessions" style="padding:0; background:#fff"></div>
            </div>
            <!-- è§’è‰² Tab -->
            <div id="tab-view-character" style="flex:1; display:none; flex-direction:column; overflow:hidden;">
               <div class="nav-bar">
        <!-- è¿™é‡Œæˆ‘ä¹Ÿå¸®ä½ æŠŠé€€å‡ºæ”¹æˆç®­å¤´äº† -->
                   <button class="nav-btn" onclick="navBack()">â†</button> 
                   <span class="nav-title">è§’è‰²ç®¡ç†</span>
                   <button class="nav-btn" onclick="openCharacterModal()">â•</button>
               </div>
    <!-- æ³¨æ„ï¼šè¿™é‡Œç”¨äº†åŸæ¥çš„ id="list-character"ï¼Œè¿™æ ·ä¹‹å‰çš„é€»è¾‘å°±èƒ½ç›´æ¥å¤ç”¨å•¦ -->
               <div class="scroll-content" id="list-character"></div>
           </div>
            <!-- æ‰¾åˆ°è¿™ä¸ª divï¼Œç”¨ä¸‹é¢çš„ä»£ç å®Œå…¨æ›¿æ¢å®ƒé‡Œé¢çš„å†…å®¹ -->
<div id="tab-view-circle" style="flex:1; display:none; flex-direction:column; overflow:hidden;">
    <div class="nav-bar">
        <button class="nav-btn" onclick="navBack()">â†</button>
        <span class="nav-title">ç©ºé—´</span> <!-- æˆ–è€…ä½ ä¹‹å‰æ”¹æˆçš„"å¹¿åœº" -->
        <div style="width:40px"></div>
    </div>
    
    <!-- ğŸ‘‡ è¿™é‡Œæ˜¯æ–°çš„å†…å®¹ ğŸ‘‡ -->
    <div class="scroll-content" style="background:#fff; padding: 15px;">
        
       <!-- 1. é¡¶éƒ¨çš„æœç´¢æ¡†ï¼ˆçœŸçš„èƒ½ç”¨äº†ï¼‰ -->
        <div class="real-search-bar">
            <input type="text" id="space-search-input" placeholder="æœç´¢èŠå¤©è®°å½•...">
            <div class="search-btn" onclick="searchChatHistory()">ğŸ”</div>
        </div>

        <!-- 2. åˆ—è¡¨åŒºåŸŸ -->
        <div class="space-list">
            <!-- å¥½å‹åŠ¨æ€ -->
            <div class="space-item" onclick="navTo('view-moments'); clearUnreadMoments();">
                <!-- è¿™é‡Œç”¨ä¸ªæ˜Ÿæ˜Ÿå›¾æ ‡æ¨¡æ‹Ÿæˆªå›¾é‡Œçš„äº”è§’æ˜Ÿ -->
                <div class="space-icon" style="color:#FF9500">â­</div> 
                <span class="space-text">å¥½å‹åŠ¨æ€</span>
                <span class="space-arrow">&gt;</span>
            </div>
            <div class="space-item" onclick="openTongpinPage()">
        <div class="space-icon" style="color:#FF5C5C">ğŸ¥</div> 
        <span class="space-text">åŒé¢‘</span>
        <span class="space-arrow">&gt;</span>
    </div>

            <!-- ä½ ä»¥åæƒ³åŠ åˆ«çš„åŠŸèƒ½ï¼Œå¤åˆ¶ä¸Šé¢è¿™ä¸€æ®µ space-item æ”¹ä¸ªåå­—å°±è¡Œ -->
        </div>
    </div>
</div>
            

<!-- æˆ‘çš„ Tab (æ— å›¾æ ‡çº¯æ–‡å­—ç‰ˆ) -->
<div id="tab-view-me" style="flex:1; display:none; flex-direction:column; overflow:hidden; background:#f5f5f5;">
    <div class="nav-bar" style="background:#fff;">
        <button class="nav-btn" onclick="navBack()">â†</button>
        <span class="nav-title">æˆ‘çš„</span>
        <div style="width:40px"></div>
    </div>
    
    <div class="scroll-content" style="padding: 20px;">
        
        <!-- æ ¸å¿ƒåŠŸèƒ½èœå•ç»„ -->
        <div class="menu-group">
            
            <!-- 1. äººè®¾ç®¡ç†å…¥å£ -->
            <div class="list-item" onclick="navTo('view-persona-list'); renderUserPersonas();">
                <div class="item-main">
                    <!-- å›¾æ ‡å·²åˆ é™¤ -->
                    <div class="item-text">
                        <h3 style="margin:0; font-weight:500;">æˆ‘çš„äººè®¾</h3>
                    </div>
                </div>
                <div style="color:#ccc;">â¯</div>
            </div>

            <!-- 2. é’±åŒ…å…¥å£ -->
            <div class="list-item" onclick="openWalletPage()">
                <div class="item-main">
                    <!-- å›¾æ ‡å·²åˆ é™¤ -->
                    <div class="item-text">
                        <h3 style="margin:0; font-weight:500;">æˆ‘çš„é’±åŒ…</h3>
                    </div>
                </div>
                <div style="color:#ccc;">â¯</div>
            </div>
            <div class="list-item" onclick="openLevelPage()">
                <div class="item-main">
                    <div class="item-text"><h3 style="margin:0; font-weight:500;">æˆ‘çš„ç­‰çº§</h3></div>
                </div>
                <div style="color:#ccc;">â¯</div>
            </div>
            <!-- ... ä¸Šé¢æ˜¯æˆ‘çš„ç­‰çº§ ... -->
            <div class="list-item" onclick="navTo('view-sticker-manager'); renderStickerPacks();">
    <div class="item-main">
        <div class="item-text"><h3 style="margin:0; font-weight:500;">è¡¨æƒ…åŒ…ç®¡ç†</h3></div>
    </div>
    <div style="color:#ccc;">â¯</div>
</div>

<!-- ğŸ‘‡ğŸ‘‡ğŸ‘‡ æ–°å¢ï¼šå¤‡ä»½ä¸æ¢å¤åŒºåŸŸ ğŸ‘‡ğŸ‘‡ğŸ‘‡ -->
<div style="height:10px; background:#f5f5f5; margin:0 -20px;"></div> <!-- åˆ†éš”æ¡ -->

<div class="list-item" onclick="doExportAll()">
    <div class="item-main">
        <div class="item-text"><h3 style="margin:0; font-weight:500;">ğŸ“¤ å¯¼å‡ºæ‰€æœ‰æ•°æ® (å¤‡ä»½)</h3></div>
    </div>
    <div style="color:#ccc;">â¯</div>
</div>

<div class="list-item" onclick="document.getElementById('import-file-input').click()">
    <div class="item-main">
        <div class="item-text"><h3 style="margin:0; font-weight:500; color:#007AFF;">ğŸ“¥ å¯¼å…¥æ•°æ® (æ¢å¤)</h3></div>
    </div>
    <div style="color:#ccc;">â¯</div>
</div>

<!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ æ§ä»¶ï¼Œç”¨äºå¯¼å…¥ -->
<input type="file" id="import-file-input" hidden accept=".json" onchange="handleImportFile(this)">
<!-- ğŸ‘†ğŸ‘†ğŸ‘† æ–°å¢ç»“æŸ ğŸ‘†ğŸ‘†ğŸ‘† -->

        </div>

    </div>
</div>
            <div class="chat-tabs">
                <div class="tab-btn active" onclick="switchChatTab('msg')"><span>ğŸ’¬</span>æ¶ˆæ¯</div>
                <div class="tab-btn" onclick="switchChatTab('character')"><span>ğŸ‘¥</span>è§’è‰²</div>
                <div class="tab-btn" onclick="switchChatTab('circle')" style="position:relative;">
    <span>â­•</span>ç©ºé—´ <span id="badge-tab-circle" class="red-badge">0</span>
</div>
                <div class="tab-btn" onclick="switchChatTab('me')"><span>ğŸ‘¤</span>æˆ‘çš„</div>
            </div>
        </div>
        <!-- ğŸ‘‘ è´µæ—/è´µæ—å¼€é€šé¡µé¢ -->
<div class="view" id="view-vip">
    <!-- é¡¶éƒ¨å¯¼èˆª (é€æ˜èƒŒæ™¯) -->
    <!-- é¡¶éƒ¨å¯¼èˆª (é€æ˜èƒŒæ™¯ï¼Œå¸¦è¿”å›é”®) -->
    <div class="nav-bar" style="background:transparent; border:none; position:absolute; top:0; width:100%; z-index:1001;">
        <!-- ğŸ”´ ä¿®æ”¹ç‚¹ï¼šonclick æ”¹æˆå›åˆ° view-moments -->
        <button class="nav-btn" style="color:#fff; text-shadow:0 1px 2px rgba(0,0,0,0.4); font-size:20px;" onclick="navTo('view-moments')">â®</button>
        
        <span class="nav-title" style="color:#fff; text-shadow:0 1px 2px rgba(0,0,0,0.4);">å¼€é€šè´µæ—</span>
        
        <!-- å³è¾¹å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­ -->
        <div style="width:40px"></div>
    </div>

    <div class="scroll-content" style="padding:0;">
        <!-- 1. é¡¶éƒ¨å¤§Banner -->
        <div class="vip-banner"></div>

        <!-- 2. ç”¨æˆ·ä¿¡æ¯ -->
        <div class="vip-user-card">
            <img src="" id="vip-user-avatar" class="vip-avatar">
            <div class="vip-info">
                <h3 id="vip-user-name">åŠ è½½ä¸­...</h3>
                <p id="vip-user-id">æ‚¨è¿˜æ²¡æœ‰å¼€é€šè¿‡è´µæ—</p>
            </div>
            <div class="vip-close" onclick="navTo('view-moments')">Ã—</div>
        </div>

        <!-- 3. ç‰¹æƒ Tab -->
        <div class="vip-tabs">
            <div class="vip-tab-item active">ğŸ’ è¶…çº§è´µæ—</div>
        </div>
        <div style="background:#fff; padding:10px 20px; font-size:12px; color:#888;">
            è´µæ—å°Šäº«åŠ¨æ€çº¢è‰²åç§°ã€ä¸“å±é“­ç‰Œç­‰ç‰¹æƒ <span style="float:right; color:#999;">æ›´å¤šç‰¹æƒ ></span>
        </div>

        <!-- 4. ä»·æ ¼é€‰æ‹© -->
        <div class="vip-price-grid">
            <!-- 1å¤© -->
            <div class="price-card active" onclick="selectVipPrice(1, 10, this)">
                <div class="price-month">1å¤©</div> <!-- ğŸ‘ˆ è¿™é‡Œæ”¹æˆå¤© -->
                <div class="price-num">10</div>
            </div>
            <!-- 3å¤© -->
            <div class="price-card" onclick="selectVipPrice(3, 30, this)">
                <div class="price-month">3å¤©</div> <!-- ğŸ‘ˆ è¿™é‡Œæ”¹æˆå¤© -->
                <div class="price-num">30</div>
            </div>
            <!-- 12å¤© -->
            <div class="price-card recommend" onclick="selectVipPrice(12, 118, this)">
                <div class="price-save">çœ2å…ƒ</div>
                <div class="price-month">12å¤©</div> <!-- ğŸ‘ˆ è¿™é‡Œæ”¹æˆå¤© -->
                <div class="price-num">118</div>
            </div>
        </div>
        
        <!-- å ä½é«˜åº¦ï¼Œé˜²æ­¢åº•éƒ¨é®æŒ¡ -->
        <div style="height:150px;"></div>
    </div>

    <!-- 5. åº•éƒ¨å›ºå®šæ”¯ä»˜æ  -->
    <div class="vip-footer">
        <div style="background:#f9f9f9; padding:10px; border-radius:8px; font-size:12px; color:#999;">
            å¼€é€š <span id="pay-month-display">1</span> å¤©è´µæ—ï¼Œäº«å°Šè´µç‰¹æƒ
        </div>
        
        <div class="auto-renew-row">
            <span>è‡ªåŠ¨ç»­è´¹</span>
            <label class="switch">
                <input type="checkbox" id="vip-auto-renew-switch" onchange="toggleAutoRenewState(this)">
                <span class="slider"></span>
            </label>
        </div>
        
        <button class="pay-btn" id="pay-confirm-btn" onclick="payVip()">ç¡®è®¤åè®®å¹¶ç«‹å³ä»¥10å…ƒå¼€é€š</button>
        
        <div class="pay-tips">è¯·é˜…è¯»ã€Šå°é¼ æœºè´µæ—ã€‹ï¼Œä»€ä¹ˆä½ æ²¡çœ‹åˆ°ï¼Œå› ä¸ºæˆ‘ä¹Ÿæ²¡æœ‰å†™</div>
    </div>
</div>
<!-- ğŸ¨ é¡µé¢ï¼šç¾åŒ–ä¸­å¿ƒ (å­—ä½“åº“å‡çº§ç‰ˆ) -->
<div class="view" id="view-beautify">
    <div class="nav-bar">
        <button class="nav-btn" onclick="navBack()">â® è¿”å›</button>
        <span class="nav-title">ç¾åŒ–ä¸­å¿ƒ</span>
        <div style="width:40px"></div>
    </div>
    
    <div class="scroll-content" style="padding:20px;">
        
        <!-- 1. ç•Œé¢å­—ä½“å¤§å° -->
        <div class="form-group" style="padding:20px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="font-weight:600;">ğŸ“± ç•Œé¢å­—ä½“å¤§å°</span>
                <span id="global-font-size-display" style="color:#007AFF;">15px</span>
            </div>
            <input type="range" id="global-font-size-slider" min="12" max="22" step="1" value="15" oninput="changeGlobalFontSize(this.value)">
            <p style="font-size:12px; color:#999; margin-top:10px;">
                è°ƒæ•´èœå•ã€åˆ—è¡¨ã€æœ‹å‹åœˆç­‰ç•Œé¢çš„å­—å·ã€‚<br>
                (æ³¨ï¼šèŠå¤©æ°”æ³¡å­—å·è¯·åœ¨â€œèŠå¤©è®¾ç½®â€ä¸­è°ƒæ•´)
            </p>
        </div>

        <!-- 2. å­—ä½“ç®¡ç† -->
        <div class="form-group" style="padding:20px;">
            <h3 style="margin:0 0 15px 0; font-weight:600;">âœ’ï¸ å…¨å±€å­—ä½“æ ·å¼</h3>
            
            <!-- é¡¶éƒ¨æ“ä½œåŒº -->
            <div style="display:flex; gap:15px; margin-bottom:20px;">
                <button class="btn-block secondary" style="margin:0; flex:1; background:#e5e5ea; color:#333;" onclick="resetFont()">
                    â†º æ¢å¤ç³»ç»Ÿé»˜è®¤
                </button>
                <button class="btn-block" style="margin:0; flex:1;" onclick="document.getElementById('font-file-input').click()">
                    ğŸ“‚ å¯¼å…¥ .ttf å­—ä½“
                </button>
                <button class="btn-block" style="margin:0; flex:1; background:#5856d6;" onclick="handleLinkImport()">
        ğŸ”— é“¾æ¥å¯¼å…¥
    </button>
                <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
                <input type="file" id="font-file-input" hidden accept=".ttf,.otf" onchange="handleFontImport(this)">
            </div>

            <!-- åˆ†å‰²çº¿ -->
            <div style="border-top:1px solid #eee; margin:10px -20px;"></div>
            
            <!-- åº•éƒ¨ä¿å­˜çš„å­—ä½“åˆ—è¡¨ -->
            <div style="font-size:14px; font-weight:600; margin:15px 0 10px; color:#333;">æˆ‘çš„å­—ä½“åº“</div>
            <div id="saved-font-list" style="display:flex; flex-direction:column; gap:10px;">
                <!-- JS ä¼šåœ¨è¿™é‡Œç”Ÿæˆå­—ä½“åˆ—è¡¨ -->
                <div style="text-align:center; color:#999; font-size:12px; padding:10px;">æš‚æ— ä¿å­˜çš„å­—ä½“</div>
            </div>
            
            <p style="font-size:12px; color:#999; margin-top:15px;">
                * å¯¼å…¥çš„å­—ä½“ä¿å­˜åœ¨æœ¬åœ°æ•°æ®åº“ï¼Œä¸ä¼šæ¶ˆè€—æµé‡ã€‚<br>
                * å»ºè®®å­—ä½“æ–‡ä»¶ä¸è¦è¶…è¿‡ 10MBï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´å¡é¡¿ã€‚
            </p>
        </div>

    </div>
</div>
<!-- ğŸ“ å‘å¸ƒåŠ¨æ€é¡µé¢ -->
<div class="view" id="view-publish-moment">
    <div class="nav-bar">
        <button class="nav-btn" onclick="navBackFromPublish()">å–æ¶ˆ</button>
        <span class="nav-title">å‘è¡¨åŠ¨æ€</span>
        <button class="nav-btn" style="background:#07C160; color:white; padding:4px 12px; border-radius:4px; font-size:14px;" onclick="doPublishMoment()">å‘è¡¨</button>
    </div>
    <div class="scroll-content" style="background:#fff;">
        <!-- 1. æ–‡æœ¬è¾“å…¥ -->
        <textarea id="publish-text" class="publish-textarea" placeholder="è¿™ä¸€åˆ»çš„æƒ³æ³•..."></textarea>
        
        <!-- 2. å›¾ç‰‡é¢„è§ˆåŒº -->
        <div class="publish-img-grid" id="publish-img-container">
            <!-- JS ä¼šåœ¨è¿™é‡Œæ’å…¥ img æ ‡ç­¾ -->
            <!-- è¿™æ˜¯ä¸€ä¸ªå‡çš„æ·»åŠ æŒ‰é’®ï¼Œç‚¹å‡»è§¦å‘ input -->
            <div style="width:100px; height:100px; background:#f5f5f5; display:flex; align-items:center; justify-content:center; font-size:40px; color:#ccc; cursor:pointer;" onclick="document.getElementById('pub-img-input').click()">+</div>
        </div>
        <input type="file" id="pub-img-input" hidden accept="image/*" onchange="handlePublishImg(this)">

        <!-- 3. å·¥å…·æ  -->
        <div class="publish-toolbar">
            <!-- æ‰€åœ¨ä½ç½® -->
            <div class="toolbar-row" onclick="openLocationModal()">
                <div style="display:flex;align-items:center;">
                    <span class="toolbar-icon">ğŸ“</span>
                    <span>æ‰€åœ¨ä½ç½®</span>
                </div>
                <div class="toolbar-right">
                    <span id="pub-location-display"></span>
                    <span>â¯</span>
                </div>
            </div>
            
            <!-- æé†’è°çœ‹ (@å¥½å‹) -->
            <div class="toolbar-row" onclick="openAtFriendModal()">
                <div style="display:flex;align-items:center;">
                    <span class="toolbar-icon">@</span>
                    <span>æé†’è°çœ‹</span>
                </div>
                <div class="toolbar-right">â¯</div>
            </div>
            
            <div class="toolbar-row">
                <div style="display:flex;align-items:center;">
                    <span class="toolbar-icon">ğŸ”’</span>
                    <span>è°å¯ä»¥çœ‹</span>
                </div>
                <div class="toolbar-right">å…¬å¼€ â¯</div>
            </div>
        </div>
    </div>
</div>

<!-- ğŸ“ ä½ç½®è¾“å…¥å¼¹çª— -->
<div class="modal-mask" id="modal-input-location">
    <div class="modal-panel" style="height:auto; width:80%;">
        <div class="modal-header">æ‰€åœ¨ä½ç½®</div>
        <div class="modal-body">
            <input type="text" id="location-input-val" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;" placeholder="è¯·è¾“å…¥ä½ç½®åç§°...">
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal('modal-input-location')">å–æ¶ˆ</button>
            <button class="btn-confirm" onclick="confirmLocation()">ç¡®å®š</button>
        </div>
    </div>
</div>

<!-- @ å¥½å‹é€‰æ‹©å¼¹çª— -->
<div class="modal-mask" id="modal-at-friend">
    <div class="modal-panel" style="height:70%;">
        <div class="modal-header">é€‰æ‹©æé†’çš„äºº</div>
        <div class="modal-body" id="at-friend-list"></div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal('modal-at-friend')">å–æ¶ˆ</button>
        </div>
    </div>
</div>
        <!-- ğŸ‘¤ æˆ‘çš„è¯´è¯´é¡µé¢ -->
<div class="view" id="view-my-moments">
    <div class="nav-bar">
        <!-- è¿”å›æŒ‰é’®ï¼šå›åˆ°å¥½å‹åŠ¨æ€é¦–é¡µ -->
        <button class="nav-btn" onclick="navTo('view-moments'); renderMoments();">â® è¿”å›</button>
        <span class="nav-title">æˆ‘çš„è¯´è¯´</span>
        <!-- æ–°å¢å‘å¸ƒæŒ‰é’® -->
        <button class="nav-btn" style="font-size:24px; font-weight:300;" onclick="openPublishPage()">â•</button>
    </div>
    
    <!-- å†…å®¹å®¹å™¨ -->
    <div class="scroll-content" id="my-moments-scroll">
        <!-- åˆ—è¡¨å®¹å™¨ -->
        <div id="list-my-moments" style="padding-top:10px;"></div>
    </div>
</div>
        <!-- ğŸ¨ ç©ºé—´è£…æ‰®é¡µé¢ -->
<div class="view" id="view-decoration">
    <div class="nav-bar">
        <!-- è¿”å›æŒ‰é’®ï¼šå›åˆ°å¥½å‹åŠ¨æ€ -->
        <button class="nav-btn" onclick="navTo('view-moments')">â® è¿”å›</button>
        <span class="nav-title">ç©ºé—´è£…æ‰®</span>
        <div style="width:40px"></div>
    </div>
    <div class="scroll-content">
        
        <!-- 1. å£çº¸è®¾ç½® -->
        <div class="list-item" style="margin-top:20px;">
            <div class="item-main" onclick="document.getElementById('deco-bg-input').click()">
                <div class="icon-box" style="background:#07C160; width:40px; height:40px; font-size:20px;">ğŸ–¼ï¸</div>
                <div class="item-text">
                    <h3>æ›´æ¢åŠ¨æ€å£çº¸</h3>
                    <p>é€‰æ‹©ä¸€å¼ å›¾ç‰‡ä½œä¸ºå…¨å±èƒŒæ™¯</p>
                </div>
            </div>
            <!-- è¿™é‡Œçš„ input æ¬è¿‡æ¥äº† -->
            <input type="file" id="deco-bg-input" hidden accept="image/*" onchange="changeZoneBg(this)">
        </div>

        <!-- 2. å¡ç‰‡é€æ˜åº¦è®¾ç½® -->
        <div class="form-group" style="margin-top:20px; padding:20px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="font-weight:600;">åŠ¨æ€å¡ç‰‡é€æ˜åº¦</span>
                <span id="opacity-display" style="color:#007AFF;">100%</span>
            </div>
            <!-- æ»‘å—ï¼šä» 0.1 (å‡ ä¹å…¨é€) åˆ° 1 (ä¸é€æ˜) -->
            <input type="range" id="card-opacity-slider" min="0" max="1.0" step="0.05" value="1" oninput="updateCardOpacity(this.value)">
            <p style="font-size:12px; color:#888; margin-top:10px;">
                å‘å·¦æ‹–åŠ¨è®©å¡ç‰‡å˜é€æ˜ï¼Œé€å‡ºåº•ä¸‹çš„å£çº¸ã€‚
            </p>
        </div>

    </div>
</div>

        <!-- 6. èŠå¤©çª—å£ -->
        <!-- 6. èŠå¤©çª—å£ (ç»“æ„å¾®è°ƒ) -->
<div class="view" id="view-conversation" style="display:flex; flex-direction:column; height:100%;">
    
    <!-- é¡¶éƒ¨å¯¼èˆªä¿æŒä¸å˜ -->
    <div class="nav-bar">
        <button class="nav-btn" onclick="closeConversation()" style="position:relative;">
            â® æ¶ˆæ¯ <span id="badge-chat-back" class="red-badge">0</span>
        </button>
        <span class="nav-title" id="chat-title" style="flex:1; text-align:center; margin-right:-20px;">...</span>
        <div style="display:flex; align-items:center;">
            <button class="nav-btn" onclick="openMemoryModal()">ğŸ–Šï¸</button>
            <button class="nav-btn" onclick="openChatSettings()">â•</button>
        </div>
    </div>

    <!-- èŠå¤©å†…å®¹åŒº (å¿…é¡»åŠ ä¸Š flex:1 ä»¥ä¾¿å æ®å‰©ä½™ç©ºé—´) -->
    <div class="chat-bg" id="chat-msg-container" onclick="closeToolPanel()"></div>

    <!-- å¤šé€‰å·¥å…·æ  (ä¿æŒä¸å˜) -->
    <div class="selection-toolbar" id="selection-toolbar">
        <div class="toolbar-btn cancel" onclick="exitSelectionMode()">å–æ¶ˆ</div>
        <div style="font-size:14px; font-weight:bold;">é€‰æ‹©æ¶ˆæ¯</div>
        <div class="toolbar-btn delete" onclick="deleteSelectedMessages()">åˆ é™¤</div>
    </div>

    <!-- ğŸ‘‡ğŸ‘‡ğŸ‘‡ åº•éƒ¨è¾“å…¥åŒº (åŒ…å«è¾“å…¥æ  + åŠŸèƒ½é¢æ¿) ğŸ‘‡ğŸ‘‡ğŸ‘‡ -->
    <div style="flex-shrink: 0; background: #f7f7f7; border-top: 1px solid #dcdcdc;">
        
        <!-- 1. è¾“å…¥æ  -->
        <div class="chat-input-bar" id="chat-input-bar" style="border:none;">
            <!-- åŠ å·æŒ‰é’®ï¼šç‚¹å‡»åˆ‡æ¢é¢æ¿ -->
            <button class="plus-btn" onclick="toggleToolPanel(event)">+</button>
            <button class="plus-btn" style="font-size:20px; border-color:#999; color:#666;" onclick="toggleStickerPanel(event)">â˜º</button>
            
            <!-- è¾“å…¥æ¡†ï¼šç‚¹å‡»æ—¶è‡ªåŠ¨æ”¶èµ·é¢æ¿ -->
            <input type="text" id="msg-input" placeholder="å‘é€æ¶ˆæ¯..." onfocus="closeToolPanel()">
            
            <button class="mini-btn" style="background:#ff9500" onclick="triggerAiReply()">å›å¤</button>
            <button class="mini-btn" style="background:#07c160" onmousedown="event.preventDefault();" onclick="sendUserMsg()">å‘é€</button>
        </div>
        <div id="chat-sticker-panel" class="chat-tool-panel" style="height:0; overflow:hidden; background:#f0f0f0;">
        <!-- é¡¶éƒ¨å·¥å…·æ¡ï¼šæ˜¾ç¤ºæç¤º + çˆ±å¿ƒé€‰æ‹©å™¨ -->
        <div style="height:40px; display:flex; align-items:center; justify-content:space-between; padding:0 15px; border-bottom:1px solid #e0e0e0; background:#fff;">
            <span id="sticker-panel-hint" style="font-size:12px; color:#999;">é»˜è®¤è¡¨æƒ…</span>
            <!-- çˆ±å¿ƒæŒ‰é’®ï¼šç‚¹å‡»åˆ‡æ¢åˆ†ç±» -->
            <button onclick="openStickerSelector()" style="border:none; background:transparent; font-size:18px; color:#ff3b30;">â¤ï¸</button>
        </div>
        <!-- è¡¨æƒ…å†…å®¹åŒº -->
        <div id="chat-sticker-content" style="height:220px; overflow-y:auto; padding:10px;">
            <!-- JS å¡«å……è¡¨æƒ… -->
        </div>
    </div>


        <!-- 2. åº•éƒ¨åŠŸèƒ½é¢æ¿ (é»˜è®¤éšè—) -->
        <div id="chat-tool-panel" class="chat-tool-panel">
            <div class="tool-grid">
                <!-- ç›¸å†Œ -->
                <div class="tool-item" onclick="selectChatImage()">
                    <div class="tool-icon-box" style="background:#F5F5F5;">
                        <span style="font-size:24px;">ğŸ–¼ï¸</span>
                    </div>
                    <span class="tool-name">ç›¸å†Œ</span>
                </div>
                <!-- æ‹ç…§ (å ä½) -->
                <div class="tool-item" onclick="openPhotoSimModal()"> <div class="tool-icon-box" style="background:#F5F5F5;"> <span style="font-size:24px;">ğŸ“·</span> </div> <span class="tool-name">æ‹æ‘„</span> </div>
                <!-- è§†é¢‘é€šè¯ (ä»¿å›¾2) -->
                <div class="tool-item">
                    <div class="tool-icon-box" style="background:#F5F5F5;">
                        <span style="font-size:24px;">ğŸ“¹</span>
                    </div>
                    <span class="tool-name">è§†é¢‘é€šè¯</span>
                </div>
                <!-- è¯­éŸ³é€šè¯ (ä»¿å›¾2) -->
                <div class="tool-item">
                    <div class="tool-icon-box" style="background:#F5F5F5;">
                        <span style="font-size:24px;">ğŸ“</span>
                    </div>
                    <span class="tool-name">è¯­éŸ³é€šè¯</span>
                </div>
                <!-- çº¢åŒ… -->
                <div class="tool-item" onclick="openTransferModal()">
                    <div class="tool-icon-box" style="background:#F5F5F5;">
                        <span style="font-size:24px;">ğŸ§§</span>
                    </div>
                    <span class="tool-name">çº¢åŒ…/è½¬è´¦</span>
                </div>
                <!-- å›æº¯åŠŸèƒ½ -->
                <div class="tool-item" onclick="handleRegenerate()">
                    <div class="tool-icon-box" style="background:#F5F5F5;">
                        <span style="font-size:24px;">â†º</span>
                    </div>
                    <span class="tool-name">å›æº¯</span>
                </div>
                 <!-- ä½ç½® (å ä½) -->
                 <div class="tool-item">
                    <div class="tool-icon-box" style="background:#F5F5F5;">
                        <span style="font-size:24px;">ğŸ“</span>
                    </div>
                    <span class="tool-name">ä½ç½®</span>
                </div>
                <!-- æ–‡ä»¶ (å ä½) -->
                <!-- ä¿®æ”¹ï¼šæŠŠæ–‡ä»¶æ”¹æˆè¯­éŸ³ -->
<div class="tool-item" onclick="openVoicePanel()">
    <div class="tool-icon-box" style="background:#F5F5F5;">
        <span style="font-size:24px;">ğŸ™ï¸</span>
    </div>
    <span class="tool-name">è¯­éŸ³æ¶ˆæ¯</span>
</div>
            </div>
        </div>
        <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
        <input type="file" id="chat-image-input" hidden accept="image/*" onchange="handleChatImageSelected(this)">
    </div>
</div>
         <!-- 7. æ–°çš„å¥½å‹åŠ¨æ€é¡µé¢ -->
        <div class="view" id="view-moments">
            <div class="nav-bar">
                <button class="nav-btn" onclick="navTo('view-chat-app')">â†</button>
                <span class="nav-title">å¥½å‹åŠ¨æ€</span>
                <!-- å³ä¸Šè§’åˆ·æ–°æŒ‰é’® -->
                <button class="nav-btn" id="btn-moment-refresh" onclick="toggleMomentMenu()" style="font-size:20px;">â†»</button>
            </div>
            
            <!-- é€‰äººç”Ÿæˆçš„å°èœå• (é»˜è®¤éšè—) -->
            <div class="moment-menu" id="moment-gen-menu">
                <h4>é€‰æ‹©è§’è‰²å‘åŠ¨æ€</h4>
                <div class="menu-scroll" id="moment-candidate-list"></div>
                <button class="btn-block" style="padding:8px; font-size:14px; margin-top:10px;" onclick="confirmGenerateMoments()">âœ¨ ç«‹å³ç”Ÿæˆ</button>
            </div>

            <div class="scroll-content" style="padding:0;">
    <!-- 1. å¤§èƒŒæ™¯å›¾ -->
    <div class="zone-header-bg" id="zone-bg-img"></div>
    
    <!-- 2. ä¸ªäººä¿¡æ¯ (å¤´åƒé‡å ) -->
    <div class="zone-profile-box">
        <img src="" id="zone-my-avatar" class="zone-avatar-big">
        <div class="zone-username">
            <span id="zone-my-name">æˆ‘</span>
        </div>
        <div class="zone-visitors">
            è®¿å®¢æ€»é‡ <b id="zone-visitor-count">61314</b>
        </div>
    </div>

    <!-- 3. åŠŸèƒ½æ  (è¯´è¯´ã€ç•™è¨€æ¿ã€è£…æ‰®) -->
    <div class="zone-nav-bar">
        <!-- è¯´è¯´ï¼šç‚¹å‡»è§¦å‘ç”ŸæˆåŠ¨æ€èœå• -->
        <div class="zone-nav-item" onclick="openMyMoments()">
            <div class="zone-nav-icon" style="background:#FFF7E6; color:#FF9500;">ğŸ’¬</div>
            <span>è¯´è¯´</span>
        </div>
        <!-- ç•™è¨€æ¿ï¼šæš‚æ—¶åšä¸ªæ ·å­ -->
        <div class="zone-nav-item" onclick="alert('ç•™è¨€æ¿åŠŸèƒ½å¼€å‘ä¸­...')">
            <div class="zone-nav-icon" style="background:#E6F7FF; color:#007AFF;">ğŸ“</div>
            <span>ç•™è¨€æ¿</span>
        </div>
        <!-- è£…æ‰®ï¼šç‚¹å‡»æ¢èƒŒæ™¯å›¾ -->
        <div class="zone-nav-item" onclick="navTo('view-decoration')">
            <div class="zone-nav-icon" style="background:#F0FFF4; color:#07C160;">ğŸ¨</div>
            <span>è£…æ‰®</span>
        </div>
        <div class="zone-nav-item" onclick="openVipPage()"> <div class="zone-nav-icon" style="background:#FFF7E6; color:#D4A048;">ğŸ‘‘</div> <span>è´µæ—</span> </div>
        <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ æ¡†ï¼Œç”¨äºæ¢èƒŒæ™¯ -->
        <input type="file" id="zone-bg-input" hidden accept="image/*" onchange="changeZoneBg(this)">
    </div>
                <!-- åŠ¨æ€åˆ—è¡¨å®¹å™¨ -->
                <div id="list-moments">
                    <div style="text-align:center; margin-top:50px; color:#999;">
                        <div style="font-size:40px; margin-bottom:10px;">ğŸ“­</div>
                        <p>ç‚¹å³ä¸Šè§’è®©å¤§å®¶å‘åŠ¨æ€å§~</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- ... ä¸Šé¢æ˜¯ view-moments çš„ç»“æŸæ ‡ç­¾ </div> ... -->


<!-- ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€è¯·æŠŠè¿™æ®µä»£ç ç²˜è´´åœ¨è¿™é‡Œã€‘ğŸ‘‡ğŸ‘‡ğŸ‘‡ -->
<div class="view" id="view-tongpin">
    <!-- 1. å¯¼èˆªæ ï¼šä¿®æ”¹è¿”å›é€»è¾‘ -->
    <div class="nav-bar">
        <!-- ğŸ”´ è¿™é‡Œçš„ onclick æ”¹äº†ï¼šç‚¹å‡»è¿”å›æ—¶ï¼Œç›´æ¥å›åˆ°ä¸»èŠå¤©APPçš„â€œç©ºé—´â€Tab -->
        <button class="nav-btn" onclick="navTo('view-chat-app'); switchChatTab('circle')">â® è¿”å›</button>
        <span class="nav-title">åŒé¢‘</span>
        <div style="width:40px"></div>
    </div>
    
    <div class="scroll-content" style="padding:0; background:#fff;">
        <!-- 2. ä¸ªäººä¿¡æ¯å¤´ (ä¿æŒä¸å˜) -->
        <!-- ä¸ªäººä¿¡æ¯å¤´ (ä¿®æ”¹ç‰ˆï¼šå³ä¾§å¢åŠ äº†åŠ å·) -->
<!-- ä¸ªäººä¿¡æ¯å¤´ (ä¿®æ”¹ç‰ˆï¼šå¢åŠ äº†æ˜Ÿæ˜Ÿå˜‰å®¾èœå•) -->
<!-- ä¸ªäººä¿¡æ¯å¤´ (æœ€ç»ˆç¾åŒ–ç‰ˆï¼šç™½è‰²æµ®çª—) -->
<div class="tp-header-bar" style="position:relative;">
    <img src="" id="tp-user-avatar" class="tp-my-avatar">
    <span class="tp-my-name" id="tp-user-name">æˆ‘</span>
    <span class="tp-decoration">ğŸ</span>
    
    <div style="margin-left:auto; display:flex; align-items:center; gap:15px;">
        <!-- æ˜Ÿæ˜ŸæŒ‰é’® -->
        <div onclick="toggleTpGuestMenu()" style="font-size:22px; color:#FF9500; cursor:pointer;">â˜…</div>
        
        <!-- åŠ å·æŒ‰é’® -->
        <div class="tp-add-cat-btn" onclick="openAddCategoryModal()" style="font-size:24px; font-weight:300; color:#007AFF; cursor:pointer; width:30px; height:30px; display:flex; align-items:center; justify-content:center;">
            +
        </div>
    </div>

    <!-- ğŸ”´ æ ¸å¿ƒä¿®æ”¹ï¼šèƒŒæ™¯æ”¹æˆç™½è‰²(#fff)ï¼Œæ–‡å­—æ”¹æˆæ·±è‰²(#333)ï¼ŒåŠ äº†é˜´å½± -->
    <div id="tp-guest-menu" class="pop-menu" style="top:50px; right:10px; width:130px; max-height:500px; overflow-y:auto; display:none; flex-direction:column; background:#fff; color:#333; box-shadow: 0 5px 20px rgba(0,0,0,0.15);">
        
        <!-- æç¤ºè¯­çš„åˆ†å‰²çº¿é¢œè‰²ä¹Ÿè°ƒæµ…äº†(#f0f0f0) -->
        <div style="padding:10px; font-size:12px; color:#999; border-bottom:1px solid #f0f0f0;">
            å‹¾é€‰åï¼ŒTAä»¬å¯èƒ½éšæœºå‡ºç°åœ¨å¸–å­æˆ–è¯„è®ºåŒº
        </div>
        
        <!-- åˆ—è¡¨å®¹å™¨ -->
        <div id="tp-guest-list-box"></div>
    </div>
</div>
        
        <!-- 3. åˆ†ç±» Tab æ ï¼šæœ€å·¦ä¾§æ–°å¢â€œå…³æ³¨â€ -->
        <div class="tp-nav-container">
            <div class="tp-scroll-tabs" id="tp-tabs">
                <!-- â­â­ æ–°å¢ï¼šå…³æ³¨ Tab (æ”¾åœ¨æœ€å‰é¢) â­â­ -->
                <div class="tp-tab-item" onclick="switchTpTab('å…³æ³¨', this)">å…³æ³¨</div>
                
                <!-- åŸæœ‰çš„ Tabs -->
                <div class="tp-tab-item active" onclick="switchTpTab('æ¨è', this)">æ¨è</div>
                <div class="tp-tab-item" onclick="switchTpTab('æ¸¸æˆ', this)">æ¸¸æˆ</div>
                <div class="tp-tab-item" onclick="switchTpTab('ææ€–', this)">ææ€–</div>
                <div class="tp-tab-item" onclick="switchTpTab('å°è¯´', this)">å°è¯´</div>
                <div class="tp-tab-item" onclick="switchTpTab('æ­Œæ›²', this)">æ­Œæ›²</div>
                <div class="tp-tab-item" onclick="switchTpTab('å…«å¦', this)">å…«å¦</div>
            </div>
            <div class="tp-refresh-btn" onclick="refreshTpList()">â†»</div>
        </div>
        
        <!-- 4. å†…å®¹åˆ—è¡¨å®¹å™¨ (ä¿æŒä¸å˜) -->
        <div class="tp-feed-list" id="tp-content-list"></div>
        <div style="height:40px;"></div>
    </div>
</div>
<!-- ğŸ¢ é¡µé¢ï¼šå°ç»„è¯¦æƒ… (Channel) -->
<div class="view" id="view-tp-group">
    <div class="nav-bar">
    <button class="nav-btn" onclick="navTo('view-tongpin')">â®</button>
    <span class="nav-title" id="tp-group-page-title">å°ç»„</span> 
    
    <!-- ğŸ”´ 1. ä¿®æ”¹å³ä¸Šè§’æŒ‰é’®ï¼šç‚¹å‡»è§¦å‘èœå• -->
    <button class="nav-btn" style="font-size:20px; font-weight:bold; letter-spacing:2px;" onclick="toggleGroupMenu()">Â·Â·Â·</button>
    
    <!-- ğŸ”´ 2. æ–°å¢ï¼šéšè—çš„å°èœå• -->
    <!-- ğŸ”´ 2. æ–°å¢ï¼šéšè—çš„å°èœå• (ç™½åº•ç²¾ä¿®ç‰ˆ) -->
    <div id="tp-group-menu-box" class="pop-menu" style="top:85px; right:10px; width:60px; background:#fff; color:#333; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
        <!-- è¿™é‡Œçš„ border-bottom æ”¹æˆäº†æµ…ç°è‰² #f5f5f5 -->
        <div class="pop-item" style="border-bottom:1px solid #f5f5f5;" onclick="refreshGroupPosts()"> åˆ·æ–°</div>
        <!-- è¿™é‡Œçš„ border-bottom å»æ‰äº†ï¼Œçœ‹èµ·æ¥æ›´å¹²å‡€ -->
        <div class="pop-item" style="color:#ff3b30; border-bottom:none;" onclick="clearGroupPosts()"> æ¸…ç©º</div>
    </div>
</div>
    
    <div class="scroll-content" style="padding:0; background:#fff;">
        <!-- é¡¶éƒ¨ä¿¡æ¯ -->
        <!-- é¡¶éƒ¨ä¿¡æ¯ -->
<div class="tp-group-header-bar">
    <!-- ğŸ”´ æ ¸å¿ƒä¿®æ”¹ï¼šæŠŠåŸæ¥çš„ img æ ‡ç­¾æ”¹æˆäº† divï¼Œå¹¶åŠ äº†å±…ä¸­æ ·å¼ -->
    <!-- ğŸ”´ æ ¸å¿ƒä¿®æ”¹ï¼šåŠ äº† width, height å’Œ flex-shrink:0 (ç¦æ­¢æŒ¤å‹) -->
<div id="tp-group-header-img" class="tp-gh-avatar" style="width:50px; height:50px; min-width:50px; flex-shrink:0; display:flex; align-items:center; justify-content:center; color:#fff; font-size:24px; font-weight:bold; border-radius:12px;">
    ?
</div>
    
    <div class="tp-gh-info">
        <h3 id="tp-group-header-name">å°ç»„å</h3>
        <p id="tp-group-header-desc">ç®€ä»‹...</p>
    </div>
</div>

        <!-- å¸–å­åˆ—è¡¨ -->
        <div id="tp-post-list" style="background:#f5f5f5; min-height:100%;">
            <!-- JS ç”Ÿæˆå¸–å­å¡ç‰‡ -->
        </div>
    </div>
</div>

<!-- ğŸ“ é¡µé¢ï¼šå¸–å­è¯¦æƒ… (Post Detail) -->
<div class="view" id="view-tp-post">
    <div class="nav-bar">
        <!-- ğŸ”´ æ ¸å¿ƒä¿®æ”¹ï¼šå°† onclick="navBack()" æ”¹ä¸º navTo('view-tp-group') -->
        <!-- åŸç†ï¼šæ™ºèƒ½å¯¼èˆªç³»ç»Ÿä¼šæ£€æµ‹åˆ° view-tp-group å°±åœ¨ä½ èº«åï¼Œæ‰€ä»¥å®ƒä¼šè‡ªåŠ¨æ‰§è¡Œâ€œåé€€åŠ¨ç”»â€ï¼Œè€Œä¸æ˜¯å‰è¿› -->
        <button class="nav-btn" onclick="navTo('view-tp-group')">â® è¿”å›</button>
        
        <span class="nav-title">è¯¦æƒ…</span>
        <div style="width:40px"></div>
    </div>
    
    <!-- ä¸‹é¢çš„å†…å®¹ä¿æŒä¸å˜ -->
    <div class="scroll-content" style="padding:0; background:#fff;">
        <!-- å¸–å­æ­£æ–‡åŒº (JSå¡«å……) -->
        <div id="tp-post-detail-container"></div>
        
        <!-- è¯„è®ºåŒºæ ‡é¢˜ -->
        <div style="padding:15px; font-weight:bold; border-bottom:1px solid #eee;">å…¨éƒ¨è¯„è®º</div>
        
        <!-- è¯„è®ºåˆ—è¡¨ -->
        <div id="tp-comment-full-list" class="tp-comment-list"></div>
    </div>
    
    <!-- åº•éƒ¨è¯„è®ºè¾“å…¥æ¡† -->
    <div class="chat-input-bar">
        <input type="text" placeholder="è¯´ç‚¹å¥½å¬çš„..." style="background:#f0f0f0; border:none;">
        <button class="mini-btn" style="background:#2D68FF">å‘é€</button>
    </div>
</div>
<!-- ğŸ˜œ é¡µé¢ï¼šè¡¨æƒ…åŒ…ç®¡ç†åˆ—è¡¨ -->
<div class="view" id="view-sticker-manager">
    <div class="nav-bar">
        <button class="nav-btn" onclick="navBackToMe()">â® è¿”å›</button>
        <span class="nav-title">è¡¨æƒ…åŒ…ç®¡ç†</span>
        <button class="nav-btn" onclick="openAddStickerPackModal()">â•</button>
    </div>
    <div class="scroll-content" style="background:#fff;">
        <div id="sticker-pack-list" style="padding:15px;"></div>
    </div>
</div>

<!-- ğŸ˜œ é¡µé¢ï¼šè¡¨æƒ…åŒ…è¯¦æƒ… (æŸ¥çœ‹æŸä¸ªåˆ†ç±»ä¸‹çš„å›¾) -->
<div class="view" id="view-sticker-detail">
    <div class="nav-bar">
        <button class="nav-btn" onclick="navTo('view-sticker-manager')">â® è¿”å›</button>
        <span class="nav-title" id="sticker-pack-title">è¯¦æƒ…</span>
        <button class="nav-btn" style="color:#ff3b30;" onclick="deleteCurrentStickerPack()">ğŸ—‘ï¸</button>
    </div>
    <div class="scroll-content" style="background:#fff;">
        <div id="sticker-grid-view" class="sticker-grid-display"></div>
    </div>
</div>
<!-- ğŸ‘†ğŸ‘†ğŸ‘† ç²˜è´´ç»“æŸ ğŸ‘†ğŸ‘†ğŸ‘† -->


<!-- ================= å¼¹çª—ç»„ä»¶ ================= -->
<!-- ... ä¸‹é¢æ˜¯å„ç§ modal å¼¹çª— ... -->


        <!-- ================= å¼¹çª—ç»„ä»¶ ================= -->
        <!-- ğŸ§§ æ”¶æ¬¾ç¡®è®¤å¼¹çª— -->
<div class="modal-mask" id="modal-transfer-receive">
    <div class="modal-panel" style="width: 75%; height: auto; padding-bottom: 20px;">
        <div class="modal-header">ç¡®è®¤æ”¶æ¬¾</div>
        <div class="modal-body" style="text-align: center;">
            <div style="font-size: 14px; color: #999; margin-bottom: 5px;">æ”¶åˆ°è½¬è´¦</div>
            <div style="font-size: 32px; font-weight: bold; color: #fa9d3b; margin-bottom: 10px;">
                Â¥ <span id="receive-amount-display">0.00</span>
            </div>
            <div style="font-size: 14px; color: #333;" id="receive-desc-display">å¤‡æ³¨ä¿¡æ¯</div>
        </div>
        <div class="modal-footer" style="flex-direction: column; gap: 10px; padding: 0 20px;">
            <!-- ä¸¤ä¸ªå¤§æŒ‰é’® -->
            <button class="btn-block" style="background: #fa9d3b; margin: 0;" onclick="confirmReceive('accepted')">ç¡®è®¤æ”¶ä¸‹</button>
            <button class="btn-block" style="background: #fff; color: #999; border: 1px solid #eee; margin: 0;" onclick="confirmReceive('rejected')">ç«‹å³é€€è¿˜</button>
        </div>
    </div>
</div>
        <!-- ğŸ”— åˆ†äº«è‡³... å¼¹çª— -->
<!-- ğŸ”— åŒé¢‘å¸–å­åˆ†äº«å¼¹çª— (ä¿®æ”¹ç‰ˆï¼šå¸¦è·³è½¬å¼€å…³) -->
<div class="share-sheet-mask" id="modal-tp-share">
    <div class="share-panel">
        <!-- ğŸ”´ æ ¸å¿ƒä¿®æ”¹ï¼šæ ‡é¢˜æ å˜æˆäº† Flex å¸ƒå±€ï¼Œå³è¾¹åŠ äº†å¼€å…³ -->
        <div class="share-header" style="display:flex; justify-content:space-between; align-items:center; padding:15px 20px; font-weight:bold; font-size:16px; color:#000;">
            <span>åˆ†äº«ç»™è°</span>
            
            <!-- è·³è½¬å¼€å…³ -->
            <label style="display:flex; align-items:center; gap:5px; font-size:13px; font-weight:normal; color:#666; cursor:pointer;">
                <span>åˆ†äº«å¹¶è·³è½¬</span>
                <input type="checkbox" id="share-jump-checkbox" style="transform: scale(1.2);">
            </label>
        </div>
        
        <!-- å¥½å‹åˆ—è¡¨å®¹å™¨ (ä¿æŒä¸å˜) -->
        <div class="share-grid" id="tp-share-friend-list"></div>
        <div class="share-cancel" onclick="document.getElementById('modal-tp-share').classList.remove('show')">å–æ¶ˆ</div>
    </div>
</div>
<!-- â• æ–°å»ºè¡¨æƒ…åŒ…å¼¹çª— -->
<div class="modal-mask" id="modal-add-sticker-pack">
    <div class="modal-panel">
        <div class="modal-header">æ–°å»ºè¡¨æƒ…åŒ…åˆ†ç±»</div>
        <div class="modal-body">
            <div class="form-group">
                <div class="form-row">
                    <label>å¤‡æ³¨åç§°</label>
                    <input type="text" id="sticker-pack-name" placeholder="ä¾‹å¦‚: å“†å•¦Aæ¢¦">
                </div>
            </div>
            <div style="font-size:12px; color:#666; margin-bottom:5px;">è¡¨æƒ…å†…å®¹ (æ ¼å¼: idï¼šå›¾ç‰‡é“¾æ¥ï¼Œä¸€è¡Œä¸€ä¸ª)</div>
            <textarea id="sticker-pack-content" class="modal-forward-input" rows="8" placeholder="happyï¼šhttps://...&#10;sadï¼šhttps://..."></textarea>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal('modal-add-sticker-pack')">å–æ¶ˆ</button>
            <button class="btn-confirm" onclick="saveStickerPack()">ç¡®å®šå¯¼å…¥</button>
        </div>
    </div>
</div>

<!-- â¤ï¸ é€‰æ‹©å½“å‰ä½¿ç”¨çš„è¡¨æƒ…åŒ…å¼¹çª— -->
<div class="modal-mask" id="modal-select-sticker">
    <div class="modal-panel" style="height:50%;">
        <div class="modal-header">é€‰æ‹©è¦æ˜¾ç¤ºçš„è¡¨æƒ…åŒ…</div>
        <div class="modal-body">
            <div id="sticker-pack-selector-list" class="select-list"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal('modal-select-sticker')">å…³é—­</button>
        </div>
    </div>
</div>
<!-- â†ªï¸ è½¬å‘åŠ¨æ€è¾“å…¥å¼¹çª— -->
<div class="modal-mask" id="modal-forward-input">
    <div class="modal-panel" style="height:auto; width:85%;">
        <div class="modal-header">è½¬å‘åŠ¨æ€</div>
        <div class="modal-body">
            <div style="font-size:13px; color:#999; margin-bottom:5px;">è½¬å‘ç»™æœ‹å‹ä»¬ï¼š</div>
            <textarea id="forward-text-input" class="modal-forward-input" rows="3" placeholder="è¯´ç‚¹ä»€ä¹ˆå§..."></textarea>
            
            <!-- è¿™é‡Œæ˜¾ç¤ºè¢«è½¬å‘å†…å®¹çš„é¢„è§ˆ -->
            <div class="forward-box" id="forward-preview-box">
                <span class="fwd-name">@æŸäºº</span>
                <span class="fwd-content">å†…å®¹é¢„è§ˆ...</span>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal('modal-forward-input')">å–æ¶ˆ</button>
            <button class="btn-confirm" onclick="confirmForwardMoment()">å‘è¡¨</button>
        </div>
    </div>
</div>
        <!-- â˜ï¸ æ­£åœ¨æ‹‰å–çš„å¼¹çª— -->
        <div class="modal-mask" id="modal-loading">
            <div class="modal-panel" style="height:auto; width:70%; padding:20px;">
                <div style="text-align:center;">
                    <div style="font-size:40px; margin-bottom:10px; animation: pulse 1s infinite;"></div>
                    <h3 style="margin:0 0 10px;">æ­£åœ¨æ‹‰å–ä¸­...</h3>
                    <p style="font-size:13px; color:#888; margin:0;">æ­£åœ¨è¿æ¥ API è·å–æ¨¡å‹åˆ—è¡¨<br>è¯·ç¨å€™ç‰‡åˆ»</p>
                </div>
                <button class="btn-block danger" onclick="closeModal('modal-loading')" style="margin-top:20px;">å–æ¶ˆ / å…³é—­</button>
            </div>
        </div>
        <!-- ğŸ§  æ­£åœ¨ç”Ÿæˆè®°å¿†çš„å¼¹çª— -->
<div class="modal-mask" id="modal-generating">
    <div class="modal-panel" style="height:auto; width:70%; padding:20px;">
        <div style="text-align:center;">
            <!-- ä¸€ä¸ªä¼šè·³åŠ¨çš„å¤§è„‘å›¾æ ‡ -->
            <div style="font-size:40px; margin-bottom:10px; animation: pulse 1s infinite;">ğŸ§ </div>
            <h3 style="margin:0 0 10px;">æ­£åœ¨æ•´ç†å›å¿†...</h3>
            <p style="font-size:13px; color:#888; margin:0;">AI æ­£åœ¨é˜…è¯»ä½ ä»¬çš„å¯¹è¯<br>æå–å…³é”®ä¿¡æ¯ä¸­</p>
        </div>
        <button class="btn-block danger" onclick="closeModal('modal-generating')" style="margin-top:20px;">åå°è¿è¡Œ / å…³é—­</button>
    </div>
</div>
<!-- ğŸ” æœç´¢ç»“æœå¼¹çª— -->
<div class="modal-mask" id="modal-search-result">
    <div class="modal-panel" style="height:80%;">
        <div class="modal-header">æœç´¢ç»“æœ</div>
        <div class="modal-body" id="search-result-list" style="padding:0;">
            <!-- æœç´¢ç»“æœä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal('modal-search-result')">å…³é—­</button>
        </div>
    </div>
</div>
<!-- ğŸ’° è½¬è´¦é‡‘é¢è¾“å…¥å¼¹çª— -->
<div class="modal-mask" id="modal-transfer-input">
    <div class="modal-panel" style="height:auto; width:80%;">
        <div class="modal-header">è½¬è´¦ç»™å¯¹æ–¹</div>
        <div class="modal-body">
            <div style="font-size:24px; font-weight:bold; text-align:center; margin-bottom:10px;">Â¥ <span id="trans-amount-display">0.00</span></div>
            <div class="form-group" style="margin-bottom:0;">
                <div class="form-row">
                    <label>é‡‘é¢</label>
                    <input type="number" id="transfer-amount-val" placeholder="0.00" oninput="document.getElementById('trans-amount-display').innerText=parseFloat(this.value||0).toFixed(2)">
                </div>
                <div class="form-row">
                    <label>è¯´æ˜</label>
                    <input type="text" id="transfer-desc-val" placeholder="è½¬è´¦ç»™TA">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal('modal-transfer-input')">å–æ¶ˆ</button>
            <button class="btn-confirm" style="background:#ff9c00;" onclick="sendTransferMsg()">ğŸ’° å¡é’±</button>
        </div>
    </div>
</div>
<!-- ğŸ“· æ‹ç…§æè¿°å¼¹çª— -->
<div class="modal-mask" id="modal-photo-sim">
    <div class="modal-panel" style="width:80%; height:auto;">
        <div class="modal-header">æ‹æ‘„ç…§ç‰‡</div>
        <div class="modal-body">
            <div style="text-align:center; margin-bottom:15px; color:#999;">
                <div style="font-size:40px; margin-bottom:5px;">ğŸ“¸</div>
                <p style="font-size:12px;">è¯·æè¿°ä½ â€œæ‹â€åˆ°çš„ç”»é¢</p>
            </div>
            <textarea id="photo-sim-input" class="modal-forward-input" rows="3" placeholder="ä¾‹å¦‚ï¼šä¸€åªæ­£åœ¨ç¡è§‰çš„æ©˜çŒ«ï¼Œé˜³å…‰æ´’åœ¨å®ƒèº«ä¸Š..."></textarea>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal('modal-photo-sim')">å–æ¶ˆ</button>
            <button class="btn-confirm" onclick="sendSimulatedPhoto()">å‘é€</button>
        </div>
    </div>
</div>
        <!-- æŒ‡ä»¤ -->
        <div class="modal-mask" id="modal-instruction">
            <div class="modal-panel">
                <div class="modal-header">ç¼–è¾‘æŒ‡ä»¤</div>
                <div class="modal-body">
                    <input type="hidden" id="inst-id">
                    <div class="form-group">
                        <div class="form-row"><label>åç§°</label><input type="text" id="inst-name"></div>
                        <div class="form-row"><textarea id="inst-content" rows="5" placeholder="ä¾‹å¦‚ï¼š(img:https://example.com/cat.jpg)"></textarea></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-cancel" onclick="closeModal('modal-instruction')">å–æ¶ˆ</button>
                    <button class="btn-confirm" onclick="saveInstruction()">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- è§’è‰² -->
        <div class="modal-mask" id="modal-character">
            <div class="modal-panel">
                <div class="modal-header">ç¼–è¾‘è§’è‰²</div>
                <div class="modal-body">
                    <input type="hidden" id="char-id">
                    <div class="avatar-upload">
                        <img id="char-avatar-preview" class="avatar-prev" src="" onclick="document.getElementById('char-avatar-file').click()">
                        <span style="font-size:12px;color:#007AFF;margin-top:5px;">ç‚¹å‡»ä¸Šä¼ å¤´åƒ</span>
                        <input type="file" id="char-avatar-file" hidden accept="image/*" onchange="handleImageUpload(this, 'char-avatar-preview')">
                    </div>
                    <div class="form-group">
                        <div class="form-row"><label>åç§°</label><input type="text" id="char-name"></div>
                        <div class="form-row"><textarea id="char-prompt" rows="3" placeholder="è§’è‰²è®¾å®š..."></textarea></div>
                    </div>
                    <div style="margin-bottom:5px; font-weight:600; font-size:14px; color:#333; padding-left:5px;">å…³è”æŒ‡ä»¤ (å¯æ”¾å…¥å›¾ç‰‡é“¾æ¥):</div>
                    <div class="select-list" id="char-inst-select-list"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn-cancel" onclick="closeModal('modal-character')">å–æ¶ˆ</button>
                    <button class="btn-confirm" onclick="saveCharacter()">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- äººè®¾ -->
        <div class="modal-mask" id="modal-user-persona">
            <div class="modal-panel">
                <div class="modal-header">æˆ‘çš„äººè®¾</div>
                <div class="modal-body">
                    <input type="hidden" id="user-id">
                    <div class="avatar-upload">
                        <img id="user-avatar-preview" class="avatar-prev" src="" onclick="document.getElementById('user-avatar-file').click()">
                        <span style="font-size:12px;color:#007AFF;margin-top:5px;">ç‚¹å‡»æ›´æ¢å¤´åƒ</span>
                        <input type="file" id="user-avatar-file" hidden accept="image/*" onchange="handleImageUpload(this, 'user-avatar-preview')">
                    </div>
                    <div class="form-group">
                        <div class="form-row"><label>å¤‡æ³¨</label><input type="text" id="user-desc" placeholder="ä»…è‡ªå·±å¯è§ï¼Œä¸ä¼šå‘ç»™AI"></div>
                        <div class="form-row"><label>æˆ‘çš„åç§°</label><input type="text" id="user-name"></div>
                        <div class="form-row"><textarea id="user-prompt" rows="3" placeholder="æˆ‘çš„è¯¦ç»†è®¾å®š..."></textarea></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-cancel" onclick="closeModal('modal-user-persona')">å–æ¶ˆ</button>
                    <button class="btn-confirm" onclick="saveUserPersona()">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- å‘èµ·å¯¹è¯ -->
        <div class="modal-mask" id="modal-select-chat">
            <div class="modal-panel" style="height:60%">
                <div class="modal-header">é€‰æ‹©èŠå¤©å¯¹è±¡</div>
                <div class="modal-body">
                    <div class="select-list" id="chat-select-list"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn-cancel" onclick="closeModal('modal-select-chat')">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- ç¾¤èŠ -->
        <div class="modal-mask" id="modal-create-group">
            <div class="modal-panel">
                <div class="modal-header">åˆ›å»ºç¾¤èŠ</div>
                <div class="modal-body">
                    <div class="avatar-upload">
                        <img id="group-avatar-preview" class="avatar-prev" src="" onclick="document.getElementById('group-avatar-file').click()">
                        <input type="file" id="group-avatar-file" hidden accept="image/*" onchange="handleImageUpload(this, 'group-avatar-preview')">
                        <span style="font-size:12px;color:#007AFF;margin-top:5px;">ç¾¤å¤´åƒ</span>
                    </div>
                    <div class="form-group">
                        <div class="form-row"><label>ç¾¤åç§°</label><input type="text" id="group-name"></div>
                    </div>
                    <div style="margin-bottom:5px; font-weight:600; font-size:14px; color:#333;">é€‰æ‹©æˆå‘˜ (è‡³å°‘2äºº):</div>
                    <div class="select-list" id="group-member-select"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn-cancel" onclick="closeModal('modal-create-group')">å–æ¶ˆ</button>
                    <button class="btn-confirm" onclick="confirmCreateGroup()">åˆ›å»º</button>
                </div>
            </div>
        </div>
        <!-- ğŸ–Šï¸ è®°å¿†ç¬”è®°æœ¬å¼¹çª— (æ–°) -->
        <div class="modal-mask" id="modal-memory">
            <div class="modal-panel" style="height:70%;"> <!-- é«˜åº¦ç»™é«˜ä¸€ç‚¹ï¼Œæ–¹ä¾¿çœ‹è®°å¿† -->
                <div class="modal-header">è®°å¿†ç¬”è®°æœ¬</div>
                <div class="modal-body">
                    
                    <!-- è¿™é‡Œæ˜¯åŸæ¥çš„è®°å¿†ç®¡ç†ä»£ç ï¼ŒåŸå°ä¸åŠ¨æ¬è¿‡æ¥çš„ -->
                    <div class="form-group">
                        <button class="btn-block secondary" style="margin-top:0; margin-bottom:10px;" onclick="generateSummary()">ğŸ§  ç”Ÿæˆè®°å¿†æ‘˜è¦</button>
                        
                        <!-- æ™®é€šæ‘˜è¦åˆ—è¡¨ -->
                        <div id="summary-list-box" class="memory-box">
                            <div style="text-align:center; color:#999; padding:20px;">æš‚æ— å¾…å¤„ç†è®°å¿†</div>
                        </div>
                        
                        <button class="btn-block" onclick="refineMemories()">âœ¨ å½’æ¡£ä¸ºç²¾ç‚¼è®°å¿† (å‹¾é€‰)</button>
                        
                        <!-- ç²¾ç‚¼è®°å¿†åˆ—è¡¨ -->
                        <div style="margin-top:15px; font-weight:500; color:#333;">å·²ç”Ÿæ•ˆçš„ç²¾ç‚¼è®°å¿†:</div>
                        <div id="refined-memory-box" class="memory-box" style="background:#f0f8ff;"></div>
                        
                        <div style="text-align:right;">
                            <span style="font-size:12px; color:#ff3b30; cursor:pointer;" onclick="clearRefinedMemories()">æ¸…ç©ºç²¾ç‚¼è®°å¿†</span>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button class="btn-confirm" onclick="closeModal('modal-memory')">å…³é—­</button>
                </div>
            </div>
        </div>

        <!-- â˜…â˜…â˜… èŠå¤©è®¾ç½® (å«è®°å¿†ç®¡ç†) â˜…â˜…â˜… -->
        <div class="modal-mask" id="modal-chat-settings">
            <div class="modal-panel" style="height:auto;">
                <div class="modal-header">èŠå¤©è®¾ç½®</div>
                <div class="modal-body">
                    <div class="form-group">
                        <div class="form-row" style="flex-direction:column; align-items:flex-start; gap:10px;">
                            <label style="width:100%">åˆ‡æ¢æˆ‘çš„èº«ä»½</label>
                            <select id="current-persona-select" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; background:#f9f9f9"></select>
                        </div>
                    </div>
                    <!-- æ–°å¢ï¼šæ—¶é—´æ„ŸçŸ¥å¼€å…³ -->
                    <div class="form-group">
                        <div style="padding:10px 0; font-weight:500; color:#333; display:flex; justify-content:space-between; align-items:center;">
                            <span>è®©AIçŸ¥æ™“å½“å‰æ—¶é—´</span>
                            <label class="switch">
                                <input type="checkbox" id="chat-time-aware-switch">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div style="font-size:12px; color:#999; margin-top:-5px;">
                            å¼€å¯åï¼ŒAIå°†çŸ¥é“ç°åœ¨æ˜¯ï¼š<span id="settings-time-preview" style="color:#007AFF;"></span>
                        </div>
                    </div>

                    <!-- è®°å¿†è½®æ•° -->
                    <div class="form-group">
                        <div style="padding:10px 0; font-weight:500; color:#333; display:flex; justify-content:space-between;">
                            <span>è®°å¿†è½®æ•° (20-500)</span>
                            <span id="memory-limit-display" style="color:#007AFF;">20</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="font-size:12px;">çŸ­</span>
                            <input type="range" id="memory-limit-slider" min="20" max="500" step="10" value="20" oninput="updateMemoryLimit(this.value)">
                            <span style="font-size:12px;">é•¿</span>
                        </div>
                    </div>
                    <!-- âœ¨ æ–°å¢ï¼šAIè‡ªåŠ¨å‘åŠ¨æ€è®¾ç½® -->
<div class="form-group">
    <div style="padding:10px 0; font-weight:500; color:#333;">AIè‡ªåŠ¨å‘åŠ¨æ€é¢‘ç‡</div>
    <select id="ai-moment-prob-select" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; background:#f9f9f9">
        <option value="0">å…³é—­ (ä¸è‡ªåŠ¨å‘)</option>
        <option value="400">ä½ (çº¦400æ¡æ¶ˆæ¯å‘ä¸€æ¬¡)</option>
        <option value="200">ä¸­ (çº¦200æ¡æ¶ˆæ¯å‘ä¸€æ¬¡)</option>
        <option value="100">é«˜ (çº¦100æ¡æ¶ˆæ¯å‘ä¸€æ¬¡)</option>
    </select>
    <div style="font-size:12px; color:#999; margin-top:5px;">å¼€å¯åï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨èŠå¤©é‡Œè®©TAå‘åŠ¨æ€å“¦</div>
</div>
<!-- ç²˜è´´è¿™ä¸ªæ–°çš„å¼€å…³ -->
<div class="form-group">
    <div style="padding:10px 0; font-weight:500; color:#333; display:flex; justify-content:space-between; align-items:center;">
        <span>å…è®¸AIå‘é€æŒ‡ä»¤è¡¨æƒ…</span>
        <label class="switch">
            <input type="checkbox" id="ai-allow-sticker-switch">
            <span class="slider"></span>
        </label>
    </div>
    <div style="font-size:12px; color:#999; margin-top:-5px;">
        å¼€å¯åï¼ŒAIå¯å‘é€è§’è‰²ç»‘å®šæŒ‡ä»¤ä¸­çš„å›¾ç‰‡
    </div>
</div>

                   
                    <!-- æ ·å¼è°ƒèŠ‚ -->
                    <div class="form-group">
                        <div style="padding:10px 0; font-weight:500; color:#333; display:flex; justify-content:space-between;">
                            <span>é¡µé¢ç¼©æ”¾</span>
                            <span id="scale-value-display" style="color:#007AFF;">100%</span>
                        </div>
                        <input type="range" id="chat-scale-slider" min="0.8" max="1.4" step="0.1" value="1.0" oninput="updateChatScale(this.value)">
                    </div>

                    <div class="form-group">
                        <div style="padding:10px 0; font-weight:500; color:#333; display:flex; justify-content:space-between;">
                            <span>å­—ä½“å¤§å°</span>
                            <span id="font-value-display" style="color:#007AFF;">16px</span>
                        </div>
                        <input type="range" id="chat-font-slider" min="12" max="24" step="1" value="16" oninput="updateChatFontSize(this.value)">
                    </div>

                    <!-- èƒŒæ™¯ -->
                    <div class="form-group">
                        <div style="padding:10px 0; font-weight:500; color:#333;">èŠå¤©èƒŒæ™¯</div>
                        <img id="chat-bg-preview" class="bg-preview" src="" onclick="document.getElementById('chat-bg-file').click()">
                        <input type="file" id="chat-bg-file" hidden accept="image/*" onchange="handleBgUpload(this)">
                        <div style="text-align:right; margin-top:5px;">
                            <span style="font-size:12px; color:#999; cursor:pointer;" onclick="clearChatBg()">æ¢å¤é»˜è®¤èƒŒæ™¯</span>
                        </div>
                    </div>

                    <button class="btn-block danger" onclick="clearCurrentChatHistory()">âš ï¸ æ¸…ç©ºå½“å‰èŠå¤©è®°å½•</button>
                </div>
                <div class="modal-footer">
                    <button class="btn-confirm" onclick="confirmChatSettings()">ä¿å­˜å¹¶å…³é—­</button>
                </div>
            </div>
        </div>

        <!-- å¿ƒå£°å¡ç‰‡ -->
        <div class="thought-modal" id="thought-modal">
            <div class="thought-card">
                <div class="thought-close" onclick="closeThoughtModal()">Ã—</div>
                <div class="thought-title">ğŸ’­ å·å·çœ‹TAåœ¨æƒ³ä»€ä¹ˆ</div>
                <div class="thought-content" id="thought-text"></div>
            </div>
        </div>

    </div>
</div>
<!-- ğŸ‘‡ğŸ‘‡ğŸ‘‡ æŠŠè¿™æ®µä»£ç ç²˜è´´åœ¨è¿™é‡Œ ğŸ‘‡ğŸ‘‡ğŸ‘‡ -->

<!-- â• æ–°å»ºåˆ†ç±»å¼¹çª— -->
<div class="modal-mask" id="modal-add-category">
    <div class="modal-panel" style="height:auto; width:85%;">
        <div class="modal-header">åˆ›å»ºæ–°é¢‘é“</div>
        <div class="modal-body">
            <div class="form-group" style="margin-bottom:0; background:transparent; padding:0;">
                <div class="form-row">
                    <label style="width:70px;">åç§°</label>
                    <input type="text" id="new-cat-name" placeholder="ä¾‹å¦‚: èµ›åšæœ‹å…‹" maxlength="6">
                </div>
                <div class="form-row" style="border-bottom:none;">
                    <label style="width:70px; align-self:flex-start; padding-top:10px;">æè¿°</label>
                    <textarea id="new-cat-desc" rows="3" placeholder="å‘Šè¯‰AIè¿™ä¸ªåˆ†ç±»æ˜¯å…³äºä»€ä¹ˆçš„ï¼Œæ¯”å¦‚ï¼šæœªæ¥çš„é«˜ç§‘æŠ€ä½ç”Ÿæ´»ï¼Œéœ“è™¹ç¯ä¸æœºæ¢°ä¹‰è‚¢..."></textarea>
                </div>
            </div>
            <div style="font-size:12px; color:#999; margin-top:10px; padding:0 10px;">
                * æè¿°è¶Šè¯¦ç»†ï¼Œç”Ÿæˆçš„å¸–å­è¶Šç¬¦åˆä½ çš„å£å‘³
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal('modal-add-category')">å–æ¶ˆ</button>
            <button class="btn-confirm" onclick="confirmAddCategory()">åˆ›å»º</button>
        </div>
    </div>
</div>
<!-- ğŸ”— åŒé¢‘å¸–å­åˆ†äº«å¼¹çª— -->
<div class="share-sheet-mask" id="modal-tp-share">
    <div class="share-panel">
        <!-- æ ‡é¢˜é å·¦ -->
        <div class="share-header" style="text-align: left; padding-left: 20px; font-weight: bold; font-size: 16px; color: #000;">
            åˆ†äº«ç»™è°
        </div>
        <!-- å¥½å‹åˆ—è¡¨å®¹å™¨ -->
        <div class="share-grid" id="tp-share-friend-list">
            <!-- JS ä¼šåœ¨è¿™é‡Œå¡«å……å¤´åƒ -->
        </div>
        <div class="share-cancel" onclick="document.getElementById('modal-tp-share').classList.remove('show')">å–æ¶ˆ</div>
    </div>
</div>
<!-- ... ä¸Šé¢æ˜¯å…¶ä»–çš„å¼¹çª—ä»£ç  ... -->
    
    <!-- ğŸ™ï¸ å½•éŸ³å…¨å±é®ç½©å±‚ -->
    <div id="voice-overlay" class="voice-overlay">
        <!-- ä¸­é—´ï¼šç»¿è‰²æ³¢å½¢/æ–‡å­—æç¤ºåŒº -->
        <div class="voice-center-display">
            <div id="voice-wave-box" class="voice-wave-box hidden">
                <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                <div class="wave-bar"></div><div class="wave-bar"></div>
            </div>
            <div id="voice-status-text" class="voice-status-text">æ¾å¼€ å‘é€</div>
            <div id="voice-realtime-text" class="voice-realtime-text">...</div>
        </div>

        <!-- åº•éƒ¨æ“ä½œåŒº -->
        <div class="voice-controls-area">
            <div class="voice-action-btn" id="btn-voice-cancel">
                <div class="v-btn-icon">âœ•</div>
                <span class="v-btn-label">å–æ¶ˆ</span>
            </div>

            <div class="voice-record-arc" id="btn-voice-record">
                <div class="voice-mic-icon">ğŸ™ï¸</div>
            </div>

            <div class="voice-action-btn" id="btn-voice-trans">
                <div class="v-btn-icon">æ–‡</div>
                <span class="v-btn-label">è½¬æ–‡å­— å‘é€</span>
            </div>
        </div>
    </div>
    

<!-- ğŸ‘†ğŸ‘†ğŸ‘† ç²˜è´´ç»“æŸ ğŸ‘†ğŸ‘†ğŸ‘† -->

<script>
    /* ================= ğŸ§­ æ™ºèƒ½å¯¼èˆªç³»ç»Ÿ (å«åŠ¨ç”») ================= */
    /* ================= ğŸ§­ æ™ºèƒ½å¯¼èˆªç³»ç»Ÿ (å«åŠ¨ç”») ================= */
    
    /* ================= ğŸ§­ æ™ºèƒ½å¯¼èˆªç³»ç»Ÿ (iOS è¦†ç›–é€»è¾‘ä¿®å¤ç‰ˆ) ================= */
    
    /* ================= ğŸ§­ æ™ºèƒ½å¯¼èˆªç³»ç»Ÿ (è½»é‡åŒ–ç‰ˆ) ================= */
    
    /* ================= ğŸ§­ æ™ºèƒ½å¯¼èˆªç³»ç»Ÿ (æœ€ç»ˆå•ä¾‹ç‰ˆ) ================= */
    
    let navStack = ['view-home'];

    // 1. å‰è¿›å‡½æ•°
    function navTo(targetId) {
        const currentId = navStack[navStack.length - 1];
        if (currentId === targetId) return;

        // å¦‚æœç›®æ ‡æ˜¯ä¸Šä¸€ä¸ªé¡µé¢ï¼Œè‡ªåŠ¨è½¬ä¸ºåé€€
        if (navStack.length > 1 && navStack[navStack.length - 2] === targetId) {
            navBack();
            return;
        }

        const currentEl = document.getElementById(currentId);
        const targetEl = document.getElementById(targetId);
        if(!targetEl) return;

        // æ—§é¡µé¢ï¼šé€€å±…å¹•åï¼Œç¦æ­¢ç‚¹å‡»
        if (currentEl) {
            currentEl.classList.remove('active', 'entering', 'exit');
            currentEl.classList.add('background');
        }

        // æ–°é¡µé¢ï¼šè¿›åœºï¼Œæ¿€æ´»ç‚¹å‡»
        targetEl.classList.remove('background', 'exit');
        targetEl.classList.add('entering');
        targetEl.style.display = 'flex'; // ç¡®ä¿æ˜¾ç¤º
        
        // åŠ¨ç”»ç»“æŸå
        setTimeout(() => {
            targetEl.classList.remove('entering');
            targetEl.classList.add('active');
        }, 260); // ç•¥å¤§äºCSSåŠ¨ç”»æ—¶é—´ï¼Œç¡®ä¿ç¨³å®š

        navStack.push(targetId);
    }

    // 2. åé€€å‡½æ•°
    function navBack() {
        if (navStack.length <= 1) return;

        const currentId = navStack.pop();
        const prevId = navStack[navStack.length - 1];

        const currentEl = document.getElementById(currentId);
        const prevEl = document.getElementById(prevId);

        // å½“å‰é¡µï¼šæ»‘å‡º
        if (currentEl) {
            currentEl.classList.remove('active', 'entering');
            currentEl.classList.add('exit');
            
            setTimeout(() => {
                currentEl.classList.remove('exit');
                currentEl.style.display = 'none'; // å½»åº•éšè—ï¼Œé˜²æ­¢é®æŒ¡
            }, 160);
        }

        // ä¸Šä¸€é¡µï¼šæ¢å¤æ¿€æ´»
        if (prevEl) {
            prevEl.classList.remove('background');
            prevEl.classList.add('active');
        }
    }
    // 4. å…¼å®¹æ—§çš„è¿”å›å‡½æ•°
    // (æŠŠä»£ç é‡Œé›¶æ•£çš„è¿”å›å‡½æ•°éƒ½ç»Ÿä¸€æŒ‡å‘è¿™é‡Œ)
    function navBackToMe() { navBack(); }
    function navBackFromPublish() { navBack(); }
    function closeConversation() { navBack(); } // èŠå¤©çª—å£è¿”å›ä¹Ÿèµ°åŠ¨ç”»
        /* ================= æ ¸å¿ƒå·¥å…·: IndexedDB (æµ·é‡å­˜å‚¨) ================= */
    const IDB_NAME = "AIOS_ULTIMATE_DB";
    const IDB_VERSION = 1;
    
    const DB = {
        db: null,
        init: function() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(IDB_NAME, IDB_VERSION);
                request.onerror = (e) => { console.error("DB Error", e); reject(e); };
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    // åˆ›å»ºå¤šä¸ªå¯¹è±¡ä»“åº“ä»£æ›¿å•ä¸€çš„å¤§key
                    if(!db.objectStoreNames.contains('store')) db.createObjectStore('store');
                };
                request.onsuccess = (e) => {
                    this.db = e.target.result;
                    resolve(this.db);
                };
            });
        },
        get: async function(key) {
            if(!this.db) await this.init();
            return new Promise((resolve) => {
                const tx = this.db.transaction(['store'], 'readonly');
                const req = tx.objectStore('store').get(key);
                req.onsuccess = () => resolve(req.result || (key==='api_config'?{}:[]));
                req.onerror = () => resolve(key==='api_config'?{}:[]);
            });
        },
        set: async function(key, val) {
            if(!this.db) await this.init();
            return new Promise((resolve) => {
                const tx = this.db.transaction(['store'], 'readwrite');
                const req = tx.objectStore('store').put(val, key);
                req.onsuccess = () => resolve(true);
                req.onerror = (e) => { console.error("Save Fail", e); resolve(false); };
            });
        },
        getObj: async function(key) {
            const res = await this.get(key);
            return res || {};
        }
    };

    /* ================= è‡ªåŠ¨æ•°æ®è¿ç§» (LocalStorage -> IndexedDB) ================= */
    async function migrateData() {
        const keys = ['sessions', 'characters', 'instructions', 'user_personas', 'api_config'];
        let migrated = false;
        for(const k of keys) {
            const old = localStorage.getItem(k);
            if(old) {
                try {
                    const parsed = JSON.parse(old);
                    await DB.set(k, parsed);
                    localStorage.removeItem(k); // è¿ç§»ååˆ é™¤æ—§æ•°æ®é‡Šæ”¾ç©ºé—´
                    migrated = true;
                } catch(e) {}
            }
        }
        if(migrated) alert("âœ¨ ç³»ç»Ÿå·²å‡çº§ä¸ºæ— é™å­˜å‚¨æ¨¡å¼ï¼æ—§æ•°æ®å·²è‡ªåŠ¨è¿ç§»ã€‚");
    }

    const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
    let currentChatId = null;
    const DEFAULT_AVATAR = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='%23ddd'%3E%3Crect width='100' height='100'/%3E%3Cpath fill='%23fff' d='M50 55a20 20 0 1 0 0-40 20 20 0 0 0 0 40zm0 10c-25 0-40 15-40 35h80c0-20-15-35-40-35z'/%3E%3C/svg%3E";

    /* --- å¤šé€‰æ¨¡å¼å˜é‡ --- */
    let isSelectionMode = false;
    let selectedMsgs = new Set();

    /* ================= ğŸš€ åˆå§‹åŒ–å…¥å£ (é˜²é»‘å±ä¿®å¤ç‰ˆ) ================= */
    window.onload = async function() {
    try {
        updateStatus();
        setInterval(updateStatus, 5000);
        
        // å…³é”®ä¿®æ”¹ï¼šè¶…æ—¶ç›´æ¥è·³è¿‡æ•°æ®åº“ï¼Œä½¿ç”¨å†…å­˜ä¸´æ—¶å­˜å‚¨
        let dbInited = false;
        try {
            await Promise.race([
                DB.init(),
                new Promise(resolve => setTimeout(() => resolve(), 800)) // 800msè¶…æ—¶
            ]);
            dbInited = true;
        } catch (e) {}
        
        // æ•°æ®è¿ç§»åªåœ¨æ•°æ®åº“æˆåŠŸå¯åŠ¨æ—¶æ‰§è¡Œ
        if (dbInited) {
            try { await migrateData(); } catch(e) {}
            try {
                let packs = await DB.get('sticker_packs');
                if (!Array.isArray(packs)) await DB.set('sticker_packs', []);
            } catch(e) {}
        }
        if (dbInited) {
            await initBeautifySettings(); 
        }
        // æ¸²æŸ“å‡½æ•°æ”¹ä¸ºâ€œå¤±è´¥ä¸ä¸­æ–­â€
        const renderFuncs = [
            renderInstructions, renderCharacters, 
            renderUserPersonas, renderChatSessions, renderMoments
        ];
        for (const func of renderFuncs) {
            if (typeof func === 'function') {
                try { await func(); } catch(e) {}
            }
        }
    } catch (e) {
        console.error("å¯åŠ¨é”™è¯¯:", e);
    } finally {
        // å¼ºåˆ¶æ˜¾ç¤ºé¦–é¡µï¼ˆå…³é”®é™çº§é€»è¾‘ï¼‰
        const home = document.getElementById('view-home');
        if (home) {
            home.style.display = 'flex';
            home.classList.remove('background', 'exit');
            home.classList.add('active');
            // ç¡®ä¿æ ·å¼ç”Ÿæ•ˆ
            setTimeout(() => {
                home.style.opacity = '1';
            }, 100);
        }
    }
};


    function updateStatus() {
        const d = new Date();
        document.getElementById('status-time').innerText = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        if(navigator.getBattery) navigator.getBattery().then(b => document.getElementById('status-battery').innerText = Math.round(b.level*100)+'%');
    }

    function handleImageUpload(input, previewId) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 200; // å¤´åƒç¨å¾®å¤§ä¸€ç‚¹ç‚¹
                    const scaleSize = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scaleSize;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    document.getElementById(previewId).src = canvas.toDataURL('image/jpeg', 0.7);
                }
            }
            reader.readAsDataURL(file);
        }
    }

    function handleBgUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 800; // èƒŒæ™¯å›¾å…è®¸æ›´é«˜æ¸…
                    const scaleSize = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scaleSize;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    document.getElementById('chat-bg-preview').src = canvas.toDataURL('image/jpeg', 0.7);
                }
            }
            reader.readAsDataURL(file);
        }
    }

    function updateChatScale(val) {
        document.documentElement.style.setProperty('--chat-scale', val);
        document.getElementById('scale-value-display').innerText = Math.round(val * 100) + '%';
        document.getElementById('chat-scale-slider').value = val;
    }

    function updateChatFontSize(val) {
        document.documentElement.style.setProperty('--chat-font-size', val + 'px');
        document.getElementById('font-value-display').innerText = val + 'px';
        document.getElementById('chat-font-slider').value = val;
    }

    function updateMemoryLimit(val) {
        document.getElementById('memory-limit-display').innerText = val;
    }

    /* ================= å¯¼èˆª ================= */
    

    /* ================= å¿ƒå£°æµ®çª—é€»è¾‘ ================= */
    /* ================= å¿ƒå£°æµ®çª—é€»è¾‘ (æ— åŠ¨ç”»ç§’æ˜¾ç‰ˆ) ================= */
    async function showThought(timeId) {
        // å¦‚æœæ­£åœ¨å¤šé€‰åˆ é™¤æ¨¡å¼ï¼Œå°±ä¸å¼¹çª—
        if(isSelectionMode) return;

        const sessList = await DB.get('sessions');
        const sess = sessList.find(s => s.id === currentChatId);
        if(!sess) return;
        
        const msg = sess.msgs.find(m => m.t == timeId);
        // å¦‚æœæ²¡æ‰¾åˆ°æ¶ˆæ¯ï¼Œæˆ–è€…æ˜¯ç”¨æˆ·è‡ªå·±å‘çš„æ¶ˆæ¯ï¼Œå°±ä¸å¼¹çª—
        if(!msg || msg.role === 'user') return;

        const thoughtText = msg.thought || "ï¼ˆæ­¤åˆ»æ²¡æœ‰ç‰¹æ®Šæƒ³æ³•...ï¼‰";
        const modal = document.getElementById('thought-modal');
        const content = document.getElementById('thought-text');
        
        modal.classList.add('show');
        
        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ æ ¸å¿ƒä¿®æ”¹ï¼šç›´æ¥èµ‹å€¼ï¼Œæ²¡æœ‰ä»»ä½•åŠ¨ç”»å’Œå»¶è¿Ÿ ğŸ‘‡ğŸ‘‡ğŸ‘‡
        content.innerText = thoughtText;
    }
    function closeThoughtModal() { document.getElementById('thought-modal').classList.remove('show'); }

    /* ================= API ================= */
    /* ================= API (å¸¦å¼¹çª—ç‰ˆ) ================= */
    function fetchApiModels() {
        const url = document.getElementById('api-url').value.replace(/\/$/, '');
        const key = document.getElementById('api-key').value;
        
        if(!url || !key) return alert("è¯·å¡«å†™å®Œæ•´ URL å’Œ å¯†é’¥");
        
        // 1. æ‰“å¼€åŠ è½½å¼¹çª—
        openModal('modal-loading');

        let ep = url.includes('/models') ? url : `${url}/models`;
        if(!ep.includes('/v1') && !ep.includes('moonshot')) ep = `${url}/v1/models`;

        fetch(ep, { headers: {'Authorization': `Bearer ${key}`} })
        .then(r => r.json())
        .then(d => {
            const list = d.data || d;
            const sel = document.getElementById('api-model-select');
            sel.innerHTML = '';
            if(Array.isArray(list)) {
                list.forEach(m => {
                    let opt = document.createElement('option'); opt.value=m.id; opt.innerText=m.id; sel.appendChild(opt);
                });
                // 2. æˆåŠŸäº†ï¼Œå…³é—­å¼¹çª—
                closeModal('modal-loading');
                alert("âœ… æ¨¡å‹åˆ—è¡¨å·²æ›´æ–°ï¼");
            } else {
                alert("âŒ æ‹‰å–å¤±è´¥ï¼šè¿”å›æ ¼å¼ä¸æ­£ç¡®");
            }
        })
        .catch(e => {
            alert("âŒ å‡ºé”™äº†: "+e.message);
        })
        .finally(() => {
            // 3. æ— è®ºæˆåŠŸå¤±è´¥ï¼Œæœ€åéƒ½ç¡®ä¿å…³é—­å¼¹çª—
            closeModal('modal-loading');
        });
    }
    async function saveApiConfig() {
        await DB.set('api_config', {
            url: document.getElementById('api-url').value,
            key: document.getElementById('api-key').value,
            model: document.getElementById('api-model-select').value
        });
        alert("å·²ä¿å­˜"); navBack();
    }
    
    (async function loadApiCfg() {
        const _c = await DB.getObj('api_config');
        if(_c.url) document.getElementById('api-url').value=_c.url;
        if(_c.key) document.getElementById('api-key').value=_c.key;
        if(_c.model) { let o=document.createElement('option'); o.value=_c.model; o.innerText=_c.model; document.getElementById('api-model-select').appendChild(o); }
        renderApiPresets(); 
    })();

    /* ================= æŒ‡ä»¤ ================= */
    async function renderInstructions() {
        const list = await DB.get('instructions');
        const div = document.getElementById('list-instruction');
        div.innerHTML = '';
        list.forEach(i => {
            div.innerHTML += `<div class="list-item"><div class="item-main" onclick="editInst('${i.id}')"><div class="item-text"><h3>${i.title}</h3><p>${i.content}</p></div></div><button class="nav-btn danger" onclick="delInst('${i.id}')">ğŸ—‘ï¸</button></div>`;
        });
    }
    async function saveInstruction() {
        const id = document.getElementById('inst-id').value, title = document.getElementById('inst-name').value, content = document.getElementById('inst-content').value;
        if(!title) return alert("åç§°å¿…å¡«");
        let list = await DB.get('instructions');
        if(id) { let idx = list.findIndex(x=>x.id==id); list[idx] = {id, title, content}; }
        else list.push({id:uuid(), title, content});
        await DB.set('instructions', list); closeModal('modal-instruction'); renderInstructions();
    }
    async function editInst(id) {
        const list = await DB.get('instructions');
        const i = list.find(x=>x.id==id);
        document.getElementById('inst-id').value=id; document.getElementById('inst-name').value=i.title; document.getElementById('inst-content').value=i.content;
        openModal('modal-instruction');
    }
    async function delInst(id) { 
        if(confirm('åˆ ?')) { 
            let list = await DB.get('instructions');
            await DB.set('instructions', list.filter(x=>x.id!=id)); renderInstructions(); 
        } 
    }

    /* ================= è§’è‰² ================= */
    async function renderCharacters() {
        const list = await DB.get('characters');
        const div = document.getElementById('list-character');
        div.innerHTML = '';
        list.forEach(c => {
            const ava = c.avatar || DEFAULT_AVATAR;
            div.innerHTML += `<div class="list-item"><div class="item-main" onclick="editChar('${c.id}')"><img src="${ava}" class="avatar"><div class="item-text"><h3>${c.name}</h3><p>${c.prompt}</p></div></div><button class="nav-btn danger" onclick="delChar('${c.id}')">ğŸ—‘ï¸</button></div>`;
        });
    }
    // æ‰“å¼€è§’è‰²ç¼–è¾‘å¼¹çª— (ç¡®ä¿æ­£ç¡®å›æ˜¾å‹¾é€‰çŠ¶æ€)
async function openCharacterModal(id=null) {
    if(id) {
        const list = await DB.get('characters');
        const c = list.find(x => x.id == id);
        document.getElementById('char-id').value = id; 
        document.getElementById('char-name').value = c.name; 
        document.getElementById('char-prompt').value = c.prompt; 
        document.getElementById('char-avatar-preview').src = c.avatar || DEFAULT_AVATAR;
    } else {
        document.getElementById('char-id').value = ''; 
        document.getElementById('char-name').value = ''; 
        document.getElementById('char-prompt').value = ''; 
        document.getElementById('char-avatar-preview').src = DEFAULT_AVATAR; 
        document.getElementById('char-avatar-file').value = '';
    }
    
    // 1. è·å–æ‰€æœ‰å¯ç”¨æŒ‡ä»¤
    const insts = await DB.get('instructions');
    const box = document.getElementById('char-inst-select-list'); 
    box.innerHTML = '';
    
    // 2. è·å–å½“å‰è§’è‰²å·²ä¿å­˜çš„æŒ‡ä»¤åˆ—è¡¨
    let curInsts = [];
    if(id) {
        const list = await DB.get('characters');
        const char = list.find(x => x.id == id);
        if (char && char.insts) {
            curInsts = char.insts; // è¿™é‡Œå­˜çš„æ˜¯ ID æ•°ç»„ ['inst_1', 'inst_2']
        }
    }
    
    // 3. æ¸²æŸ“å‹¾é€‰æ¡†
    insts.forEach(ins => {
        // åˆ¤æ–­æ˜¯å¦åº”è¯¥æ‰“å‹¾
        const isChecked = curInsts.includes(ins.id) ? 'checked' : '';
        
        box.innerHTML += `
            <div class="select-row" onclick="this.querySelector('input').click()">
                <input type="checkbox" name="char-inst-chk" value="${ins.id}" ${isChecked} onclick="event.stopPropagation()">
                <div style="display:flex; flex-direction:column;">
                    <span style="font-weight:bold; font-size:14px;">${ins.title}</span>
                    <span style="font-size:11px; color:#999; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:200px;">${ins.content}</span>
                </div>
            </div>`;
    });
    
    openModal('modal-character');
}
    function editChar(id) { openCharacterModal(id); }
    // ä¿å­˜è§’è‰² (ä¸¥æ ¼ä¿å­˜å‹¾é€‰åˆ—è¡¨)
async function saveCharacter() {
    const id = document.getElementById('char-id').value;
    const name = document.getElementById('char-name').value;
    const prompt = document.getElementById('char-prompt').value;
    const avatarSrc = document.getElementById('char-avatar-preview').getAttribute('src');
    const avatar = (avatarSrc === DEFAULT_AVATAR) ? '' : avatarSrc;
    
    if(!name) return alert("åç§°å¿…å¡«");
    
    // 1. è·å–æ‰€æœ‰è¢«å‹¾é€‰çš„å¤é€‰æ¡†
    const checkedBoxes = Array.from(document.getElementsByName('char-inst-chk')).filter(c => c.checked);
    // 2. æå–å®ƒä»¬çš„ value (å³æŒ‡ä»¤ID)
    const instIds = checkedBoxes.map(c => c.value);
    
    let list = await DB.get('characters');
    
    if(id) { 
        let idx = list.findIndex(x => x.id == id); 
        // æ›´æ–°æ—¶ï¼Œè¦†ç›– insts å­—æ®µ
        list[idx] = { id, name, prompt, avatar, insts: instIds }; 
    } else { 
        // æ–°å»ºæ—¶
        list.push({ id: uuid(), name, prompt, avatar, insts: instIds }); 
    }
    
    await DB.set('characters', list); 
    closeModal('modal-character'); 
    renderCharacters();
    
    // è¿™é‡Œçš„æç¤ºèƒ½è®©ä½ ç¡®ä¿¡æ“ä½œæˆåŠŸ
    // alert(`ä¿å­˜æˆåŠŸï¼å½“å‰å·²å¯ç”¨ ${instIds.length} æ¡æŒ‡ä»¤ã€‚`); 
}
    async function delChar(id) { 
        if(confirm('åˆ ?')) { 
            let list = await DB.get('characters');
            await DB.set('characters', list.filter(x=>x.id!=id)); renderCharacters(); 
        } 
    }

    /* ================= èŠå¤©APP ================= */
    /* ================= èŠå¤©APP ================= */
    /* ================= ğŸ® å¢å¼ºç‰ˆ Tab åˆ‡æ¢ (å«æœå†»ç‰¹æ•ˆ) ================= */
    function switchChatTab(tab) {
        // 1. å®šä¹‰ Tab é¡ºåº (å¿…é¡»å’Œ HTML é‡Œçš„é¡ºåºä¸€è‡´)
        const tabs = ['msg', 'character', 'circle', 'me'];
        
        // 2. è·å–æ‰€æœ‰çš„æŒ‰é’®å…ƒç´ 
        const allBtns = document.querySelectorAll('.chat-tabs .tab-btn');

        tabs.forEach((t, i) => {
            // A. æ§åˆ¶é¡µé¢çš„æ˜¾ç¤º/éšè—
            const view = document.getElementById('tab-view-' + t);
            if (view) {
                view.style.display = (tab === t) ? 'flex' : 'none';
            }
            
            // B. å¤„ç†æŒ‰é’®æ ·å¼
            const btn = allBtns[i];
            if (btn) {
                // å¦‚æœè¿™ä¸ªæ˜¯å½“å‰é€‰ä¸­çš„ Tab
                if (tab === t) {
                    btn.classList.add('active'); // å˜è“
                    
                    // âœ¨âœ¨âœ¨ æ ¸å¿ƒï¼šè§¦å‘æœå†»ç‰¹æ•ˆ âœ¨âœ¨âœ¨
                    // 1. å…ˆç§»é™¤åŠ¨ç”»ç±» (é˜²æ­¢è¿ç»­ç‚¹å‡»æ²¡ååº”)
                    btn.classList.remove('jelly-active');
                    
                    // 2. å¼ºåˆ¶æµè§ˆå™¨â€œé‡ç»˜â€ä¸€ä¸‹ (é­”æ³•æ­¥éª¤)
                    void btn.offsetWidth; 
                    
                    // 3. å†åŠ ä¸ŠåŠ¨ç”»ç±»ï¼Œå®ƒå°±ä¼šé‡æ–°è·³ä¸€æ¬¡
                    btn.classList.add('jelly-active');
                    
                    // 4. åŠ¨ç”»æ’­å®Œå(0.5s)æ¸…ç†æ‰ï¼Œä¿æŒå¹²å‡€
                    setTimeout(() => {
                        btn.classList.remove('jelly-active');
                    }, 500);
                    
                } else {
                    btn.classList.remove('active'); // å˜ç°
                }
            }
        });

        // 3. åˆ·æ–°å¯¹åº”é¡µé¢çš„æ•°æ®
        if(tab=='me') renderUserPersonas();
        if(tab=='msg') renderChatSessions();
        if(tab=='character') renderCharacters();
    }
    async function renderUserPersonas() {
        const list = await DB.get('user_personas');
        const div = document.getElementById('list-user-personas'); div.innerHTML='';
        list.forEach(p => {
            const ava = p.avatar || DEFAULT_AVATAR;
            div.innerHTML += `<div class="list-item"><div class="item-main" onclick="editUserPersona('${p.id}')"><img src="${ava}" class="avatar"><div class="item-text"><h3>${p.name}</h3><p>${p.desc||''}</p></div></div><button class="nav-btn danger" onclick="delUserPersona('${p.id}')">ğŸ—‘ï¸</button></div>`;
        });
    }
    async function openUserPersonaModal(id=null) {
        if(id) {
            const list = await DB.get('user_personas');
            const p=list.find(x=>x.id==id);
            document.getElementById('user-id').value=id; document.getElementById('user-name').value=p.name; document.getElementById('user-desc').value=p.desc; document.getElementById('user-prompt').value=p.prompt; document.getElementById('user-avatar-preview').src=p.avatar||DEFAULT_AVATAR;
        } else {
            document.getElementById('user-id').value=''; document.getElementById('user-name').value=''; document.getElementById('user-desc').value=''; document.getElementById('user-prompt').value=''; document.getElementById('user-avatar-preview').src=DEFAULT_AVATAR; document.getElementById('user-avatar-file').value='';
        }
        openModal('modal-user-persona');
    }
    function editUserPersona(id) { openUserPersonaModal(id); }
    async function saveUserPersona() {
        const id=document.getElementById('user-id').value, name=document.getElementById('user-name').value, desc=document.getElementById('user-desc').value, prompt=document.getElementById('user-prompt').value, avatarSrc=document.getElementById('user-avatar-preview').getAttribute('src');
        const avatar = (avatarSrc === DEFAULT_AVATAR) ? '' : avatarSrc;
        if(!name) return alert("åç§°å¿…å¡«");
        let list = await DB.get('user_personas');
        if(id) { let idx=list.findIndex(x=>x.id==id); list[idx]={id, name, desc, prompt, avatar}; }
        else list.push({id:uuid(), name, desc, prompt, avatar});
        await DB.set('user_personas', list); closeModal('modal-user-persona'); renderUserPersonas();
    }
    async function delUserPersona(id) { 
        if(confirm('åˆ ?')) { 
            let list = await DB.get('user_personas');
            await DB.set('user_personas', list.filter(x=>x.id!=id)); renderUserPersonas(); 
        } 
    }

    /* ================= èŠå¤©ä¼šè¯åˆ—è¡¨ ================= */
    function togglePopMenu() { document.getElementById('chat-pop-menu').classList.toggle('show'); }
    
    /* ================= ä¿®å¤åçš„èŠå¤©ä¼šè¯åˆ—è¡¨ ================= */
    async function renderChatSessions() {
        const list = await DB.get('sessions');
        const characters = await DB.get('characters');
        const div = document.getElementById('list-sessions'); 
        div.innerHTML = '';
        
        list.forEach(s => {
            if (s.isHidden) return;
            let name=s.name, avatar=s.avatar;
            if(s.type=='direct') { const c=characters.find(x=>x.id==s.targetId); if(c){name=c.name; avatar=c.avatar;} }
            avatar = avatar || DEFAULT_AVATAR;
            
            let last = 'æ— æ¶ˆæ¯';
            if(s.msgs.length) {
                const m = s.msgs[s.msgs.length-1];
                
                // ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤ç‚¹åœ¨è¿™é‡Œ ğŸ”¥ğŸ”¥ğŸ”¥
                // åŸæ¥çš„ä»£ç ç›´æ¥è¯»å– m.contentï¼Œå¦‚æœæ˜¯è½¬è´¦æ¶ˆæ¯ï¼Œcontentå¯èƒ½æ˜¯nullï¼Œç›´æ¥æŠ¥é”™
                // ç°åœ¨æˆ‘ä»¬åŠ ä¸ªä¿é™©ï¼šå¦‚æœæ²¡æœ‰å†…å®¹ï¼Œå°±é»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸²
                const content = m.content || ''; 

                // é’ˆå¯¹è½¬è´¦æ¶ˆæ¯çš„ç‰¹æ®Šæ˜¾ç¤º
                if (m.type === 'transfer') {
                    last = `[è½¬è´¦] Â¥${m.amount}`;
                } 
                else if(content.includes('(img:')) {
                    last = '[å›¾ç‰‡]';
                }
                else if(content.startsWith('data:image')) {
                    last = '[ç”¨æˆ·å›¾ç‰‡]';
                }
                else {
                    // ç§»é™¤HTMLæ ‡ç­¾ï¼Œåªæ˜¾ç¤ºçº¯æ–‡æœ¬
                    last = content.replace(/<[^>]+>/g,'');
                }
            }

            const item = document.createElement('div');
            item.className = 'list-item';
            item.style.cssText = 'border-radius:0; margin:0; border-bottom:1px solid #f0f0f0; box-shadow:none;';
            item.innerHTML = `<div class="item-main"><img src="${avatar}" class="avatar"><div class="item-text"><h3>${name}</h3><p>${last}</p></div></div>`;

            let pressTimer;
            let isLongPress = false;
            const startPress = () => { isLongPress = false; pressTimer = setTimeout(() => { isLongPress = true; if(confirm(`ç¡®å®šè¦åˆ é™¤ä¸ ${name} çš„ä¼šè¯å—ï¼Ÿ`)) deleteSession(s.id); }, 800); };
            const cancelPress = () => { clearTimeout(pressTimer); };
            const handleClick = () => { if(!isLongPress) enterChat(s.id); };

            item.addEventListener('touchstart', startPress);
            item.addEventListener('touchend', cancelPress);
            item.addEventListener('touchmove', cancelPress);
            item.addEventListener('mousedown', startPress);
            item.addEventListener('mouseup', cancelPress);
            item.addEventListener('click', handleClick);

            div.appendChild(item);
        });
    }
    async function deleteSession(sid) {
        let list = await DB.get('sessions');
        list = list.filter(s => s.id !== sid);
        await DB.set('sessions', list);
        renderChatSessions();
    }

    async function openSelectChatModal() {
        togglePopMenu();
        const list = await DB.get('characters');
        const box = document.getElementById('chat-select-list'); box.innerHTML='';
        list.forEach(c => {
            const ava = c.avatar || DEFAULT_AVATAR;
            box.innerHTML += `<div class="select-row" onclick="createDirectSession('${c.id}')"><img src="${ava}" style="width:30px;height:30px;border-radius:4px"><b>${c.name}</b></div>`;
        });
        openModal('modal-select-chat');
    }
    async function createDirectSession(cid) {
        let list = await DB.get('sessions');
        const ex = list.find(s=>s.type=='direct' && s.targetId==cid);
        if(ex) { closeModal('modal-select-chat'); enterChat(ex.id); return; }
        
        const chars = await DB.get('characters');
        const c = chars.find(x=>x.id==cid);
        const s = {id:uuid(), type:'direct', targetId:cid, name:c.name, avatar:c.avatar, msgs:[], memoryLimit:20, summaries:[], refinedMemories:[]};
        list.push(s); await DB.set('sessions', list); closeModal('modal-select-chat'); renderChatSessions(); enterChat(s.id);
    }
    async function openCreateGroupModal() {
        togglePopMenu();
        const list = await DB.get('characters');
        const box = document.getElementById('group-member-select'); box.innerHTML='';
        list.forEach(c => {
            const ava = c.avatar || DEFAULT_AVATAR;
            box.innerHTML += `<div class="select-row"><input type="checkbox" name="grp-mem-chk" value="${c.id}"><img src="${ava}" style="width:30px;height:30px;border-radius:4px"><span>${c.name}</span></div>`;
        });
        document.getElementById('group-name').value=''; document.getElementById('group-avatar-preview').src=DEFAULT_AVATAR; document.getElementById('group-avatar-file').value='';
        openModal('modal-create-group');
    }
    async function confirmCreateGroup() {
        const name=document.getElementById('group-name').value, avatarSrc=document.getElementById('group-avatar-preview').getAttribute('src');
        const avatar = (avatarSrc === DEFAULT_AVATAR) ? '' : avatarSrc;
        const mids = Array.from(document.getElementsByName('grp-mem-chk')).filter(c=>c.checked).map(c=>c.value);
        if(!name) return alert("ç¾¤å?"); if(mids.length<2) return alert("è‡³å°‘2äºº");
        const s = {id:uuid(), type:'group', memberIds:mids, name, avatar, msgs:[], memoryLimit:20, summaries:[], refinedMemories:[]};
        const list = await DB.get('sessions'); list.push(s); await DB.set('sessions', list); closeModal('modal-create-group'); renderChatSessions();
    }

    /* ================= å¯¹è¯çª—å£ ================= */
    /* ================= æ ¸å¿ƒä¿®å¤ï¼šæ— ç¼è¿›å…¥èŠå¤© (é˜²æ­¢æ–‡å­—é—ªçƒ) ================= */
    async function enterChat(sid) {
        currentChatId = sid;
        
        // 1. å…ˆå»æ‹¿æ•°æ® (è¿™æ—¶å€™ç•Œé¢è¿˜æ˜¯éšè—çš„ï¼Œç”¨æˆ·çœ‹ä¸è§)
        const sessions = await DB.get('sessions');
        const s = sessions.find(x => x.id == sid);
        
        // 2. å‡†å¤‡æ ‡é¢˜
        let t = s.name;
        if(s.type=='direct') { 
            const chars = await DB.get('characters');
            const c = chars.find(x=>x.id==s.targetId); 
            if(c) t=c.name; 
        }
        document.getElementById('chat-title').innerText = t;
        
        // 3. å‡†å¤‡èƒŒæ™¯å›¾ (åœ¨æ»‘å…¥ä¹‹å‰å°±æ¢å¥½ï¼Œé˜²æ­¢èƒŒæ™¯ç™½å±)
        const bg = document.getElementById('chat-msg-container');
        if (s.bgImage) {
            bg.style.backgroundImage = `url('${s.bgImage}')`;
        } else {
            bg.style.backgroundImage = 'none';
        }

        // 4. â˜…â˜…â˜… å…³é”®æ­¥éª¤ï¼šå…ˆæ¸²æŸ“æ¶ˆæ¯ï¼Œå†è·³è½¬ï¼â˜…â˜…â˜…
        // æˆ‘ä»¬åŠ ä¸Š awaitï¼Œç¡®ä¿ HTML ç”Ÿæˆå®Œæ¯•æ’å…¥åˆ° DOM åï¼Œä»£ç æ‰ä¼šç»§ç»­å¾€ä¸‹èµ°
        await renderMessages(); 

        // 5. æ¶ˆæ¯éƒ½å¡«å¥½äº†ï¼Œç°åœ¨å¼€å§‹æ»‘å…¥é¡µé¢ (è¿™æ—¶å€™ç”¨æˆ·çœ‹åˆ°çš„å°±æ˜¯æ»¡å†…å®¹çš„é¡µé¢äº†)
        navTo('view-conversation'); 
        
        // 6. å†æ¬¡å¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨
        // (å› ä¸ºåœ¨ç¬¬4æ­¥æ¸²æŸ“æ—¶é¡µé¢æ˜¯éšè—çš„ï¼Œæµè§ˆå™¨å¯èƒ½æ— æ³•å‡†ç¡®è®¡ç®—é«˜åº¦ï¼Œæ‰€ä»¥æ˜¾ç¤ºåè¦ç«‹å³å†æ»šä¸€æ¬¡)
        requestAnimationFrame(() => {
            bg.scrollTop = bg.scrollHeight;
        });

        exitSelectionMode();
    }
    async function closeConversation() { navTo('view-chat-app'); renderChatSessions(); exitSelectionMode(); }
    
    async function renderMessages() {
        // ä¼˜åŒ–ï¼šç›´æ¥å¤ç”¨ currentChatIdï¼Œä¸é‡å¤è¯»åº“
        const sessions = await DB.get('sessions');
        const s = sessions.find(x => x.id == currentChatId);
        if (!s) return; // é˜²æ­¢æ‰¾ä¸åˆ°æŠ¥é”™

        const box = document.getElementById('chat-msg-container'); 
        
        // 1. å…ˆæ¸…ç©ºï¼Œé˜²æ­¢æ—§æ¶ˆæ¯æ®‹ç•™ (è™½ç„¶æ˜¯åœ¨åå°åšï¼Œä½†ä¹Ÿæ˜¯å¥½ä¹ æƒ¯)
        box.innerHTML = '';
        
        const userPersonas = await DB.get('user_personas');
        const characters = await DB.get('characters');

        // === â° æ—¶é—´æˆ³è®¡ç®— ===
        let lastMsgTime = 0; 

        // 2. ä¹Ÿæ˜¯åœ¨åå°é»˜é»˜ç”Ÿæˆæ‰€æœ‰çš„ HTML
        // ä½¿ç”¨ Fragment æˆ–è€…ç´¯åŠ  HTML å­—ç¬¦ä¸²ï¼Œè¿™é‡Œç”¨ç°æœ‰çš„é€»è¾‘å³å¯
        let finalHTML = '';

        s.msgs.forEach(m => {
            // æ—¶é—´æˆ³é€»è¾‘
            if (m.t - lastMsgTime > 5 * 60 * 1000) {
                const timeStr = formatChatTime(m.t);
                finalHTML += `<div class="chat-time-stamp">${timeStr}</div>`;
            }
            lastMsgTime = m.t;

            // æ¶ˆæ¯å¡ç‰‡é€»è¾‘
            finalHTML += createMsgHtml(m, userPersonas, characters);
        });
        
        // 3. ä¸€æ¬¡æ€§æ’å…¥ DOM (æ€§èƒ½æœ€é«˜)
        box.innerHTML = finalHTML;
        
        // 4. å°è¯•æ»šåŠ¨ (è™½ç„¶æ­¤æ—¶å¯èƒ½è¿˜ä¸å¯è§ï¼Œä½†å…ˆæ»šä¸€æ¬¡æ²¡é”™)
        box.scrollTop = box.scrollHeight;
    }

    function createMsgHtml(m, userPersonas, characters) {
        // 1. å¤„ç†ç³»ç»Ÿå°ç°æ¡
        if (m.type === 'system') {
            return `<div class="system-msg-row"><div class="system-msg-bubble">${m.content}</div></div>`;
        }

        const me = m.role==='user';
        let ava = '';
        if(me) { 
            const p=userPersonas.find(x=>x.id==m.personaId); 
            ava = p ? (p.avatar || DEFAULT_AVATAR) : (userPersonas[0] && userPersonas[0].avatar || DEFAULT_AVATAR); 
        } else { 
            const c=characters.find(x=>x.id==m.senderId); 
            ava = c ? (c.avatar || DEFAULT_AVATAR) : DEFAULT_AVATAR; 
        }
        
        let contentHtml = '';
        let bubbleClass = 'msg-bubble';

        // ğŸ›¡ï¸ å®‰å…¨è·å–å†…å®¹ï¼Œé˜²æ­¢æŠ¥é”™ï¼ˆè¿™æ˜¯ä¿®å¤çš„æ ¸å¿ƒï¼‰
        const safeContent = m.content || ""; 

        // --- å¼€å§‹åˆ¤æ–­æ¶ˆæ¯ç±»å‹ (å¿…é¡»è¿åœ¨ä¸€èµ·å†™) ---

        // 2. å¤„ç†è½¬è´¦å¡ç‰‡
        if (m.type === 'transfer') {
            const isPending = m.transStatus === 'pending';
            bubbleClass = `msg-bubble is-transfer ${!isPending ? 'done' : ''}`;
            
            let statusText = '';
            let icon = 'Â¥';
            let clickAttr = ''; 

            if (isPending) {
                if (me) {
                    statusText = 'ç­‰å¾…å¯¹æ–¹ç¡®è®¤';
                } else {
                    statusText = 'ç‚¹å‡»ç¡®è®¤æ”¶æ¬¾';
                    clickAttr = `onclick="openReceiveModal('${m.t}', '${m.amount}', '${m.desc || 'è½¬è´¦'}')"`;
                }
            } else {
                if (m.transStatus === 'accepted') {
                    statusText = 'å·²æ”¶é’±';
                    icon = 'âœ”';
                } else {
                    statusText = 'å·²é€€è¿˜';
                    icon = 'âœ•';
                }
            }

            contentHtml = `
                <div class="transfer-top" ${clickAttr} style="${clickAttr ? 'cursor:pointer' : ''}">
                    <div class="transfer-icon-circle">${icon}</div>
                    <div class="transfer-info">
                        <div class="transfer-amount">Â¥${m.amount}</div>
                        <div class="transfer-desc">${m.desc || 'è½¬è´¦'}</div>
                    </div>
                </div>
                <div class="transfer-bottom">
                    <span>è½¬è´¦</span>
                    <span>${statusText}</span>
                </div>
            `;
        }
        // 3. åˆ†äº«å¡ç‰‡
        else if (m.isShare && m.momentData) {
            bubbleClass = 'msg-bubble is-card';
            const clickAttr = `onclick="tryJumpToPost(event, '${m.t}')"`;
            
            contentHtml = `
                <div class="card-content" ${clickAttr} style="cursor:pointer;">
                    <div class="card-header">
                        <img src="${m.momentData.avatar || DEFAULT_AVATAR}" class="card-avatar">
                        <span class="card-title">${m.momentData.name}</span>
                    </div>
                    <div class="card-text">${m.momentData.text}</div>
                </div>
                <div class="card-footer">
                    <span style="font-size:10px"></span> åŒé¢‘å°ç»„å¸–å­
                </div>
            `;
        } 
        // ğŸ†• 4. æ„å¿µ/æ¨¡æ‹Ÿç…§ç‰‡ (sim_img:...) 
        // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨äº† safeContent.matchï¼Œä¸”æ”¾åœ¨ else if é“¾æ¡ä¸­
        else if (safeContent.match(/\(sim_img:\s*(.*?)\s*\)/)) {
            bubbleClass = 'msg-bubble is-sim-photo';
            const simMatch = safeContent.match(/\(sim_img:\s*(.*?)\s*\)/);
            const desc = simMatch[1];
            // æ¸²æŸ“æˆç›¸æ¡†
            contentHtml = `
                <div class="sim-photo-frame">
                    <div class="sim-photo-icon"></div>
                    <div class="sim-photo-text">â€œ${desc}â€</div>
                </div>
            `;
        }
        // 5. æ™®é€šå›¾ç‰‡
        else if (m.image) {
            bubbleClass = 'msg-bubble is-image';
            contentHtml = `<img src="${m.image}" class="sticker-img">`;
        } 
        // 6. åŒ…å« (img:...) çš„æ–‡æœ¬
        else if (safeContent.includes('(img:')) {
            const imgRegex = /\(img:\s*(.*?)\s*\)/;
            const match = safeContent.match(imgRegex);
            if (match) {
                bubbleClass = 'msg-bubble is-image';
                contentHtml = `<img src="${match[1]}" class="sticker-img">`;
            } else {
                contentHtml = safeContent;
            }
        } 
        // 8. ğŸ™ï¸ è¯­éŸ³æ¶ˆæ¯ (æ–°å¢)
        else if (m.type === 'voice') {
            bubbleClass = 'msg-bubble is-voice';
            // ä½¿ç”¨ transform æ¨¡æ‹Ÿ wifi ä¿¡å·å›¾æ ‡å‘å³
            const wifiIcon = '<span style="transform: rotate(90deg); display:inline-block; letter-spacing:-2px; font-weight:bold;">(((</span>';
            
            contentHtml = `
                <div class="voice-content-row" onclick="playVoice('${m.t}', '${m.voiceData}')">
                    <span class="voice-duration" style="margin-right:5px;">${m.duration}"</span>
                    <span id="voice-icon-${m.t}" class="voice-icon">${wifiIcon}</span> 
                    <span class="voice-to-text-btn" onclick="event.stopPropagation(); toggleVoiceTextResult('${m.t}')">è½¬æ–‡å­—</span>
                </div>
                <div id="voice-trans-${m.t}" class="voice-trans-result">
                    ${m.transcription || 'æ— æ–‡å­—å†…å®¹'}
                </div>
            `;
        }
        // 7. æ™®é€šæ–‡æœ¬
        else {
            contentHtml = safeContent;
        }
        
        const clickAction = me ? '' : `onclick="showThought('${m.t}')"`;
        const longPressAction = `oncontextmenu="return false;" onmousedown="startMsgLongPress('${m.t}')" ontouchstart="startMsgLongPress('${m.t}')" onclick="handleMsgClick('${m.t}')"`;

        return `
            <div class="msg-row ${me?'me':'ai'}" id="msg-${m.t}" ${longPressAction}>
                <div class="msg-checkbox"></div>
                <img src="${ava}" class="msg-avatar" ${clickAction}>
                <div class="${bubbleClass}">${contentHtml}</div>
            </div>`;
    }

    /* ================= â˜…â˜…â˜… å¤šé€‰åˆ é™¤é€»è¾‘ â˜…â˜…â˜… ================= */
    let msgPressTimer;
    function startMsgLongPress(mid) {
        if(isSelectionMode) return;
        msgPressTimer = setTimeout(() => { enterSelectionMode(); toggleMsgSelection(mid); }, 800);
    }
    window.addEventListener('mouseup', () => clearTimeout(msgPressTimer));
    window.addEventListener('touchend', () => clearTimeout(msgPressTimer));
    window.addEventListener('touchmove', () => clearTimeout(msgPressTimer));

    function enterSelectionMode() {
        isSelectionMode = true; selectedMsgs.clear();
        document.getElementById('chat-msg-container').classList.add('selection-mode');
        document.getElementById('selection-toolbar').classList.add('show');
        document.getElementById('chat-input-bar').style.display = 'none';
    }
    function exitSelectionMode() {
        isSelectionMode = false; selectedMsgs.clear();
        document.getElementById('chat-msg-container').classList.remove('selection-mode');
        document.getElementById('selection-toolbar').classList.remove('show');
        document.getElementById('chat-input-bar').style.display = 'flex';
        document.querySelectorAll('.msg-row.selected').forEach(el => el.classList.remove('selected'));
    }
    function handleMsgClick(mid) { if(isSelectionMode) toggleMsgSelection(mid); }
    function toggleMsgSelection(mid) {
        const el = document.getElementById('msg-' + mid);
        if(selectedMsgs.has(mid)) { selectedMsgs.delete(mid); el.classList.remove('selected'); } 
        else { selectedMsgs.add(mid); el.classList.add('selected'); }
    }
    async function deleteSelectedMessages() {
        if(selectedMsgs.size === 0) return;
        if(!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedMsgs.size} æ¡æ¶ˆæ¯å—ï¼Ÿ`)) return;
        const list = await DB.get('sessions');
        const idx = list.findIndex(s => s.id === currentChatId);
        if(idx !== -1) {
            list[idx].msgs = list[idx].msgs.filter(m => !selectedMsgs.has(String(m.t)) && !selectedMsgs.has(m.t));
            await DB.set('sessions', list); renderMessages(); exitSelectionMode();
        }
    }

    /* ================= æ¶ˆæ¯å‘é€ ================= */
    async function sendUserMsg() {
        const inputEl = document.getElementById('msg-input');
        const txt = inputEl.value.trim(); 
        
        if(!txt) {
            // å¦‚æœæ²¡å­—ï¼Œä¹Ÿå¾—æŠŠç„¦ç‚¹æŠ¢å›æ¥ï¼Œé˜²æ­¢è¯¯è§¦å¯¼è‡´é”®ç›˜æ”¶èµ·
            inputEl.focus();
            return;
        }

        const userPersonas = await DB.get('user_personas');
        const characters = await DB.get('characters');
        const pid = localStorage.getItem('cur_pid') || (userPersonas[0] && userPersonas[0].id);
        const t = Date.now();
        
        const tempMsg = {role:'user', content:txt, personaId:pid, t:t};
        const box = document.getElementById('chat-msg-container');

        // æ’å…¥æ—¶é—´æˆ³
        await tryAppendTimestamp(box, t);

        // æ’å…¥æ¶ˆæ¯
        box.insertAdjacentHTML('beforeend', createMsgHtml(tempMsg, userPersonas, characters));
        box.scrollTop = box.scrollHeight;
        
        // 1. æ¸…ç©ºè¾“å…¥æ¡†
        inputEl.value = '';

        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ æ ¸å¿ƒä¿®æ”¹ï¼šå‘é€å®Œç«‹åˆ»èšç„¦ï¼Œè®©é”®ç›˜ä¿æŒå¼¹èµ·çŠ¶æ€ï¼ğŸ‘‡ğŸ‘‡ğŸ‘‡
        setTimeout(() => {
            inputEl.focus(); 
        }, 10); // åŠ æçŸ­å»¶æ—¶æ˜¯ä¸ºäº†å…¼å®¹æŸäº›é¡½å›ºçš„å®‰å“æµè§ˆå™¨
        // ğŸ‘†ğŸ‘†ğŸ‘† ä¿®æ”¹ç»“æŸ ğŸ‘†ğŸ‘†ğŸ‘†

        const list = await DB.get('sessions'); 
        const idx = list.findIndex(x=>x.id==currentChatId);
        list[idx].msgs.push(tempMsg);
        await DB.set('sessions', list); 
    }

    /* ================= ğŸ› ï¸ åº•éƒ¨é¢æ¿æ§åˆ¶é€»è¾‘ ================= */

// 1. åˆ‡æ¢é¢æ¿çš„æ˜¾ç¤º/éšè— (ç»‘å®šåœ¨åŠ å·æŒ‰é’®ä¸Š)
// æ§åˆ¶åŠ å·é¢æ¿ï¼ˆåŠŸèƒ½é¢æ¿ï¼‰
function toggleToolPanel(e) {
    if(e) e.stopPropagation();

    const toolPanel = document.getElementById('chat-tool-panel');
    const stickerPanel = document.getElementById('chat-sticker-panel'); // è·å–è¡¨æƒ…é¢æ¿
    const input = document.getElementById('msg-input');
    const box = document.getElementById('chat-msg-container');

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šå…ˆæ— æ¡ä»¶å…³é—­è¡¨æƒ…é¢æ¿ â˜…â˜…â˜…
    if (stickerPanel) {
        stickerPanel.style.height = '0';
    }

    // ç„¶åå†å¤„ç†è‡ªå·±çš„å¼€å…³
    if (toolPanel.classList.contains('show')) {
        toolPanel.classList.remove('show');
    } else {
        // æ‰“å¼€æ—¶ï¼Œå…ˆæ”¶èµ·é”®ç›˜
        input.blur();
        
        toolPanel.classList.add('show');
        
        // è‡ªåŠ¨æ»šåˆ°åº•éƒ¨
        setTimeout(() => {
            box.scrollTop = box.scrollHeight;
        }, 100);
    }
}

// 2. å…³é—­é¢æ¿ (ç»‘å®šåœ¨è¾“å…¥æ¡†èšç„¦ã€ç‚¹å‡»èƒŒæ™¯æ—¶)
// å…³é—­æ‰€æœ‰åº•éƒ¨é¢æ¿
function closeToolPanel() {
    // 1. å…³é—­åŠ å·é¢æ¿
    const toolPanel = document.getElementById('chat-tool-panel');
    if (toolPanel && toolPanel.classList.contains('show')) {
        toolPanel.classList.remove('show');
    }
    
    // 2. å…³é—­è¡¨æƒ…é¢æ¿
    const stickerPanel = document.getElementById('chat-sticker-panel');
    if (stickerPanel) {
        stickerPanel.style.height = '0';
    }
}

// 3. ä¿®æ”¹åŸæ¥çš„ selectChatImage é€»è¾‘ï¼Œå› ä¸ºä¸éœ€è¦ toggleActionSheet äº†
// 4. ä¿®æ”¹åŸæ¥çš„ handleRegenerate é€»è¾‘
// ä¿®å¤åçš„å›æº¯é€»è¾‘

// 5. ä¿®æ”¹æ‰“å¼€è½¬è´¦å¼¹çª—çš„é€»è¾‘
// ä¿®å¤åçš„æ‰“å¼€è½¬è´¦å¼¹çª—é€»è¾‘

    // ä¿®å¤åçš„ç›¸å†Œé€‰æ‹©é€»è¾‘
function selectChatImage() { 
    // è§¦å‘æ–‡ä»¶é€‰æ‹©
    document.getElementById('chat-image-input').click(); 
    
    // å…³é”®ä¿®å¤ï¼šå»æ‰ toggleActionSheet()
    // è¿™é‡Œçš„ closeToolPanel() å¯åŠ å¯ä¸åŠ ï¼ŒåŠ ä¸Šä¼šè®©é¢æ¿åœ¨é€‰å›¾åè‡ªåŠ¨æ”¶èµ·ï¼Œä½“éªŒæ›´å¥½
    closeToolPanel(); 
}
    
    function handleChatImageSelected(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    // å…è®¸é«˜æ¸…å‘å›¾ï¼Œå› ä¸ºç°åœ¨ç”¨IndexedDBäº†
                    const maxWidth = 1024; 
                    const scaleSize = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scaleSize;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const compressedData = canvas.toDataURL('image/jpeg', 0.8);
                    sendUserImageMsg(compressedData);
                }
            }
            reader.readAsDataURL(file);
        }
    }
    async function sendUserImageMsg(base64Data) {
        const userPersonas = await DB.get('user_personas');
        const characters = await DB.get('characters');
        const pid = localStorage.getItem('cur_pid') || (userPersonas[0] && userPersonas[0].id);
        const t = Date.now();
        const tempMsg = {role:'user', content:'[å›¾ç‰‡]', image: base64Data, personaId:pid, t:t};
        
        const box = document.getElementById('chat-msg-container');

        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ æ–°å¢ï¼šå…ˆå°è¯•æ’å…¥æ—¶é—´æˆ³ ğŸ‘‡ğŸ‘‡ğŸ‘‡
        await tryAppendTimestamp(box, t);
        // ğŸ‘†ğŸ‘†ğŸ‘† æ–°å¢ç»“æŸ ğŸ‘†ğŸ‘†ğŸ‘†

        box.insertAdjacentHTML('beforeend', createMsgHtml(tempMsg, userPersonas, characters));
        box.scrollTop = box.scrollHeight;

        const list = await DB.get('sessions'); 
        const idx = list.findIndex(x=>x.id==currentChatId);
        list[idx].msgs.push(tempMsg);
        await DB.set('sessions', list); 
    }
    
    /* ================= èŠå¤©è®¾ç½® & è®°å¿†ç®¡ç† ================= */
    // æ‰“å¼€èŠå¤©è®¾ç½® (åŠ¨æ€æ›¿æ¢UIä¸ºå¼€å…³)
// æ‰“å¼€èŠå¤©è®¾ç½® (é€‚é… HTML ç¡¬ç¼–ç å¼€å…³ç‰ˆ)
async function openChatSettings() {
    console.log("æ­£åœ¨æ‰“å¼€è®¾ç½®...");
    
    // 1. å›æ˜¾å½“å‰èº«ä»½
    const ps = await DB.get('user_personas'); 
    const sel = document.getElementById('current-persona-select'); 
    if(sel) {
        sel.innerHTML = '';
        if(ps && ps.length > 0) {
            ps.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.name}</option>`);
            sel.value = localStorage.getItem('cur_pid') || '';
        } else {
            sel.innerHTML = '<option value="">é»˜è®¤æˆ‘</option>';
        }
    }

    // 2. è·å–å½“å‰ä¼šè¯è®¾ç½®
    const list = await DB.get('sessions');
    const sess = list.find(s => s.id == currentChatId);
    if(!sess) return alert("æœªæ‰¾åˆ°å½“å‰ä¼šè¯");

    // 3. å›æ˜¾èƒŒæ™¯å›¾
    const prev = document.getElementById('chat-bg-preview');
    if (prev) prev.src = sess.bgImage || ""; 
    const fileInput = document.getElementById('chat-bg-file');
    if(fileInput) fileInput.value = '';

    // 4. å›æ˜¾è®°å¿†è½®æ•°
    const limit = sess.memoryLimit || 20;
    const slider = document.getElementById('memory-limit-slider');
    const display = document.getElementById('memory-limit-display');
    if(slider) slider.value = limit;
    if(display) display.innerText = limit;

    // 5. æ¸²æŸ“è®°å¿†åˆ—è¡¨
    if(typeof renderMemoryLists === 'function') renderMemoryLists(sess);

    // 6. å›æ˜¾æ—¶é—´å¼€å…³
    const timeSwitch = document.getElementById('chat-time-aware-switch');
    if(timeSwitch) timeSwitch.checked = sess.isTimeAware || false;
    
    const timePrev = document.getElementById('settings-time-preview');
    if(timePrev) {
        const now = new Date();
        timePrev.innerText = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
    }

    // 7. å›æ˜¾è‡ªåŠ¨å‘åŠ¨æ€é¢‘ç‡
    const probSel = document.getElementById('ai-moment-prob-select');
    if(probSel) probSel.value = sess.aiMomentProb || 0;

    // 8. â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šç›´æ¥å›æ˜¾å¼€å…³çŠ¶æ€ â˜…â˜…â˜…
    const stickerSwitch = document.getElementById('ai-allow-sticker-switch');
    if (stickerSwitch) {
        // å¦‚æœæ•°æ®åº“é‡Œæ²¡å­˜è¿‡ï¼Œé»˜è®¤æ˜¯ false (å…³é—­)
        stickerSwitch.checked = sess.allowStickers || false;
    }

    // 9. æ‰“å¼€å¼¹çª—
    openModal('modal-chat-settings');
}
    /* ================= æ¸²æŸ“è®°å¿†åˆ—è¡¨ (å¸¦åˆ é™¤åŠŸèƒ½) ================= */
    function renderMemoryLists(sess) {
        // 1. æ¸²æŸ“æ™®é€šæ‘˜è¦åˆ—è¡¨
        const summaryBox = document.getElementById('summary-list-box');
        summaryBox.innerHTML = '';
        
        if(sess.summaries && sess.summaries.length > 0) {
            sess.summaries.forEach((sum, idx) => {
                summaryBox.innerHTML += `
                    <div class="memory-item" style="display:flex; align-items:center; gap:10px;">
                        <input type="checkbox" class="summary-checkbox" value="${idx}">
                        <div style="flex:1; word-break:break-all;">${sum}</div>
                        <span onclick="deleteMemoryItem('summary', ${idx})" style="cursor:pointer; font-size:16px;">ğŸ—‘ï¸</span>
                    </div>`;
            });
        } else {
            summaryBox.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">æš‚æ— å¾…å¤„ç†è®°å¿†</div>';
        }

        // 2. æ¸²æŸ“ç²¾ç‚¼è®°å¿†åˆ—è¡¨
        const refinedBox = document.getElementById('refined-memory-box');
        refinedBox.innerHTML = '';
        
        if(sess.refinedMemories && sess.refinedMemories.length > 0) {
            sess.refinedMemories.forEach((mem, idx) => {
                refinedBox.innerHTML += `
                    <div class="memory-item" style="display:flex; align-items:center; gap:10px;">
                        <span style="color:#007AFF;">ğŸ“Œ</span>
                        <div style="flex:1; word-break:break-all;">${mem}</div>
                        <span onclick="deleteMemoryItem('refined', ${idx})" style="cursor:pointer; font-size:16px;">ğŸ—‘ï¸</span>
                    </div>`;
            });
        } else {
            refinedBox.innerHTML = '<div style="text-align:center; color:#999; padding:10px;">æš‚æ— ç²¾ç‚¼è®°å¿†</div>';
        }
    }
    /* ================= åˆ é™¤å•æ¡è®°å¿† ================= */
    async function deleteMemoryItem(type, index) {
        if(!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å¿†å—ï¼Ÿ")) return;

        const list = await DB.get('sessions');
        const idx = list.findIndex(s => s.id === currentChatId);
        if(idx === -1) return;

        if (type === 'summary') {
            list[idx].summaries.splice(index, 1); // ä»æ•°ç»„é‡Œåˆ æ‰
        } else {
            list[idx].refinedMemories.splice(index, 1);
        }

        await DB.set('sessions', list);
        renderMemoryLists(list[idx]); // åˆ·æ–°åˆ—è¡¨
    }
    /* ================= ç”Ÿæˆæ™®é€šæ‘˜è¦ (æŒ‰é’®å˜èº«ç‰ˆ) ================= */
    async function generateSummary() {
        // 1. å‡†å¤‡æ•°æ®
        const list = await DB.get('sessions');
        const sess = list.find(s=>s.id==currentChatId);
        if(!sess) return;

        // â˜…â˜…â˜… è·å–æŒ‰é’®å¹¶å˜èº« â˜…â˜…â˜…
        const btn = document.querySelector('button[onclick="generateSummary()"]');
        const oldText = btn.innerText; // å…ˆè®°ä¸‹åŸæ¥çš„å­—(ğŸ§  ç”Ÿæˆè®°å¿†æ‘˜è¦)
        btn.innerText = "æ­£åœ¨ç”Ÿæˆä¸­..."; // å˜æˆæ–°çš„å­—
        btn.style.opacity = "0.7"; // ç¨å¾®å˜æ·¡ä¸€ç‚¹
        btn.disabled = true; // æš‚æ—¶é”ä½ä¸è®©ç‚¹äº†ï¼Œé˜²æ­¢é‡å¤æäº¤

        try {
            // è·å–åŒæ–¹çœŸå®åå­— (é€»è¾‘ä¿æŒä¸å˜)
            const userPersonas = await DB.get('user_personas');
            const curPid = localStorage.getItem('cur_pid') || (userPersonas[0] && userPersonas[0].id);
            const myName = userPersonas.find(p=>p.id==curPid)?.name || "æˆ‘";

            const characters = await DB.get('characters');
            let charName = sess.name; 
            if(sess.type === 'direct') {
                const c = characters.find(x=>x.id == sess.targetId);
                if(c) charName = c.name;
            }

            // æå–å¯¹è¯
            const recent = sess.msgs.slice(-20).map(m => {
                const sender = m.role==='user' ? myName : charName;
                return `${sender}: ${m.content}`;
            }).join('\n');
            
            // æ„é€ æŒ‡ä»¤
            const prompt = `è¯·æ ¹æ®ä»¥ä¸‹å¯¹è¯ç”Ÿæˆä¸€æ¡ç®€çŸ­æ‘˜è¦ï¼ˆ50å­—ä»¥å†…ï¼‰ã€‚
ã€é‡è¦äººç‰©è®¾å®šã€‘
æˆ‘æ–¹åå­—ï¼š${myName}
å¯¹æ–¹åå­—ï¼š${charName}

ã€è¦æ±‚ã€‘
1. å¿…é¡»ç›´æ¥ä½¿ç”¨åŒæ–¹çš„åå­—ï¼ˆ"${myName}" å’Œ "${charName}"ï¼‰æ¥æè¿°äº’åŠ¨å†…å®¹ã€‚
2. ä¸¥ç¦å‡ºç°â€œç”¨æˆ·çš„åå­—æ˜¯...â€è¿™ç§ä»‹ç»è¯­ã€‚
3. ä¸è¦è¾“å‡ºâ€œæ‘˜è¦å¦‚ä¸‹â€ç­‰åºŸè¯ï¼Œç›´æ¥å™è¿°äº‹ä»¶ã€‚

å¯¹è¯å†…å®¹ï¼š
${recent}`;
            
            // å‘é€è¯·æ±‚
            const cfg = await DB.getObj('api_config');
            const res = await fetch(cfg.url.replace(/\/$/, '')+'/chat/completions', {
                method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${cfg.key}`},
                body: JSON.stringify({model:cfg.model, messages:[{role:'user',content:prompt}], temperature:0.3})
            });
            const data = await res.json();
            const summary = data.choices[0].message.content.trim();
            
            // ä¿å­˜
            const idx = list.findIndex(s=>s.id==currentChatId);
            if(!list[idx].summaries) list[idx].summaries = [];
            list[idx].summaries.push(summary);
            await DB.set('sessions', list);
            
            renderMemoryLists(list[idx]); 
            alert("âœ¨ æ‘˜è¦ç”ŸæˆæˆåŠŸï¼");

        } catch(e) { 
            alert("ç”Ÿæˆå¤±è´¥: "+e.message); 
        } finally {
            // â˜…â˜…â˜… æ— è®ºæˆåŠŸå¤±è´¥ï¼Œæœ€åéƒ½å˜å›åŸæ¥çš„æ ·å­ â˜…â˜…â˜…
            btn.innerText = oldText;
            btn.style.opacity = "1";
            btn.disabled = false;
        }
    }
    /* ================= å‡çº§ç‰ˆï¼šè°ƒç”¨APIç²¾ç‚¼è®°å¿† ================= */
    async function refineMemories() {
        // 1. è·å–å‹¾é€‰çš„å†…å®¹
        const checks = document.querySelectorAll('.summary-checkbox:checked');
        if(checks.length === 0) return alert("è¯·å…ˆå‹¾é€‰éœ€è¦åˆå¹¶çš„æ‘˜è¦");

        // 2. å‡†å¤‡æ•°æ®
        const list = await DB.get('sessions');
        const idx = list.findIndex(s => s.id === currentChatId);
        const sess = list[idx];
        
        // æ‹¿åˆ°å‹¾é€‰çš„é‚£äº›æ–‡å­—
        const indices = Array.from(checks).map(c => parseInt(c.value)).sort((a,b)=>b-a);
        const selectedTexts = indices.map(i => sess.summaries[i]);

        // 3. å‘Šè¯‰ç”¨æˆ·ç¨ç­‰
        const btn = document.querySelector('button[onclick="refineMemories()"]');
        const oldText = btn.innerText;
        btn.innerText = "âœ¨ æ­£åœ¨åˆå¹¶ä¸­...";
        btn.disabled = true;

        try {
            // 4. æ„é€  Prompt è®© AI åŠ¨è„‘å­
            const prompt = `è¯·å°†ä»¥ä¸‹å¤šæ¡é›¶æ•£çš„ç”¨æˆ·è®°å¿†ï¼Œåˆå¹¶ã€æ¶¦è‰²ä¸ºã€ä¸€æ¡ã€‘ç®€æ´ã€å®Œæ•´çš„æ ¸å¿ƒè®°å¿†ï¼ˆä¿ç•™å…³é”®ä¿¡æ¯ï¼Œå»é‡ï¼‰ï¼š\n\n${selectedTexts.map(t=>'- '+t).join('\n')}`;
            
            const cfg = await DB.getObj('api_config');
            let url = cfg.url;
            if(!url.includes('/chat/completions')) url = url.replace(/\/$/, '') + '/chat/completions';
            if(!url.includes('/v1/') && !url.includes('moonshot')) url = url.replace('/chat', '/v1/chat');

            const res = await fetch(url, {
                method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${cfg.key}`},
                body: JSON.stringify({model:cfg.model, messages:[{role:'user',content:prompt}], temperature:0.5})
            });
            const data = await res.json();
            
            if(data.error) throw new Error(data.error.message);
            const newMemory = data.choices[0].message.content;

            // 5. ä¿å­˜ç»“æœ
            if(!sess.refinedMemories) sess.refinedMemories = [];
            sess.refinedMemories.push(newMemory); // å­˜å…¥ç²¾ç‚¼åŒº

            // 6. åˆ æ‰åŸæ¥çš„æ™®é€šè®°å¿† (å€’ç€åˆ é˜²æ­¢ç´¢å¼•é”™ä¹±)
            indices.forEach(i => {
                sess.summaries.splice(i, 1);
            });

            await DB.set('sessions', list);
            renderMemoryLists(sess);
            alert("âœ¨ åˆå¹¶æˆåŠŸï¼å·²ç”Ÿæˆä¸€æ¡æ–°çš„æ ¸å¿ƒè®°å¿†ã€‚");

        } catch(e) {
            alert("åˆå¹¶å¤±è´¥: " + e.message);
        } finally {
            // æ¢å¤æŒ‰é’®
            btn.innerText = oldText;
            btn.disabled = false;
        }
    }

    async function clearRefinedMemories() {
        if(!confirm("æ¸…ç©ºæ‰€æœ‰ç²¾ç‚¼è®°å¿†ï¼Ÿ")) return;
        const list = await DB.get('sessions');
        const idx = list.findIndex(s=>s.id==currentChatId);
        list[idx].refinedMemories = [];
        await DB.set('sessions', list);
        renderMemoryLists(list[idx]);
    }

   // ğŸ—‘ï¸ æ¸…ç©ºå½“å‰èŠå¤© (å½»åº•å¤±å¿†ç‰ˆ)
    async function clearCurrentChatHistory() {
        if(!confirm("âš ï¸ ç¡®å®šè¦å½»åº•é‡ç½®å—ï¼Ÿ\nè¿™å°†æ¸…ç©ºï¼š\n1. æ‰€æœ‰èŠå¤©è®°å½•\n2. æ‰€æœ‰è®°å¿†æ‘˜è¦\n3. æ‰€æœ‰ç²¾ç‚¼è®°å¿†\nï¼ˆAIå°†å®Œå…¨å¿˜è®°ä¸ä½ çš„è¿‡å¾€ï¼‰")) return;
        
        const list = await DB.get('sessions');
        const idx = list.findIndex(s => s.id === currentChatId);
        
        if(idx !== -1) {
            // 1. æ¸…ç©ºæ¶ˆæ¯
            list[idx].msgs = [];
            
            // 2. â˜…â˜…â˜… å…³é”®ä¿®æ”¹ï¼šæ¸…ç©ºè®°å¿†åº“ â˜…â˜…â˜…
            list[idx].summaries = [];       // æ¸…ç©ºæ™®é€šæ‘˜è¦
            list[idx].refinedMemories = []; // æ¸…ç©ºç²¾ç‚¼è®°å¿†
            
            await DB.set('sessions', list);
            
            // åˆ·æ–°ç•Œé¢
            renderMessages();
            closeModal('modal-chat-settings');
            
            alert("å·²å½»åº•é‡ç½®ï¼Œç°åœ¨å¯¹TAæ¥è¯´ï¼Œä½ æ˜¯ç¬¬ä¸€æ¬¡è§é¢äº†ã€‚");
        }
    }

    function clearChatBg() { document.getElementById('chat-bg-preview').src = ""; }

    // ä¿å­˜èŠå¤©è®¾ç½®
// ä¿å­˜èŠå¤©è®¾ç½® (é€‚é… HTML ç¡¬ç¼–ç å¼€å…³ç‰ˆ)
async function confirmChatSettings() {
    const v = document.getElementById('current-persona-select').value;
    if(v) localStorage.setItem('cur_pid', v);

    const scale = document.getElementById('chat-scale-slider').value;
    const font = document.getElementById('chat-font-slider').value;
    localStorage.setItem('chat_font_scale', scale);
    localStorage.setItem('chat_text_size', font);

    const bgSrc = document.getElementById('chat-bg-preview').getAttribute('src');
    
    const list = await DB.get('sessions');
    const idx = list.findIndex(s => s.id === currentChatId);
    if (idx !== -1) {
        if(bgSrc && bgSrc.startsWith('data:image')) list[idx].bgImage = bgSrc;
        else delete list[idx].bgImage;
        
        list[idx].memoryLimit = parseInt(document.getElementById('memory-limit-slider').value);
        list[idx].isTimeAware = document.getElementById('chat-time-aware-switch').checked;
        list[idx].aiMomentProb = parseInt(document.getElementById('ai-moment-prob-select').value);
        
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä¿å­˜å¼€å…³çŠ¶æ€ â˜…â˜…â˜…
        const stickerSwitch = document.getElementById('ai-allow-sticker-switch');
        list[idx].allowStickers = stickerSwitch ? stickerSwitch.checked : false;
        
        await DB.set('sessions', list);
        
        const bgDiv = document.getElementById('chat-msg-container');
        if (list[idx].bgImage) bgDiv.style.backgroundImage = `url('${list[idx].bgImage}')`;
        else bgDiv.style.backgroundImage = 'none';
    }
    closeModal('modal-chat-settings');
}

    /* ================= AI å›å¤ (å¢å¼ºç‰ˆ + è®°å¿†ä¿®å¤) ================= */
    
  // ================= â†º ä¿®å¤åçš„å›æº¯åŠŸèƒ½ =================
async function handleRegenerate() {
    // 1. å…³é”®ä¿®å¤ï¼šå…³é—­æ–°çš„åº•éƒ¨åŠŸèƒ½é¢æ¿
    closeToolPanel(); 
    
    const list = await DB.get('sessions');
    const idx = list.findIndex(s => s.id === currentChatId);
    if(idx === -1) return;

    let msgs = list[idx].msgs;
    if (msgs.length === 0) return alert("è¿˜æ²¡æœ‰æ¶ˆæ¯å¯ä»¥å›æº¯å“¦~");

    let deleted = false;
    
    // 2. é€»è¾‘ï¼šä»åå¾€å‰åˆ ï¼ŒæŠŠ AI æœ€åè¯´çš„è¯åˆ æ‰ï¼Œç›´åˆ°é‡åˆ°ç”¨æˆ·çš„è¯ä¸ºæ­¢
    // è¿™æ ·å¯ä»¥é¿å…åªåˆ æ‰ AI çš„åŠæˆªè¯ï¼ˆå¦‚æœå®ƒæ˜¯åˆ†æ®µå‘çš„ï¼‰
    while(msgs.length > 0) {
        const lastMsg = msgs[msgs.length - 1];
        if(lastMsg.role === 'assistant') {
            msgs.pop(); 
            deleted = true;
        } else {
            break; // é‡åˆ°ç”¨æˆ·çš„æ¶ˆæ¯å°±åœæ­¢
        }
    }

    if (deleted) {
        // 3. ä¿å­˜å¹¶åˆ·æ–°ç•Œé¢
        await DB.set('sessions', list);
        await renderMessages(); 
        
        // 4. è®© AI é‡æ–°ç”Ÿæˆå›å¤
        triggerAiReply();
    } else {
        alert("æœ€åä¸€æ¡æ˜¯ä½ çš„æ¶ˆæ¯ï¼Œæ— æ³•å›æº¯å“¦ï¼Œè¯·ç›´æ¥ç»§ç»­èŠå¤©ã€‚");
    }
}

    /* ================= ç‚¹å‡»ç©ºç™½å¤„å…³é—­åŠ å·èœå• ================= */
    /* ================= ç‚¹å‡»ç©ºç™½å¤„å…³é—­å„ç±»æµ®çª— ================= */
    /* ================= ç‚¹å‡»ç©ºç™½å¤„å…³é—­å„ç±»æµ®çª— (æœ€ç»ˆç‰ˆ) ================= */
    document.addEventListener('click', function(e) {
        // 1. èŠå¤©åŠ å·èœå•
        const chatSheet = document.getElementById('action-sheet');
        const chatBtn = document.querySelector('.plus-btn'); 
        if (chatSheet && chatSheet.classList.contains('show')) {
            if (!chatSheet.contains(e.target) && !chatBtn.contains(e.target)) {
                chatSheet.classList.remove('show');
            }
        }

        // 2. æœ‹å‹åœˆé€‰äººèœå•
        const momentMenu = document.getElementById('moment-gen-menu');
        const momentBtn = document.getElementById('btn-moment-refresh'); 
        if (momentMenu && momentMenu.classList.contains('show')) {
            if (!momentMenu.contains(e.target) && (!momentBtn || !momentBtn.contains(e.target))) {
                momentMenu.classList.remove('show');
            }
        }

        // 3. åˆ†äº«å¼¹çª— (ç‚¹å‡»é»‘è‰²é®ç½©å±‚å…³é—­)
        const shareMask = document.getElementById('modal-share');
        const sharePanel = document.querySelector('.share-panel');
        if (shareMask && shareMask.classList.contains('show')) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯ mask (é®ç½©) æœ¬èº«ï¼Œè€Œä¸æ˜¯é‡Œé¢çš„ panelï¼Œå°±å…³é—­
            if (e.target === shareMask) {
                closeShareModal();
            }
        }
    });
    
   /* ================= æœ‹å‹åœˆå®Œæ•´åŠŸèƒ½æ•´åˆåŒ… (å«åˆ†äº«åŠŸèƒ½) ================= */

    let currentShareMomentId = null; // è®°å½•å½“å‰æ­£åœ¨åˆ†äº«å“ªæ¡åŠ¨æ€

    // 1. æ‰“å¼€åˆ†äº«èœå• (æ–°)
    async function openShareMenu(mid) {
        currentShareMomentId = mid;
        const mask = document.getElementById('modal-share');
        const listDiv = document.getElementById('share-target-list');
        
        // è·å–æ‰€æœ‰ç§èŠè¿‡çš„ä¼šè¯
        const list = await DB.get('sessions');
        const characters = await DB.get('characters');
        const validSessions = list.filter(s => s.type === 'direct'); 

        listDiv.innerHTML = '';
        if(validSessions.length === 0) {
            listDiv.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999;padding:20px;">æš‚æ— æœ€è¿‘è”ç³»äºº</div>';
        } else {
            validSessions.forEach(s => {
                const char = characters.find(c => c.id === s.targetId);
                if(!char) return;
                const ava = char.avatar || DEFAULT_AVATAR;
                // ç”Ÿæˆå¤´åƒåˆ—è¡¨
                listDiv.innerHTML += `
                    <div class="share-item" onclick="confirmShare('${s.id}', '${char.name}')">
                        <img src="${ava}" class="share-avatar">
                        <div class="share-name">${char.name}</div>
                    </div>`;
            });
        }
        mask.classList.add('show');
    }

    // 2. å…³é—­åˆ†äº«èœå• (æ–°)
    function closeShareModal() {
        const mask = document.getElementById('modal-share');
        if(mask) mask.classList.remove('show');
    }

    // 3. æ‰§è¡Œåˆ†äº«é€»è¾‘ (ä¿®æ”¹ç‰ˆï¼šå¡ç‰‡æ¨¡å¼ï¼Œæ— è·³è½¬)
    async function confirmShare(sessionId, charName) {
        if(!currentShareMomentId) return;
        
        let moments = await DB.get('moments');
        const m = moments.find(x => x.id == currentShareMomentId);
        if(!m) return;

        // åœ¨åˆ—è¡¨é¡µæ˜¾ç¤ºçš„ç®€ç•¥æ–‡å­—
        const previewText = `[åŠ¨æ€] ${m.name}: ${m.content.substring(0, 15)}...`;

        const userPersonas = await DB.get('user_personas');
        const curPid = localStorage.getItem('cur_pid') || (userPersonas[0] && userPersonas[0].id);

        const t = Date.now();
        const msgObj = {
            role: 'user', 
            content: previewText, // è¿™ä¸ª content ä»…ç”¨äºåˆ—è¡¨é¢„è§ˆ
            personaId: curPid, 
            t: t,
            isShare: true,        // æ ‡è®°ä¸ºåˆ†äº«æ¶ˆæ¯
            momentData: {         // å­˜å…¥å¡ç‰‡éœ€è¦çš„æ•°æ®
                name: m.name,
                avatar: m.avatar,
                text: m.content
            }
        };

        const list = await DB.get('sessions');
        const idx = list.findIndex(s => s.id === sessionId);
        if(idx !== -1) {
            list[idx].msgs.push(msgObj);
            await DB.set('sessions', list);
            
            alert(`å·²åˆ†äº«ç»™ ${charName} âœ…`);
            closeShareModal();
        }
    }

    // 4. æ‰“å¼€/å…³é—­é€‰äººèœå• (æ—§é€»è¾‘ä¿ç•™)
    async function toggleMomentMenu() {
        const menu = document.getElementById('moment-gen-menu');
        if (menu.classList.contains('show')) {
            menu.classList.remove('show');
            return;
        }
        const list = await DB.get('sessions');
        const characters = await DB.get('characters');
        const validSessions = list.filter(s => s.msgs.length > 0 && s.type === 'direct');
        const box = document.getElementById('moment-candidate-list');
        box.innerHTML = '';
        if (validSessions.length === 0) {
            box.innerHTML = '<div style="font-size:12px;color:#999;text-align:center;padding:10px;">è¿˜æ²¡æœ‰èŠè¿‡å¤©å“¦</div>';
        } else {
            validSessions.forEach(s => {
                const char = characters.find(c => c.id === s.targetId);
                if (!char) return;
                const ava = char.avatar || DEFAULT_AVATAR;
                box.innerHTML += `
                    <div class="menu-item">
                        <input type="checkbox" class="moment-chk" value="${s.id}">
                        <img src="${ava}" style="width:24px;height:24px;border-radius:4px;">
                        <span style="font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${char.name}</span>
                    </div>`;
            });
        }
        menu.classList.add('show');
    }

    // 5. ç”Ÿæˆæ–°åŠ¨æ€ (æ—§é€»è¾‘ä¿ç•™)
    async function confirmGenerateMoments() {
        const checks = document.querySelectorAll('.moment-chk:checked');
        if (checks.length === 0) return alert("è¯·è‡³å°‘é€‰ä¸€ä¸ªè§’è‰²");
        const menu = document.getElementById('moment-gen-menu');
        const btn = menu.querySelector('button');
        const oldText = btn.innerText;
        btn.innerText = "âœ¨ ç”Ÿæˆä¸­...";
        btn.disabled = true;
        const list = await DB.get('sessions');
        const characters = await DB.get('characters');
        const userPersonas = await DB.get('user_personas');
        const curPid = localStorage.getItem('cur_pid') || (userPersonas[0] && userPersonas[0].id);
        const myName = userPersonas.find(p=>p.id==curPid)?.name || "æˆ‘";
        try {
            const cfg = await DB.getObj('api_config');
            for (const chk of checks) {
                const sess = list.find(s => s.id === chk.value);
                if (!sess) continue;
                const char = characters.find(c => c.id === sess.targetId);
                const recent = sess.msgs.slice(-15).map(m => `${m.role==='user'?myName:char.name}: ${m.content}`).join('\n');
                const prompt = `ä½ ç°åœ¨æ‰®æ¼”ã€${char.name}ã€‘ã€‚åŸºäºå’Œã€${myName}ã€‘çš„èŠå¤©ï¼Œå‘ä¸€æ¡æœ‹å‹åœˆã€‚è¦æ±‚ï¼šè¯­æ°”ç¬¦åˆäººè®¾(${char.prompt})ï¼Œç®€çŸ­(60å­—å†…)ï¼Œè‡ªç„¶ç”Ÿæ´»åŒ–ï¼Œä¸è¦ä»»ä½•å‰ç¼€ã€‚\n\nèŠå¤©èƒŒæ™¯ï¼š${recent}`;
                let url = cfg.url;
                if(!url.includes('/chat/completions')) url = url.replace(/\/$/, '') + '/chat/completions';
                if(!url.includes('/v1/') && !url.includes('moonshot')) url = url.replace('/chat', '/v1/chat');
                const res = await fetch(url, {
                    method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${cfg.key}`},
                    body: JSON.stringify({model:cfg.model, messages:[{role:'user',content:prompt}], temperature:0.7})
                });
                const data = await res.json();
                const content = data.choices[0].message.content.replace(/^["â€œ]|["â€]$/g, '');
                let moments = await DB.get('moments'); 
                if (!Array.isArray(moments)) moments = [];
                moments.unshift({
                    id: Date.now() + Math.random(),
                    charId: char.id,
                    name: char.name,
                    avatar: char.avatar,
                    content: content,
                    time: new Date().toLocaleString(),
                    likeCount: Math.floor(Math.random() * 50) + 1, 
    
    isLiked: false
                });
                await DB.set('moments', moments);
            }
            renderMoments();
            menu.classList.remove('show');
        } catch(e) { alert("ç”Ÿæˆå¤±è´¥: " + e.message); } 
        finally { btn.innerText = oldText; btn.disabled = false; }
    }

    // 6. ç‚¹èµ (æœ€ç»ˆç‰ˆï¼šå˜è‰² + æ•°å­—åŠ å‡)
async function toggleLike(id) {
    // --- 1. ç•Œé¢æ›´æ–° (å˜å¿ƒ + å˜æ•°å­—) ---
    const btn = document.getElementById('like-btn-' + id);
    const countEl = document.getElementById('like-count-' + id);
    
    let isLikedNow = false;

    if (btn) {
        // åˆ‡æ¢çˆ±å¿ƒæ ·å¼
        isLikedNow = btn.classList.toggle('liked');
        btn.innerText = isLikedNow ? 'â¤ï¸' : 'ğŸ¤';
    }

    // æ›´æ–°æ•°å­—
    if (countEl) {
        // æå–å½“å‰çš„æ•°å­— (æ­£åˆ™æå– "å·²æœ‰ 35 äºº" é‡Œçš„ 35)
        let currentText = countEl.innerText;
        let num = parseInt(currentText.replace(/[^0-9]/g, '')) || 0;
        
        // å¦‚æœå˜æˆäº†ç‚¹èµçŠ¶æ€ï¼Œæ•°å­—+1ï¼›å–æ¶ˆç‚¹èµï¼Œæ•°å­—-1
        if (isLikedNow) {
            num += 1;
        } else {
            num = Math.max(0, num - 1); // é˜²æ­¢å˜æˆè´Ÿæ•°
        }
        countEl.innerText = `å·²æœ‰ ${num} äººç‚¹èµ`;
    }

    // --- 2. æ•°æ®åº“æ›´æ–° ---
    let moments = await DB.get('moments');
    const idx = moments.findIndex(m => m.id == id);
    if (idx !== -1) {
        moments[idx].isLiked = isLikedNow;
        
        // ç¡®ä¿æ•°æ®åº“é‡Œä¹Ÿå­˜ä¸Šæœ€æ–°çš„æ•°å­—
        // å¦‚æœä¹‹å‰æ²¡æœ‰éšæœºæ•°(æ—§æ•°æ®)ï¼Œå°±ä»¥å½“å‰æ˜¾ç¤ºçš„ä¸ºå‡†
        let dbNum = moments[idx].likeCount || 0; 
        moments[idx].likeCount = isLikedNow ? (dbNum + 1) : (dbNum - 1);
        
        await DB.set('moments', moments);
    }
}
    // 7. åˆ‡æ¢è¯„è®ºæ¡† (æ—§é€»è¾‘ä¿ç•™)
    function toggleCommentInput(id) {
        const box = document.getElementById('input-box-' + id);
        const input = document.getElementById('input-' + id);
        if (box.classList.contains('show')) {
            box.classList.remove('show');
        } else {
            document.querySelectorAll('.comment-input-box').forEach(b => b.classList.remove('show'));
            box.classList.add('show');
            setTimeout(() => input.focus(), 100);
        }
    }

    // 8. æäº¤è¯„è®º (æ—§é€»è¾‘ä¿ç•™)
    async function submitComment(id) {
        const inputEl = document.getElementById('input-' + id);
        const text = inputEl.value.trim();
        if (!text) return alert("å†™ç‚¹ä»€ä¹ˆå§~");
        let moments = await DB.get('moments');
        const idx = moments.findIndex(m => m.id == id);
        if (idx === -1) return;
        const userPersonas = await DB.get('user_personas');
        const curPid = localStorage.getItem('cur_pid') || (userPersonas[0] && userPersonas[0].id);
        const myName = userPersonas.find(p=>p.id==curPid)?.name || "æˆ‘";
        if (!moments[idx].comments) moments[idx].comments = [];
        moments[idx].comments.push({ name: myName, content: text, isAi: false });
        moments[idx].isWaitingReply = true; 
        await DB.set('moments', moments);
        renderMoments(); 
        triggerMomentReply(id, text, myName);
    }

    // 9. AIå›å¤ (æ—§é€»è¾‘ä¿ç•™)
    async function triggerMomentReply(momentId, userComment, userName) {
        let moments = await DB.get('moments');
        const m = moments.find(x => x.id == momentId);
        if (!m) return;
        const characters = await DB.get('characters');
        const char = characters.find(c => c.id === m.charId);
        if (!char) return;
        try {
            const prompt = `ä½ ç°åœ¨æ‰®æ¼”ã€${char.name}ã€‘ã€‚æœ‹å‹åœˆï¼šã€${m.content}ã€‘ã€‚æœ‹å‹ã€${userName}ã€‘è¯„è®ºï¼šã€${userComment}ã€‘ã€‚è¯·å›å¤ã€‚è¦æ±‚ï¼šè¯­æ°”ç¬¦åˆäººè®¾(${char.prompt})ï¼Œç®€çŸ­æœ‰è¶£(30å­—å†…)ï¼Œä¸å¸¦åå­—å‰ç¼€ã€‚`;
            const cfg = await DB.getObj('api_config');
            let url = cfg.url;
            if(!url.includes('/chat/completions')) url = url.replace(/\/$/, '') + '/chat/completions';
            if(!url.includes('/v1/') && !url.includes('moonshot')) url = url.replace('/chat', '/v1/chat');
            const res = await fetch(url, {
                method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${cfg.key}`},
                body: JSON.stringify({model:cfg.model, messages:[{role:'user',content:prompt}], temperature:0.7})
            });
            const data = await res.json();
            const replyText = data.choices[0].message.content.replace(/^["â€œ]|["â€]$/g, '');
            moments = await DB.get('moments');
            const idx = moments.findIndex(x => x.id == momentId);
            if (idx !== -1) {
                moments[idx].isWaitingReply = false; 
                moments[idx].comments.push({
                    name: char.name,
                    content: `å›å¤@${userName} ${replyText}`,
                    isAi: true
                });
                await DB.set('moments', moments);
                renderMoments();
            }
        } catch(e) {
            console.error(e);
            moments = await DB.get('moments');
            const idx = moments.findIndex(x => x.id == momentId);
            if (idx !== -1) { moments[idx].isWaitingReply = false; await DB.set('moments', moments); renderMoments(); }
        }
    }

    // 10. æ¸²æŸ“åˆ—è¡¨ (â˜…é‡è¦æ›´æ–°ï¼šåŠ å…¥äº†å³ä¸Šè§’ä¸‰ç‚¹å›¾æ ‡â˜…)
    // 10. æ¸²æŸ“åˆ—è¡¨ (ğŸ‘‘ è´µæ—ç‰¹æƒç‰ˆ)
    // 10. æ¸²æŸ“åˆ—è¡¨ (æ”¯æŒå›¾ç‰‡å’Œä½ç½®ç‰ˆ)
    async function renderMoments() {
        renderZoneHeader();
        
        const vipInfo = await DB.getObj('vip_info'); 
        const now = Date.now();
        const isVip = vipInfo && vipInfo.expiry > now;

        let moments = await DB.get('moments'); 
        const box = document.getElementById('list-moments');
        
        if (!moments || moments.length === 0) {
            box.innerHTML = `<div style="text-align:center; margin-top:50px; color:#999;"><div style="font-size:40px; margin-bottom:10px;">ğŸ“­</div><p>ç‚¹å³ä¸Šè§’è®©å¤§å®¶å‘åŠ¨æ€å§~</p></div>`;
            return;
        }

        moments.sort((a, b) => b.id - a.id);
        box.innerHTML = '';
        
        moments.forEach(m => {
            const ava = m.avatar || DEFAULT_AVATAR;
            const likeClass = m.isLiked ? 'liked' : '';
            const likeIcon = m.isLiked ? 'â¤ï¸' : 'ğŸ¤';

            let nameHtml = m.name;
            let nameClass = 'moment-name';
            if (m.charId === 'ME' && isVip) {
                nameClass += ' is-vip'; 
                nameHtml += `<span class="vip-crown-icon">ğŸ‘‘</span>`; 
            }

            let commentsHtml = '';
            const hasComments = (m.comments && m.comments.length > 0) || m.isWaitingReply;
            if (hasComments) {
                commentsHtml += `<div class="comment-area show">`;
                if(m.comments) {
                    m.comments.forEach(c => {
                        commentsHtml += `<div class="comment-row"><span class="comment-user">${c.name}</span>: <span class="comment-content">${c.content}</span></div>`;
                    });
                }
                if (m.isWaitingReply) {
                    commentsHtml += `<div class="comment-row"><span class="reading-status">TAæ­£åœ¨è¯»ä½ çš„è¯„è®º...</span></div>`;
                }
                commentsHtml += `</div>`;
            }

            // --- æ„å»ºå†…å®¹åŒº (æ–‡æœ¬ + é•¶åµŒ + å›¾ç‰‡ + ä½ç½®) ---
            let contentHtml = `<div class="moment-content">${m.content}</div>`;
            
            // A. è½¬å‘/é•¶åµŒå†…å®¹
            if (m.forwardedFrom) {
                contentHtml += `
                    <div class="forward-box">
                        <span class="fwd-name">@${m.forwardedFrom.name}</span>
                        <span class="fwd-content">${m.forwardedFrom.content}</span>
                    </div>`;
            }

            // B. â˜…â˜…â˜… å›¾ç‰‡æ˜¾ç¤º â˜…â˜…â˜…
            if (m.image) {
                contentHtml += `<img src="${m.image}" class="moment-photo">`;
            }

            // C. â˜…â˜…â˜… ä½ç½®æ˜¾ç¤º â˜…â˜…â˜…
            if (m.location) {
                contentHtml += `<div class="moment-location">${m.location}</div>`;
            }

            // --- æ‹¼æ¥ ---
            box.innerHTML += `
                <div class="moment-card"
     oncontextmenu="return false;"
     onmousedown="startMomentPress(${m.id})" 
     ontouchstart="startMomentPress(${m.id})" 
     onmouseup="cancelMomentPress()" 
     ontouchend="cancelMomentPress()" 
     ontouchmove="cancelMomentPress()"
>
                    <div class="moment-header" style="justify-content:space-between;">
                        <div style="display:flex; align-items:center; flex:1; overflow:hidden;">
                            <img src="${ava}" class="moment-avatar">
                            <div class="${nameClass}">${nameHtml}</div>
                        </div>
                        <div class="moment-more-btn" onclick="openShareMenu(${m.id})">â€¢â€¢â€¢</div>
                    </div>
                    
                    ${contentHtml}
                    
                    <div class="moment-actions">
                        <span class="like-stat" id="like-count-${m.id}">å·²æœ‰ ${m.likeCount || 0} äººç‚¹èµ</span>
                        <div style="display:flex; gap:20px;">
                            <div id="like-btn-${m.id}" class="action-btn ${likeClass}" onclick="toggleLike(${m.id})">${likeIcon}</div>
                            <div class="action-btn" onclick="toggleCommentInput(${m.id})">ğŸ’¬</div>
                            <div class="action-btn" onclick="openForwardModal(${m.id})">â†–</div>
                        </div>
                    </div>
                    
                    <div class="comment-input-box" id="input-box-${m.id}">
                        <input type="text" id="input-${m.id}" placeholder="è¯„è®ºä¸€å¥...">
                        <button class="comment-send-btn" onclick="submitComment(${m.id})">å‘é€</button>
                    </div>
                    
                    ${commentsHtml}
                    
                    <div class="moment-time"><span>${m.time}</span></div>
                </div>`;
        });
    }
    /* ================= API é¢„è®¾åŠŸèƒ½ ================= */

    // 1. ä¿å­˜é¢„è®¾
    async function saveApiPreset() {
        const url = document.getElementById('api-url').value;
        const key = document.getElementById('api-key').value;
        const model = document.getElementById('api-model-select').value;

        if(!url || !key) return alert("è¯·å…ˆå¡«å†™ URL å’Œ å¯†é’¥");

        const name = prompt("ç»™è¿™ä¸ªé…ç½®èµ·ä¸ªåå­—å§ (ä¾‹å¦‚: DeepSeek):");
        if(!name) return; // å¦‚æœç‚¹å‡»å–æ¶ˆï¼Œå°±ä¸ä¿å­˜

        let presets = await DB.get('api_presets');
        if (!Array.isArray(presets)) presets = []; // å¦‚æœè¿˜æ²¡æœ‰é¢„è®¾ï¼Œåˆå§‹åŒ–ä¸ºç©ºæ•°ç»„

        presets.push({
            id: Date.now().toString(), // ç”¨æ—¶é—´æˆ³åšID
            name: name,
            url: url,
            key: key,
            model: model
        });

        await DB.set('api_presets', presets);
        renderApiPresets(); // åˆ·æ–°åˆ—è¡¨
        alert("âœ… é¢„è®¾å·²ä¿å­˜");
    }

    // 2. æ¸²æŸ“é¢„è®¾åˆ—è¡¨
    async function renderApiPresets() {
        const presets = await DB.get('api_presets');
        const box = document.getElementById('api-preset-list');
        box.innerHTML = '';

        if (!Array.isArray(presets) || presets.length === 0) {
            box.innerHTML = '<div style="text-align:center; color:#ccc; font-size:12px; padding:10px;">æš‚æ— é¢„è®¾</div>';
            return;
        }

        presets.forEach(p => {
            // åˆ›å»ºåˆ—è¡¨é¡¹
            const item = document.createElement('div');
            item.className = 'list-item';
            item.style.marginBottom = '8px'; //ç¨å¾®ç´§å‡‘ç‚¹
            
            item.innerHTML = `
                <div class="item-main" onclick="loadApiPreset('${p.id}')">
                    <div class="icon-box" style="width:36px; height:36px; font-size:18px; background:#e1e1e1; margin-right:10px;">âš¡</div>
                    <div class="item-text">
                        <h3 style="font-size:15px;">${p.name}</h3>
                        <p style="font-size:11px;">${p.model || 'æœªé€‰æ¨¡å‹'}</p>
                    </div>
                </div>
                <button class="nav-btn danger" style="padding:5px 10px;" onclick="deleteApiPreset('${p.id}')">ğŸ—‘ï¸</button>
            `;
            box.appendChild(item);
        });
    }

    // 3. åŠ è½½é¢„è®¾ (ç‚¹å‡»åˆ—è¡¨é¡¹æ—¶è§¦å‘)
    async function loadApiPreset(id) {
        const presets = await DB.get('api_presets');
        const p = presets.find(x => x.id == id);
        if(!p) return;

        document.getElementById('api-url').value = p.url;
        document.getElementById('api-key').value = p.key;
        
        // å¤„ç†æ¨¡å‹ä¸‹æ‹‰æ¡†ï¼šå› ä¸ºç›´æ¥å¡«å€¼å¯èƒ½ä¸‹æ‹‰æ¡†é‡Œæ²¡æœ‰è¿™ä¸ªé€‰é¡¹ï¼Œæ‰€ä»¥è¦æ‰‹åŠ¨åŠ è¿›å»
        const sel = document.getElementById('api-model-select');
        // å…ˆæ¸…ç©ºï¼Œæˆ–è€…ä¿ç•™æç¤º
        sel.innerHTML = '<option value="">è¯·æ‹‰å–æˆ–ç›´æ¥ä½¿ç”¨</option>';
        if(p.model) {
            const opt = document.createElement('option');
            opt.value = p.model;
            opt.innerText = p.model;
            opt.selected = true; // è®¾ä¸ºé€‰ä¸­
            sel.appendChild(opt);
        }
        
        alert(`å·²åŠ è½½é¢„è®¾ï¼š${p.name}\nè®°å¾—ç‚¹ä¸Šé¢çš„ã€ä¿å­˜é…ç½®ã€‘ç”Ÿæ•ˆå“¦ï¼`);
    }

    // 4. åˆ é™¤é¢„è®¾
    async function deleteApiPreset(id) {
        if(!confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªé¢„è®¾å—ï¼Ÿ")) return;
        let presets = await DB.get('api_presets');
        presets = presets.filter(x => x.id != id);
        await DB.set('api_presets', presets);
        renderApiPresets();
    }
    /* ================= è½¬å‘åŠ¨æ€åŠŸèƒ½ ================= */
    
    let currentForwardId = null; // è®°å½•æ­£åœ¨è½¬å‘å“ªæ¡

    // 1. æ‰“å¼€è½¬å‘å¼¹çª—
    async function openForwardModal(id) {
        currentForwardId = id;
        
        let moments = await DB.get('moments');
        const m = moments.find(x => x.id == id);
        if(!m) return;

        // å¡«å……é¢„è§ˆåŒºåŸŸ
        const previewBox = document.getElementById('forward-preview-box');
        
        // é€»è¾‘åˆ¤æ–­ï¼šå¦‚æœè½¬å‘çš„æ˜¯"å·²ç»æ˜¯è½¬å‘çš„åŠ¨æ€"ï¼Œæˆ‘ä»¬è¦è½¬å‘"æœ€åŸå§‹"çš„é‚£æ¡
        // ä¹Ÿå°±æ˜¯ï¼šå¥—å¨ƒåªå¥—ä¸€å±‚ï¼Œä¸æ— é™å¥—å¨ƒ
        let targetName = m.name;
        let targetContent = m.content;
        
        if (m.forwardedFrom) {
            targetName = m.forwardedFrom.name;
            targetContent = m.forwardedFrom.content;
        }

        previewBox.innerHTML = `
            <span class="fwd-name">@${targetName}</span>
            <span class="fwd-content">${targetContent}</span>
        `;
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('forward-text-input').value = '';
        openModal('modal-forward-input');
    }

    // 2. ç¡®è®¤è½¬å‘
    async function confirmForwardMoment() {
        if(!currentForwardId) return;
        
        const text = document.getElementById('forward-text-input').value.trim() || "è½¬å‘åŠ¨æ€"; // æ²¡å†™å­—å°±é»˜è®¤å¡«è¿™ä¸ª
        
        // è·å–åŸå§‹æ•°æ®
        let moments = await DB.get('moments');
        const original = moments.find(x => x.id == currentForwardId);
        if(!original) return;

        // è·å–"æˆ‘"çš„ä¿¡æ¯
        const userPersonas = await DB.get('user_personas');
        const curPid = localStorage.getItem('cur_pid') || (userPersonas[0] && userPersonas[0].id);
        const me = userPersonas.find(p => p.id == curPid) || { name: "æˆ‘", avatar: "" };

        // ç¡®å®šè¦é•¶åµŒçš„å†…å®¹ï¼ˆå¦‚æœåŸåŠ¨æ€ä¹Ÿæ˜¯è½¬å‘çš„ï¼Œå°±å–æœ€é‡Œé¢é‚£å±‚ï¼‰
        let fwdData = {
            name: original.name,
            content: original.content
        };
        if (original.forwardedFrom) {
            fwdData = original.forwardedFrom;
        }

        // åˆ›å»ºæ–°åŠ¨æ€å¯¹è±¡
        const newMoment = {
            id: Date.now() + Math.random(),
            charId: 'ME',       // æ ‡è®°æ˜¯æˆ‘å‘çš„
            name: me.name,
            avatar: me.avatar || DEFAULT_AVATAR, // ç¡®ä¿æœ‰å¤´åƒ
            content: text,      // æˆ‘çš„è¯„è®º
            time: new Date().toLocaleString(),
            likeCount: 0,       // æ–°å‘çš„èµæ˜¯0
            isLiked: false,
            comments: [],
            
            // â˜…â˜…â˜… æ ¸å¿ƒï¼šè¿™é‡Œå­˜å…¥é•¶åµŒæ•°æ® â˜…â˜…â˜…
            forwardedFrom: fwdData 
        };

        // ä¿å­˜å¹¶åˆ·æ–°
        moments.unshift(newMoment);
        await DB.set('moments', moments);
        
        closeModal('modal-forward-input');
        renderMoments();
        
        // æ»šåŠ¨åˆ°é¡¶éƒ¨çœ‹æ–°åŠ¨æ€
        document.getElementById('view-moments').querySelector('.scroll-content').scrollTop = 0;
    }
    /* ================= æœç´¢åŠŸèƒ½é€»è¾‘ (è¡¥å…¨) ================= */
    
    async function searchChatHistory() {
        // 1. è·å–æœç´¢æ¡†é‡Œçš„å­—
        const inputEl = document.getElementById('space-search-input');
        const keyword = inputEl.value.trim();
        
        if (!keyword) return alert("è¯·è¾“å…¥è¦æœç´¢çš„å†…å®¹~");

        // 2. å‡†å¤‡æ•°æ®
        const sessions = await DB.get('sessions');
        const characters = await DB.get('characters');
        // ç®€å•è·å–â€œæˆ‘â€çš„åå­—ï¼Œç”¨äºæ˜¾ç¤º
        const userPersonas = await DB.get('user_personas');
        const curPid = localStorage.getItem('cur_pid');
        const me = userPersonas.find(p => p.id == curPid) || { name: "æˆ‘" };

        let results = [];

        // 3. å¼€å§‹éå†æ‰€æœ‰ä¼šè¯
        sessions.forEach(s => {
            // ç¡®å®šè¿™ä¸ªä¼šè¯çš„åå­—ï¼ˆæ˜¯å’Œè°èŠçš„ï¼‰
            let chatName = s.name;
            if (s.type === 'direct') {
                const c = characters.find(x => x.id === s.targetId);
                if (c) chatName = c.name;
            }

            // éå†è¿™ä¸ªä¼šè¯é‡Œçš„æ¯ä¸€æ¡æ¶ˆæ¯
            s.msgs.forEach(m => {
                // åªè¦å†…å®¹åŒ…å«å…³é”®è¯ï¼ˆæ’é™¤å›¾ç‰‡ç­‰éæ–‡æœ¬ï¼‰
                if (typeof m.content === 'string' && m.content.includes(keyword)) {
                    
                    // ç¡®å®šæ˜¯è°å‘çš„
                    let senderName = "æœªçŸ¥";
                    if (m.role === 'user') {
                        senderName = me.name;
                    } else {
                        const c = characters.find(x => x.id === m.senderId);
                        senderName = c ? c.name : chatName;
                    }

                    // å­˜å…¥ç»“æœåˆ—è¡¨
                    results.push({
                        sessionId: s.id,
                        chatName: chatName,
                        senderName: senderName,
                        content: m.content,
                        time: m.t
                    });
                }
            });
        });

        // 4. æ¸²æŸ“æœç´¢ç»“æœ
        const box = document.getElementById('search-result-list');
        box.innerHTML = '';

        if (results.length === 0) {
            box.innerHTML = `<div style="padding:30px; text-align:center; color:#999;">
                <div style="font-size:30px; margin-bottom:10px;">ğŸ‚</div>
                æ²¡æœ‰æ‰¾åˆ°åŒ…å« "${keyword}" çš„è®°å½•
            </div>`;
        } else {
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            results.sort((a, b) => b.time - a.time);

            results.forEach(r => {
                const timeStr = new Date(r.time).toLocaleString();
                // é«˜äº®å…³é”®è¯
                const highlightContent = r.content.replace(new RegExp(keyword, 'g'), `<span style="color:#ff3b30;font-weight:bold;">${keyword}</span>`);

                box.innerHTML += `
                    <div class="list-item" onclick="jumpToChatFromSearch('${r.sessionId}')">
                        <div class="item-main">
                            <div class="item-text">
                                <h3 style="display:flex;justify-content:space-between;">
                                    ${r.chatName} 
                                    <span style="font-size:11px; font-weight:normal; color:#ccc;">${timeStr}</span>
                                </h3>
                                <p><span style="color:#007AFF;">${r.senderName}:</span> ${highlightContent}</p>
                            </div>
                        </div>
                    </div>`;
            });
        }

        // 5. æ˜¾ç¤ºå¼¹çª—
        openModal('modal-search-result');
    }

    // è·³è½¬åŠŸèƒ½çš„è¾…åŠ©å‡½æ•°
    async function jumpToChatFromSearch(sid) {
        closeModal('modal-search-result'); // å…³æ‰æœç´¢ç»“æœ
        // åˆ‡æ¢åˆ°åº•éƒ¨â€œæ¶ˆæ¯â€Tab
        switchChatTab('msg');
        // è¿›å…¥èŠå¤©
        await enterChat(sid);
    }
/* ================= ä¸ªäººä¸»é¡µå¤´éƒ¨é€»è¾‘ (ä¿®å¤ç‰ˆï¼šæ°¸ä¹…ä¿å­˜) ================= */

// 1. æ¸²æŸ“ä¸ªäººä¸»é¡µ (ğŸ‘‘ è´µæ—ç‰¹æƒå¢å¼ºç‰ˆ)
    async function renderZoneHeader() {
        const userPersonas = await DB.get('user_personas');
        const curPid = localStorage.getItem('cur_pid') || (userPersonas[0] && userPersonas[0].id);
        const me = userPersonas.find(p => p.id == curPid) || { name: "æˆ‘", avatar: "" };

        const nameEl = document.getElementById('zone-my-name');
        const avatarEl = document.getElementById('zone-my-avatar');
        const visitorEl = document.getElementById('zone-visitor-count');

        // è®¾ç½®å¤´åƒ
        avatarEl.src = me.avatar || DEFAULT_AVATAR;

        // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ£€æŸ¥è´µæ—çŠ¶æ€å¹¶æ”¹å˜åå­—æ ·å¼ â˜…â˜…â˜…
        const vipInfo = await DB.getObj('vip_info');
        const isVip = vipInfo && vipInfo.expiry > Date.now();

        if (isVip) {
            // æ˜¯è´µæ—ï¼šåå­—å˜çº¢ + åŠ çš‡å†  (å¤ç”¨ä¹‹å‰çš„å‘¼å¸åŠ¨ç”»ç±» vip-crown-icon)
            nameEl.innerHTML = `${me.name} <span class="vip-crown-icon" style="font-size:18px; vertical-align: text-bottom;">ğŸ‘‘</span>`;
            nameEl.style.color = "#ff0000";
            nameEl.style.textShadow = "0 1px 4px rgba(255, 0, 0, 0.2)"; // åŠ ç‚¹çº¢è‰²å…‰æ™•
        } else {
            // æ™®é€šäººï¼šæ¢å¤åŸæ ·
            nameEl.innerText = me.name;
            nameEl.style.color = "#333";
            nameEl.style.textShadow = "0 1px 2px rgba(255,255,255,0.8)";
        }

        // â˜…â˜…â˜… ä¿®å¤ç‚¹ï¼šä» DB è¯»å–å£çº¸ â˜…â˜…â˜…
        const savedBg = await DB.get('zone_bg_image'); 
        const view = document.getElementById('view-moments');
        
        if (savedBg) {
            view.style.backgroundImage = `url('${savedBg}')`;
        } else {
            view.style.backgroundImage = 'none';
        }

        // è®¿å®¢æ•°é€»è¾‘ (ä¿æŒä¸å˜)
        let visitors = parseInt(localStorage.getItem('zone_visitors')) || 61314;
        if(Math.random() > 0.5) { visitors++; localStorage.setItem('zone_visitors', visitors); }
        visitorEl.innerText = visitors;
    }

    // 2. æ¢èƒŒæ™¯åŠŸèƒ½ (è£…æ‰®)
    function changeZoneBg(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                const base64 = e.target.result;
                
                // 1. ç«‹å³æ˜¾ç¤ºåœ¨å±å¹•ä¸Š (æ— éœ€ç­‰å¾…ä¿å­˜)
                document.getElementById('view-moments').style.backgroundImage = `url('${base64}')`;
                
                // 2. â˜…â˜…â˜… ä¿®å¤ç‚¹ï¼šå­˜å…¥ DB (æ— é™å­˜å‚¨) â˜…â˜…â˜…
                try {
                    await DB.set('zone_bg_image', base64);
                    // è¿™é‡Œå¯ä»¥åŠ ä¸ªå°æç¤ºï¼Œæˆ–è€…é™é»˜ä¿å­˜
                    console.log("å£çº¸ä¿å­˜æˆåŠŸ"); 
                } catch (err) {
                    alert("å›¾ç‰‡å¤ªå¤§äº†ï¼Œä¿å­˜å¤±è´¥ï¼Œå»ºè®®å‹ç¼©ä¸€ä¸‹å“¦");
                }
            }
            reader.readAsDataURL(file);
        }
    }
    /* ================= è£…æ‰®é¡µé¢é€»è¾‘ ================= */

    // 1. å®æ—¶è°ƒæ•´é€æ˜åº¦
    function updateCardOpacity(val) {
        // æ”¹å˜ CSS å˜é‡
        document.documentElement.style.setProperty('--moment-opacity', val);
        // æ›´æ–°æ˜¾ç¤ºçš„ç™¾åˆ†æ¯”
        document.getElementById('opacity-display').innerText = Math.round(val * 100) + '%';
        // ä¿å­˜åˆ°æœ¬åœ°
        localStorage.setItem('moment_card_opacity', val);
    }

    // 2. åˆå§‹åŒ–åŠ è½½é€æ˜åº¦ (éœ€è¦åœ¨é¡µé¢åŠ è½½æ—¶è°ƒç”¨)
    function initDecoSettings() {
        const savedOp = localStorage.getItem('moment_card_opacity');
        if (savedOp) {
            // åº”ç”¨ä¿å­˜çš„å€¼
            document.documentElement.style.setProperty('--moment-opacity', savedOp);
            // å¦‚æœæ»‘å—å­˜åœ¨ï¼Œä¹Ÿæ›´æ–°æ»‘å—ä½ç½®
            const slider = document.getElementById('card-opacity-slider');
            if(slider) {
                slider.value = savedOp;
                document.getElementById('opacity-display').innerText = Math.round(savedOp * 100) + '%';
            }
        }
    }
    /* ================= æˆ‘çš„è¯´è¯´é¡µé¢é€»è¾‘ ================= */

    async function openMyMoments() {
        // 1. è·³è½¬é¡µé¢
        navTo('view-my-moments');

        // 2. åŒæ­¥èƒŒæ™¯å£çº¸
        const savedBg = await DB.get('zone_bg_image');
        const view = document.getElementById('view-my-moments');
        
        view.style.backgroundRepeat = 'no-repeat';
        view.style.backgroundPosition = 'center';
        view.style.backgroundSize = 'cover';
        view.style.backgroundAttachment = 'fixed';

        if (savedBg) {
            view.style.backgroundImage = `url('${savedBg}')`;
        } else {
            view.style.backgroundColor = '#f2f2f7';
            view.style.backgroundImage = 'none';
        }

        // 3. è·å–æ•°æ®
        let moments = await DB.get('moments');
        if (!moments) moments = [];
        const myMoments = moments.filter(m => m.charId === 'ME');
        myMoments.sort((a, b) => b.id - a.id);

        // â˜…â˜…â˜… æ–°å¢ï¼šè·å–è´µæ—çŠ¶æ€ â˜…â˜…â˜…
        const vipInfo = await DB.getObj('vip_info'); 
        const now = Date.now();
        const isVip = vipInfo && vipInfo.expiry > now;

        const box = document.getElementById('list-my-moments');
        box.innerHTML = '';

        // 4. ç©ºçŠ¶æ€
        if (myMoments.length === 0) {
            box.innerHTML = `
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #999; font-size: 14px;">
                    <div style="font-size:40px; margin-bottom:10px;">ğŸƒ</div>
                    æ‚¨è¿˜æ²¡æœ‰å‘è¿‡åŠ¨æ€~
                </div>`;
            return;
        }

        // 5. æ¸²æŸ“åˆ—è¡¨
        myMoments.forEach(m => {
            const ava = m.avatar || DEFAULT_AVATAR;
            const likeClass = m.isLiked ? 'liked' : '';
            const likeIcon = m.isLiked ? 'â¤ï¸' : 'ğŸ¤';
            
            // â˜…â˜…â˜… ä¿®å¤ç‚¹ï¼šå¦‚æœæ˜¯è´µæ—ï¼Œåå­—å˜çº¢+çš‡å†  â˜…â˜…â˜…
            let nameHtml = m.name;
            let nameClass = 'moment-name';
            if (isVip) {
                nameClass += ' is-vip'; 
                nameHtml += ` <span class="vip-crown-icon">ğŸ‘‘</span>`; 
            }

            // å¤„ç†è½¬å‘
            let contentHtml = `<div class="moment-content">${m.content}</div>`;
            if (m.forwardedFrom) {
                contentHtml += `<div class="forward-box"><span class="fwd-name">@${m.forwardedFrom.name}</span><span class="fwd-content">${m.forwardedFrom.content}</span></div>`;
            }
            // å¤„ç†å›¾ç‰‡
            if (m.image) {
                contentHtml += `<img src="${m.image}" class="moment-photo">`;
            }
            // å¤„ç†ä½ç½®
            if (m.location) {
                contentHtml += `<div class="moment-location">${m.location}</div>`;
            }

            let commentsHtml = '';
            if (m.comments && m.comments.length > 0) {
                commentsHtml += `<div class="comment-area show">`;
                m.comments.forEach(c => {
                    commentsHtml += `<div class="comment-row"><span class="comment-user">${c.name}</span>: <span class="comment-content">${c.content}</span></div>`;
                });
                commentsHtml += `</div>`;
            }

            // æ‹¼æ¥ HTML
            // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è¿™é‡Œä¹ŸåŠ ä¸Šé•¿æŒ‰ç›‘å¬ ğŸ‘‡ğŸ‘‡ğŸ‘‡
            box.innerHTML += `
                <div class="moment-card"
                     oncontextmenu="return false;"
                     onmousedown="startMomentPress(${m.id})" 
                     ontouchstart="startMomentPress(${m.id})"
                     onmouseup="cancelMomentPress()" 
                     ontouchend="cancelMomentPress()" 
                     ontouchmove="cancelMomentPress()"
                >
                    <div class="moment-header" style="justify-content:space-between;">
                        <!-- ... é‡Œé¢çš„å†…å®¹ä¿æŒä¸å˜ ... -->
                        <div style="display:flex; align-items:center; flex:1; overflow:hidden;">
                            <img src="${ava}" class="moment-avatar">
                            <!-- è¿™é‡Œä½¿ç”¨äº†æ–°çš„ nameClass å’Œ nameHtml -->
                            <div class="${nameClass}">${nameHtml}</div>
                        </div>
                         <div class="moment-more-btn" style="font-size:14px;" onclick="deleteMyMoment(${m.id})">ğŸ—‘ï¸</div>
                    </div>
                    
                    ${contentHtml}
                    
                    <div class="moment-actions">
                        <span class="like-stat">å·²æœ‰ ${m.likeCount || 0} äººç‚¹èµ</span>
                        <div style="display:flex; gap:20px;">
                            <div class="action-btn ${likeClass}">${likeIcon}</div>
                            <div class="action-btn">ğŸ’¬</div>
                        </div>
                    </div>
                    ${commentsHtml}
                    <div class="moment-time"><span>${m.time}</span></div>
                </div>`;
        });
    }

    // é™„èµ ä¸€ä¸ªï¼šåˆ é™¤è‡ªå·±åŠ¨æ€çš„åŠŸèƒ½
    async function deleteMyMoment(id) {
        if(!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿ")) return;
        
        let moments = await DB.get('moments');
        moments = moments.filter(m => m.id != id);
        await DB.set('moments', moments);
        
        // åˆ·æ–°å½“å‰é¡µé¢
        openMyMoments();
    }
    /* ================= è´µæ—/VIPé¡µé¢é€»è¾‘ ================= */

    // 1. æ‰“å¼€è´µæ—é¡µé¢
    // 2. æ‰“å¼€è´µæ—é¡µé¢ (æ˜¾ç¤ºè‡ªåŠ¨ç»­è´¹çŠ¶æ€)
async function openVipPage() {
    navTo('view-vip');

    // è§¦å‘ä¸€æ¬¡è‡ªåŠ¨ç»­è´¹æ£€æŸ¥ï¼ˆä»¥é˜²åˆšå¥½è¿‡æœŸäº†ï¼‰
    await checkAutoRenewSystem();

    const userPersonas = await DB.get('user_personas');
    const curPid = localStorage.getItem('cur_pid') || (userPersonas[0] && userPersonas[0].id);
    const me = userPersonas.find(p => p.id == curPid) || { name: "æˆ‘", avatar: "" };
    document.getElementById('vip-user-avatar').src = me.avatar || DEFAULT_AVATAR;
    document.getElementById('vip-user-name').innerText = me.name;

    // è·å–ä¿¡æ¯
    const vipInfo = await DB.getObj('vip_info');
    const now = Date.now();
    const idLabel = document.getElementById('vip-user-id');
    const switchEl = document.getElementById('vip-auto-renew-switch');

    // è®¾ç½®å¼€å…³çŠ¶æ€
    switchEl.checked = !!(vipInfo && vipInfo.autoRenew);

    if (vipInfo && vipInfo.expiry > now) {
        const date = new Date(vipInfo.expiry);
        let timeStr = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes()}`;
        
        // â˜…â˜…â˜… å¦‚æœå¼€å¯äº†è‡ªåŠ¨ç»­è´¹ï¼Œè¿½åŠ æç¤ºæ–‡å­— â˜…â˜…â˜…
        if (vipInfo.autoRenew) {
            timeStr += ` (å·²è‡ªåŠ¨ç»­è´¹)`;
        }

        idLabel.innerText = `å°Šè´µçš„VIPï¼Œæœ‰æ•ˆæœŸè‡³ï¼š${timeStr}`;
        idLabel.style.color = "#D4A048";
        idLabel.style.fontWeight = "bold";
    } else {
        idLabel.innerText = 'æ‚¨è¿˜æ²¡æœ‰å¼€é€šè¿‡è´µæ—ï¼Œæˆ–ç‰¹æƒå·²è¿‡æœŸ';
        idLabel.style.color = "#999";
        idLabel.style.fontWeight = "normal";
        // å¦‚æœè¿‡æœŸäº†ï¼Œå¼€å…³è™½ç„¶æ˜¾ç¤ºçŠ¶æ€ï¼Œä½†å…¶å®æ²¡æ„ä¹‰ï¼Œå¯ä»¥ä¸å¼ºåˆ¶å…³ï¼Œæ–¹ä¾¿ä¸‹æ¬¡ä¹°
    }

    const firstCard = document.querySelector('.price-card');
    if(firstCard && !document.querySelector('.price-card.active')) {
        selectVipPrice(1, 10, firstCard);
    }
}

// å•ç‹¬ç‚¹å‡»å¼€å…³æ—¶ï¼Œæ›´æ–°æ•°æ®åº“çŠ¶æ€
async function toggleAutoRenewState(el) {
    let vipInfo = await DB.getObj('vip_info');
    if (vipInfo) {
        vipInfo.autoRenew = el.checked;
        await DB.set('vip_info', vipInfo);
        openVipPage(); // åˆ·æ–°æ–‡å­—æ˜¾ç¤º
    }
}
    /* ================= ğŸ’° æ–°å¢ï¼šè½¬è´¦äº¤äº’é€»è¾‘ ================= */

// 1. æ‰“å¼€è½¬è´¦å¼¹çª—
// ================= ğŸ§§ ä¿®å¤åçš„æ‰“å¼€è½¬è´¦å¼¹çª— =================
function openTransferModal() {
    // 1. å…³é”®ä¿®å¤ï¼šå…³é—­åº•éƒ¨é¢æ¿
    closeToolPanel(); 
    
    // 2. æ¸…ç©ºä¹‹å‰çš„è¾“å…¥æ•°æ®
    const amountInput = document.getElementById('transfer-amount-val');
    const descInput = document.getElementById('transfer-desc-val');
    const display = document.getElementById('trans-amount-display');

    if(amountInput) amountInput.value = '';
    if(descInput) descInput.value = '';
    if(display) display.innerText = '0.00';
    
    // 3. æ‰“å¼€å¼¹çª—
    openModal('modal-transfer-input');
}

// 2. å‘é€è½¬è´¦æ¶ˆæ¯ (ç”¨æˆ· -> AI)
// ================= ğŸ’° ä¿®å¤åçš„å‘é€è½¬è´¦é€»è¾‘ =================
async function sendTransferMsg() {
    const amtInput = document.getElementById('transfer-amount-val');
    const descInput = document.getElementById('transfer-desc-val');
    
    const amt = amtInput.value;
    const desc = descInput.value || 'è½¬è´¦ç»™TA';

    if(!amt || parseFloat(amt) <= 0) return alert("è¯·è¾“å…¥æ­£ç¡®çš„é‡‘é¢");

    const userPersonas = await DB.get('user_personas');
    const curPid = localStorage.getItem('cur_pid') || (userPersonas[0] && userPersonas[0].id);
    const t = Date.now();

    // æ„å»ºè½¬è´¦æ¶ˆæ¯æ•°æ®
    const msg = {
        role: 'user', 
        type: 'transfer', 
        amount: amt, 
        desc: desc,
        transStatus: 'pending', // çŠ¶æ€ï¼šç­‰å¾…å¯¹æ–¹ç¡®è®¤
        personaId: curPid, 
        t: t
    };

    // 1. å­˜å…¥æ•°æ®åº“
    const list = await DB.get('sessions'); 
    const idx = list.findIndex(x => x.id == currentChatId);
    if (idx !== -1) {
        list[idx].msgs.push(msg);
        await DB.set('sessions', list);
    }
    
    // 2. å…³é—­å¼¹çª—
    closeModal('modal-transfer-input');
    
    // 3. åˆ·æ–°èŠå¤©ç•Œé¢ï¼Œè®©å¡ç‰‡æ˜¾ç¤ºå‡ºæ¥
    await renderMessages(); 
}

// 3. å¤„ç†è½¬è´¦ (ä»…ç”¨äº AI å‘ç»™æˆ‘æ—¶ï¼Œæˆ‘ç‚¹å‡»æŒ‰é’®)
async function handleTransfer(msgTime, action) {
    const list = await DB.get('sessions');
    const idx = list.findIndex(s => s.id === currentChatId);
    if(idx === -1) return;
    
    const sess = list[idx];
    const msgIndex = sess.msgs.findIndex(m => m.t == msgTime);
    if(msgIndex === -1) return;
    const msg = sess.msgs[msgIndex];
    
    // ä¿®æ”¹çŠ¶æ€
    msg.transStatus = action; 

    // æ’å…¥ç³»ç»Ÿå°ç°æ¡
    const characters = await DB.get('characters');
    const char = characters.find(c => c.id === sess.targetId);
    const charName = char ? char.name : "å¯¹æ–¹";
    
    // å› ä¸ºè¿™æ˜¯æˆ‘æ“ä½œçš„ï¼Œæ‰€ä»¥è‚¯å®šæ˜¯ AI å‘ç»™æˆ‘çš„
    const sysText = action === 'accepted' ? `ä½ å·²é¢†å–äº†${charName}çš„è½¬è´¦` : `ä½ å·²é€€è¿˜äº†${charName}çš„è½¬è´¦`;

    sess.msgs.splice(msgIndex + 1, 0, {
        role: 'system', type: 'system', content: sysText, t: Date.now()
    });
    
    await DB.set('sessions', list);
    renderMessages();
}

/* ================= âš¡ é‡å†™ AI å›å¤é€»è¾‘ (æ”¯æŒè½¬è´¦åˆ¤å®š) ================= */
// è¯·å°†æ­¤å‡½æ•°è¦†ç›–åŸæœ‰çš„ triggerAiReply
/* ================= âš¡ é‡å†™ AI å›å¤é€»è¾‘ (æ”¯æŒå›¾ç‰‡æ–‡å­—åˆ†å¼€å‘é€) ================= */
/* ================= âš¡ æœ€ç»ˆç‰ˆ AI å›å¤ (åŠ å¼ºå¿ƒå£°ç‰ˆ + æ‰€æœ‰åŠŸèƒ½åˆé›†) ================= */
/* ================= âš¡ æœ€ç»ˆç‰ˆ AI å›å¤ (è‡ªåŠ¨æ”¶é”®ç›˜ç‰ˆ) ================= */
    /* ================= âš¡ æœ€ç»ˆç‰ˆ AI å›å¤ (é”®ç›˜å¸¸é©»ç‰ˆ) ================= */
/* ================= âš¡ æœ€ç»ˆå¢å¼ºç‰ˆ AI å›å¤ (å®¹é”™ç‡ MAX) ================= */
/* ================= âš¡ å”¯ä¸€çœŸç¥ç‰ˆ AI å›å¤é€»è¾‘ (è¯·åªä¿ç•™è¿™ä¸€ä¸ª) ================= */
/* ================= âš¡ å”¯ä¸€çœŸç¥ç‰ˆ AI å›å¤ (èåˆæ€§åˆ«è¡¥ä¸+å¼ºåˆ¶å¿ƒå£°+å‘åŠ¨æ€) ================= */
/* ================= âš¡ å”¯ä¸€çœŸç¥ç‰ˆ AI å›å¤ (å«æ—¶é—´è·¨åº¦æ„ŸçŸ¥ + è‡ªåŠ¨åŠ¨æ€) ================= */
/* ================= âš¡ å”¯ä¸€çœŸç¥ç‰ˆ AI å›å¤ (ä¸¥æ ¼è¡¨æƒ…åŒ…æ§åˆ¶ + æ—¶é—´æ„ŸçŸ¥) ================= */
/* ================= âš¡ å”¯ä¸€çœŸç¥ç‰ˆ AI å›å¤ (åŠ¨æ€æŒ‡ä»¤å¼€å…³ + è¡¨æƒ…æ§åˆ¶ + æ—¶é—´æ„ŸçŸ¥) ================= */
/* ================= âš¡ å”¯ä¸€çœŸç¥ç‰ˆ AI å›å¤ (ç»‘å®šæŒ‡ä»¤å¼€å…³ + æ—¶é—´æ„ŸçŸ¥) ================= */
async function triggerAiReply() {
    const inputEl = document.getElementById('msg-input');
    if(inputEl) inputEl.blur();

    const sessions = await DB.get('sessions');
    const characters = await DB.get('characters');
    const instructions = await DB.get('instructions');
    const userPersonas = await DB.get('user_personas');

    const sess = sessions.find(x => x.id == currentChatId);
    if (!sess) return;

    let tid = sess.type == 'direct' ? sess.targetId : sess.memberIds[Math.floor(Math.random() * sess.memberIds.length)];
    const char = characters.find(x => x.id == tid);
    if (!char) return alert("è§’è‰²ä¸¢å¤±");

    const ava = char.avatar || DEFAULT_AVATAR;
    const box = document.getElementById('chat-msg-container');
    const loadId = 'loading-' + Date.now();

    await tryAppendTimestamp(box, Date.now());

    const loadingHtml = `<div class="msg-row ai" id="${loadId}"><img src="${ava}" class="msg-avatar"><div class="msg-bubble"><div class="typing"><div class="dot"></div><div class="dot"></div></div></div></div>`;
    box.insertAdjacentHTML('beforeend', loadingHtml);
    box.scrollTop = box.scrollHeight;

    // --- 4. æ„å»ºç³»ç»Ÿæç¤ºè¯ (Prompt) ---
    let sys = `ä½ æ‰®æ¼”${char.name}ã€‚è®¾å®šï¼š${char.prompt}\n`;

    // åŠ¨æ€æŒ‡ä»¤æ³¨å…¥
    if (char.insts && Array.isArray(char.insts)) {
        char.insts.forEach(iid => { 
            const ins = instructions.find(x => x.id == iid); 
            if (ins) {
                sys += `\nã€ç³»ç»ŸæŒ‡ä»¤-${ins.title}ã€‘:\n${ins.content}\n`; 
            }
        });
    }

    // æ€§åˆ«è®¤çŸ¥è¡¥ä¸
    const pid = localStorage.getItem('cur_pid') || (userPersonas[0] && userPersonas[0].id);
    const userP = userPersonas.find(x => x.id == pid);
    if (userP) {
        sys += `\nã€å½“å‰äº’åŠ¨å¯¹è±¡ï¼ˆç”¨æˆ·ï¼‰æ¡£æ¡ˆã€‘ï¼š
- åå­—ï¼š${userP.name}
- è®¾å®šï¼š${userP.prompt}
- âš ï¸âš ï¸ è®¤çŸ¥å¼ºåˆ¶ï¼šè¯·ä»”ç»†é˜…è¯»ç”¨æˆ·è®¾å®šã€‚å¦‚æœæš—ç¤ºæ˜¯å¥³æ€§ï¼Œå¿ƒå£°ä¸­å¿…é¡»ç”¨â€œå¥¹â€ï¼›äº’åŠ¨å¯¹è±¡æ˜¯ï¼š${userP.name}ã€‚\n`;
    }

    // ============================================================
    // ğŸš« è¡¨æƒ…åŒ…/å›¾ç‰‡ ä¸¥æ ¼æ§åˆ¶é€»è¾‘ (åŸºäºå¼€å…³)
    // ============================================================
    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šåªçœ‹å¼€å…³ï¼Œä¸å†åŠ è½½è¡¨æƒ…åº“ â˜…â˜…â˜…
    const allowStickers = sess.allowStickers || false; 

    if (allowStickers) {
        // å¦‚æœå¼€å…³å¼€å¯ï¼šæç¤ºå®ƒå¯ä»¥è‡ªç”±ä½¿ç”¨æŒ‡ä»¤é‡Œçš„å›¾ç‰‡
        sys += `\nã€å›¾ç‰‡å‘é€æƒé™ï¼šå·²å¼€å¯âœ…ã€‘\nä½ å¯ä»¥è‡ªç”±ä½¿ç”¨ã€ç³»ç»ŸæŒ‡ä»¤ã€‘ä¸­å®šä¹‰çš„å›¾ç‰‡é“¾æ¥ã€‚\næ ¼å¼ï¼š(img:é“¾æ¥)ã€‚è¯·åœ¨åˆé€‚çš„è¯­å¢ƒä¸‹å‘é€è¡¨æƒ…åŒ…ã€‚\n`;
    } else {
        // å¦‚æœå¼€å…³å…³é—­ï¼šä¸¥å‰ç¦æ­¢
        sys += `\nã€å›¾ç‰‡å‘é€æƒé™ï¼šå·²å…³é—­ğŸš«ã€‘\nå½“å‰å¯¹è¯**ä¸¥ç¦å‘é€ä»»ä½•å›¾ç‰‡æˆ–è¡¨æƒ…åŒ…**ï¼\nè¯·ä¸è¦è¾“å‡ºä»»ä½• (img:...) æˆ–å›¾ç‰‡é“¾æ¥ã€‚\nå¿…é¡»ä»…ä½¿ç”¨çº¯æ–‡å­—å›å¤ï¼\n`;
    }
    // ============================================================

    // è®°å¿†æ³¨å…¥
    let memoryContext = "";
    if (sess.refinedMemories && sess.refinedMemories.length > 0) memoryContext += "ã€æ ¸å¿ƒé•¿æœŸè®°å¿†ã€‘:\n" + sess.refinedMemories.join('\n') + "\n";
    if (sess.summaries && sess.summaries.length > 0) memoryContext += "ã€è¿‘æœŸæ‘˜è¦ã€‘:\n" + sess.summaries.join('\n') + "\n";
    if (memoryContext) sys += `\n[Memory]:\n${memoryContext}\n`;

    // æ—¶é—´æ„ŸçŸ¥
    if (sess.isTimeAware) {
        const now = new Date();
        const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const timeStr = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥ æ˜ŸæœŸ${weekDays[now.getDay()]} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        
        sys += `\n[å½“å‰ç³»ç»Ÿæ—¶é—´]: ${timeStr}ã€‚\n`;
        if (sess.msgs.length >= 2) {
            const lastMsg = sess.msgs[sess.msgs.length - 2]; 
            const lastTime = lastMsg.t;
            const diff = Date.now() - lastTime;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const lastD = new Date(lastTime);
            const lastDateStr = `${lastD.getMonth() + 1}æœˆ${lastD.getDate()}æ—¥ ${String(lastD.getHours()).padStart(2,'0')}:${String(lastD.getMinutes()).padStart(2,'0')}`;

            if (minutes > 30) {
                let durationStr = days > 0 ? `${days}å¤©` : (hours > 0 ? `${hours}å°æ—¶` : `${minutes}åˆ†é’Ÿ`);
                sys += `\nã€âš¡æ—¶é—´è·¨åº¦âš¡ã€‘ä¸Šæ¬¡å¯¹è¯ç»“æŸäºï¼š${lastDateStr}ã€‚å·²è¿‡å»ã€${durationStr}ã€‘ã€‚è¯·æ ¹æ®äººè®¾å¯¹â€œæ–­è”æ—¶é—´â€åšå‡ºååº”ã€‚\n`;
            } else {
                sys += `\n[æ—¶é—´çŠ¶æ€]: å¯¹è¯æŒç»­è¿›è¡Œä¸­ã€‚\n`;
            }
        } else {
            sys += `\n[æ—¶é—´çŠ¶æ€]: ç¬¬ä¸€æ¬¡å¯¹è¯ã€‚\n`;
        }
    }

    // å¼ºåˆ¶å›å¤è§„åˆ™
    sys += `\nã€âš¡âš¡ç»å¯¹å›å¤è§„åˆ™âš¡âš¡ã€‘ï¼š
1. æ¯ä¸€è½®å›å¤ **å¿…é¡»** åŒ…å«å¿ƒå£°ï¼æ ¼å¼ï¼š(inner:è¿™é‡Œå†™ä½ çš„å¿ƒç†æ´»åŠ¨...)ã€‚
2. å¿ƒå£°å¿…é¡»å†™åœ¨æ­£æ–‡å‰é¢ã€‚å¿ƒå£°å­—æ•°åœ¨50-100
3. å¦‚æœç”¨æˆ·è®©ä½ å‘åŠ¨æ€ï¼Œä½ å¿…é¡»åœ¨å›å¤æœ«å°¾åŠ ä¸Š (opcode:post_moment)ã€‚
`;
sys += `\nã€ğŸ“¸ å›¾ç‰‡äº’åŠ¨æ¨¡å¼ã€‘ï¼š
1. å¦‚æœç”¨æˆ·å‘é€ (sim_img:æè¿°)ï¼Œä»£è¡¨ç”¨æˆ·ç»™ä½ å‘äº†ä¸€å¼ ç…§ç‰‡ï¼Œå†…å®¹æ˜¯â€œæè¿°â€ã€‚è¯·ä½ æ ¹æ®è¯­å¢ƒï¼Œå‡è£…çœ‹åˆ°äº†è¿™å¼ å›¾å¹¶è¿›è¡Œç‚¹è¯„ã€‚
2. ä½ ä¹Ÿå¯ä»¥å‘é€ç…§ç‰‡ï¼æ ¼å¼ï¼š(sim_img:ç”»é¢æè¿°)ã€‚
   ä¾‹å¦‚ï¼š(sim_img:å›¾ç‰‡ä¸­æœ‰å¾ˆå¤šé£Ÿç‰©ï¼Œè‹¹æœï¼Œæ¢¨å­ç­‰ã€‚)ã€‚
   è¯·åœ¨åˆé€‚çš„æ—¶å€™ï¼ˆæ¯”å¦‚åˆ†äº«ç”Ÿæ´»ã€å±•ç¤ºç‰©å“ï¼‰ä¸»åŠ¨ä½¿ç”¨æ­¤æ ¼å¼å‘å›¾ã€‚
`;

    // å†å²è®°å½•
    const limit = sess.memoryLimit || 20;
    let hist = sess.msgs.slice(-limit).filter(m => m.type !== 'system').map(m => {
        if (m.image) return { role: m.role === 'user' ? 'user' : 'assistant', content: m.content || "[å›¾ç‰‡]" };
        return { role: m.role === 'user' ? 'user' : 'assistant', content: m.content || "..." };
    });

    // å…³é”®è¯åŠ«æŒ
    const lastUserMsg = sess.msgs.slice().reverse().find(m => m.role === 'user');
    let userAskedForMoment = false;
    if (lastUserMsg && lastUserMsg.content) {
        const txt = typeof lastUserMsg.content === 'string' ? lastUserMsg.content : "";
        if (/å‘.*åŠ¨æ€|å‘.*æœ‹å‹åœˆ|å‘.*è¯´è¯´|å†™.*åŠ¨æ€/.test(txt)) userAskedForMoment = true;
    }

    hist.push({
        role: "system",
        content: `[System Override]: Please ensure your response starts with (inner:...) followed by your spoken text.`
    });

    try {
        const cfg = await DB.getObj('api_config');
        let url = cfg.url.replace(/\/$/, '');
        if (!url.endsWith('/chat/completions')) {
            if (url.endsWith('/v1')) url += '/chat/completions';
            else url += '/v1/chat/completions';
        }

        const res = await fetch(url, {
            method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${cfg.key}` },
            body: JSON.stringify({ model: cfg.model, messages: [{ role: 'system', content: sys }, ...hist], temperature: 0.85 })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error.message);

        let fullText = data.choices[0].message.content;

        // è½¬è´¦å¤„ç†
        const opRegex = /(?:\(|^|\s)opcode:\s*(accept|reject)(?:\)|$|\s)/i;
        const opMatch = fullText.match(opRegex);
        if (opMatch) {
            fullText = fullText.replace(opMatch[0], '').trim();
            const decision = opMatch[1].toLowerCase() === 'accept' ? 'accepted' : 'rejected';
            const freshList = await DB.get('sessions');
            const freshSess = freshList.find(s => s.id === currentChatId);
            const pendingTransfer = freshSess.msgs.slice().reverse().find(m => m.type === 'transfer' && m.role === 'user' && m.transStatus === 'pending');
            if (pendingTransfer) {
                pendingTransfer.transStatus = decision;
                const sysText = decision === 'accepted' ? `${char.name}å·²é¢†å–äº†ä½ çš„è½¬è´¦` : `${char.name}å·²é€€è¿˜äº†ä½ çš„è½¬è´¦`;
                const idx = freshSess.msgs.indexOf(pendingTransfer);
                if (idx !== -1) freshSess.msgs.splice(idx + 1, 0, { role: 'system', type: 'system', content: sysText, t: Date.now() });
                await DB.set('sessions', freshList);
                renderMessages();
            }
        }

        // åŠ¨æ€è§¦å‘é€»è¾‘
        let triggerMoment = false;
        const postOpRegex = /(?:\(|^|\s)opcode:\s*post_?moment(?:\)|$|\s)/i;
        if (postOpRegex.test(fullText)) {
            fullText = fullText.replace(postOpRegex, '');
            triggerMoment = true;
        }
        if (userAskedForMoment) triggerMoment = true;

        const probSetting = sess.aiMomentProb || 0; 
        if (!triggerMoment && probSetting > 0) {
            let luck = sess.momentLuckAccumulator || 0;
            let chance = probSetting <= 100 ? 0.2 : (probSetting <= 200 ? 0.1 : 0.05);
            if (Math.random() < chance) {
                triggerMoment = true;
                sess.momentLuckAccumulator = 0; 
            } else {
                sess.momentLuckAccumulator = luck + 1;
            }
             const tempList = await DB.get('sessions');
             const tempIdx = tempList.findIndex(s => s.id === currentChatId);
             if(tempIdx !== -1) {
                 tempList[tempIdx].momentLuckAccumulator = sess.momentLuckAccumulator;
                 await DB.set('sessions', tempList);
             }
        }
        if (triggerMoment) setTimeout(() => { autoGenerateMoment(char.id, sess.msgs); }, 1500);

        // å¿ƒå£°æå–
        let thoughtText = "";
        let tMatch = fullText.match(/\(inner:([\s\S]*?)\)/i);
        if (!tMatch) tMatch = fullText.match(/(?:^|\n)\s*inner:\s*([\s\S]*?)(?:$|\n)/i);
        if (!tMatch) tMatch = fullText.match(/\(å¿ƒå£°:([\s\S]*?)\)/i);

        if (tMatch) {
            thoughtText = tMatch[1];
            fullText = fullText.replace(tMatch[0], ""); 
        }

        let rawParts = fullText.split('|||');
        let parts = [];
        for (let rp of rawParts) {
            let subParts = rp.split(/\r?\n/);
            for (let sp of subParts) {
                if (sp.trim()) parts.push(sp.trim());
            }
        }
        if (parts.length === 0) parts = [fullText];

        let isFirstChunk = true;
        const sendOneMsg = async (content, type = 'text', extraData = {}) => {
            const t = Date.now();
            let msgObj = {
                role: 'assistant', senderId: char.id,
                content: content,
                t: t,
                thought: isFirstChunk ? thoughtText : "", 
                ...extraData
            };

            const freshList = await DB.get('sessions');
            const idx = freshList.findIndex(x => x.id == currentChatId);
            if (idx !== -1) {
                freshList[idx].msgs.push(msgObj);
                await DB.set('sessions', freshList);

                const newMsgHtml = createMsgHtml(msgObj, userPersonas, characters);

                if (isFirstChunk) {
                    const loadingEl = document.getElementById(loadId);
                    if (loadingEl) loadingEl.outerHTML = newMsgHtml;
                    else box.insertAdjacentHTML('beforeend', newMsgHtml);
                    isFirstChunk = false;
                } else {
                    box.insertAdjacentHTML('beforeend', newMsgHtml);
                }
                box.scrollTop = box.scrollHeight;
            }
        };

        // ... (åœ¨ triggerAiReply å‡½æ•°åº•éƒ¨)

        for (let p of parts) {
            if (!p.trim()) continue;
            await new Promise(r => setTimeout(r, 800)); // æ¨¡æ‹Ÿæ‰“å­—å»¶è¿Ÿ
            
            //åŸæœ‰æ­£åˆ™
            const transRegex = /\(transfer:(\d+):?(.*?)\)/;
            const transMatch = p.match(transRegex);
            const imgRegex = /\(img:\s*(.*?)\s*\)/;
            const imgMatch = p.match(imgRegex);

            // ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€æ–°å¢1ï¼šå®šä¹‰æ„å¿µç…§ç‰‡æ­£åˆ™ã€‘ğŸ‘‡ğŸ‘‡ğŸ‘‡
            const simRegex = /\(sim_img:\s*(.*?)\s*\)/;
            const simMatch = p.match(simRegex);
            // ğŸ‘†ğŸ‘†ğŸ‘†ã€æ–°å¢ç»“æŸã€‘ğŸ‘†ğŸ‘†ğŸ‘†

            if (transMatch) {
                // è½¬è´¦é€»è¾‘
                await sendOneMsg(null, 'transfer', {
                    type: 'transfer',
                    amount: transMatch[1],
                    desc: transMatch[2] || 'è½¬è´¦ç»™ä½ ',
                    transStatus: 'pending'
                });
            } 
            // ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€æ–°å¢2ï¼šæ„å¿µç…§ç‰‡åˆ¤æ–­åˆ†æ”¯ã€‘ğŸ‘‡ğŸ‘‡ğŸ‘‡
            else if (simMatch) {
                // å¦‚æœåŒ¹é…åˆ° (sim_img:...)ï¼Œç›´æ¥å‘é€ã€‚
                // å› ä¸ºæˆ‘ä»¬åœ¨ createMsgHtml é‡Œå·²ç»å†™å¥½äº†æ¸²æŸ“é€»è¾‘ï¼Œå®ƒä¼šè‡ªåŠ¨å˜æˆæ–¹æ¡†ã€‚
                await sendOneMsg(p.trim());
            } 
            // ğŸ‘†ğŸ‘†ğŸ‘†ã€æ–°å¢ç»“æŸã€‘ğŸ‘†ğŸ‘†ğŸ‘†
            else if (imgMatch) {
                // å›¾ç‰‡é€»è¾‘ (ä¿ç•™åŸæœ‰çš„)
                if (!allowStickers) {
                    const textOnly = p.replace(imgRegex, '').trim(); 
                    if (textOnly) await sendOneMsg(textOnly);
                } else {
                    const url = imgMatch[1]; 
                    const textOnly = p.replace(imgRegex, '').trim(); 
                    if (textOnly) {
                        await sendOneMsg(textOnly);
                        await new Promise(r=>setTimeout(r, 500)); 
                    }
                    await sendOneMsg(`(img:${url})`);
                }
            } else {
                // æ™®é€šæ–‡å­—
                await sendOneMsg(p.trim());
            }
        }

    } catch (e) {
        const loadingEl = document.getElementById(loadId);
        if (loadingEl) loadingEl.remove();
        alert("API Error: " + e.message);
    }
}
/* ================= ğŸ§§ æ”¶æ¬¾å¼¹çª—é€»è¾‘ (æ–°å¢) ================= */

let currentReceiveMsgTime = null; // è®°å½•å½“å‰æ­£åœ¨æ“ä½œå“ªæ¡è½¬è´¦

// 1. æ‰“å¼€æ”¶æ¬¾å¼¹çª—
function openReceiveModal(t, amt, desc) {
    currentReceiveMsgTime = t; // è®°ä½è¿™æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³
    document.getElementById('receive-amount-display').innerText = amt;
    document.getElementById('receive-desc-display').innerText = desc;
    openModal('modal-transfer-receive');
}

// 2. ç¡®è®¤æ”¶æ¬¾/é€€è¿˜
function confirmReceive(action) {
    if (!currentReceiveMsgTime) return;
    
    // è°ƒç”¨ä¹‹å‰å†™å¥½çš„å¤„ç†å‡½æ•°
    handleTransfer(currentReceiveMsgTime, action);
    
    // å…³é—­å¼¹çª—
    closeModal('modal-transfer-receive');
}
/* ================= ğŸ’° é’±åŒ…æ ¸å¿ƒé€»è¾‘ ================= */

// 1. æ‰“å¼€é’±åŒ…ä¸»é¡µ (è®¡ç®—ä½™é¢)
async function openWalletPage() {
    const data = await calcWalletData();
    // æ¸²æŸ“ä½™é¢
    document.getElementById('my-wallet-balance').innerText = data.balance.toFixed(2);
    navTo('view-wallet');
}

// 2. æ‰“å¼€æ˜ç»†é¡µé¢ (æ¸²æŸ“åˆ—è¡¨)
async function openWalletHistory() {
    const data = await calcWalletData();
    const box = document.getElementById('wallet-history-list');
    box.innerHTML = '';

    if (data.history.length === 0) {
        box.innerHTML = `<div style="text-align:center; padding:30px; color:#999;">æš‚æ— äº¤æ˜“è®°å½•</div>`;
    } else {
        // æŒ‰æ—¶é—´å€’åº
        data.history.sort((a, b) => b.time - a.time);

        data.history.forEach(item => {
            const isAdd = item.amount > 0;
            const sign = isAdd ? '+' : '';
            const colorClass = isAdd ? 'add' : 'minus';
            const timeStr = new Date(item.time).toLocaleString();

            box.innerHTML += `
                <div class="bill-item">
                    <div class="bill-left">
                        <div class="bill-title">${item.title}</div>
                        <div class="bill-time">${timeStr}</div>
                    </div>
                    <div class="bill-right">
                        <div class="bill-amount ${colorClass}">${sign}${item.amount.toFixed(2)}</div>
                        <div class="bill-status">äº¤æ˜“æˆåŠŸ</div>
                    </div>
                </div>
            `;
        });
    }
    navTo('view-wallet-history');
}

// â˜…â˜…â˜… æ ¸å¿ƒç®—æ³•ï¼šéå†æ‰€æœ‰èŠå¤©ï¼Œç®—å‡ºå½“å‰ä½™é¢å’Œæ˜ç»† â˜…â˜…â˜…
async function calcWalletData() {
    let balance = 100.00; // åˆå§‹èµ„é‡‘
    let history = [];

    const sessions = await DB.get('sessions');
    const characters = await DB.get('characters');

    // éå†æ¯ä¸€ä¸ªä¼šè¯
    sessions.forEach(sess => {
        // ç¡®å®šå¯¹æ–¹åå­—
        let targetName = sess.name;
        if (sess.type === 'direct') {
            const c = characters.find(x => x.id === sess.targetId);
            if (c) targetName = c.name;
        }

        // éå†æ¯æ¡æ¶ˆæ¯
        sess.msgs.forEach(m => {
            if (m.type !== 'transfer') return; // åªçœ‹è½¬è´¦æ¶ˆæ¯

            const amt = parseFloat(m.amount);

            // æƒ…å†µ1ï¼šæˆ‘è½¬å‡ºçš„ (role == user)
            if (m.role === 'user') {
                // åªè¦å‘å‡ºå»äº†ï¼Œå°±å…ˆæ‰£é’±
                balance -= amt;
                history.push({
                    title: `è½¬è´¦ç»™ ${targetName}`,
                    amount: -amt,
                    time: m.t
                });

                // ç‰¹æ®Šæƒ…å†µï¼šå¦‚æœå¯¹æ–¹æ‹’æ”¶äº† (status == rejected)ï¼Œé’±è¦é€€å›æ¥
                if (m.transStatus === 'rejected') {
                    balance += amt;
                    history.push({
                        title: `é€€æ¬¾-æ¥è‡ª ${targetName}`,
                        amount: amt,
                        time: m.t + 1000 // åŠ ä¸€ç‚¹æ—¶é—´è®©å®ƒæ’åœ¨è½¬è´¦åé¢
                    });
                }
            }
            // æƒ…å†µ2ï¼šæˆ‘æ”¶åˆ°çš„ (role == assistant)
            else {
                // åªæœ‰æˆ‘ç‚¹äº†â€œæ”¶ä¸‹â€ (status == accepted)ï¼Œé’±æ‰è¿›è´¦
                if (m.transStatus === 'accepted') {
                    balance += amt;
                    history.push({
                        title: `æ”¶åˆ° ${targetName} çš„è½¬è´¦`,
                        amount: amt,
                        time: m.t
                    });
                }
                // è¿˜æ²¡ç‚¹æ”¶ä¸‹ï¼Œæˆ–è€…æ‹’æ”¶äº†ï¼Œéƒ½ä¸ç®—è¿›ä½™é¢
            }
        });
    });

    return { balance, history };
}
// ä»äººè®¾åˆ—è¡¨è¿”å›åˆ°â€œæˆ‘çš„â€Tab
// ä»äººè®¾åˆ—è¡¨è¿”å›åˆ°â€œæˆ‘çš„â€Tab
function navBackToMe() {
    // é”™è¯¯å†™æ³•ï¼šdocument.getElementById('view-persona-list').classList.remove('active');
    
    // âœ… æ­£ç¡®å†™æ³•ï¼šç›´æ¥å¯¼èˆªå›ä¸»èŠå¤©APPè§†å›¾
    navTo('view-chat-app');
}
/* ================= ğŸ‘‘ è´µæ—ç³»ç»Ÿé€»è¾‘ ================= */

// å…¨å±€å˜é‡ï¼Œè®°å½•å½“å‰é€‰ä¸­çš„å¥—é¤
let currentVipSelection = { days: 1, price: 10 };

// 1. é€‰æ‹©å¥—é¤ (è¦†ç›–æ—§å‡½æ•°)
function selectVipPrice(days, price, cardEl) {
    // è®°å½•é€‰æ‹©
    currentVipSelection = { days, price };

    // UI æ›´æ–°
    document.querySelectorAll('.price-card').forEach(el => el.classList.remove('active'));
    cardEl.classList.add('active');
    
    document.getElementById('pay-month-display').innerText = days;
    document.getElementById('pay-confirm-btn').innerText = `ç¡®è®¤åè®®å¹¶ç«‹å³ä»¥${price}å…ƒå¼€é€š`;
}

// 2. æ‰“å¼€è´µæ—é¡µé¢ (è¦†ç›–æ—§å‡½æ•°ï¼šå¢åŠ è¿‡æœŸæ—¶é—´æ£€æŸ¥)
async function openVipPage() {
    navTo('view-vip');

    // å¡«å……ç”¨æˆ·ä¿¡æ¯
    const userPersonas = await DB.get('user_personas');
    const curPid = localStorage.getItem('cur_pid') || (userPersonas[0] && userPersonas[0].id);
    const me = userPersonas.find(p => p.id == curPid) || { name: "æˆ‘", avatar: "" };
    document.getElementById('vip-user-avatar').src = me.avatar || DEFAULT_AVATAR;
    document.getElementById('vip-user-name').innerText = me.name;

    // â˜…â˜…â˜… æ£€æŸ¥è¿‡æœŸæ—¶é—´ â˜…â˜…â˜…
    const vipInfo = await DB.getObj('vip_info'); // { expiry: æ—¶é—´æˆ³ }
    const now = Date.now();
    const idLabel = document.getElementById('vip-user-id');

    if (vipInfo && vipInfo.expiry > now) {
        // å·²å¼€é€šä¸”æœªè¿‡æœŸ
        const date = new Date(vipInfo.expiry);
        idLabel.innerText = `å°Šè´µçš„VIPï¼Œæœ‰æ•ˆæœŸè‡³ï¼š${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes()}`;
        idLabel.style.color = "#D4A048"; // é‡‘è‰²æ–‡å­—
        idLabel.style.fontWeight = "bold";
    } else {
        // æœªå¼€é€šæˆ–å·²è¿‡æœŸ
        idLabel.innerText = 'æ‚¨è¿˜æ²¡æœ‰å¼€é€šè¿‡è´µæ—ï¼Œæˆ–ç‰¹æƒå·²è¿‡æœŸ';
        idLabel.style.color = "#999";
        idLabel.style.fontWeight = "normal";
    }

    // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
    const firstCard = document.querySelector('.price-card');
    if(firstCard && !document.querySelector('.price-card.active')) {
        selectVipPrice(1, 10, firstCard);
    }
}

// 3. æ”¯ä»˜å¼€é€š (æ ¸å¿ƒé€»è¾‘)
// 3. æ”¯ä»˜å¼€é€š (æ”¯æŒè‡ªåŠ¨ç»­è´¹ç‰ˆ)
async function payVip() {
    const btn = document.getElementById('pay-confirm-btn');
    const oldText = btn.innerText;
    const isAutoRenew = document.getElementById('vip-auto-renew-switch').checked;
    
    // 1. è·å–ä»·æ ¼
    const price = currentVipSelection.price;
    const days = currentVipSelection.days;

    btn.innerText = "æ­£åœ¨æ”¯ä»˜...";
    btn.disabled = true;

    // 2. æ£€æŸ¥ä½™é¢
    const walletData = await calcWalletData(); 
    if (walletData.balance < price) {
        alert(`ğŸ’¸ ä½™é¢ä¸è¶³ï¼\nå½“å‰ä½™é¢ï¼šÂ¥${walletData.balance.toFixed(2)}\néœ€è¦ï¼šÂ¥${price}`);
        btn.innerText = oldText;
        btn.disabled = false;
        return;
    }

    // 3. æ‰£æ¬¾ (è®°å½•åˆ°ç³»ç»Ÿä¼šè¯)
    let list = await DB.get('sessions');
    let sysSess = list.find(s => s.id === 'system_wallet_deduct');
    
    if (!sysSess) {
        sysSess = {
            id: 'system_wallet_deduct',
            type: 'system', 
            name: 'ç³»ç»Ÿæ¶ˆè´¹',
            avatar: '',
            msgs: [],
            isHidden: true 
        };
        list.push(sysSess);
    }

    sysSess.msgs.push({
        role: 'user', 
        type: 'transfer',
        amount: price,
        desc: `å¼€é€šè´µæ— ${days} å¤©`,
        transStatus: 'accepted', 
        t: Date.now()
    });

    // 4. æ›´æ–°è´µæ—æ—¶é—´ & ä¿å­˜ç»­è´¹é…ç½®
    let vipInfo = await DB.getObj('vip_info');
    const now = Date.now();
    let newExpiry = now;

    if (vipInfo && vipInfo.expiry > now) {
        newExpiry = vipInfo.expiry;
    }
    
    newExpiry += days * 24 * 60 * 60 * 1000;

    // â˜…â˜…â˜… å…³é”®ä¿®æ”¹ï¼šä¿å­˜ autoRenew å’Œ plan â˜…â˜…â˜…
    await DB.set('vip_info', { 
        expiry: newExpiry,
        autoRenew: isAutoRenew, // æ˜¯å¦è‡ªåŠ¨ç»­è´¹
        plan: { days: days, price: price } // è®°ä½è¿™æ¬¡ä¹°çš„å¥—é¤ï¼Œä¸‹æ¬¡æŒ‰è¿™ä¸ªæ‰£
    });
    
    await DB.set('sessions', list);

    // 5. å®Œæˆ
    btn.innerText = "âœ¨ å¼€é€šæˆåŠŸï¼";
    setTimeout(() => {
        btn.innerText = oldText;
        btn.disabled = false;
        alert(`ğŸ‰ å¼€é€šæˆåŠŸï¼\n${isAutoRenew ? 'å·²å¼€å¯è‡ªåŠ¨ç»­è´¹ï¼Œåˆ°æœŸå°†è‡ªåŠ¨æ‰£æ¬¾ã€‚' : 'æœªå¼€å¯è‡ªåŠ¨ç»­è´¹ã€‚'}`);
        openVipPage();
    }, 500);
}
/* ================= âš™ï¸ è‡ªåŠ¨ç»­è´¹æ ¸å¿ƒå¼•æ“ ================= */
async function checkAutoRenewSystem() {
    // 1. è·å–è´µæ—ä¿¡æ¯
    let vipInfo = await DB.getObj('vip_info');
    
    // å¦‚æœæ²¡å¼€é€šã€æˆ–è€…æ²¡å¼€è‡ªåŠ¨ç»­è´¹ã€æˆ–è€…è¿˜æ²¡è¿‡æœŸï¼Œç›´æ¥é€€å‡º
    if (!vipInfo || !vipInfo.autoRenew || !vipInfo.plan || Date.now() < vipInfo.expiry) {
        return;
    }

    // === åˆ°äº†è¿™é‡Œï¼Œè¯´æ˜å·²ç»è¿‡æœŸäº†ï¼Œä¸”å¼€å¯äº†è‡ªåŠ¨ç»­è´¹ ===
    console.log("æ£€æµ‹åˆ°è´µæ—è¿‡æœŸï¼Œå°è¯•è‡ªåŠ¨ç»­è´¹...");

    // 2. æ£€æŸ¥ä½™é¢
    const walletData = await calcWalletData();
    const price = vipInfo.plan.price;
    const days = vipInfo.plan.days;

    if (walletData.balance >= price) {
        // === ä½™é¢å……è¶³ï¼Œæ‰§è¡Œæ‰£æ¬¾ ===
        let list = await DB.get('sessions');
        let sysSess = list.find(s => s.id === 'system_wallet_deduct');
        
        if (!sysSess) {
            sysSess = { id: 'system_wallet_deduct', type: 'system', name: 'ç³»ç»Ÿæ¶ˆè´¹', msgs: [], isHidden: true };
            list.push(sysSess);
        }

        sysSess.msgs.push({
            role: 'user',
            type: 'transfer',
            amount: price,
            desc: `è´µæ—è‡ªåŠ¨ç»­è´¹ ${days} å¤©`, // è¿™é‡Œçš„æ–‡æ¡ˆä¸ä¸€æ ·
            transStatus: 'accepted',
            t: Date.now()
        });

        // å»¶é•¿è¿‡æœŸæ—¶é—´
        vipInfo.expiry = Date.now() + (days * 24 * 60 * 60 * 1000);
        
        await DB.set('vip_info', vipInfo);
        await DB.set('sessions', list);
        
        console.log("âœ… è‡ªåŠ¨ç»­è´¹æˆåŠŸï¼");
        // å¯ä»¥é€‰æ‹©å¼¹çª—æç¤ºï¼Œæˆ–è€…é™é»˜ç»­è´¹
    } else {
        // === ä½™é¢ä¸è¶³ï¼Œå…³é—­è‡ªåŠ¨ç»­è´¹ ===
        console.log("âŒ ä½™é¢ä¸è¶³ï¼Œè‡ªåŠ¨ç»­è´¹å¤±è´¥ï¼Œå·²å…³é—­æœåŠ¡");
        vipInfo.autoRenew = false; // å¼ºåˆ¶å…³é—­
        await DB.set('vip_info', vipInfo);
    }
}
/* ================= â­ ç­‰çº§ä¸ç­¾åˆ°ç³»ç»Ÿ ================= */

// 1. å¯åŠ¨æ—¶è®°å½•ç™»å½• (è¯·ç¡®ä¿è¿™æ®µé€»è¾‘è¢«æ‰§è¡Œ)
// 1. å¯åŠ¨æ—¶è®°å½•ç™»å½• (æ™ºèƒ½è¿ç»­å¤©æ•°ç‰ˆ)
async function trackLogin() {
    let info = await DB.getObj('user_level_info');
    
    // åˆå§‹åŒ–
    if (!info || !info.level) {
        info = { level: 1, lastLogin: 0, lastSignIn: 0, consecutiveDays: 1 };
    }

    const now = new Date();
    // è·å–â€œä»Šå¤©â€çš„é›¶ç‚¹æ—¶é—´æˆ³ï¼Œç”¨äºæŒ‰è‡ªç„¶æ—¥æ¯”è¾ƒ
    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    
    // è·å–â€œä¸Šæ¬¡ç™»å½•â€çš„é›¶ç‚¹æ—¶é—´æˆ³
    const lastDate = new Date(info.lastLogin || 0);
    const lastLoginStart = new Date(lastDate.getFullYear(), lastDate.getMonth(), lastDate.getDate()).getTime();

    const oneDay = 24 * 60 * 60 * 1000;

    if (todayStart === lastLoginStart) {
        // A. ä»Šå¤©å·²ç»ç™»å½•è¿‡ï¼šå•¥ä¹Ÿä¸ç”¨åšï¼Œä¿æŒåŸæ ·
    } else if (todayStart - lastLoginStart === oneDay) {
        // B. åˆšå¥½æ˜¯æ˜¨å¤©ç™»å½•çš„ï¼šè¿ç»­å¤©æ•° +1
        info.consecutiveDays = (info.consecutiveDays || 0) + 1;
    } else {
        // C. æ–­ç­¾äº†ï¼ˆæ˜¯å‰å¤©æˆ–æ›´æ—©ï¼‰ï¼šé‡ç½®ä¸º 1å¤©
        info.consecutiveDays = 1;
    }

    // æ›´æ–°æœ€åç™»å½•æ—¶é—´ä¸ºç°åœ¨
    info.lastLogin = Date.now();
    
    await DB.set('user_level_info', info);
}

// ç«‹å³æ‰§è¡Œä¸€æ¬¡
trackLogin();
// æŠŠè¿™ä¸ªå‡½æ•°æŒ‚è½½åˆ° window.onload é‡Œ (æˆ–è€…ä½ ç›´æ¥æ‰‹åŠ¨åŠ è¿›å»)
// è¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘å†™ä¸€ä¸ªç‹¬ç«‹çš„åˆå§‹åŒ–è°ƒç”¨ï¼Œä½ å¯ä»¥æŠŠå®ƒæ”¾åœ¨ window.onload çš„æœ«å°¾
setTimeout(trackLogin, 1000); 


// 2. æ‰“å¼€ç­‰çº§é¡µé¢ (æ ¸å¿ƒæ¸²æŸ“)
// 2. æ‰“å¼€ç­‰çº§é¡µé¢ (æ›´æ–°ç‰ˆï¼šè¾¾äººé€»è¾‘)
async function openLevelPage() {
    navTo('view-level');

    // 1. åŸºç¡€ä¿¡æ¯æ¸²æŸ“
    const userPersonas = await DB.get('user_personas');
    const curPid = localStorage.getItem('cur_pid') || (userPersonas[0] && userPersonas[0].id);
    const me = userPersonas.find(p => p.id == curPid) || { name: "æˆ‘", avatar: "" };
    document.getElementById('level-user-name').innerText = me.name;
    document.getElementById('level-user-avatar').src = me.avatar || DEFAULT_AVATAR;

    let info = await DB.getObj('user_level_info');
    if(!info || !info.level) info = { level: 1, consecutiveDays: 1 };

    // 2. æ¸²æŸ“ç­‰çº§
    document.getElementById('level-num-display').innerText = info.level;

    // â˜…â˜…â˜… 3. æ¸²æŸ“è¾¾äººå›¾æ ‡ (æ ¸å¿ƒä¿®æ”¹) â˜…â˜…â˜…
    const talentIcon = document.getElementById('talent-icon');
    const days = info.consecutiveDays || 1;

    // ä¿®æ”¹æ–‡å­—ï¼šæ˜¾ç¤ºè¿ç»­å¤©æ•°
    talentIcon.innerHTML = `<span>ğŸ¥‡</span> <span>è¿ç»­${days}å¤©</span>`;

    // åˆ¤æ–­é¢œè‰²ï¼šå°äº3å¤©å˜ç°ï¼Œå¤§äºç­‰äº3å¤©äº®èµ·
    if (days < 3) {
        talentIcon.classList.add('gray'); // å˜ç°
    } else {
        talentIcon.classList.remove('gray'); // äº®èµ·
    }

    // 4. ç­¾åˆ°æŒ‰é’®çŠ¶æ€
    const btn = document.getElementById('btn-sign-in');
    const todayStr = new Date().toDateString();
    const lastSignStr = new Date(info.lastSignIn || 0).toDateString();

    if (todayStr === lastSignStr) {
        btn.innerText = "ä»Šæ—¥å·²ç­¾åˆ° (æ˜å¤©å†æ¥)";
        btn.classList.add('disabled');
        btn.disabled = true;
    } else {
        btn.innerText = "âœ¨ ç«‹å³ç­¾åˆ° (+1çº§)";
        btn.classList.remove('disabled');
        btn.disabled = false;
    }
}

// 3. æ‰§è¡Œç­¾åˆ°
async function doSignIn() {
    const btn = document.getElementById('btn-sign-in');
    
    // é˜²æ­¢è¿ç‚¹
    if(btn.disabled) return;
    btn.disabled = true;

    // æ›´æ–°æ•°æ®
    let info = await DB.getObj('user_level_info');
    info.level = (info.level || 1) + 1; // ç­‰çº§+1
    info.lastSignIn = Date.now();       // è®°å½•æ—¶é—´
    
    await DB.set('user_level_info', info);

    // UI åé¦ˆ
    document.getElementById('level-num-display').innerText = info.level;
    btn.innerText = "ä»Šæ—¥å·²ç­¾åˆ° (æ˜å¤©å†æ¥)";
    btn.classList.add('disabled');

    // æ’’èŠ±ç‰¹æ•ˆ (ç®€å•çš„ alert æˆ–è€… log)
    alert(`ğŸ‰ ç­¾åˆ°æˆåŠŸï¼\næ­å–œå‡çº§åˆ° Lv${info.level}`);
}
/* ================= ğŸ“ å‘å¸ƒåŠ¨æ€é€»è¾‘ ================= */

let publishTempImg = null; // æš‚å­˜ä¸€å¼ å›¾ç‰‡ (ç®€æ˜“ç‰ˆ)

// 1. æ‰“å¼€/å…³é—­å‘å¸ƒé¡µ
function openPublishPage() {
    // æ¸…ç©ºæ•°æ®
    document.getElementById('publish-text').value = '';
    document.getElementById('pub-location-display').innerText = '';
    document.getElementById('pub-img-input').value = '';
    publishTempImg = null;
    
    // é‡ç½®å›¾ç‰‡é¢„è§ˆåŒº
    const container = document.getElementById('publish-img-container');
    // åªä¿ç•™é‚£ä¸ªåŠ å·æŒ‰é’®
    container.innerHTML = `<div style="width:100px; height:100px; background:#f5f5f5; display:flex; align-items:center; justify-content:center; font-size:40px; color:#ccc; cursor:pointer;" onclick="document.getElementById('pub-img-input').click()">+</div>`;
    
    navTo('view-publish-moment');
}

function navBackFromPublish() {
    navTo('view-my-moments');
}

// 2. å¤„ç†å›¾ç‰‡é€‰æ‹©
function handlePublishImg(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            publishTempImg = e.target.result; // å­˜Base64
            
            // æ˜¾ç¤ºé¢„è§ˆå°å›¾
            const img = document.createElement('img');
            img.src = publishTempImg;
            img.className = 'publish-img-item';
            
            // æ’åˆ°åŠ å·æŒ‰é’®å‰é¢
            const container = document.getElementById('publish-img-container');
            container.insertBefore(img, container.lastElementChild);
            
            // ç®€æ˜“ç‰ˆï¼šä¸ºäº†UIä¸ä¹±ï¼Œé€‰äº†ä¸€å¼ å°±éšè—åŠ å· (ä¹Ÿå¯ä»¥ä¸åšé™åˆ¶)
            container.lastElementChild.style.display = 'none'; 
        }
        reader.readAsDataURL(file);
    }
}

// 3. å¤„ç†ä½ç½®
function openLocationModal() {
    document.getElementById('location-input-val').value = '';
    openModal('modal-input-location');
}
function confirmLocation() {
    const loc = document.getElementById('location-input-val').value;
    document.getElementById('pub-location-display').innerText = loc;
    closeModal('modal-input-location');
}

// 4. å¤„ç† @å¥½å‹
async function openAtFriendModal() {
    const list = await DB.get('characters');
    const box = document.getElementById('at-friend-list');
    box.innerHTML = '';
    
    list.forEach(c => {
        const ava = c.avatar || DEFAULT_AVATAR;
        box.innerHTML += `
            <div class="list-item" onclick="insertAtName('${c.name}')">
                <div class="item-main">
                    <img src="${ava}" class="avatar" style="width:36px;height:36px;">
                    <div class="item-text"><h3>${c.name}</h3></div>
                </div>
            </div>`;
    });
    openModal('modal-at-friend');
}
function insertAtName(name) {
    const textarea = document.getElementById('publish-text');
    textarea.value += ` @${name} `; // æ’å…¥æ–‡å­—
    closeModal('modal-at-friend');
}

// 5. â­ æœ€ç»ˆå‘è¡¨
async function doPublishMoment() {
    const text = document.getElementById('publish-text').value;
    const location = document.getElementById('pub-location-display').innerText;
    
    if (!text && !publishTempImg) return alert("å†™ç‚¹ä»€ä¹ˆæˆ–å‘å¼ å›¾å§~");

    // è·å–"æˆ‘"çš„ä¿¡æ¯
    const userPersonas = await DB.get('user_personas');
    const curPid = localStorage.getItem('cur_pid') || (userPersonas[0] && userPersonas[0].id);
    const me = userPersonas.find(p => p.id == curPid) || { name: "æˆ‘", avatar: "" };

    // æ„å»ºæ•°æ®
    const newMoment = {
        id: Date.now(),
        charId: 'ME',
        name: me.name,
        avatar: me.avatar || DEFAULT_AVATAR,
        content: text,
        image: publishTempImg, // å­˜å…¥å›¾ç‰‡
        location: location,    // å­˜å…¥ä½ç½®
        time: new Date().toLocaleString(),
        likeCount: 0,
        isLiked: false,
        comments: []
    };

    // å­˜åº“
    let moments = await DB.get('moments');
    if (!moments) moments = [];
    moments.unshift(newMoment);
    await DB.set('moments', moments);

    // å®Œæˆ
    alert("å‘è¡¨æˆåŠŸï¼");
    
    // è·³è½¬å›æˆ‘çš„è¯´è¯´å¹¶åˆ·æ–°
    navTo('view-my-moments');
    // é‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼ˆæ³¨æ„ï¼šæˆ‘ä»¬è¿˜éœ€è¦æ”¹ä¸€ä¸‹ renderMoments æ‰èƒ½çœ‹åˆ°å›¾ç‰‡å’Œä½ç½®ï¼‰
    openMyMoments(); 
}
/* ================= ğŸ—‘ï¸ åŠ¨æ€å¡ç‰‡é•¿æŒ‰åˆ é™¤é€»è¾‘ (é€šç”¨ç‰ˆ) ================= */
    
    let momentPressTimer = null; // è®¡æ—¶å™¨å˜é‡

    // 1. å¼€å§‹æŒ‰ä½
    function startMomentPress(id) {
        // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§è®¡æ—¶å™¨
        clearTimeout(momentPressTimer);
        
        // è®¾ç½®800æ¯«ç§’åè§¦å‘åˆ é™¤
        momentPressTimer = setTimeout(() => {
            // éœ‡åŠ¨ä¸€ä¸‹æ‰‹æœº (å¦‚æœæœ‰éœ‡åŠ¨åé¦ˆçš„è¯)
            if (navigator.vibrate) navigator.vibrate(50);
            
            if (confirm('ğŸ—‘ï¸ ç¡®å®šè¦åˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿ')) {
                doDeleteAnyMoment(id);
            }
        }, 800);
    }

    // 2. å–æ¶ˆæŒ‰ä½ (æ¾å¼€æ‰‹ã€ç§»å¼€æ‰‹æŒ‡ã€æ»‘åŠ¨å±å¹•æ—¶è§¦å‘)
    function cancelMomentPress() {
        clearTimeout(momentPressTimer);
    }

    // 3. æ‰§è¡Œåˆ é™¤æ“ä½œ
    async function doDeleteAnyMoment(id) {
        // ä»æ•°æ®åº“åˆ æ‰
        let moments = await DB.get('moments');
        moments = moments.filter(m => m.id != id);
        await DB.set('moments', moments);

        // åˆ¤æ–­å½“å‰æ˜¯åœ¨å“ªä¸ªé¡µé¢ï¼Œå°±åˆ·æ–°å“ªä¸ªé¡µé¢
        const homeView = document.getElementById('view-moments');
        const myView = document.getElementById('view-my-moments');

        if (myView.classList.contains('active')) {
            // å¦‚æœåœ¨â€œæˆ‘çš„è¯´è¯´â€é¡µé¢
            openMyMoments(); 
        } else if (homeView.classList.contains('active')) {
            // å¦‚æœåœ¨â€œå¥½å‹åŠ¨æ€â€å¹¿åœº
            renderMoments();
        }
        
        // æç¤ºä¸€ä¸‹
        // alert('å·²åˆ é™¤'); // è§‰å¾—çƒ¦å¯ä»¥æ³¨é‡Šæ‰è¿™è¡Œ
    }
    /* ================= â° æ—¶é—´æ ¼å¼åŒ–å·¥å…· ================= */
function formatChatTime(timestamp) {
    const d = new Date(timestamp);
    const now = new Date();
    
    // è¡¥é›¶å‡½æ•°ï¼Œæ¯”å¦‚ 5 -> 05
    const pad = (n) => String(n).padStart(2, '0');
    const timeStr = `${pad(d.getHours())}:${pad(d.getMinutes())}`;

    // åˆ¤æ–­æ˜¯ä¸æ˜¯ä»Šå¤©
    if (d.toDateString() === now.toDateString()) {
        return timeStr; // ä»Šå¤©åªæ˜¾ç¤º 12:30
    }
    
    // åˆ¤æ–­æ˜¯ä¸æ˜¯æ˜¨å¤©
    const yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    if (d.toDateString() === yesterday.toDateString()) {
        return `æ˜¨å¤© ${timeStr}`;
    }

    // æ›´æ—©çš„æ—¶é—´ï¼Œæ˜¾ç¤ºæ—¥æœŸ
    return `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥ ${timeStr}`;
}
/* ================= â° å®æ—¶æ’å…¥æ—¶é—´æˆ³å·¥å…· ================= */
async function tryAppendTimestamp(box, newTime) {
    // 1. è·å–å½“å‰ä¼šè¯çš„æœ€åä¸€æ¡æ¶ˆæ¯æ—¶é—´
    const list = await DB.get('sessions');
    const sess = list.find(x => x.id == currentChatId);
    
    let lastTime = 0;
    // å¦‚æœä¼šè¯å­˜åœ¨ä¸”æœ‰æ¶ˆæ¯ï¼Œå–æœ€åä¸€æ¡çš„æ—¶é—´
    if (sess && sess.msgs.length > 0) {
        lastTime = sess.msgs[sess.msgs.length - 1].t;
    }

    // 2. å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæˆ–è€…é—´éš”è¶…è¿‡10åˆ†é’Ÿ (600000æ¯«ç§’)
    // æ³¨æ„ï¼šå¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯(lastTime=0)ï¼Œå‡æ³•ç»“æœå¾ˆå¤§ï¼Œä¹Ÿä¼šè§¦å‘ï¼Œè¿™æ­£å¥½ç¬¦åˆâ€œç¬¬ä¸€æ¡æ˜¾ç¤ºæ—¶é—´â€çš„éœ€æ±‚
    if (newTime - lastTime > 5 * 60 * 1000) {
        const timeStr = formatChatTime(newTime); // è¿™é‡Œçš„ formatChatTime ç”¨ä½ ä¹‹å‰åŠ é‚£ä¸ª
        box.insertAdjacentHTML('beforeend', `<div class="chat-time-stamp">${timeStr}</div>`);
    }
}
/* ================= ğŸ¹ é”®ç›˜å¼¹èµ·è‡ªåŠ¨è´´åº•é€»è¾‘ ================= */

/* ================= ğŸ¹ é”®ç›˜å¼¹èµ·ä¸æ»‘è´´åº• (æœ€ç»ˆæé€Ÿç‰ˆ) ================= */

// 1. ä½¿ç”¨ visualViewport API ç›‘å¬é”®ç›˜é«˜åº¦å˜åŒ– (è¿™æ˜¯æœ€å…ˆè¿›çš„æ–¹æ³•)
if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', () => {
        const box = document.getElementById('chat-msg-container');
        // é”®ç›˜åªè¦ä¸€åŠ¨ï¼Œç«‹é©¬è°ƒæ•´æ»šåŠ¨æ¡ï¼Œä¸åšä»»ä½•ç­‰å¾…
        box.scrollTop = box.scrollHeight;
    });
}

// 2. å¤‡ç”¨æ–¹æ¡ˆï¼šè¾“å…¥æ¡†è·å–ç„¦ç‚¹æ—¶ï¼Œä¹Ÿå¼ºåˆ¶æ»šä¸€æ¬¡ (é˜²æ­¢æ—§æ‰‹æœºä¸æ”¯æŒä¸Šé¢çš„API)
const msgInputFix = document.getElementById('msg-input');
msgInputFix.addEventListener('focus', function() {
    const box = document.getElementById('chat-msg-container');
    // å»æ‰äº† setTimeoutï¼Œç«‹å³æ‰§è¡Œï¼
    box.scrollTop = box.scrollHeight;
    
    // ç¨å¾®åŠ ä¸ªæçŸ­çš„åç»­æ£€æŸ¥ (100ms)ï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±ï¼Œäººçœ¼å‡ ä¹æ„Ÿè§‰ä¸åˆ°
    requestAnimationFrame(() => {
        box.scrollTop = box.scrollHeight;
    });
});
/* ================= ğŸ“¦ æ•°æ®å¤‡ä»½ä¸æ¢å¤ç³»ç»Ÿ (å®Œæ•´ç‰ˆ) ================= */

// å®šä¹‰æ‰€æœ‰éœ€è¦å¤‡ä»½çš„æ•°æ®åº“ Key
const DB_KEYS = [
    'sessions',         // èŠå¤©ä¼šè¯ & è®°å½•
    'characters',       // è§’è‰²åˆ—è¡¨
    'instructions',     // æŒ‡ä»¤
    'user_personas',    // ç”¨æˆ·äººè®¾
    'moments',          // æœ‹å‹åœˆæ•°æ®
    'api_config',       // APIé…ç½®
    'api_presets',      // APIé¢„è®¾åˆ—è¡¨
    'vip_info',         // è´µæ—ä¿¡æ¯
    'user_level_info',  // ç­‰çº§ç­¾åˆ°ä¿¡æ¯
    'zone_bg_image'     // ç©ºé—´èƒŒæ™¯å›¾ (Base64)
];

// 1. ğŸ“¤ å¯¼å‡ºåŠŸèƒ½
async function doExportAll() {
    if(!confirm("å‡†å¤‡å¯¼å‡ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ\nå¦‚æœæ•°æ®åŒ…å«å¾ˆå¤šå›¾ç‰‡ï¼Œå¯èƒ½éœ€è¦å‡ ç§’é’Ÿæ‰“åŒ…ã€‚")) return;

    const btn = event.currentTarget; // è·å–ç‚¹å‡»çš„æŒ‰é’®
    const oldText = btn.innerHTML;
    btn.innerHTML = `<div class="item-main"><div class="item-text"><h3>â³ æ‰“åŒ…ä¸­...</h3></div></div>`;

    try {
        const backupData = {
            version: 1.0,
            timestamp: Date.now(),
            date: new Date().toLocaleString(),
            data: {}
        };

        // éå†æ‰€æœ‰ Keyï¼Œä» IndexedDB å–å‡ºæ•°æ®
        for (const key of DB_KEYS) {
            const val = await DB.get(key);
            if (val) {
                backupData.data[key] = val;
            }
        }

        // è½¬æˆ JSON å­—ç¬¦ä¸²
        const jsonStr = JSON.stringify(backupData, null, 2);
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const blob = new Blob([jsonStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        // æ–‡ä»¶åå¸¦ä¸Šæ—¶é—´ï¼Œæ–¹ä¾¿åŒºåˆ†
        const dateStr = new Date().toISOString().split('T')[0];
        a.href = url;
        a.download = `AIOS_Backup_${dateStr}.json`;
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        alert("âœ… å¯¼å‡ºæˆåŠŸï¼è¯·å¦¥å–„ä¿å­˜ json æ–‡ä»¶ã€‚");

    } catch (e) {
        console.error(e);
        alert("âŒ å¯¼å‡ºå¤±è´¥: " + e.message);
    } finally {
        btn.innerHTML = oldText; // æ¢å¤æŒ‰é’®æ–‡å­—
    }
}

// 2. ğŸ“¥ å¯¼å…¥åŠŸèƒ½ (å¤„ç†æ–‡ä»¶é€‰æ‹©)
async function handleImportFile(input) {
    const file = input.files[0];
    if (!file) return;

    // äºŒæ¬¡ç¡®è®¤ï¼Œå› ä¸ºè¿™ä¼šè¦†ç›–ç°æœ‰æ•°æ®
    if (!confirm("âš ï¸ è­¦å‘Šï¼šå¯¼å…¥å°†ã€è¦†ç›–ã€‘å½“å‰æ‰€æœ‰çš„èŠå¤©è®°å½•ã€è§’è‰²å’Œè®¾ç½®ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿå»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½å½“å‰æ•°æ®ã€‚")) {
        input.value = ''; // æ¸…ç©ºé€‰æ‹©
        return;
    }

    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const jsonStr = e.target.result;
            const backup = JSON.parse(jsonStr);

            // ç®€å•çš„æ ¼å¼æ£€æŸ¥
            if (!backup.data) {
                throw new Error("æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œæ‰¾ä¸åˆ°æ•°æ®åŒ…ã€‚");
            }

            // å¼€å§‹æ¢å¤æ•°æ®
            let count = 0;
            for (const key of DB_KEYS) {
                if (backup.data[key]) {
                    await DB.set(key, backup.data[key]);
                    count++;
                }
            }

            alert(`ğŸ‰ æ¢å¤æˆåŠŸï¼\nå…±æ¢å¤äº† ${count} é¡¹æ•°æ®æ¨¡å—ã€‚\né¡µé¢å³å°†åˆ·æ–°ä»¥åº”ç”¨æ›´æ”¹ã€‚`);
            
            // åˆ·æ–°é¡µé¢
            window.location.reload();

        } catch (err) {
            alert("âŒ å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½å·²æŸåæˆ–æ ¼å¼é”™è¯¯ã€‚\né”™è¯¯ä¿¡æ¯: " + err.message);
        }
    };
    
    // å¼€å§‹è¯»å–
    reader.readAsText(file);
}
/* ================= ğŸš€ API é‡åˆ¶ç‰ˆé€»è¾‘ ================= */

// 1. æ™ºèƒ½æ‹‰å–æ¨¡å‹ (æ”¯æŒå¤šç§è·¯å¾„æ¢æµ‹)
/* ================= ğŸš€ å¢å¼ºç‰ˆæ¨¡å‹æ‹‰å– (å¸¦5ç§’è¶…æ—¶) ================= */
/* ================= ğŸš€ å¢å¼ºç‰ˆæ¨¡å‹æ‹‰å– (å¸¦è¯¦ç»†æŠ¥é”™) ================= */
async function smartFetchModels() {
    const rawUrl = document.getElementById('api-url').value.trim();
    const key = document.getElementById('api-key').value.trim();
    const listPanel = document.getElementById('model-select-panel');
    
    // 1. åŸºç¡€æ£€æŸ¥
    if (!rawUrl || !key) return alert("âŒ è¯·å…ˆå¡«å†™ æ¥å£åœ°å€ å’Œ API Key");

    // 2. æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    listPanel.style.display = 'block';
    listPanel.innerHTML = '<div style="padding:15px; text-align:center; color:#007AFF;">â³ æ­£åœ¨è¿æ¥æœåŠ¡å™¨...<br><span style="font-size:12px;color:#999">å¦‚æœé•¿æ—¶é—´æ— ååº”ï¼Œè¯·æŒ‰F12æŸ¥çœ‹æ§åˆ¶å°æŠ¥é”™</span></div>';

    // 3. æ™ºèƒ½å¤„ç† URL
    let baseUrl = rawUrl.replace(/\/$/, '');
    if (baseUrl.endsWith('/v1')) baseUrl = baseUrl.replace(/\/v1$/, '');

    // å°è¯•å¤šç§è·¯å¾„
    const endpoints = [
        `${baseUrl}/v1/models`,
        `${baseUrl}/models`,
        `${baseUrl}/api/v1/models` // éƒ¨åˆ†æœåŠ¡å•†çš„ç‰¹æ®Šè·¯å¾„
    ];

    let successData = null;
    let finalError = '';

    // 4. å¾ªç¯å°è¯•è·¯å¾„
    for (const ep of endpoints) {
        try {
            console.log("æ­£åœ¨å°è¯•è¿æ¥:", ep);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000); // å»¶é•¿åˆ°8ç§’è¶…æ—¶

            const res = await fetch(ep, {
                method: 'GET',
                headers: { 
                    'Authorization': `Bearer ${key}`,
                    'Content-Type': 'application/json'
                },
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);

            if (res.ok) {
                const json = await res.json();
                successData = json.data || json; // å…¼å®¹ä¸åŒæ ¼å¼
                if (Array.isArray(successData)) break; 
            } else {
                finalError = `çŠ¶æ€ç : ${res.status} (${res.statusText})`;
                console.warn(`è·¯å¾„ ${ep} å¤±è´¥: ${finalError}`);
            }
        } catch (e) {
            finalError = e.name === 'AbortError' ? 'è¿æ¥è¶…æ—¶' : e.message;
            console.warn(`è·¯å¾„ ${ep} å‡ºé”™:`, e);
        }
    }

    // 5. å¤„ç†ç»“æœ
    if (successData && Array.isArray(successData)) {
        let html = '';
        successData.forEach(m => {
            const id = m.id || m;
            html += `<div onclick="selectModel('${id}')" style="padding:10px; border-bottom:1px solid #eee; cursor:pointer; font-size:14px;">ğŸ“¦ ${id}</div>`;
        });
        listPanel.innerHTML = html;
        
        // è‡ªåŠ¨ä¿å­˜ä¸€ä¸‹é…ç½®
        await DB.set('api_config', { url: rawUrl, key: key, model: document.getElementById('api-model-input').value });
        alert(`âœ… è¿æ¥æˆåŠŸï¼è·å–åˆ° ${successData.length} ä¸ªæ¨¡å‹ã€‚`);
        
    } else {
        // 6. å¤±è´¥åçš„å‹å¥½æç¤º
        const isCors = finalError.includes('Failed to fetch') || finalError.includes('NetworkError');
        
        let errorTip = `<b>âŒ æ‹‰å–å¤±è´¥</b><br>é”™è¯¯ä¿¡æ¯: ${finalError || 'æœªçŸ¥é”™è¯¯'}`;
        
        if (isCors) {
            errorTip += `<br><br>ğŸ’¡ <b>æ¨æµ‹åŸå› ï¼šæµè§ˆå™¨è·¨åŸŸé™åˆ¶(CORS)</b><br>æµè§ˆå™¨æ‹¦æˆªäº†è¯·æ±‚ã€‚è¿™æ˜¯ç½‘é¡µç‰ˆçš„å¸¸è§é™åˆ¶ï¼Œå¹¶éä½ çš„åœ°å€æœ‰è¯¯ã€‚`;
        }

        listPanel.innerHTML = `
            <div style="padding:15px; text-align:center; color:#ff3b30; font-size:13px; line-height:1.6;">
                ${errorTip}
                <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
                <div style="color:#333; font-weight:bold;">âœ¨ è§£å†³æ–¹æ¡ˆï¼š</div>
                <div>ä¸éœ€è¦æ‹‰å–åˆ—è¡¨ä¹Ÿèƒ½ç”¨ï¼<br>è¯·ç›´æ¥åœ¨ä¸Šæ–¹è¾“å…¥æ¡†<b>æ‰‹åŠ¨å¡«å†™æ¨¡å‹å</b><br>(å¦‚ gpt-4o, deepseek-chat)</div>
            </div>`;
    }
}

// 2. é€‰æ‹©æ¨¡å‹ (ç‚¹å‡»åˆ—è¡¨é¡¹)
function selectModel(modelName) {
    const input = document.getElementById('api-model-input');
    input.value = modelName;
    // é€‰å®Œéšè—åˆ—è¡¨
    document.getElementById('model-select-panel').style.display = 'none';
}

// 3. ä¿å­˜é…ç½®
async function saveApiConfig() {
    const url = document.getElementById('api-url').value.trim();
    const key = document.getElementById('api-key').value.trim();
    const model = document.getElementById('api-model-input').value.trim(); // ç°åœ¨çš„è¾“å…¥æ¡†IDå˜äº†

    if (!url || !key || !model) return alert("âš ï¸ è¯·å¡«å†™å®Œæ•´ï¼šURLã€Key å’Œ æ¨¡å‹å");

    await DB.set('api_config', { url, key, model });
    alert("âœ… é…ç½®å·²ä¿å­˜ï¼å¯ä»¥å»èŠå¤©äº†ã€‚");
    navBack();
}

// 4. ä¿å­˜é¢„è®¾
async function saveApiPreset() {
    const url = document.getElementById('api-url').value.trim();
    const key = document.getElementById('api-key').value.trim();
    const model = document.getElementById('api-model-input').value.trim();

    if (!url) return alert("è‡³å°‘å¡«ä¸ªåœ°å€æ‰èƒ½å­˜é¢„è®¾å§~");

    const name = prompt("ç»™è¿™ä¸ªé…ç½®èµ·ä¸ªå (å¦‚: è°·æ­ŒGemini):");
    if (!name) return;

    let presets = await DB.get('api_presets');
    if (!Array.isArray(presets)) presets = [];

    presets.push({
        id: Date.now().toString(),
        name: name,
        url: url,
        key: key,
        model: model
    });

    await DB.set('api_presets', presets);
    renderApiPresets(); // åˆ·æ–°
    alert("âœ… é¢„è®¾å·²ä¿å­˜");
}

// 5. åŠ è½½é¢„è®¾
async function loadApiPreset(id) {
    const presets = await DB.get('api_presets');
    const p = presets.find(x => x.id == id);
    if (!p) return;

    document.getElementById('api-url').value = p.url || '';
    document.getElementById('api-key').value = p.key || '';
    document.getElementById('api-model-input').value = p.model || ''; // è‡ªåŠ¨å¡«å…¥
    
    // éšè—ä¹‹å‰çš„æ‹‰å–åˆ—è¡¨ï¼Œä¿æŒç•Œé¢æ¸…çˆ½
    document.getElementById('model-select-panel').style.display = 'none';

    alert(`å·²åŠ è½½ï¼š${p.name}\nè®°å¾—ç‚¹â€œä¿å­˜å½“å‰é…ç½®â€ç”Ÿæ•ˆå“¦ï¼`);
}

// 6. åˆå§‹åŒ–åŠ è½½ (é¡µé¢æ‰“å¼€æ—¶å›æ˜¾æ•°æ®)
(async function initApiPage() {
    const c = await DB.getObj('api_config');
    if (c.url) document.getElementById('api-url').value = c.url;
    if (c.key) document.getElementById('api-key').value = c.key;
    if (c.model) document.getElementById('api-model-input').value = c.model;
    
    renderApiPresets();
})();
/* =================  åŒé¢‘ (Tongpin) 3.0 ç»ˆæç‰ˆ ================= */

// å…¨å±€ç¼“å­˜ï¼škeyæ˜¯åˆ†ç±»åï¼Œvalueæ˜¯å°ç»„æ•°æ®æ•°ç»„
let tpCache = {};
let currentTpCategory = 'æ¨è';

 // 1. æ‰“å¼€é¡µé¢ (ä¿®æ”¹ç‰ˆï¼šä¸è‡ªåŠ¨åˆ·æ–°ï¼Œæ˜¾ç¤ºç­‰å¾…æç¤º)
// 1. æ‰“å¼€é¡µé¢ (ä¿®æ”¹ç‰ˆï¼šè‡ªåŠ¨è¯»å–æ•°æ®åº“å­˜æ¡£)
// 1. æ‰“å¼€é¡µé¢ (æœ€ç»ˆç‰ˆï¼šæ”¯æŒè‡ªå®šä¹‰åˆ†ç±»åŠ è½½)
async function openTongpinPage() {
    navTo('view-tongpin');
    
    // åŠ è½½ä¸ªäººä¿¡æ¯
    const userPersonas = await DB.get('user_personas');
    const curPid = localStorage.getItem('cur_pid') || (userPersonas[0] && userPersonas[0].id);
    const me = userPersonas.find(p => p.id == curPid) || { name: "æˆ‘", avatar: "" };
    document.getElementById('tp-user-name').innerText = me.name;
    document.getElementById('tp-user-avatar').src = me.avatar || DEFAULT_AVATAR;

    // ğŸ”´ æ ¸å¿ƒä¿®æ”¹1ï¼šæ¸²æŸ“ Tab æ  (é‡ç½® + è¿½åŠ è‡ªå®šä¹‰)
    const tabsContainer = document.getElementById('tp-tabs');
    // å…ˆæ¢å¤é»˜è®¤çŠ¶æ€ (æŠŠä¹‹å‰åŠ¨æ€æ·»åŠ çš„åˆ æ‰ï¼Œåªä¿ç•™ç¡¬ç¼–ç çš„)
    // è¿™é‡Œçš„ HTML ç»“æ„ä¸€å®šè¦å’Œä½  index.html é‡Œä¿æŒä¸€è‡´
    tabsContainer.innerHTML = `
        <div class="tp-tab-item" onclick="switchTpTab('å…³æ³¨', this)">å…³æ³¨</div>
        <div class="tp-tab-item active" onclick="switchTpTab('æ¨è', this)">æ¨è</div>
        <div class="tp-tab-item" onclick="switchTpTab('æ¸¸æˆ', this)">æ¸¸æˆ</div>
        <div class="tp-tab-item" onclick="switchTpTab('ææ€–', this)">ææ€–</div>
        <div class="tp-tab-item" onclick="switchTpTab('å°è¯´', this)">å°è¯´</div>
        <div class="tp-tab-item" onclick="switchTpTab('æ­Œæ›²', this)">æ­Œæ›²</div>
        <div class="tp-tab-item" onclick="switchTpTab('å…«å¦', this)">å…«å¦</div>
    `;

    // ä»æ•°æ®åº“åŠ è½½è‡ªå®šä¹‰åˆ†ç±»
    const customCats = await DB.get('tongpin_custom_cats'); // [{name:'èµ›åš', desc:'...'}]
    if (Array.isArray(customCats)) {
        customCats.forEach(cat => {
            // è¿½åŠ åˆ°åé¢
            const div = document.createElement('div');
            div.className = 'tp-tab-item';
            div.innerText = cat.name;
            div.onclick = function() { switchTpTab(cat.name, this); };
            tabsContainer.appendChild(div);
        });
    }
    
    // æ¢å¤ä¸Šæ¬¡é€‰ä¸­çš„ Tab é«˜äº® (å¯é€‰ä¼˜åŒ–ï¼Œè¿™é‡Œé»˜è®¤é‡ç½®å›æ¨èæˆ–ä¿æŒç°çŠ¶)
    // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬é»˜è®¤æ¯æ¬¡è¿›å»é‡ç½®ä¸ºâ€œæ¨èâ€ï¼Œæˆ–è€…ä½ å¯ä»¥ä¿æŒä¹‹å‰çš„é€»è¾‘
    currentTpCategory = 'æ¨è'; 
    // è®°å¾—è¯»ç¼“å­˜æ•°æ®
    if (Object.keys(tpCache).length === 0) {
        const savedCache = await DB.get('tongpin_cache');
        if (savedCache) tpCache = savedCache;
    }

    // æ¸²æŸ“å†…å®¹åŒº
    const box = document.getElementById('tp-content-list');
    if (!tpCache[currentTpCategory] || tpCache[currentTpCategory].length === 0) {
        box.innerHTML = `
            <div style="text-align:center; padding:60px 20px; color:#999; cursor:pointer;" onclick="refreshTpList()">
                <div style="font-size:50px; margin-bottom:15px; opacity:0.5;"></div>
                <h3 style="margin:0; font-size:16px; color:#666;">ç­‰å¾…æœå¯»ä¿¡å·</h3>
                <p style="font-size:13px; margin-top:5px;">ç‚¹å‡»å³ä¸Šè§’ â†» æˆ–æ­¤å¤„å¼€å§‹è·å–ã€${currentTpCategory}ã€‘é¢‘é“</p>
            </div>
        `;
    } else {
        renderTpFromCache();
    }
}
// 2. åˆ‡æ¢åˆ†ç±» (ä¸è‡ªåŠ¨åˆ·æ–°)
// 2. åˆ‡æ¢åˆ†ç±» (ä¿®æ”¹ç‰ˆï¼šä¸è‡ªåŠ¨åˆ·æ–°)
// 2. åˆ‡æ¢åˆ†ç±» (æœ€ç»ˆç‰ˆï¼šé€‚é…å…³æ³¨åˆ—è¡¨)
async function switchTpTab(category, el) {
    if (currentTpCategory === category) return;
    currentTpCategory = category;
    
    // UI é«˜äº®åˆ‡æ¢
    document.querySelectorAll('.tp-tab-item').forEach(d => d.classList.remove('active'));
    el.classList.add('active');
    
    const box = document.getElementById('tp-content-list');

    // ğŸ”´ æ ¸å¿ƒä¿®æ”¹ï¼šå¦‚æœæ˜¯â€œå…³æ³¨â€é¡µï¼Œèµ°ç‰¹æ®Šé€šé“
    if (category === 'å…³æ³¨') {
        await loadFollowedList(); // è¯»å–æ•°æ®åº“å¹¶æ¸²æŸ“
        return;
    }

    // æ™®é€šåˆ†ç±»é€»è¾‘ (ä¿æŒä¸å˜)
    if (!tpCache[category] || tpCache[category].length === 0) {
        box.innerHTML = `
            <div style="text-align:center; padding:60px 20px; color:#999; cursor:pointer;" onclick="refreshTpList()">
                <div style="font-size:50px; margin-bottom:15px; opacity:0.5;"> </div>
                <h3 style="margin:0; font-size:16px; color:#666;">ç­‰å¾…æœå¯»ä¿¡å·</h3>
                <p style="font-size:13px; margin-top:5px;">ç‚¹å‡»å³ä¸Šè§’ â†» æˆ–æ­¤å¤„å¼€å§‹è·å–ã€${category}ã€‘é¢‘é“</p>
            </div>
        `;
    } else {
        renderTpFromCache();
    }
}
// 3. ç‚¹å‡»åˆ·æ–°æŒ‰é’® (å¢é‡æ›´æ–°ï¼šä¿ç•™æ—§5ä¸ªï¼ŒåŠ æ–°5ä¸ª)
// 3. ç‚¹å‡»åˆ·æ–°æŒ‰é’® (ä¿®æ”¹ç‰ˆï¼šæ™ºèƒ½åˆ¤æ–­åŠ è½½æ¨¡å¼)
// 3. ç‚¹å‡»åˆ·æ–°æŒ‰é’® (æœ€ç»ˆç‰ˆï¼šå¼ºåˆ¶æ¢ä¸€æ‰¹)
function refreshTpList() {
    // 1. æŒ‰é’®æ—‹è½¬åŠ¨ç”»
    const btn = document.querySelector('.tp-refresh-btn');
    btn.style.transform = "rotate(360deg)";
    setTimeout(() => btn.style.transform = "rotate(0deg)", 500);
    
    // ğŸ”´ æ ¸å¿ƒä¿®æ”¹ï¼šç›´æ¥è°ƒç”¨ 'new' æ¨¡å¼
    // ä¹‹å‰çš„é€»è¾‘æ˜¯å¦‚æœæœ‰æ•°æ®å°± append (è¿½åŠ )ï¼Œç°åœ¨æ”¹æˆç›´æ¥è¦†ç›–
    // è¿™æ ·ç‚¹å‡»åˆ·æ–°ï¼Œå°±ä¼šæ¸…ç©ºå½“å‰åˆ—è¡¨ï¼Œé‡æ–°å» AI é‚£é‡Œæ‹‰å– 5 ä¸ªå…¨æ–°çš„å°ç»„
    renderTpList('new');
}
// 4. æ ¸å¿ƒæ¸²æŸ“æ§åˆ¶å™¨
// 4. æ ¸å¿ƒæ¸²æŸ“æ§åˆ¶å™¨ (ä¿®æ”¹ç‰ˆï¼šåˆå§‹åŒ–æ—¶ä¸ç”Ÿæˆå‡æ•°æ®)
// 4. æ ¸å¿ƒæ¸²æŸ“æ§åˆ¶å™¨ (ä¿®æ”¹ç‰ˆï¼šç”Ÿæˆåè‡ªåŠ¨å­˜æ¡£)
async function renderTpList(mode) {
    const box = document.getElementById('tp-content-list');
    
    if (mode === 'new') {
        box.innerHTML = `<div class="tp-loading-box"><div class="tp-loading-icon">ğŸ”®</div><p>æ­£åœ¨æœå¯»${currentTpCategory}é¢‘é“...</p></div>`;
    }

    try {
        const cfg = await DB.getObj('api_config');
        if (!cfg || !cfg.key) throw new Error("è¯·å…ˆé…ç½® API Key");

        const newGroups = await fetchAiGroups(cfg, currentTpCategory);
        
        newGroups.forEach(g => {
            g.id = Date.now() + Math.random(); 
            g.iconColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            g.posts = null; 
            g.isLoaded = false; 
        });

        if (!tpCache[currentTpCategory]) tpCache[currentTpCategory] = [];
        
        if (mode === 'new') {
            tpCache[currentTpCategory] = newGroups;
        } else if (mode === 'append') {
            const oldData = tpCache[currentTpCategory].slice(0, 5);
            tpCache[currentTpCategory] = [...newGroups, ...oldData];
        }

        // ğŸ”´ æ ¸å¿ƒä¿®æ”¹ï¼šæ•°æ®æ›´æ–°äº†ï¼Œç«‹åˆ»å­˜å…¥æ•°æ®åº“ï¼
        await DB.set('tongpin_cache', tpCache);

        renderTpFromCache();

    } catch (e) {
        if(mode === 'new') {
            box.innerHTML = `<div style="text-align:center;padding:20px;color:#999">åŠ è½½å¤±è´¥: ${e.message} <br><a onclick="renderTpList('new')">é‡è¯•</a></div>`;
        } else {
            alert("åˆ·æ–°å¤±è´¥ï¼š" + e.message);
        }
    }
}

// 5. ä»ç¼“å­˜æ¸²æŸ“ DOM (çº¯åŒæ­¥ï¼Œæ— åŠ è½½æ—¶é—´)
// 5. ä»ç¼“å­˜æ¸²æŸ“ DOM (æœ€ç»ˆç‰ˆï¼šåŠ¨æ€æŒ‰é’®)
function renderTpFromCache() {
    const box = document.getElementById('tp-content-list');
    box.innerHTML = '';
    
    const dataList = tpCache[currentTpCategory] || [];
    
    // ç©ºçŠ¶æ€å¤„ç† (ç‰¹åˆ«æ˜¯å…³æ³¨åˆ—è¡¨ä¸ºç©ºæ—¶)
    if (dataList.length === 0) {
        if (currentTpCategory === 'å…³æ³¨') {
            box.innerHTML = `<div style="text-align:center; padding:50px; color:#999;">è¿˜æ²¡æœ‰å…³æ³¨ä»»ä½•å°ç»„<br>å¿«å»æ¨èé¡µçœ‹çœ‹å§~</div>`;
        }
        return;
    }
    
    dataList.forEach(data => {
        // ğŸ”´ æ ¸å¿ƒä¿®æ”¹ï¼šæ ¹æ®å½“å‰åˆ†ç±»ï¼Œå†³å®šæŒ‰é’®æ ·å¼å’Œæ–‡å­—
        let btnHtml = '';
        if (currentTpCategory === 'å…³æ³¨') {
            // å…³æ³¨é¡µï¼šæ˜¾ç¤ºé€€å‡ºæŒ‰é’® (ç°è‰²è¾¹æ¡†)
            btnHtml = `<button class="btn-join-group" style="background:#fff; border:1px solid #ddd; color:#666;" onclick="toggleGroupFollow(event, ${data.id})">é€€å‡º</button>`;
        } else {
            // æ™®é€šé¡µï¼šæ˜¾ç¤ºåŠ å…¥æŒ‰é’® (ç²‰è‰²èƒŒæ™¯)
            btnHtml = `<button class="btn-join-group" onclick="toggleGroupFollow(event, ${data.id})">åŠ å…¥</button>`;
        }

        box.innerHTML += `
            <div class="tp-card" onclick="openGroupPage(${data.id})">
                <div class="tp-card-header">
                    <div class="tp-group-info">
                        <div class="tp-group-icon" style="background:${data.iconColor}; display:flex; align-items:center; justify-content:center; font-size:18px; color:#fff; font-weight:bold;">${data.name[0]}</div>
                        <div class="tp-group-text">
                            <h4>${data.name}</h4>
                            <p>${data.members || Math.floor(Math.random()*5000+100)} æˆå‘˜</p>
                        </div>
                    </div>
                    <!-- åŠ¨æ€æ’å…¥æŒ‰é’® -->
                    ${btnHtml}
                </div>
                <div class="tp-card-desc" style="margin-top:10px;">${data.desc}</div>
                <div class="tp-card-footer"><span>â¤ï¸ ${data.likes || 0}</span></div>
            </div>
        `;
    });
}

// 6. â˜…â˜…â˜… æ‰“å¼€å°ç»„è¯¦æƒ…é¡µ â˜…â˜…â˜…
// 6. â˜…â˜…â˜… æ‰“å¼€å°ç»„è¯¦æƒ…é¡µ (æœ€ç»ˆæ•´åˆç‰ˆï¼šå«æ¸²æŸ“é€»è¾‘) â˜…â˜…â˜…
// 6. â˜…â˜…â˜… æ‰“å¼€å°ç»„è¯¦æƒ…é¡µ (ä¿®æ”¹ç‰ˆï¼šç”Ÿæˆå†…å®¹åè‡ªåŠ¨å­˜æ¡£) â˜…â˜…â˜…
// ğŸ¨ å·¥å…·å‡½æ•°ï¼šç”Ÿæˆâ€œéšæœºåº•è‰²+é¦–å­—â€å¤´åƒ
// ğŸ¨ å·¥å…·å‡½æ•°ï¼šæ ¹æ®åå­—ç”Ÿæˆå›ºå®šé¢œè‰²å¤´åƒ (Hashç®—æ³•)
// ğŸ¨ å·¥å…·å‡½æ•°ï¼šä½¿ç”¨ Canvas æœ¬åœ°ç»˜åˆ¶å¤´åƒ (å½»åº•è§£å†³ä¹±ç é—®é¢˜)
function generateNameAvatar(name) {
    if (!name) name = "?";
    const char = name[0];
    
    // 1. è®¡ç®—å›ºå®šé¢œè‰² (Hashç®—æ³•)
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    let c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
    const hex = "00000".substring(0, 6 - c.length) + c;
    const color = "#" + hex; // åŠ ä¸Šäº•å·

    // 2. åˆ›å»ºç”»å¸ƒ
    const canvas = document.createElement('canvas');
    canvas.width = 100;
    canvas.height = 100;
    const ctx = canvas.getContext('2d');

    // 3. å¡«å……èƒŒæ™¯è‰²
    ctx.fillStyle = color;
    ctx.fillRect(0, 0, 100, 100);

    // 4. ç»˜åˆ¶æ–‡å­— (ç™½è‰²ï¼Œå±…ä¸­ï¼Œä½¿ç”¨ç³»ç»Ÿå­—ä½“)
    ctx.fillStyle = '#FFFFFF';
    ctx.font = 'bold 35px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'; 
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    // ç¨å¾®è°ƒæ•´ä¸€ä¸‹å‚ç›´ä½ç½®ï¼Œè®©æ±‰å­—è§†è§‰å±…ä¸­
    ctx.fillText(char, 50, 52);

    // 5. å¯¼å‡ºä¸º Base64 å›¾ç‰‡
    return canvas.toDataURL('image/png');
}
// 6. â˜…â˜…â˜… æ‰“å¼€å°ç»„è¯¦æƒ…é¡µ (ä¿®å¤å¤´åƒç‰ˆ) â˜…â˜…â˜…
// 6. â˜…â˜…â˜… æ‰“å¼€å°ç»„è¯¦æƒ…é¡µ (æœ€ç»ˆç‰ˆï¼šçœŸå®æ—¶é—´æµ) â˜…â˜…â˜…
// 6. â˜…â˜…â˜… æ‰“å¼€å°ç»„è¯¦æƒ…é¡µ (æœ€ç»ˆå®Œç¾ç‰ˆï¼šç»Ÿä¸€å¤´åƒ + çœŸå®æ—¶é—´) â˜…â˜…â˜…
// 6. â˜…â˜…â˜… æ‰“å¼€å°ç»„è¯¦æƒ…é¡µ (æè‡´ä¼˜åŒ–ç‰ˆï¼šä¸é‡å¤åˆ·æ–°å¤´åƒ) â˜…â˜…â˜…
// 6. â˜…â˜…â˜… æ‰“å¼€å°ç»„è¯¦æƒ…é¡µ (æœ€ç»ˆç‰ˆï¼šæ”¯æŒç‰¹é‚€å˜‰å®¾å¤´åƒ) â˜…â˜…â˜…
async function openGroupPage(groupId) {
    currentViewingGroupId = groupId;
    const groupData = tpCache[currentTpCategory].find(g => g.id == groupId);
    if (!groupData) return;

    navTo('view-tp-group');

    // 1. é¡¶éƒ¨ UI
    document.getElementById('tp-group-page-title').innerText = groupData.name;
    document.getElementById('tp-group-header-name').innerText = groupData.name;
    document.getElementById('tp-group-header-desc').innerText = groupData.desc;
    
    const headerIcon = document.getElementById('tp-group-header-img');
    headerIcon.style.background = groupData.iconColor;
    headerIcon.innerText = groupData.name[0];
    
    const postList = document.getElementById('tp-post-list');

    // 2. ç¬¬ä¸€æ¬¡åŠ è½½é€»è¾‘ (ç”Ÿæˆæ–°å†…å®¹)
    if (!groupData.isLoaded || !groupData.posts) {
        postList.innerHTML = `
            <div style="padding:60px 20px; text-align:center; color:#666;">
                <div style="font-size:40px; margin-bottom:15px; animation:tp-spin 1s infinite linear;">ğŸ’«</div>
                <h3 style="margin:0;">æ­£åœ¨æ½œå…¥ã€${groupData.name}ã€‘...</h3>
                <p style="font-size:12px; margin-top:5px; opacity:0.7;">AIæ­£åœ¨é‚€è¯·å˜‰å®¾ã€ä¼ªé€ å‘å¸–è®°å½•...</p>
            </div>
        `;

        try {
            const cfg = await DB.getObj('api_config');
            let realPosts = await fetchAiPostsForGroup(cfg, groupData.name, groupData.desc);
            
            // åˆ†é…æ—¶é—´
            realPosts = assignRealisticTimes(realPosts);
            
            // ğŸ”´ æ ¸å¿ƒä¿®æ”¹ï¼šè°ƒç”¨å˜‰å®¾å¤´åƒåŒ¹é…å‡½æ•° (å®ƒä¼šè‡ªåŠ¨å¤„ç†å˜‰å®¾çœŸå¤´åƒå’Œè·¯äººå‡å¤´åƒ)
            await applyGuestAvatars(realPosts);
            
            // åˆå§‹åŒ–è½¬å‘æ•°
            realPosts.forEach(p => { 
                if(p.shares === undefined) p.shares = Math.floor(Math.random() * 50); 
            });

            groupData.posts = realPosts;
            groupData.isLoaded = true;
            await saveCurrentTpData();

        } catch (e) {
            postList.innerHTML = `<div style="text-align:center; padding:30px; color:#ff3b30;">å¤±è´¥: ${e.message}<br><button class="mini-btn" onclick="openGroupPage(${groupId})">é‡è¯•</button></div>`;
            return;
        }
    }

    // 3. æŸ¥æ¼è¡¥ç¼º (æ¯æ¬¡è¿›æ¥éƒ½æ£€æŸ¥ä¸€éï¼Œç¡®ä¿å¤´åƒåŒ¹é…æœ€æ–°çŠ¶æ€)
    if (groupData.posts && groupData.posts.length > 0) {
        // ğŸ”´ æ ¸å¿ƒä¿®æ”¹ï¼šå†æ¬¡è°ƒç”¨åŒ¹é…å‡½æ•°ï¼Œé˜²æ­¢ä¹‹å‰æ¼æ‰æˆ–è€…è§’è‰²å¤´åƒæ›´æ–°äº†
        await applyGuestAvatars(groupData.posts);
        
        // æ£€æŸ¥è½¬å‘æ•°
        let needSave = false;
        groupData.posts.forEach(p => {
            if(p.shares === undefined) { p.shares = Math.floor(Math.random()*50); needSave = true; }
        });
        
        // è¿™é‡Œæˆ‘ä»¬æ€»æ˜¯ä¿å­˜ä¸€ä¸‹ï¼Œç¡®ä¿å¤´åƒç¼“å­˜æ˜¯æœ€æ–°çš„
        await saveCurrentTpData();
    }

    // 4. æ¸²æŸ“åˆ—è¡¨
    postList.innerHTML = '';
    if (groupData.posts.length === 0) {
        postList.innerHTML = `
            <div style="text-align:center; padding:80px 20px; color:#999;">
                <div style="font-size:60px; margin-bottom:20px; opacity:0.3;">ğŸƒ</div>
                <h3 style="margin:0; font-weight:normal; color:#666;">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿ</h3>
                <button class="btn-block" style="background:#007AFF; width:auto; display:inline-block; padding:10px 30px; margin-top:30px;" onclick="refreshGroupPosts()">ğŸ”® ç”Ÿæˆæ–°å¸–</button>
            </div>`;
        return;
    }

    // 5. æ¸²æŸ“å¾ªç¯
    groupData.posts.forEach((post, index) => {
        const timeStr = formatRelativeTime(post.time);

        let previewCommentsHtml = '';
        if(post.comments && post.comments.length > 0) {
            post.comments.slice(0, 3).forEach(c => {
                previewCommentsHtml += `<div class="tp-cmt-row"><span class="tp-cmt-user">${c.user}:</span>${c.text}</div>`;
            });
            if(post.comments.length > 3) {
                previewCommentsHtml += `<div class="tp-cmt-more">æŸ¥çœ‹å…¨éƒ¨ ${post.comments.length} æ¡è¯„è®º ></div>`;
            }
        } else {
            previewCommentsHtml = '<div style="color:#ccc;font-size:12px;">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘</div>';
        }

        postList.innerHTML += `
            <div class="tp-post-card" onclick="openPostDetailPage(${groupId}, ${index})">
                <div class="tp-poster-row">
                    <img src="${post.avatar}" class="tp-poster-avatar">
                    <div style="flex:1">
                        <div class="tp-poster-name">${post.user}</div>
                        <div style="font-size:10px; color:#999">æ¥¼ä¸»</div>
                    </div>
                    <div class="tp-post-time">${timeStr}</div>
                </div>
                <div class="tp-post-content">${post.content}</div>
                <div class="tp-post-stats">
                    <div class="tp-stat-item">ğŸ‘ ${post.likes}</div>
                    <div class="tp-stat-item">ğŸ’¬ ${post.comments ? post.comments.length : 0}</div>
                    <div class="tp-stat-item">â†—ï¸ ${post.shares || 0}</div>
                </div>
                <div class="tp-comment-preview-box">
                    ${previewCommentsHtml}
                </div>
            </div>
        `;
    });
}
    // å…¨å±€å˜é‡ï¼šè®°å½•å½“å‰æ­£åœ¨çœ‹å“ªä¸ªå°ç»„çš„ ID
let currentViewingGroupId = null;

// èœå•å¼€å…³
function toggleGroupMenu() {
    const menu = document.getElementById('tp-group-menu-box');
    menu.classList.toggle('show');
}

// ç‚¹å‡»å…¶ä»–åœ°æ–¹è‡ªåŠ¨å…³é—­èœå• (è¡¥å……ä¹‹å‰çš„å…¨å±€ç‚¹å‡»äº‹ä»¶)
/* ================= ç‚¹å‡»ç©ºç™½å¤„å…³é—­å„ç±»æµ®çª— (æœ€ç»ˆå®Œæ•´ç‰ˆ) ================= */
document.addEventListener('click', function(e) {
    
    // 1. æœ‹å‹åœˆï¼šé€‰äººç”Ÿæˆèœå•
    const momentMenu = document.getElementById('moment-gen-menu');
    const momentBtn = document.getElementById('btn-moment-refresh');
    if (momentMenu && momentMenu.classList.contains('show')) {
        if (!momentMenu.contains(e.target) && (!momentBtn || !momentBtn.contains(e.target))) {
            momentMenu.classList.remove('show');
        }
    }

    // 2. èŠå¤©é¡µï¼šè¾“å…¥æ¡†æ—è¾¹çš„åŠ å·èœå•
    const actionSheet = document.getElementById('action-sheet');
    const plusBtn = document.querySelector('.plus-btn');
    if (actionSheet && actionSheet.classList.contains('show')) {
        if (!actionSheet.contains(e.target) && (!plusBtn || !plusBtn.contains(e.target))) {
            actionSheet.classList.remove('show');
        }
    }

    // 3. åˆ†äº«å¼¹çª— (ç‚¹å‡»é»‘è‰²é®ç½©å…³é—­)
    const shareMask = document.getElementById('modal-share');
    if (shareMask && shareMask.classList.contains('show')) {
        if (e.target === shareMask) {
            closeShareModal();
        }
        const tpShareMask = document.getElementById('modal-tp-share');
    if (tpShareMask && tpShareMask.classList.contains('show')) {
        if (e.target === tpShareMask) {
            tpShareMask.classList.remove('show');
        }
    }
    }

    // ğŸ”´ 4. æ–°å¢ï¼šå°ç»„è¯¦æƒ…é¡µå³ä¸Šè§’èœå• (ä¿®å¤è¿™é‡Œï¼)
    const gMenu = document.getElementById('tp-group-menu-box');
    // ç²¾å‡†æ‰¾åˆ°é‚£ä¸ª "..." æŒ‰é’® (é˜²æ­¢æŠ¥é”™ï¼ŒåŠ ä¸ªåˆ¤æ–­)
    const gBtn = document.querySelector('#view-tp-group .nav-bar button[onclick="toggleGroupMenu()"]');

    if (gMenu && gMenu.classList.contains('show')) {
        // å¦‚æœç‚¹å‡»çš„åœ°æ–¹æ—¢ä¸æ˜¯èœå•é‡Œé¢ï¼Œä¹Ÿä¸æ˜¯é‚£ä¸ªæŒ‰é’®
        if (!gMenu.contains(e.target) && (!gBtn || !gBtn.contains(e.target))) {
            gMenu.classList.remove('show');
        }
    }
    
    // 5. èŠå¤©åˆ—è¡¨é¡µçš„å³ä¸Šè§’åŠ å·èœå•
    const chatPop = document.getElementById('chat-pop-menu');
    // æ‰¾åˆ°è§¦å‘å®ƒçš„æŒ‰é’® (åœ¨ view-chat-app çš„å¯¼èˆªæ é‡Œ)
    const chatPopBtn = document.querySelector('#view-chat-app .nav-bar button[onclick="togglePopMenu()"]');
    
    if (chatPop && chatPop.classList.contains('show')) {
        if (!chatPop.contains(e.target) && (!chatPopBtn || !chatPopBtn.contains(e.target))) {
            chatPop.classList.remove('show');
        }
    }
});
// 7. â˜…â˜…â˜… æ‰“å¼€å¸–å­è¯¦æƒ…é¡µ â˜…â˜…â˜…
// 7. â˜…â˜…â˜… æ‰“å¼€å¸–å­è¯¦æƒ…é¡µ (é€‚é…é•¿æ–‡ç‰ˆ) â˜…â˜…â˜…
// 7. â˜…â˜…â˜… æ‰“å¼€å¸–å­è¯¦æƒ…é¡µ (æœ€ç»ˆç‰ˆï¼šè¯„è®ºå¸¦å¤´åƒ) â˜…â˜…â˜…
// 7. â˜…â˜…â˜… æ‰“å¼€å¸–å­è¯¦æƒ…é¡µ (æœ€ç»ˆç‰ˆï¼šçœŸå®è¯„è®ºæ—¶é—´) â˜…â˜…â˜…
// 7. â˜…â˜…â˜… æ‰“å¼€å¸–å­è¯¦æƒ…é¡µ (æœ€ç»ˆç‰ˆï¼šå»æ‰äº†å…³æ³¨æŒ‰é’®) â˜…â˜…â˜…
// 7. â˜…â˜…â˜… æ‰“å¼€å¸–å­è¯¦æƒ…é¡µ (æœ€ç»ˆç‰ˆï¼šäº¤äº’åŠŸèƒ½å…¨å¼€) â˜…â˜…â˜…
// 7. â˜…â˜…â˜… æ‰“å¼€å¸–å­è¯¦æƒ…é¡µ (æœ€ç»ˆç‰ˆï¼šå»æ‰è¯„è®ºçº¢å¿ƒ) â˜…â˜…â˜…
// 7. â˜…â˜…â˜… æ‰“å¼€å¸–å­è¯¦æƒ…é¡µ (æœ€ç»ˆç‰ˆï¼šæ”¯æŒç‚¹å‡»å›å¤) â˜…â˜…â˜…
function openPostDetailPage(groupId, postIndex) {
    currentTpDetail = { groupId, postIndex };

    const groupData = tpCache[currentTpCategory].find(g => g.id == groupId);
    const post = groupData.posts[postIndex];
    
    if (!post.likes) post.likes = 0;
    if (!post.shares) post.shares = 0;
    if (!post.isLiked) post.isLiked = false;

    navTo('view-tp-post');
    
    if (!post.avatar) post.avatar = generateNameAvatar(post.user);
    const postTimeStr = formatRelativeTime(post.time);

    const container = document.getElementById('tp-post-detail-container');
    
    const likeColor = post.isLiked ? '#ff3b30' : '#666';
    const likeIcon = post.isLiked ? 'â¤ï¸' : 'ğŸ‘';

    container.innerHTML = `
        <div style="padding:20px;">
            <h2 style="font-size:18px; margin:0 0 15px 0; color:#000; line-height:1.4; font-weight:bold;">${post.content.substring(0, 20)}...</h2>
            
            <div class="tp-poster-row">
                <img src="${post.avatar}" class="tp-poster-avatar" style="width:40px;height:40px;">
                <div style="flex:1">
                    <div class="tp-poster-name" style="font-size:16px;">${post.user}</div>
                    <div style="font-size:12px;color:#999">æ¥¼ä¸» Â· ${postTimeStr}</div>
                </div>
            </div>
            
            <div style="font-size:17px; line-height:1.7; color:#333; margin:20px 0; white-space: pre-wrap; text-align:justify;">${post.content}</div>
            
            <div class="tp-post-stats" style="border-top:1px solid #f5f5f5; padding-top:15px; margin-top:30px; display:flex; justify-content:space-between;">
                <div class="tp-stat-item" style="color:${likeColor}; cursor:pointer;" onclick="toggleTpLike(${groupId}, ${postIndex})">
                    ${likeIcon} ${post.likes}
                </div>
                <div class="tp-stat-item">ğŸ’¬ ${post.comments ? post.comments.length : 0}</div>
                <div class="tp-stat-item" onclick="openTpShareModal(${groupId}, ${postIndex})">
                    â†—ï¸ ${post.shares}
                </div>
            </div>
        </div>
    `;
    
    const cmtList = document.getElementById('tp-comment-full-list');
    cmtList.innerHTML = '';
    
    if (post.comments && post.comments.length > 0) {
        post.comments.forEach(c => {
            const ava = c.avatar || generateNameAvatar(c.user);
            const cmtTimeStr = formatRelativeTime(c.time || Date.now());
            
            cmtList.innerHTML += `
                <div class="tp-full-cmt-item">
                    <img src="${ava}" class="tp-cmt-avatar-lg">
                    <div style="flex:1">
                        <div style="font-size:13px; color:#666; font-weight:bold; margin-bottom:2px;">${c.user}</div>
                        <div style="font-size:15px; color:#222; line-height:1.5;">${c.text}</div>
                        
                        <!-- ğŸ”´ æ ¸å¿ƒä¿®æ”¹ï¼šç»™â€œå›å¤â€æ–‡å­—æ·»åŠ äº†ç‚¹å‡»äº‹ä»¶ï¼ŒæŠŠåå­—ä¼ è¿›å» -->
                        <div style="font-size:11px; color:#ccc; margin-top:6px;">
                            ${cmtTimeStr} Â· <span style="color:#576b95; font-weight:bold; cursor:pointer;" onclick="prepTpReply('${c.user}')">å›å¤</span>
                        </div>
                    </div>
                </div>
            `;
        });
    } else {
        cmtList.innerHTML = `<div style="text-align:center; padding:20px; color:#ccc;">æš‚æ—¶æ²¡äººè¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘ï¼</div>`;
    }

    const bottomBar = document.querySelector('#view-tp-post .chat-input-bar');
    bottomBar.innerHTML = `
        <input type="text" id="tp-comment-input" placeholder="è¯´ç‚¹å¥½å¬çš„..." style="background:#f0f0f0; border:none; flex:1; padding:10px; border-radius:20px;">
        <button class="mini-btn" style="background:#2D68FF; margin-left:10px;" onclick="submitTpComment()">å‘é€</button>
    `;
}

// 8. è¾…åŠ©ï¼šæœ¬åœ°ç”Ÿæˆå¸–å­æ•°æ® (ä¸ç”¨AIï¼Œä¸ºäº†é€Ÿåº¦å’Œç¨³å®šæ€§)
function generateMockPosts(groupName, category) {
    const posts = [];
    const count = Math.floor(Math.random() * 4) + 3; // æ¯ä¸ªç»„ 3-6 ä¸ªå¸–å­
    
    // ç®€å•çš„æ–‡æ¡ˆåº“ï¼Œé˜²æ­¢å…¨æ˜¯Lorem Ipsum
    const texts = {
        'ææ€–': ['æ˜¨å¤©æ™šä¸Šèµ°å¤œè·¯ï¼Œæ€»æ„Ÿè§‰åé¢æœ‰äºº...', 'ç»™å¤§å®¶è®²ä¸ªçœŸäº‹ï¼Œå°±åœ¨æˆ‘ä½çš„è¿™æ ‹æ¥¼ã€‚', 'è§„åˆ™æ€ªè°ˆï¼šå¦‚æœä½ çœ‹åˆ°çº¢è‰²çš„æœˆäº®ï¼Œè¯·ç«‹åˆ»é—­çœ¼ã€‚', 'è¿™å¼ ç…§ç‰‡å“ªé‡Œä¸å¯¹åŠ²ï¼Ÿ'],
        'æ¸¸æˆ': ['è¿™æ³¢æ“ä½œä»€ä¹ˆæ°´å¹³ï¼Ÿ', 'æ–°ç‰ˆæœ¬æ›´æ–°å¤ªå‘äº†ï¼Œç­–åˆ’åœ¨æƒ³ä»€ä¹ˆï¼Ÿ', 'æ‰¾ä¸ªå›ºç©ï¼Œå¿ƒæ€å¥½çš„æ¥ã€‚', 'ç»ˆäºæŠ½åˆ°è¿™ä¸ªçš®è‚¤äº†ï¼'],
        'å°è¯´': ['æ±‚æ¨ä¹¦ï¼ä¹¦è’äº†ï¼', 'è¿™æœ¬å°è¯´çš„ç»“å±€æ„éš¾å¹³å•Š...', 'å¦‚æœä½ ç©¿è¶Šåˆ°ä¹¦é‡Œï¼Œä½ æœ€æƒ³æˆä¸ºè°ï¼Ÿ', 'æœ‰æ²¡æœ‰é‚£ç§ä¸»è§’ä¸€å¼€å§‹å°±å¾ˆå¼ºçš„ä¹¦ï¼Ÿ'],
        'å…«å¦': ['ç†æ€§è®¨è®ºï¼Œè¿™æ¬¡å¡Œæˆ¿è°çš„é”…ï¼Ÿ', 'æƒŠå¤©å¤§ç“œï¼æŸé¡¶æµéšå©šç”Ÿå­ï¼Ÿ', 'çœ‹ä¸æ‡‚ç°åœ¨çš„æ—¶å°šåœˆäº†ã€‚', 'çº¯è·¯äººï¼Œè§‰å¾—è¿™ä»¶äº‹å¾ˆæœ‰è¹Šè··ã€‚']
    };
    
    const pool = texts[category] || texts['æ¸¸æˆ'];
    const names = ['åƒç“œè·¯äºº', 'ç†¬å¤œå† å†›', 'çº¯çˆ±æˆ˜ç¥', 'æš´èºè€å“¥', 'åŒ¿åç”¨æˆ·', 'MOMO', 'å¿«ä¹å°ç‹—'];

    for(let i=0; i<count; i++) {
        const user = names[Math.floor(Math.random() * names.length)] + Math.floor(Math.random()*100);
        const content = pool[Math.floor(Math.random() * pool.length)] + " " + "è¯¦ç»†å†…å®¹".repeat(Math.random()*10 + 5);
        
        // ç”Ÿæˆè¯„è®º
        const comments = [];
        const cmtCount = Math.floor(Math.random() * 8) + 4; // 4-12ä¸ªè¯„è®º
        for(let j=0; j<cmtCount; j++) {
            comments.push({
                user: names[Math.floor(Math.random() * names.length)],
                text: ['ç¡®å®', 'ç»†æ€ææ', 'å“ˆå“ˆå“ˆ', 'è¿™å°±å»çœ‹çœ‹', 'åŒæ„Ÿ', 'å¤ªçœŸå®äº†'][Math.floor(Math.random()*6)]
            });
        }
        
        posts.push({
            user: user,
            avatar: `https://dummyimage.com/100x100/eee/333?text=${user[0]}`,
            content: content,
            likes: Math.floor(Math.random() * 500),
            comments: comments,
            shares: Math.floor(Math.random() * 50)
        });
    }
    return posts;
}

// 9. API è¯·æ±‚å‡½æ•° (ä¿æŒä¹‹å‰çš„é€»è¾‘ï¼Œç•¥å¾®ç®€åŒ–)
// 9. API è¯·æ±‚å‡½æ•° (æœ€ç»ˆç‰ˆï¼šæ”¯æŒè‡ªå®šä¹‰æè¿°)
async function fetchAiGroups(cfg, category) {
    let extraInstruction = "";

    // 1. å°è¯•ä»æ•°æ®åº“è·å–è‡ªå®šä¹‰æè¿°
    const customCats = await DB.get('tongpin_custom_cats') || [];
    const targetCat = customCats.find(c => c.name === category);

    if (targetCat) {
        // ğŸ”´ å¦‚æœæ˜¯è‡ªå®šä¹‰åˆ†ç±»ï¼Œä½¿ç”¨ç”¨æˆ·å¡«å†™çš„æè¿°
        extraInstruction = `è¿™æ˜¯ä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰çš„é¢†åŸŸï¼Œä¸»é¢˜æ˜¯â€œ${category}â€ã€‚
        è¯¦ç»†è®¾å®š/é£æ ¼è¦æ±‚ï¼š${targetCat.desc}ã€‚
        è¯·ä¸¥æ ¼æ ¹æ®ä¸Šè¿°è®¾å®šç”Ÿæˆå°ç»„åå’Œç®€ä»‹ã€‚`;
    } else {
        // é»˜è®¤åˆ†ç±»çš„é¢„è®¾é€»è¾‘
        if (category === 'æ¸¸æˆ') extraInstruction = "åŸºäºçœŸå®çŸ¥åæ¸¸æˆ(å¦‚åŸç¥ã€ç‹è€…ã€LOL)èµ·åã€‚";
        else if (category === 'å°è¯´') extraInstruction = "åŸºäºçœŸå®çŸ¥åå°è¯´(å¦‚è¯¡ç§˜ã€ç›—å¢“)èµ·åã€‚";
        else if (category === 'ææ€–') extraInstruction = "é£æ ¼è¦æƒŠæ‚šã€æ‚¬ç–‘ã€éƒ½å¸‚ä¼ è¯´ã€‚";
        else if (category === 'æ­Œæ›²') extraInstruction = "å…³äºæµè¡ŒéŸ³ä¹ã€æ­Œè¯è®¨è®ºã€‚";
        else if (category === 'å…«å¦') extraInstruction = "å…³äºå¨±ä¹åœˆã€ç½‘çº¢ç“œã€‚";
        else extraInstruction = "å‘æŒ¥åˆ›æ„ï¼Œèµ·åè¦æœ‰è¶£ã€‚";
    }

    const prompt = `ä¸ºã€${category}ã€‘åˆ†ç±»ç”Ÿæˆ5ä¸ªæœ‰è¶£çš„å°ç»„ã€‚
    ${extraInstruction}
    è¦æ±‚ï¼šJSONæ•°ç»„æ ¼å¼ï¼ŒåŒ…å« name, desc, members(æ•°å­—), likes(æ•°å­—)ã€‚ç¦æ­¢Markdownã€‚`;

    let url = cfg.url;
    if(!url.includes('/chat/completions')) url = url.replace(/\/$/, '') + '/chat/completions';
    if(!url.includes('/v1/') && !url.includes('moonshot')) url = url.replace('/chat', '/v1/chat');

    const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${cfg.key}` },
        body: JSON.stringify({ model: cfg.model, messages: [{ role: 'user', content: prompt }] })
    });

    const data = await res.json();
    let content = data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
    return JSON.parse(content);
}
// 9.5 æ–°å¢ï¼šä¸ºç‰¹å®šå°ç»„ç”Ÿæˆæ·±åº¦å¸–å­
// 9.5 å‡çº§ç‰ˆï¼šç”Ÿæˆæ·±åº¦å¸–å­ (æ”¯æŒæ•°é‡æ§åˆ¶ + éšæœºè¯„è®º + äº’åŠ¨)
// 9.5 å‡çº§ç‰ˆï¼šç”Ÿæˆæ·±åº¦å¸–å­ (æ”¯æŒç‰¹é‚€å˜‰å®¾)
async function fetchAiPostsForGroup(cfg, groupName, groupDesc, count = 5) {
    // ... (ä¿ç•™å‰é¢çš„å˜‰å®¾å¤„ç†é€»è¾‘å’Œ Prompt å®šä¹‰) ...

    let url = cfg.url;
    if(!url.includes('/chat/completions')) url = url.replace(/\/$/, '') + '/chat/completions';
    if(!url.includes('/v1/') && !url.includes('moonshot')) url = url.replace('/chat', '/v1/chat');

    const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${cfg.key}` },
        body: JSON.stringify({ 
            model: cfg.model, 
            messages: [{ role: 'user', content: prompt }],
            temperature: 0.85 
        })
    });

    const data = await res.json();
    if(data.error) throw new Error(data.error.message);
    
    let content = data.choices[0].message.content;
    
    // âŒ åˆ é™¤ä¸­é—´é‚£æ®µå…³äº fullText å’Œ sess çš„é”™è¯¯ä»£ç 
    // âŒ åˆ é™¤ triggerMoment ç›¸å…³é€»è¾‘

    content = content.replace(/```json/g, '').replace(/```/g, '').trim();
    
    return JSON.parse(content);
}
// â­ æ ¸å¿ƒåŠŸèƒ½ï¼šåŠ å…¥æˆ–é€€å‡ºå°ç»„
async function toggleGroupFollow(event, groupId) {
    // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢ç‚¹æŒ‰é’®æ—¶è¿›å…¥è¯¦æƒ…é¡µ
    event.stopPropagation();
    
    // 1. è·å–å½“å‰æ“ä½œçš„å°ç»„æ•°æ®
    const group = tpCache[currentTpCategory].find(g => g.id == groupId);
    if (!group) return;

    // 2. è·å–å·²å…³æ³¨åˆ—è¡¨
    let followed = await DB.get('tongpin_followed');
    if (!Array.isArray(followed)) followed = [];

    // åˆ¤æ–­æ˜¯â€œåŠ å…¥â€è¿˜æ˜¯â€œé€€å‡ºâ€
    if (currentTpCategory === 'å…³æ³¨') {
        // --- é€€å‡ºé€»è¾‘ ---
        if (!confirm(`ç¡®å®šè¦é€€å‡ºã€${group.name}ã€‘å—ï¼Ÿ\né€€å‡ºåå®ƒå°†ä»å…³æ³¨åˆ—è¡¨ä¸­ç§»é™¤ã€‚`)) return;
        
        // ä»åˆ—è¡¨ç§»é™¤
        followed = followed.filter(g => g.id != groupId);
        await DB.set('tongpin_followed', followed);
        
        // åˆ·æ–°å½“å‰é¡µé¢
        tpCache['å…³æ³¨'] = followed; // æ›´æ–°å†…å­˜ç¼“å­˜
        renderTpFromCache();        // é‡æ–°æ¸²æŸ“
        
    } else {
        // --- åŠ å…¥é€»è¾‘ ---
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        if (followed.find(g => g.id == group.id)) {
            return alert("ä½ å·²ç»åŠ å…¥è¿‡è¿™ä¸ªå°ç»„å•¦ï¼Œå»ã€å…³æ³¨ã€‘åˆ—è¡¨çœ‹çœ‹å§ï¼");
        }
        
        // å­˜å…¥æ•°æ®åº“
        followed.unshift(group); // åŠ åˆ°æœ€å‰é¢
        await DB.set('tongpin_followed', followed);
        
        // è§†è§‰åé¦ˆ (å˜ç°)
        const btn = event.target;
        btn.innerText = "å·²åŠ å…¥";
        btn.style.background = "#f5f5f5";
        btn.style.color = "#ccc";
        
        // å¦‚æœæƒ³æ›´æ˜æ˜¾ä¸€ç‚¹
        alert(`ğŸ‰ æˆåŠŸåŠ å…¥ã€${group.name}ã€‘ï¼\nä»¥åå¯ä»¥åœ¨ã€å…³æ³¨ã€‘é¡µå¿«é€Ÿæ‰¾åˆ°å®ƒã€‚`);
    }
}

// â­ ä¸“é—¨åŠ è½½å…³æ³¨åˆ—è¡¨çš„å‡½æ•°
async function loadFollowedList() {
    let followed = await DB.get('tongpin_followed');
    if (!Array.isArray(followed)) followed = [];
    
    // æ”¾å…¥ç¼“å­˜
    tpCache['å…³æ³¨'] = followed;
    // æ¸²æŸ“
    renderTpFromCache();
}
// â­ åˆ·æ–°å°ç»„å†…å®¹ (ç”Ÿæˆ 3 æ¡æ–°å¸–)
// â­ åˆ·æ–°å°ç»„å†…å®¹ (ä¿®å¤ç‰ˆï¼šå¸¦æ—¶é—´åˆ†é…)
// â­ åˆ·æ–°å°ç»„å†…å®¹ (ä¿®å¤ç‰ˆï¼šæ­£ç¡®ä¿å­˜çŠ¶æ€)
// â­ åˆ·æ–°å°ç»„å†…å®¹ (æœ€ç»ˆä¿®å¤ç‰ˆï¼šæ–°å¸–æ—¶é—´é—´éš”æ‹‰å¤§)
// â­ åˆ·æ–°å°ç»„å†…å®¹ (æœ€ç»ˆä¿®å¤ç‰ˆï¼šåˆ†é…è½¬å‘æ•°)
// â­ åˆ·æ–°å°ç»„å†…å®¹ (æœ€ç»ˆç‰ˆï¼šæ”¯æŒç‰¹é‚€å˜‰å®¾å¤´åƒ)
async function refreshGroupPosts() {
    const menu = document.getElementById('tp-group-menu-box');
    if (menu) menu.classList.remove('show');
    
    if (!currentViewingGroupId) return;
    const groupData = tpCache[currentTpCategory].find(g => g.id == currentViewingGroupId);
    if (!groupData) return;

    const postList = document.getElementById('tp-post-list');
    
    if (!groupData.posts || groupData.posts.length === 0) {
        postList.innerHTML = `<div style="text-align:center; padding:60px 20px; color:#007AFF;">ğŸ”® æ­£åœ¨æ— ä¸­ç”Ÿæœ‰...</div>`;
    } else {
        const loadingDiv = document.createElement('div');
        loadingDiv.innerHTML = `<div style="text-align:center; padding:15px; color:#007AFF; background:#f0f8ff;">ğŸ”® æ­£åœ¨æœå¯» 3 æ¡æ–°åŠ¨æ€...</div>`;
        postList.insertBefore(loadingDiv, postList.firstChild);
    }
    
    try {
        const cfg = await DB.getObj('api_config');
        let newPosts = await fetchAiPostsForGroup(cfg, groupData.name, groupData.desc, 3);
        
        // ğŸ”´ æ ¸å¿ƒä¿®æ”¹ï¼šå…ˆè°ƒç”¨å¤´åƒåŒ¹é…
        await applyGuestAvatars(newPosts);

        // åˆ†é…æ—¶é—´ (æ³¨æ„ï¼šåˆ é™¤äº†è¿™é‡Œçš„å¤´åƒç”Ÿæˆä»£ç ï¼Œå› ä¸ºä¸Šé¢å·²ç»å¤„ç†äº†)
        let tempTime = Date.now();
        
        newPosts.forEach((p, i) => {
            if (i === 0) p.time = tempTime;
            else {
                const gap = (Math.floor(Math.random() * 13) + 12) * 60 * 1000;
                tempTime -= gap;
                p.time = tempTime;
            }

            // åˆå§‹åŒ–è½¬å‘æ•°
            p.shares = Math.floor(Math.random() * 30); 

            if (p.comments) {
                let cTime = p.time;
                p.comments.forEach(c => {
                    cTime += Math.floor(Math.random() * 10 * 60 * 1000) + 60000;
                    if(cTime > Date.now()) cTime = Date.now() - 1000;
                    c.time = cTime;
                    // è¿™é‡Œçš„å¤´åƒç”Ÿæˆä»£ç ä¹Ÿåˆ é™¤äº†ï¼ŒapplyGuestAvatars å·²ç»å¤„ç†äº†è¯„è®ºåŒº
                });
            }
        });

        if (!Array.isArray(groupData.posts)) groupData.posts = [];
        groupData.posts = [...newPosts, ...groupData.posts];
        groupData.isLoaded = true;

        await saveCurrentTpData();
        openGroupPage(currentViewingGroupId);
        
    } catch (e) {
        alert("åˆ·æ–°å¤±è´¥: " + e.message);
        openGroupPage(currentViewingGroupId);
    }
}
// é™„èµ ï¼šæ¸…ç©ºåŠŸèƒ½ (ä¸‡ä¸€ç”Ÿæˆçš„å†…å®¹ä¸å–œæ¬¢)
// ğŸ—‘ï¸ æ¸…ç©ºå½“å‰å¸–å­ (ä¿®å¤ç‰ˆï¼šæ­£ç¡®ä¿å­˜çŠ¶æ€)
async function clearGroupPosts() {
    // å…³é—­èœå•
    const menu = document.getElementById('tp-group-menu-box');
    if (menu) menu.classList.remove('show');

    if (!confirm("ç¡®å®šè¦æ¸…ç©ºå½“å‰æ‰€æœ‰å¸–å­å—ï¼Ÿ\n(æ¸…ç©ºåä¸ä¼šç«‹å³ç”Ÿæˆï¼Œéœ€æ‰‹åŠ¨åˆ·æ–°)")) return;
    
    const groupData = tpCache[currentTpCategory].find(g => g.id == currentViewingGroupId);
    if (groupData) {
        // 1. æ¸…ç©ºæ•°æ®
        groupData.posts = [];
        groupData.isLoaded = true; // æ ‡è®°ä¸ºå·²åŠ è½½ï¼Œé˜²æ­¢è‡ªåŠ¨ç”Ÿæˆ
        
        // ğŸ”´ 2. æ ¸å¿ƒä¿®æ”¹ï¼šè°ƒç”¨æ™ºèƒ½ä¿å­˜
        await saveCurrentTpData();
        
        // 3. é‡æ–°æ¸²æŸ“ (æ˜¾ç¤ºç©ºçŠ¶æ€)
        openGroupPage(currentViewingGroupId); 
    }
}
// æ‰“å¼€å¼¹çª—
function openAddCategoryModal() {
    document.getElementById('new-cat-name').value = '';
    document.getElementById('new-cat-desc').value = '';
    openModal('modal-add-category');
}

// ç¡®è®¤åˆ›å»º
async function confirmAddCategory() {
    const name = document.getElementById('new-cat-name').value.trim();
    const desc = document.getElementById('new-cat-desc').value.trim();
    
    if (!name) return alert("è¯·è¾“å…¥åˆ†ç±»åç§°");
    if (!desc) return alert("è¯·è¾“å…¥æè¿°ï¼Œä»¥ä¾¿AIç”Ÿæˆå†…å®¹");

    // 1. ä¿å­˜åˆ°æ•°æ®åº“
    let customCats = await DB.get('tongpin_custom_cats');
    if (!Array.isArray(customCats)) customCats = [];
    
    // æŸ¥é‡
    if (customCats.find(c => c.name === name)) return alert("è¿™ä¸ªåˆ†ç±»å·²ç»å­˜åœ¨å•¦");
    
    customCats.push({ name, desc });
    await DB.set('tongpin_custom_cats', customCats);

    // 2. åŠ¨æ€æ·»åŠ åˆ°é¡µé¢ Tab æ 
    const tabsContainer = document.getElementById('tp-tabs');
    const div = document.createElement('div');
    div.className = 'tp-tab-item';
    div.innerText = name;
    // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œå¹¶è‡ªåŠ¨è§¦å‘ä¸€æ¬¡ç‚¹å‡»ä»¥åˆ‡æ¢è¿‡å»
    div.onclick = function() { switchTpTab(name, this); };
    tabsContainer.appendChild(div);

    // 3. å…³é—­å¼¹çª—å¹¶è‡ªåŠ¨è·³è½¬
    closeModal('modal-add-category');
    div.click(); // æ¨¡æ‹Ÿç‚¹å‡»ï¼Œç›´æ¥åˆ‡æ¢åˆ°æ–°åˆ†ç±»
}
// ğŸ•’ å·¥å…·1ï¼šæŠŠæ—¶é—´æˆ³å˜æˆâ€œå¤šä¹…å‰â€
function formatRelativeTime(timestamp) {
    if (!timestamp) return 'åˆšåˆš';
    const now = Date.now();
    const diff = now - timestamp;
    
    const min = 60 * 1000;
    const hour = 60 * min;
    const day = 24 * hour;
    
    if (diff < 0) return 'åˆšåˆš'; // é˜²æ­¢æ—¶é—´è¶…å‰
    if (diff < min) return 'åˆšåˆš';
    if (diff < hour) return Math.floor(diff / min) + 'åˆ†é’Ÿå‰';
    if (diff < day) return Math.floor(diff / hour) + 'å°æ—¶å‰';
    return Math.floor(diff / day) + 'å¤©å‰';
}

// ğŸ•’ å·¥å…·2ï¼šç»™å¸–å­å’Œè¯„è®ºåˆ†é…â€œçœŸå®â€çš„æ—¶é—´æˆ³
// é€»è¾‘ï¼šå¸–å­åˆ—è¡¨(è¶Šå¾€ä¸‹è¶Šæ—§)ï¼Œè¯„è®ºåˆ—è¡¨(è¶Šå¾€ä¸‹è¶Šæ–°)
// ğŸ•’ å·¥å…·2ï¼šç»™å¸–å­å’Œè¯„è®ºåˆ†é…â€œçœŸå®â€çš„æ—¶é—´æˆ³ (ä¿®å¤ç‰ˆï¼šæ‹‰å¤§æ—¶é—´å·®è·)
function assignRealisticTimes(posts) {
    let baseTime = Date.now();
    
    posts.forEach((post, index) => {
        // 1. è®¾å®šå¸–å­æ—¶é—´
        if (index === 0) {
            // ç¬¬ä¸€æ¡å¸–å­ï¼šè®¾ä¸ºå½“å‰æ—¶é—´ (æ˜¾ç¤ºâ€œåˆšåˆšâ€)
            post.time = baseTime;
        } else {
            // åé¢çš„å¸–å­ï¼šæ¯ä¸€æ¡éƒ½æ¯”å‰ä¸€æ¡ å€’é€€ 15~45 åˆ†é’Ÿ
            // è¿™æ ·èƒ½ä¿è¯æ—¶é—´æ˜¾ç¤ºä¸ºï¼šåˆšåˆš -> 20åˆ†é’Ÿå‰ -> 50åˆ†é’Ÿå‰ -> 1å°æ—¶å‰...
            const gap = Math.floor(Math.random() * 30 * 60 * 1000) + 15 * 60 * 1000; 
            baseTime -= gap; 
            post.time = baseTime;
        }

        // 2. è®¾å®šè¯„è®ºæ—¶é—´
        if (post.comments && post.comments.length > 0) {
            // è¯„è®ºçš„æ—¶é—´åŸºå‡†æ˜¯å‘å¸–æ—¶é—´
            let commentTime = post.time;
            
            post.comments.forEach(c => {
                // æ¯æ¡è¯„è®ºé—´éš” 2~10 åˆ†é’Ÿ
                const commentGap = Math.floor(Math.random() * 8 * 60 * 1000) + 2 * 60 * 1000;
                commentTime += commentGap;
                
                // ä¿®æ­£ï¼šè¯„è®ºæ—¶é—´ç»å¯¹ä¸èƒ½è¶…è¿‡â€œç°åœ¨â€
                if (commentTime > Date.now()) commentTime = Date.now() - Math.floor(Math.random() * 60000);
                
                c.time = commentTime;
            });
        }
    });
    return posts;
}
// ğŸ’¾ å·¥å…·å‡½æ•°ï¼šæ™ºèƒ½ä¿å­˜å½“å‰åˆ†ç±»çš„æ•°æ®
async function saveCurrentTpData() {
    // 1. å¦‚æœå½“å‰åœ¨â€œå…³æ³¨â€åˆ—è¡¨ï¼Œä¿å­˜åˆ°å…³æ³¨ä¸“å±æ•°æ®åº“
    if (currentTpCategory === 'å…³æ³¨') {
        // tpCache['å…³æ³¨'] é‡Œå­˜çš„å°±æ˜¯å½“å‰çš„å…³æ³¨åˆ—è¡¨
        await DB.set('tongpin_followed', tpCache['å…³æ³¨']);
    } 
    // 2. å¦‚æœæ˜¯å…¶ä»–åˆ†ç±»ï¼ˆæ¨èã€æ¸¸æˆç­‰ï¼‰ï¼Œä¿å­˜åˆ°æ™®é€šç¼“å­˜æ•°æ®åº“
    else {
        await DB.set('tongpin_cache', tpCache);
    }
    console.log(`æ•°æ®å·²ä¿å­˜è‡³ [${currentTpCategory}] åˆ†ç±»`);
}
// å…¨å±€å˜é‡
let tempSharePostData = null;
let tempShareGroupName = ""; // ğŸ”´ æ–°å¢ï¼šç”¨æ¥å­˜å°ç»„åå­—

// 1. æ‰“å¼€åˆ†äº«å¼¹çª—
async function openTpShareModal(groupId, postIndex) {
    // æ‰¾åˆ°å°ç»„æ•°æ®
    const groupData = tpCache[currentTpCategory].find(g => g.id == groupId);
    const post = groupData.posts[postIndex];
    
    // ğŸ”´ æ ¸å¿ƒä¿®æ”¹ï¼šæŠŠå¸–å­æ•°æ®å’Œå°ç»„åå­—éƒ½å­˜ä¸‹æ¥
    tempSharePostData = post;
    tempShareGroupName = groupData.name; // ä¾‹å¦‚ "éœæ ¼æ²ƒèŒ¨"

    const mask = document.getElementById('modal-tp-share');
    const listDiv = document.getElementById('tp-share-friend-list');
    
    // è·å–èŠå¤©åˆ—è¡¨
    const list = await DB.get('sessions');
    const characters = await DB.get('characters');
    const validSessions = list.filter(s => s.type === 'direct'); 

    listDiv.innerHTML = '';
    
    if(validSessions.length === 0) {
        listDiv.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999;padding:20px;">æš‚æ— æœ€è¿‘è”ç³»äºº</div>';
    } else {
        validSessions.forEach(s => {
            const char = characters.find(c => c.id === s.targetId);
            if(!char) return;
            const ava = char.avatar || DEFAULT_AVATAR;
            
            listDiv.innerHTML += `
                <div class="share-item" onclick="sendTpPostToChat('${s.id}', '${char.name}')">
                    <img src="${ava}" class="share-avatar">
                    <div class="share-name">${char.name}</div>
                </div>`;
        });
    }
    
    mask.classList.add('show');
}

// 2. å‘é€å¸–å­ (å¡ç‰‡æ ¼å¼ï¼Œä¸è·³è½¬)
// 2. å‘é€å¸–å­ (å‡çº§ç‰ˆï¼šæ‰“åŒ…å…¨æ–‡å’Œè¯„è®ºç»™AIçœ‹)
// 2. å‘é€å¸–å­ (æœ€ç»ˆç‰ˆï¼šå¸¦è½¬å‘è®¡æ•°)
// 2. å‘é€å¸–å­ (æœ€ç»ˆç‰ˆï¼šæ”¯æŒè·³è½¬å¼€å…³ + åŸ‹å…¥å¯»å€åæ ‡)
async function sendTpPostToChat(sessionId, charName) {
    if(!tempSharePostData) return;

    const userPersonas = await DB.get('user_personas');
    const curPid = localStorage.getItem('cur_pid') || (userPersonas[0] && userPersonas[0].id);
    const t = Date.now();

    // 1. è·å–å¼€å…³çŠ¶æ€
    const needJump = document.getElementById('share-jump-checkbox').checked;

    // 2. å‡†å¤‡ AI ä¸Šä¸‹æ–‡ (ä¿æŒä¸å˜)
    let commentsStr = "æš‚æ— è¯„è®º";
    if (tempSharePostData.comments && tempSharePostData.comments.length > 0) {
        commentsStr = tempSharePostData.comments.map(c => `${c.user}: ${c.text}`).join('\n');
    }
    const aiContext = `
ã€ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆ†äº«äº†ä¸€ä¸ªæ¥è‡ªå°ç»„ "${tempShareGroupName}" çš„å¸–å­... (çœç•¥ï¼Œä¿æŒåŸæ ·) ...`.trim();

    // 3. æ„é€ æ¶ˆæ¯
    const msgObj = {
        role: 'user',
        content: `[åˆ†äº«å¸–å­] ${tempSharePostData.content.substring(0, 15)}...`,
        personaId: curPid,
        t: t,
        isShare: true, 
        aiPayload: aiContext, 
        momentData: {  
            name: tempSharePostData.user,   
            avatar: tempSharePostData.avatar, 
            text: `ã€${tempShareGroupName}ã€‘\n${tempSharePostData.content}`,
            
            // ğŸ”´ æ ¸å¿ƒæ–°å¢ï¼šåŸ‹å…¥â€œåæ ‡â€ï¼Œç”¨äºå°†æ¥è·³å›æ¥
            sourceRef: {
                category: currentTpCategory,      // åˆ†ç±» (å¦‚ï¼šæ¸¸æˆ)
                groupId: currentTpDetail.groupId, // å°ç»„ID
                contentSign: tempSharePostData.content // å†…å®¹æŒ‡çº¹ (ç”¨æ¥éªŒè¯å¸–å­è¿˜åœ¨ä¸åœ¨)
            }
        }
    };

    const list = await DB.get('sessions');
    const idx = list.findIndex(s => s.id === sessionId);
    if(idx !== -1) {
        list[idx].msgs.push(msgObj);
        await DB.set('sessions', list);
        
        // å¢åŠ è½¬å‘æ•°
        if (!tempSharePostData.shares) tempSharePostData.shares = 0;
        tempSharePostData.shares++;
        if (currentTpDetail.groupId) await saveAndRenderTpDetail(currentTpDetail.groupId, currentTpDetail.postIndex);
        else await saveCurrentTpData();

        document.getElementById('modal-tp-share').classList.remove('show');

        // ğŸ”´ æ ¸å¿ƒåˆ†æ”¯ï¼šåˆ¤æ–­æ˜¯è·³è½¬è¿˜æ˜¯ç•™åœ¨è¿™é‡Œ
        if (needJump) {
            // A. è·³è½¬æ¨¡å¼ï¼š
            // 1. åˆ‡æ¢åˆ°åº•éƒ¨â€œæ¶ˆæ¯â€Tab
            switchChatTab('msg'); 
            // 2. è¿›å…¥è¯¥è§’è‰²çš„èŠå¤©çª—å£
            await enterChat(sessionId);
        } else {
            // B. åœç•™æ¨¡å¼ï¼šæ˜¾ç¤ºæç¤º
            const toast = document.createElement('div');
            toast.innerText = `å·²å‘é€ç»™ ${charName} âœ…`;
            toast.style.cssText = "position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(0,0,0,0.7); color:white; padding:10px 20px; border-radius:8px; z-index:9999; transition: opacity 0.5s;";
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 1500);
        }
    }
}
// ğŸŸ¢ å…¨å±€å˜é‡ï¼šè®°å½•å½“å‰æ­£åœ¨æµè§ˆçš„å¸–å­åæ ‡
let currentTpDetail = { groupId: null, postIndex: null };

// ğŸŸ¢ è¾…åŠ©å‡½æ•°ï¼šä¿å­˜å¹¶åˆ·æ–°è¯¦æƒ…é¡µ UI
async function saveAndRenderTpDetail(groupId, postIndex) {
    // 1. æ™ºèƒ½ä¿å­˜ (æ ¹æ®æ˜¯å…³æ³¨è¿˜æ˜¯æ¨èï¼Œå­˜åˆ°ä¸åŒåœ°æ–¹)
    await saveCurrentTpData();
    
    // 2. é‡æ–°æ¸²æŸ“è¯¦æƒ…é¡µ (åˆ·æ–°ç‚¹èµæ•°ã€è¯„è®ºåˆ—è¡¨)
    // æ³¨æ„ï¼šä¸éœ€è¦è·³è½¬ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»åœ¨è¯¦æƒ…é¡µäº†ï¼Œç›´æ¥è°ƒæ¸²æŸ“å‡½æ•°å³å¯
    openPostDetailPage(groupId, postIndex); 
}
// ğŸ‘ ç‚¹èµ/å–æ¶ˆç‚¹èµ
async function toggleTpLike(groupId, postIndex) {
    const groupData = tpCache[currentTpCategory].find(g => g.id == groupId);
    const post = groupData.posts[postIndex];

    if (post.isLiked) {
        post.likes--; // å–æ¶ˆ
        post.isLiked = false;
    } else {
        post.likes++; // ç‚¹èµ
        post.isLiked = true;
    }
    
    await saveAndRenderTpDetail(groupId, postIndex);
}
// ğŸ’¬ ç”¨æˆ·æäº¤è¯„è®º
async function submitTpComment() {
    const input = document.getElementById('tp-comment-input');
    const text = input.value.trim();
    if (!text) return;

    const { groupId, postIndex } = currentTpDetail;
    if (!groupId) return;

    // 1. è·å–ç”¨æˆ·ä¿¡æ¯
    const userPersonas = await DB.get('user_personas');
    const curPid = localStorage.getItem('cur_pid') || (userPersonas[0] && userPersonas[0].id);
    const me = userPersonas.find(p => p.id == curPid) || { name: "æˆ‘", avatar: "" };

    // 2. æ„é€ è¯„è®ºå¯¹è±¡
    const newComment = {
        user: me.name,
        avatar: me.avatar || DEFAULT_AVATAR, // ç”¨ä½ è‡ªå·±çš„å¤´åƒ
        text: text,
        time: Date.now()
    };

    // 3. å­˜å…¥æ•°æ®
    const groupData = tpCache[currentTpCategory].find(g => g.id == groupId);
    const post = groupData.posts[postIndex];
    
    if (!post.comments) post.comments = [];
    post.comments.push(newComment);

    // 4. ä¿å­˜å¹¶åˆ·æ–°
    await saveAndRenderTpDetail(groupId, postIndex);
    input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†

    // 5. ğŸš€ è§¦å‘ AI æ¨¡æ‹Ÿå›´è§‚
    triggerTpCommentSim(groupId, postIndex, me.name, text);
}

// ğŸ¤– AI æ¨¡æ‹Ÿå›´è§‚å›å¤
// ğŸ¤– AI æ¨¡æ‹Ÿå›´è§‚å›å¤ (å‡çº§ç‰ˆï¼šæ”¯æŒå®šå‘å›å¤æ£€æµ‹)
async function triggerTpCommentSim(groupId, postIndex, userName, userText) {
    const cmtList = document.getElementById('tp-comment-full-list');
    
    // 1. æ’å…¥ Loading
    const loadingId = 'tp-sim-loading';
    const loadingHtml = `
        <div id="${loadingId}" style="padding:10px; color:#007AFF; font-size:12px; text-align:center; background:#f0f8ff; border-radius:8px; margin:10px 0; animation:pulse 1.5s infinite;">
            ğŸ‘€ å¤§å®¶æ­£åœ¨è¯»ä½ çš„è¯„è®º...
        </div>
    `;
    cmtList.insertAdjacentHTML('beforeend', loadingHtml);
    const scrollContent = document.querySelector('#view-tp-post .scroll-content');
    scrollContent.scrollTop = scrollContent.scrollHeight;

    try {
        const groupData = tpCache[currentTpCategory].find(g => g.id == groupId);
        const post = groupData.posts[postIndex];
        const cfg = await DB.getObj('api_config');

        // 2. ğŸ” æ£€æµ‹æ˜¯å¦ @ äº†æŸäºº
        // æ­£åˆ™åŒ¹é…ï¼šä»¥ @ å¼€å¤´ï¼Œåé¢è·Ÿç€éç©ºå­—ç¬¦ï¼Œç›´åˆ°é‡åˆ°ç©ºæ ¼æˆ–ç»“æŸ
        const atMatch = userText.match(/^@(\S+)\s/); 
        const targetName = atMatch ? atMatch[1] : null;

        // 3. æ„é€ åŠ¨æ€ Prompt
        let specificInstruction = "";
        
        if (targetName) {
            // ğŸ…°ï¸ æƒ…å†µAï¼šç”¨æˆ· @ äº†æŸäºº (ä¾‹å¦‚ @è·¯äººA)
            specificInstruction = `
            ã€é‡è¦æŒ‡ä»¤ã€‘
            ç”¨æˆ·æ­£åœ¨ç›´æ¥å›å¤ NPC "${targetName}"ã€‚
            1. âš ï¸ **å¿…é¡»**ç”Ÿæˆä¸€æ¡æ¥è‡ª "${targetName}" çš„è¯„è®ºï¼Œå›å¤ç”¨æˆ·çš„å†…å®¹ï¼ˆè¯­æ°”è¦ç¬¦åˆä¹‹å‰çš„å‘è¨€ï¼‰ã€‚
            2. ç”Ÿæˆ 1-2 ä¸ªå…¶ä»–è·¯äººï¼Œä»–ä»¬å¯ä»¥ï¼š
               - å›´è§‚ä½ ä»¬çš„å¯¹è¯ï¼ˆâ€œæ‰“èµ·æ¥æ‰“èµ·æ¥â€ï¼‰ã€‚
               - æˆ–è€…å¸® "${targetName}" è¯´è¯ã€‚
               - æˆ–è€…åé©³ç”¨æˆ·çš„è§‚ç‚¹ã€‚
            `;
        } else {
            // ğŸ…±ï¸ æƒ…å†µBï¼šç”¨æˆ·åªæ˜¯æ™®é€šå‘å¸–
            specificInstruction = `
            1. éšæœºé€‰å– 1-2 å NPC å›å¤ç”¨æˆ·ï¼ˆä¾‹å¦‚ï¼šå›å¤ @${userName}ï¼šå“ˆå“ˆ...ï¼‰ã€‚
            2. å…¶ä»–äººç»§ç»­è®¨è®ºæ¥¼ä¸»çš„è¯é¢˜ï¼Œæˆ–è€…äº’ç›¸èŠå¤©ã€‚
            `;
        }

        const prompt = `
åœºæ™¯ï¼šä½ åœ¨ä¸€ä¸ªåä¸ºâ€œ${groupData.name}â€çš„ç½‘ç»œå°ç»„ã€‚
æ¥¼ä¸»å‘å¸–ï¼š${post.content}
ç”¨æˆ·â€œ${userName}â€åˆšåˆšè¯„è®ºï¼šâ€œ${userText}â€ã€‚

ä»»åŠ¡ï¼šè¯·æ¨¡æ‹Ÿ 4-5 ä¸ªç½‘å‹ï¼ˆNPCï¼‰ï¼Œå¯¹å½“å‰æƒ…å†µè¿›è¡Œååº”ã€‚
${specificInstruction}

è¦æ±‚ï¼š
1. **çœŸå®æ„Ÿ**ï¼šè¯­æ°”è¦åƒçœŸå®çš„ç½‘å‹ï¼Œå¯ä»¥ç”¨ç½‘ç»œç”¨è¯­ï¼Œä¸è¦å…¨æ˜¯å¥½è¯ã€‚
2. **æ ¼å¼**ï¼šè¿”å› JSON æ•°ç»„ï¼š[{"user":"è·¯äººå","text":"å†…å®¹"},...]ã€‚
        `;

        let url = cfg.url;
        if(!url.includes('/chat/completions')) url = url.replace(/\/$/, '') + '/chat/completions';
        if(!url.includes('/v1/') && !url.includes('moonshot')) url = url.replace('/chat', '/v1/chat');

        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${cfg.key}` },
            body: JSON.stringify({ model: cfg.model, messages: [{ role: 'user', content: prompt }], temperature: 0.8 })
        });

        const data = await res.json();
        let content = data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
        const newCmts = JSON.parse(content);

        // 4. å¤„ç†æ–°è¯„è®º
        let now = Date.now();
        newCmts.forEach(c => {
            now += Math.floor(Math.random() * 30000) + 5000; 
            c.time = now;
            
            // ğŸ”´ æ ¸å¿ƒï¼šä¸ºäº†å¤´åƒä¸€è‡´æ€§ï¼Œå¦‚æœå›å¤çš„äººæ˜¯å·²å­˜åœ¨çš„NPCï¼Œå¿…é¡»ç”¨ calculateNameAvatar ç”Ÿæˆä¸€æ ·çš„é¢œè‰²
            c.avatar = generateNameAvatar(c.user); 
        });

        // 5. ç§»é™¤ Loading
        const loadingEl = document.getElementById(loadingId);
        if (loadingEl) loadingEl.remove();

        // 6. å­˜å…¥å¹¶åˆ·æ–°
        post.comments = [...post.comments, ...newCmts];
        await saveAndRenderTpDetail(groupId, postIndex);

    } catch (e) {
        const loadingEl = document.getElementById(loadingId);
        if (loadingEl) loadingEl.innerText = "å¤§å®¶å¥½åƒæ‰çº¿äº†...";
        setTimeout(() => loadingEl && loadingEl.remove(), 2000);
    }
}
// ğŸ’¬ ç‚¹å‡»â€œå›å¤â€æŒ‰é’®ï¼šè‡ªåŠ¨å¡«å…… @åå­—
function prepTpReply(name) {
    const input = document.getElementById('tp-comment-input');
    // å¡«å…¥æ ¼å¼ï¼š@åå­— + ç©ºæ ¼
    input.value = `@${name} `;
    // è‡ªåŠ¨èšç„¦ï¼Œæ–¹ä¾¿ç›´æ¥æ‰“å­—
    input.focus();
}
// ğŸš€ èŠå¤©å¡ç‰‡è·³è½¬é€»è¾‘
async function tryJumpToPost(e, msgTime) {
    e.stopPropagation(); // é˜²æ­¢è§¦å‘æ°”æ³¡çš„å…¶ä»–äº‹ä»¶

    // 1. å¼¹çª—ç¡®è®¤
    if (!confirm("æ˜¯å¦è·³è½¬è‡³è¯¥å¸–å­è¯¦æƒ…ï¼Ÿ")) return;

    // 2. ä»å½“å‰ä¼šè¯é‡Œæ‰¾åˆ°è¿™æ¡æ¶ˆæ¯ï¼Œè·å–åæ ‡
    const list = await DB.get('sessions');
    const sess = list.find(s => s.id === currentChatId);
    const msg = sess.msgs.find(m => m.t == msgTime);
    
    if (!msg || !msg.momentData || !msg.momentData.sourceRef) {
        return alert("âŒ æ— æ³•å®šä½å¸–å­ä¿¡æ¯ (å¯èƒ½æ˜¯æ—§ç‰ˆæœ¬åˆ†äº«)");
    }

    const ref = msg.momentData.sourceRef; // { category, groupId, contentSign }

    // 3. å¼€å§‹å¯»å€ï¼šå»æ•°æ®åº“/ç¼“å­˜é‡Œæ‰¾
    // å…ˆæ¢å¤åˆ†ç±»ï¼Œå› ä¸ºæˆ‘ä»¬è¦å»é‚£ä¸ªåˆ†ç±»ä¸‹æ‰¾
    currentTpCategory = ref.category;
    
    // ç¡®ä¿ç¼“å­˜å·²åŠ è½½ (é˜²æ­¢ç”¨æˆ·åˆšæ‰“å¼€APPç›´æ¥è¿›èŠå¤©ï¼Œæ²¡è¿›è¿‡åŒé¢‘ï¼Œå¯¼è‡´ç¼“å­˜ä¸ºç©º)
    if (!tpCache[currentTpCategory]) {
        // å°è¯•ä»æ•°æ®åº“è¯»å–è¯¥åˆ†ç±»çš„å­˜æ¡£
        // è¿™é‡Œåšä¸€ä¸ªç®€å•çš„å…¨é‡è¯»å–å…œåº•
        const saved = await DB.get('tongpin_cache') || {};
        const savedFollowed = await DB.get('tongpin_followed') || [];
        
        if (currentTpCategory === 'å…³æ³¨') tpCache['å…³æ³¨'] = savedFollowed;
        else tpCache = saved;
    }

    const groupList = tpCache[currentTpCategory];
    
    if (!groupList) {
        return alert("ğŸ‚ è¯¥å¸–å­æ‰€å±çš„å°ç»„åˆ†ç±»å·²ä¸å­˜åœ¨æˆ–æ•°æ®ä¸¢å¤±ã€‚");
    }

    const group = groupList.find(g => g.id == ref.groupId);
    
    if (!group) {
        return alert("ğŸ‚ è¯¥å¸–å­æ‰€å±çš„å°ç»„å·²è¢«è§£æ•£ã€‚");
    }

    // 4. åœ¨å°ç»„é‡Œæ‰¾å¸–å­
    // æˆ‘ä»¬ä¸å¯¹æ¯” indexï¼Œå› ä¸ºæ–°å¸–å­ä¼šè®© index å˜åŒ–
    // æˆ‘ä»¬å¯¹æ¯” content (å†…å®¹æŒ‡çº¹)ï¼Œè¿™æ ·æœ€å‡†ç¡®
    if (!group.posts) group.posts = [];
    
    const postIndex = group.posts.findIndex(p => p.content === ref.contentSign);

    if (postIndex === -1) {
        // ğŸ”´ æ‰¾åˆ°äº†å°ç»„ï¼Œä½†æ²¡æ‰¾åˆ°å¸–å­ -> è¯´æ˜è¢«åˆ äº†
        return alert("ğŸ‚ è¯¥å¸–å­å·²ç»è¢«åˆ æ‰äº†å“¦ (å¯èƒ½è¢«åˆ·æ–°æˆ–æ¸…ç©ºäº†)");
    }

    // 5. æ‰¾åˆ°äº†ï¼å‡†å¤‡ç©¿è¶Š
    // åˆ‡æ¢ Tab æ ·å¼
    switchChatTab('circle'); 
    // å¯¼èˆªåˆ°è¯¦æƒ…é¡µ
    openPostDetailPage(group.id, postIndex);
}
// â­ æ‰“å¼€/å…³é—­å˜‰å®¾èœå•
// â­ æ‰“å¼€/å…³é—­å˜‰å®¾èœå• (ä¿®æ”¹ç‰ˆï¼šæµ…è‰²åˆ†å‰²çº¿)
async function toggleTpGuestMenu() {
    const menu = document.getElementById('tp-guest-menu');
    
    if (!menu.classList.contains('show')) {
        const box = document.getElementById('tp-guest-list-box');
        box.innerHTML = '';

        const characters = await DB.get('characters');
        let selectedIds = await DB.get('tongpin_guest_ids');
        if (!Array.isArray(selectedIds)) selectedIds = [];

        if (characters.length === 0) {
            box.innerHTML = '<div style="padding:15px; text-align:center; color:#666;">è¿˜æ²¡åˆ›å»ºè¿‡è§’è‰²</div>';
        } else {
            characters.forEach(c => {
                const isChecked = selectedIds.includes(c.id) ? 'checked' : '';
                const ava = c.avatar || DEFAULT_AVATAR;
                
                // ğŸ”´ æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨ style é‡ŒåŠ äº† border-bottom: 1px solid #f5f5f5;
                // è¿™æ ·çº¿æ¡å°±æ˜¯éå¸¸æ·¡çš„ç°è‰²ï¼Œè€Œä¸æ˜¯é»‘çº¿äº†
                box.innerHTML += `
                    <div class="pop-item" style="display:flex; align-items:center; gap:10px; padding:10px; border-bottom: 1px solid #f5f5f5; background:transparent;" onclick="updateTpGuest('${c.id}')">
                        <input type="checkbox" id="chk-guest-${c.id}" ${isChecked} style="pointer-events:none;">
                        <img src="${ava}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">
                        <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color:#333;">${c.name}</span>
                    </div>
                `;
            });
        }
        menu.style.display = 'flex';
        requestAnimationFrame(() => menu.classList.add('show'));
    } else {
        menu.classList.remove('show');
        setTimeout(() => menu.style.display = 'none', 200);
    }
}

// â­ æ›´æ–°å‹¾é€‰çŠ¶æ€
async function updateTpGuest(charId) {
    // 1. åˆ‡æ¢ checkbox çŠ¶æ€
    const chk = document.getElementById('chk-guest-' + charId);
    chk.checked = !chk.checked;

    // 2. æ›´æ–°æ•°æ®åº“
    let selectedIds = await DB.get('tongpin_guest_ids');
    if (!Array.isArray(selectedIds)) selectedIds = [];

    if (chk.checked) {
        if (!selectedIds.includes(charId)) selectedIds.push(charId);
    } else {
        selectedIds = selectedIds.filter(id => id !== charId);
    }

    await DB.set('tongpin_guest_ids', selectedIds);
}

// è¡¥å……ï¼šç‚¹å‡»ç©ºç™½å…³é—­è¿™ä¸ªæ–°èœå• (æ·»åŠ åˆ°å…¨å±€ç›‘å¬é‡Œ)
document.addEventListener('click', function(e) {
    // ... (ä¹‹å‰çš„ä»£ç ) ...
    
    // ğŸ”´ æ–°å¢ï¼šå˜‰å®¾èœå•å…³é—­é€»è¾‘
    const guestMenu = document.getElementById('tp-guest-menu');
    // æ‰¾åˆ°è§¦å‘æŒ‰é’® (æ˜Ÿæ˜Ÿ)
    const guestBtn = document.querySelector('.tp-header-bar div[onclick="toggleTpGuestMenu()"]');
    
    if (guestMenu && guestMenu.classList.contains('show')) {
        // å¦‚æœç‚¹çš„ä¸æ˜¯èœå•å†…éƒ¨ï¼Œä¹Ÿä¸æ˜¯æ˜Ÿæ˜ŸæŒ‰é’®
        if (!guestMenu.contains(e.target) && !guestBtn.contains(e.target)) {
            guestMenu.classList.remove('show');
            setTimeout(() => guestMenu.style.display = 'none', 200);
        }
    }
});
// ğŸ­ å·¥å…·å‡½æ•°ï¼šä¸ºå¸–å­åˆ—è¡¨åŒ¹é…çœŸå®è§’è‰²å¤´åƒ
async function applyGuestAvatars(posts) {
    const characters = await DB.get('characters');
    if (!characters || characters.length === 0) return posts;

    // å»ºç«‹åå­—->å¤´åƒçš„æ˜ å°„è¡¨ (æ–¹ä¾¿å¿«é€ŸæŸ¥æ‰¾)
    const charMap = {};
    characters.forEach(c => {
        charMap[c.name] = c.avatar || DEFAULT_AVATAR;
    });

    posts.forEach(post => {
        // 1. æ£€æŸ¥æ¥¼ä¸»
        if (charMap[post.user]) {
            post.avatar = charMap[post.user]; // å‘½ä¸­ï¼ä½¿ç”¨çœŸå¤´åƒ
        } else if (!post.avatar) {
            post.avatar = generateNameAvatar(post.user); // æ²¡å‘½ä¸­ï¼Œç”¨è‰²å—
        }

        // 2. æ£€æŸ¥è¯„è®ºåŒº
        if (post.comments) {
            post.comments.forEach(c => {
                if (charMap[c.user]) {
                    c.avatar = charMap[c.user]; // å‘½ä¸­ï¼
                } else if (!c.avatar) {
                    c.avatar = generateNameAvatar(c.user);
                }
            });
        }
    });
    return posts;
}
// === ğŸ”´ çº¢ç‚¹é€šçŸ¥ç³»ç»Ÿ ===
function updateRedDotUI() {
    const count = parseInt(localStorage.getItem('unread_moments_count')) || 0;
    const display = count > 0 ? 'flex' : 'none';
    const text = count > 99 ? '99+' : count;

    // æ›´æ–°ä¸‰ä¸ªä½ç½®çš„çº¢ç‚¹
    ['badge-chat-back', 'badge-tab-circle', 'badge-space-list'].forEach(id => {
        const el = document.getElementById(id);
        if(el) {
            el.style.display = display;
            el.innerText = text;
        }
    });
}

function addUnreadMomentCount() {
    let count = parseInt(localStorage.getItem('unread_moments_count')) || 0;
    count++;
    localStorage.setItem('unread_moments_count', count);
    updateRedDotUI();
}

function clearUnreadMoments() {
    localStorage.setItem('unread_moments_count', 0);
    updateRedDotUI();
    // é¡ºä¾¿æ¸²æŸ“ä¸€ä¸‹åˆ—è¡¨
    renderMoments(); 
}

// âš ï¸ è®°å¾—åœ¨ window.onload é‡Œè°ƒç”¨ä¸€æ¬¡ updateRedDotUI();
// === âœ¨ AIè‡ªåŠ¨å‘åŠ¨æ€é€»è¾‘ ===
async function autoGenerateMoment(charId, contextMsgs) {
    console.log("æ­£åœ¨è§¦å‘AIè‡ªåŠ¨å‘åŠ¨æ€...");
    
    // 1. è·å–è§’è‰²ä¿¡æ¯
    const characters = await DB.get('characters');
    const char = characters.find(c => c.id === charId);
    if(!char) return;

    // 2. å‡†å¤‡API
    const cfg = await DB.getObj('api_config');
    const userPersonas = await DB.get('user_personas');
    const curPid = localStorage.getItem('cur_pid') || (userPersonas[0] && userPersonas[0].id);
    const myName = userPersonas.find(p=>p.id==curPid)?.name || "æˆ‘";

    // 3. æ„å»º Prompt
    // æå–æœ€è¿‘å¯¹è¯ä½œä¸ºèƒŒæ™¯
    const recent = contextMsgs.slice(-10).map(m => `${m.role==='user'?myName:char.name}: ${m.content}`).join('\n');
    
    const prompt = `
    ä½ ç°åœ¨æ˜¯ã€${char.name}ã€‘ã€‚
    è¯·æ ¹æ®åˆšåˆšå’Œã€${myName}ã€‘çš„èŠå¤©å†…å®¹ï¼Œå‘ä¸€æ¡æœ‹å‹åœˆåŠ¨æ€ã€‚
    
    ã€è¦æ±‚ã€‘
    1. è¯­æ°”å¿…é¡»ç¬¦åˆä½ çš„äººè®¾ï¼š${char.prompt}
    2. å†…å®¹è‡ªç„¶ã€ç”Ÿæ´»åŒ–ï¼Œä¸è¦å¤ªé•¿ï¼ˆ60å­—ä»¥å†…ï¼‰ã€‚
    3. ä¸è¦å¸¦ä»»ä½•å‰ç¼€ï¼ˆå¦‚â€œæœ‹å‹åœˆï¼šâ€ï¼‰ï¼Œç›´æ¥è¾“å‡ºå†…å®¹ã€‚
    4. å¦‚æœèŠå¤©å†…å®¹å¾ˆå¹³æ·¡ï¼Œå°±å‘ä¸€æ¡ç¬¦åˆå¿ƒæƒ…çš„æ—¥å¸¸ã€‚

    ã€èŠå¤©èƒŒæ™¯ã€‘ï¼š
    ${recent}
    `;

    try {
        let url = cfg.url;
        if(!url.includes('/chat/completions')) url = url.replace(/\/$/, '') + '/chat/completions';
        if(!url.includes('/v1/') && !url.includes('moonshot')) url = url.replace('/chat', '/v1/chat');

        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${cfg.key}` },
            body: JSON.stringify({ model: cfg.model, messages: [{ role: 'user', content: prompt }], temperature: 0.8 })
        });
        
        const data = await res.json();
        const content = data.choices[0].message.content.replace(/^["â€œ]|["â€]$/g, '').trim();

        if(content) {
            // 4. å­˜å…¥æ•°æ®åº“
            let moments = await DB.get('moments');
            if (!Array.isArray(moments)) moments = [];
            
            moments.unshift({
                id: Date.now() + Math.random(),
                charId: char.id,
                name: char.name,
                avatar: char.avatar,
                content: content,
                time: new Date().toLocaleString(),
                likeCount: Math.floor(Math.random() * 20), 
                isLiked: false
            });
            
            await DB.set('moments', moments);
            
            // 5. å¢åŠ çº¢ç‚¹è®¡æ•°
            addUnreadMomentCount();
            console.log("AIåŠ¨æ€å‘å¸ƒæˆåŠŸï¼");
        }

    } catch(e) {
        console.error("è‡ªåŠ¨å‘åŠ¨æ€å¤±è´¥:", e);
    }
}
/* ================= ğŸ˜œ è¡¨æƒ…åŒ…ç³»ç»Ÿé€»è¾‘ ================= */

// 1. æ¸²æŸ“è¡¨æƒ…åŒ…ç®¡ç†åˆ—è¡¨
async function renderStickerPacks() {
    const packs = await DB.get('sticker_packs') || [];
    const div = document.getElementById('sticker-pack-list');
    div.innerHTML = '';
    
    if (packs.length === 0) {
        div.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">è¿˜æ²¡æœ‰åˆ›å»ºè¡¨æƒ…åŒ…åˆ†ç±»<br>ç‚¹å‡»å³ä¸Šè§’ + å·æ·»åŠ </div>';
        return;
    }

    packs.forEach(p => {
        // å–ç¬¬ä¸€å¼ å›¾åšå°é¢
        const cover = p.items.length > 0 ? p.items[0].url : DEFAULT_AVATAR;
        div.innerHTML += `
            <div class="list-item" onclick="openStickerDetail('${p.id}')">
                <div class="item-main">
                    <img src="${cover}" class="avatar" style="object-fit:contain; background:#f5f5f5;">
                    <div class="item-text">
                        <h3>${p.name}</h3>
                        <p>å…± ${p.items.length} ä¸ªè¡¨æƒ…</p>
                    </div>
                </div>
                <div style="color:#ccc;">â¯</div>
            </div>`;
    });
}

// 2. æ‰“å¼€æ–°å»ºå¼¹çª—
function openAddStickerPackModal() {
    document.getElementById('sticker-pack-name').value = '';
    document.getElementById('sticker-pack-content').value = '';
    openModal('modal-add-sticker-pack');
}

// 3. ä¿å­˜è¡¨æƒ…åŒ… (è§£æ idï¼šurl)
async function saveStickerPack() {
    const name = document.getElementById('sticker-pack-name').value.trim();
    const content = document.getElementById('sticker-pack-content').value.trim();
    
    if (!name) return alert("è¯·è¾“å…¥å¤‡æ³¨åç§°");
    if (!content) return alert("è¯·è¾“å…¥è¡¨æƒ…å†…å®¹");

    const items = [];
    const lines = content.split(/\n/);
    
    lines.forEach(line => {
        // æ”¯æŒä¸­æ–‡å†’å·å’Œè‹±æ–‡å†’å·
        const parts = line.replace('ï¼š', ':').split(':');
        if (parts.length >= 2) {
            const id = parts[0].trim();
            // é‡æ–°æ‹¼æ¥ URL (é˜²æ­¢URLé‡Œä¹Ÿæœ‰å†’å·è¢«åˆ‡æ–­)
            const url = parts.slice(1).join(':').trim();
            if (id && url) {
                items.push({ id, url });
            }
        }
    });

    if (items.length === 0) return alert("æ²¡æœ‰è¯†åˆ«åˆ°æœ‰æ•ˆçš„è¡¨æƒ… (æ ¼å¼: idï¼šé“¾æ¥)");

    let packs = await DB.get('sticker_packs') || [];
    packs.push({
        id: Date.now().toString(),
        name: name,
        items: items
    });
    
    await DB.set('sticker_packs', packs);
    closeModal('modal-add-sticker-pack');
    renderStickerPacks();
    alert(`æˆåŠŸå¯¼å…¥ ${items.length} ä¸ªè¡¨æƒ…ï¼`);
}

// 4. æŸ¥çœ‹è¡¨æƒ…åŒ…è¯¦æƒ…
let currentPackId = null;
async function openStickerDetail(pid) {
    currentPackId = pid;
    const packs = await DB.get('sticker_packs');
    const pack = packs.find(p => p.id == pid);
    if (!pack) return;

    document.getElementById('sticker-pack-title').innerText = pack.name;
    const grid = document.getElementById('sticker-grid-view');
    grid.innerHTML = '';

    pack.items.forEach(item => {
        grid.innerHTML += `
            <div class="sticker-item-view">
                <img src="${item.url}" class="sticker-img-view">
                <div class="sticker-id-text">${item.id}</div>
            </div>`;
    });

    navTo('view-sticker-detail');
}

// 5. åˆ é™¤è¡¨æƒ…åŒ…
async function deleteCurrentStickerPack() {
    if (!confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªè¡¨æƒ…åŒ…åˆ†ç±»å—ï¼Ÿ")) return;
    let packs = await DB.get('sticker_packs');
    packs = packs.filter(p => p.id != currentPackId);
    await DB.set('sticker_packs', packs);
    navTo('view-sticker-manager');
    renderStickerPacks();
}

// 6. èŠå¤©è®¾ç½®ï¼šç»‘å®š AI è¡¨æƒ…åŒ…
// ä¿®æ”¹ openChatSettings å‡½æ•°ï¼Œåœ¨é‡Œé¢æ·»åŠ æ¸²æŸ“ select çš„é€»è¾‘
// è¯·æ‰¾åˆ°åŸæ¥çš„ openChatSettings å‡½æ•°ï¼Œåœ¨ openModal ä¹‹å‰åŠ å…¥ä¸‹é¢è¿™æ®µï¼š
/*
    const aiStickerSel = document.getElementById('ai-sticker-select');
    aiStickerSel.innerHTML = '<option value="">ä¸ä½¿ç”¨è¡¨æƒ…åŒ…</option>';
    const allPacks = await DB.get('sticker_packs') || [];
    allPacks.forEach(p => {
        aiStickerSel.innerHTML += `<option value="${p.id}">${p.name}</option>`;
    });
    aiStickerSel.value = sess.boundStickerId || '';
*/

// ================= ğŸ’¬ èŠå¤©ç•Œé¢è¡¨æƒ…äº¤äº’ =================

// 7. åˆ‡æ¢è¡¨æƒ…é¢æ¿æ˜¾ç¤º/éšè—
// æ§åˆ¶è¡¨æƒ…é¢æ¿
function toggleStickerPanel(e) {
    if (e) e.stopPropagation();
    
    const stickerPanel = document.getElementById('chat-sticker-panel');
    const toolPanel = document.getElementById('chat-tool-panel'); // è·å–åŠ å·é¢æ¿
    const input = document.getElementById('msg-input');
    const box = document.getElementById('chat-msg-container');

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šå…ˆæ— æ¡ä»¶å…³é—­åŠ å·é¢æ¿ â˜…â˜…â˜…
    if (toolPanel) {
        toolPanel.classList.remove('show');
    }
    
    // ç„¶åå†å¤„ç†è‡ªå·±çš„å¼€å…³
    if (stickerPanel.style.height === '260px') {
        stickerPanel.style.height = '0';
    } else {
        // æ‰“å¼€æ—¶ï¼Œå…ˆæ”¶èµ·é”®ç›˜
        input.blur();
        
        stickerPanel.style.height = '260px';
        renderChatPanelStickers(); // æ¸²æŸ“å†…å®¹
        
        // è‡ªåŠ¨æ»šåˆ°åº•éƒ¨
        setTimeout(() => {
            box.scrollTop = box.scrollHeight;
        }, 100);
    }
}

function closeStickerPanel() {
    document.getElementById('chat-sticker-panel').style.height = '0';
}

// 8. æ¸²æŸ“èŠå¤©é¢æ¿é‡Œçš„è¡¨æƒ…
async function renderChatPanelStickers() {
    // è·å–å½“å‰ç”¨æˆ·é€‰ä¸­çš„ pack ID (å­˜åœ¨ localStorage)
    const curPackId = localStorage.getItem('user_current_sticker_pack');
    const packs = await DB.get('sticker_packs') || [];
    const contentDiv = document.getElementById('chat-sticker-content');
    const hintDiv = document.getElementById('sticker-panel-hint');
    
    contentDiv.innerHTML = '';

    if (!curPackId || packs.length === 0) {
        // æ²¡æœ‰åŒ…ï¼Œæˆ–è€…æ²¡é€‰åŒ…
        hintDiv.innerText = "ä½ è¿˜æ²¡æœ‰è¡¨æƒ…åŒ…å“¦";
        contentDiv.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">ç‚¹å‡»å³ä¾§ â¤ï¸ é€‰æ‹©æˆ–æ·»åŠ è¡¨æƒ…</div>`;
        return;
    }

    const pack = packs.find(p => p.id == curPackId);
    if (!pack) {
        hintDiv.innerText = "è¡¨æƒ…åŒ…å·²å¤±æ•ˆ";
        return;
    }

    hintDiv.innerText = `å½“å‰ä½¿ç”¨ï¼š${pack.name}`;
    
    // æ¸²æŸ“å›¾ç‰‡ç½‘æ ¼
    contentDiv.style.display = 'grid';
    contentDiv.style.gridTemplateColumns = 'repeat(4, 1fr)';
    contentDiv.style.gap = '10px';

    pack.items.forEach(item => {
        // ç‚¹å‡»å‘é€
        const itemHtml = document.createElement('img');
        itemHtml.src = item.url;
        itemHtml.className = 'chat-sticker-img';
        itemHtml.onclick = () => sendStickerMsg(item.url, item.id);
        contentDiv.appendChild(itemHtml);
    });
}

// 9. æ‰“å¼€çˆ±å¿ƒé€‰æ‹©å™¨
async function openStickerSelector() {
    const packs = await DB.get('sticker_packs') || [];
    const list = document.getElementById('sticker-pack-selector-list');
    list.innerHTML = '';
    
    if (packs.length === 0) {
        list.innerHTML = '<div style="padding:10px;text-align:center;">æš‚æ— è¡¨æƒ…åŒ…ï¼Œå»"æˆ‘çš„"æ·»åŠ </div>';
    } else {
        packs.forEach(p => {
            list.innerHTML += `
                <div class="select-row" onclick="selectUserStickerPack('${p.id}')">
                    <span>${p.name}</span>
                    <span style="font-size:12px;color:#999;">(${p.items.length})</span>
                </div>
            `;
        });
    }
    openModal('modal-select-sticker');
}

function selectUserStickerPack(pid) {
    localStorage.setItem('user_current_sticker_pack', pid);
    closeModal('modal-select-sticker');
    renderChatPanelStickers(); // åˆ·æ–°é¢æ¿
}

// 10. å‘é€è¡¨æƒ…æ¶ˆæ¯
async function sendStickerMsg(url, id) {
    // ç›´æ¥å¤ç”¨å‘å›¾é€»è¾‘ï¼Œæˆ–è€…å°è£…ä¸€ä¸ªæ–°çš„
    // è¿™é‡Œæˆ‘ä»¬ä½œä¸ºâ€œç”¨æˆ·å›¾ç‰‡â€å‘é€ï¼Œæˆ–è€…ä½ å¯ä»¥åšæˆ (img:url) æ ¼å¼
    // æ—¢ç„¶è¦æ±‚æ˜¯è½¬æ¢çš„å›¾ç‰‡ï¼Œæˆ‘ä»¬ç›´æ¥å‘å›¾
    await sendUserImageMsg(url); 
    // å‘å®Œä¸ç”¨å…³é¢æ¿ï¼Œæ–¹ä¾¿è¿å‘ï¼Œæˆ–è€…ä½ å¯ä»¥è°ƒç”¨ closeStickerPanel()
}
/* ================= ğŸš‘ ç´§æ€¥ä¿®å¤è¡¥ä¸ï¼šæ‰¾å›ä¸¢å¤±çš„å¼¹çª—å‡½æ•° ================= */

// 1. è¡¥å›æœ€åŸºç¡€çš„å¼¹çª—æ‰“å¼€å‡½æ•°
window.openModal = function(id) {
    const el = document.getElementById(id);
    if (el) {
        el.classList.add('show');
    } else {
        console.error("âŒ æ‰¾ä¸åˆ°å¼¹çª—ID:", id);
    }
}

// 2. è¡¥å›æœ€åŸºç¡€çš„å¼¹çª—å…³é—­å‡½æ•°
window.closeModal = function(id) {
    const el = document.getElementById(id);
    if (el) {
        el.classList.remove('show');
    }
}

/* ================= ğŸ”§ ä¿®å¤èŠå¤©è®¾ç½®ç‚¹ä¸å¼€çš„é—®é¢˜ ================= */
// è¦†ç›–åŸæœ‰çš„ openChatSettingsï¼Œå¢åŠ é˜²æŠ¥é”™æœºåˆ¶
window.openChatSettings = async function() {
    console.log("æ­£åœ¨æ‰“å¼€è®¾ç½®...");
    
    // 1. å›æ˜¾å½“å‰èº«ä»½
    const ps = await DB.get('user_personas'); 
    const sel = document.getElementById('current-persona-select'); 
    if(sel) {
        sel.innerHTML = '';
        if(ps && ps.length > 0) {
            ps.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.name}</option>`);
            sel.value = localStorage.getItem('cur_pid') || '';
        } else {
            sel.innerHTML = '<option value="">é»˜è®¤æˆ‘</option>';
        }
    }

    // 2. è·å–å½“å‰ä¼šè¯è®¾ç½®
    const list = await DB.get('sessions');
    const sess = list.find(s => s.id == currentChatId);
    if(!sess) return alert("æœªæ‰¾åˆ°å½“å‰ä¼šè¯");

    // 3. å›æ˜¾èƒŒæ™¯å›¾
    const prev = document.getElementById('chat-bg-preview');
    if (prev) prev.src = sess.bgImage || ""; 
    const fileInput = document.getElementById('chat-bg-file');
    if(fileInput) fileInput.value = '';

    // 4. å›æ˜¾è®°å¿†è½®æ•°
    const limit = sess.memoryLimit || 20;
    const slider = document.getElementById('memory-limit-slider');
    const display = document.getElementById('memory-limit-display');
    if(slider) slider.value = limit;
    if(display) display.innerText = limit;

    // 5. æ¸²æŸ“è®°å¿†åˆ—è¡¨
    if(typeof renderMemoryLists === 'function') renderMemoryLists(sess);

    // 6. å›æ˜¾æ—¶é—´å¼€å…³
    const timeSwitch = document.getElementById('chat-time-aware-switch');
    if(timeSwitch) timeSwitch.checked = sess.isTimeAware || false;
    
    const timePrev = document.getElementById('settings-time-preview');
    if(timePrev) {
        const now = new Date();
        timePrev.innerText = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
    }

    // 7. å›æ˜¾è‡ªåŠ¨å‘åŠ¨æ€é¢‘ç‡
    const probSel = document.getElementById('ai-moment-prob-select');
    if(probSel) probSel.value = sess.aiMomentProb || 0;

    // 8. å›æ˜¾è¡¨æƒ…åŒ… (è¿™é‡Œä¹‹å‰å®¹æ˜“æŠ¥é”™ï¼ŒåŠ äº†å®‰å…¨æ£€æŸ¥)
    const stickerSel = document.getElementById('ai-sticker-select');
    if (stickerSel) {
        stickerSel.innerHTML = '<option value="">ğŸš« ä¸ä½¿ç”¨è¡¨æƒ…åŒ…</option>';
        const allPacks = await DB.get('sticker_packs') || [];
        allPacks.forEach(p => {
            stickerSel.innerHTML += `<option value="${p.id}">${p.name}</option>`;
        });
        stickerSel.value = sess.boundStickerId || '';
    }

    // 9. æœ€åæ‰“å¼€å¼¹çª—
    openModal('modal-chat-settings');
}

/* ================= ğŸ”§ ä¿®å¤è½¬è´¦ç‚¹ä¸å¼€çš„é—®é¢˜ ================= */
// è¦†ç›–åŸæœ‰çš„ openTransferModalï¼Œç¡®ä¿é¢æ¿èƒ½å…³é—­
window.openTransferModal = function() {
    // å°è¯•å…³é—­åº•éƒ¨é¢æ¿ (å¦‚æœå‡½æ•°å­˜åœ¨)
    if(typeof closeToolPanel === 'function') closeToolPanel();
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    const amountInput = document.getElementById('transfer-amount-val');
    const descInput = document.getElementById('transfer-desc-val');
    const display = document.getElementById('trans-amount-display');

    if(amountInput) amountInput.value = '';
    if(descInput) descInput.value = '';
    if(display) display.innerText = '0.00';
    
    // æ‰“å¼€å¼¹çª—
    openModal('modal-transfer-input');
}

/* ================= ğŸ”§ ä¿®å¤è®°å¿†æ€»ç»“ç‚¹ä¸å¼€çš„é—®é¢˜ ================= */
window.openMemoryModal = async function() {
    const list = await DB.get('sessions');
    const sess = list.find(s => s.id === currentChatId);
    
    if (!sess) return; 

    if(typeof renderMemoryLists === 'function') renderMemoryLists(sess);

    openModal('modal-memory');
}
/* ================= ğŸ¨ ç¾åŒ–ç³»ç»Ÿé€»è¾‘ (æœ¬åœ°å­—ä½“åº“ç‰ˆ) ================= */

// 1. æ”¹å˜å…¨å±€ç•Œé¢å­—ä½“å¤§å°
function changeGlobalFontSize(val) {
    const display = document.getElementById('global-font-size-display');
    if(display) display.innerText = val + 'px';
    document.documentElement.style.setProperty('--app-global-size', val + 'px');
    localStorage.setItem('app_global_ui_size', val);
}

// 2. å¤„ç†å­—ä½“å¯¼å…¥ (è¯»å–æ–‡ä»¶ -> å¼¹çª—å‘½å -> å­˜å…¥DB)
function handleFontImport(input) {
    const file = input.files[0];
    if (!file) return;

    // ç®€å•é™åˆ¶ä¸€ä¸‹å¤§å° (ä¾‹å¦‚ 15MB)
    if (file.size > 15 * 1024 * 1024) {
        alert("å­—ä½“æ–‡ä»¶å¤ªå¤§äº† (è¶…è¿‡15MB)ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¡é¡¿ï¼Œå»ºè®®æ¢ä¸€ä¸ªå°çš„ã€‚");
        input.value = '';
        return;
    }

    const reader = new FileReader();
    reader.onload = async function(e) {
        const base64Data = e.target.result;
        
        // å¼¹å‡ºè¾“å…¥æ¡†è®©ç”¨æˆ·å‘½å
        const fontName = prompt("ğŸ‰ å­—ä½“è¯»å–æˆåŠŸï¼\nè¯·ç»™è¿™ä¸ªå­—ä½“èµ·ä¸ªåå­— (ä¾‹å¦‚: å°‘å¥³ä½“):");
        if (!fontName) {
            input.value = '';
            return; // ç”¨æˆ·å–æ¶ˆ
        }

        // å­˜å…¥ IndexedDB
        let fonts = await DB.get('custom_fonts');
        if (!Array.isArray(fonts)) fonts = [];
        
        const newFont = {
            id: Date.now().toString(),
            name: fontName,
            data: base64Data // è¿™é‡Œå­˜çš„æ˜¯å·¨å¤§çš„ Base64 å­—ç¬¦ä¸²
        };
        
        fonts.push(newFont);
        
        try {
            await DB.set('custom_fonts', fonts);
            alert(`âœ… å­—ä½“ã€${fontName}ã€‘å·²ä¿å­˜åˆ°å­—ä½“åº“ï¼`);
            renderSavedFonts(); // åˆ·æ–°åˆ—è¡¨
        } catch (err) {
            alert("ä¿å­˜å¤±è´¥ï¼Œå¯èƒ½æ˜¯å­˜å‚¨ç©ºé—´ä¸è¶³ã€‚");
            console.error(err);
        }
        
        input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
    };
    
    // ç•Œé¢ç»™ä¸ªæç¤º
    const btn = document.querySelector('button[onclick*="font-file-input"]');
    const oldText = btn.innerText;
    btn.innerText = "â³ è¯»å–ä¸­...";
    
    reader.readAsDataURL(file);
    
    // æ¢å¤æŒ‰é’®æ–‡å­—
    reader.onloadend = () => { btn.innerText = oldText; };
}
// ================= ğŸ”— æ–°å¢ï¼šé“¾æ¥å¯¼å…¥å­—ä½“é€»è¾‘ =================

// ================= ğŸ”— é“¾æ¥å¯¼å…¥å­—ä½“é€»è¾‘ (è‡ªåŠ¨åº”ç”¨ + æœ‰æ•ˆæ€§æ£€æµ‹) =================

// ================= ğŸ”— é“¾æ¥å¯¼å…¥å­—ä½“é€»è¾‘ (æ— è§†æŠ¥é”™ï¼Œå¼ºåˆ¶åº”ç”¨ç‰ˆ) =================

async function handleLinkImport() {
    // 1. è¾“å…¥é“¾æ¥
    const url = prompt("è¯·è¾“å…¥å­—ä½“æ–‡ä»¶çš„ç›´é“¾åœ°å€ (æ¨è HTTPS):", "https://");
    if (!url || url === "https://") return;

    // 2. ç›´æ¥èµ·åå­— (ä¸æ£€æµ‹é“¾æ¥å¥½åäº†)
    const fontName = prompt("ç»™è¿™ä¸ªå­—ä½“èµ·ä¸ªåå­— (ä¾‹å¦‚: é¸¿è’™å­—ä½“):");
    if (!fontName) return;

    // 3. ç›´æ¥å­˜å…¥æ•°æ®åº“
    let fonts = await DB.get('custom_fonts');
    if (!Array.isArray(fonts)) fonts = [];
    
    const newId = Date.now().toString();
    const newFont = {
        id: newId,
        name: fontName,
        data: url,      
        isLink: true   
    };
    
    fonts.push(newFont);
    
    try {
        await DB.set('custom_fonts', fonts);
        
        // 4. ç«‹å³å¼ºåˆ¶æ³¨å…¥ CSS
        injectFontStyle(fontName, url);
        
        // 5. è®°å½•çŠ¶æ€å¹¶åˆ·æ–°åˆ—è¡¨
        localStorage.setItem('app_current_font_id', newId);
        renderSavedFonts(); 

        alert(`âœ… å·²æ·»åŠ ï¼\nå¦‚æœæ˜¯å¤§æ–‡ä»¶ï¼Œå¯èƒ½éœ€è¦å‡ ç§’é’Ÿä¸‹è½½ï¼Œè¯·è€å¿ƒç­‰å¾…å­—ä½“å˜åŒ–ã€‚`);

    } catch (err) {
        alert("ä¿å­˜å¤±è´¥: " + err.message);
    }
}
// 3. æ¸²æŸ“å·²ä¿å­˜çš„å­—ä½“åˆ—è¡¨
async function renderSavedFonts() {
    const fonts = await DB.get('custom_fonts') || [];
    const listDiv = document.getElementById('saved-font-list');
    if (!listDiv) return; // é˜²æ­¢ä¸åœ¨ç¾åŒ–é¡µé¢æ—¶æŠ¥é”™

    listDiv.innerHTML = '';

    if (fonts.length === 0) {
        listDiv.innerHTML = '<div style="text-align:center; color:#ccc; font-size:12px; padding:20px; background:#f9f9f9; border-radius:8px;">æš‚æ— ä¿å­˜çš„å­—ä½“ï¼Œå¿«å»å¯¼å…¥å§~</div>';
        return;
    }

    // è·å–å½“å‰æ­£åœ¨ä½¿ç”¨çš„å­—ä½“ID
    const currentFontId = localStorage.getItem('app_current_font_id');

    fonts.forEach(f => {
        const isUsing = currentFontId === f.id;
        const activeClass = isUsing ? 'background:#e6f7ff; border:1px solid #1890ff;' : 'background:#f9f9f9; border:1px solid #eee;';
        const activeText = isUsing ? '<span style="color:#1890ff; font-size:12px; margin-right:5px;">â— ä½¿ç”¨ä¸­</span>' : '';

        listDiv.innerHTML += `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; border-radius:10px; ${activeClass} transition:0.2s;">
                <div style="flex:1; cursor:pointer; display:flex; align-items:center;" onclick="applySavedFont('${f.id}')">
                    <span style="font-size:20px; margin-right:10px;">Aa</span>
                    <div style="font-weight:500; color:#333;">${f.name}</div>
                </div>
                <div style="display:flex; align-items:center;">
                    ${activeText}
                    <button class="mini-btn danger" style="padding:4px 10px; margin-left:10px; height:28px;" onclick="deleteSavedFont('${f.id}')">åˆ é™¤</button>
                </div>
            </div>
        `;
    });
}

// 4. åº”ç”¨å·²ä¿å­˜çš„å­—ä½“ (ä»DBè¯»å–Base64å¹¶æ³¨å…¥)
async function applySavedFont(id) {
    const fonts = await DB.get('custom_fonts') || [];
    const target = fonts.find(f => f.id == id);
    
    if (!target) return alert("å­—ä½“æ–‡ä»¶ä¼¼ä¹ä¸¢å¤±äº†");

    // æ³¨å…¥ CSS
    injectFontStyle(target.name, target.data);

    // ä¿å­˜çŠ¶æ€
    localStorage.setItem('app_current_font_id', id);
    
    // åˆ·æ–°åˆ—è¡¨æ˜¾ç¤ºâ€œä½¿ç”¨ä¸­â€çŠ¶æ€
    renderSavedFonts();
    
    alert(`âœ… å·²åˆ‡æ¢ä¸ºï¼š${target.name}`);
}

// 5. æ³¨å…¥å­—ä½“çš„æ ¸å¿ƒå‡½æ•°
// 5. æ³¨å…¥å­—ä½“çš„æ ¸å¿ƒå‡½æ•° (ä¿®å¤ç‰ˆï¼šè‡ªåŠ¨è¯†åˆ«æ ¼å¼ + å¢å¼ºä¼˜å…ˆçº§)
// 5. æ³¨å…¥å­—ä½“çš„æ ¸å¿ƒå‡½æ•° (CSS å¼ºåˆ¶æ³¨å…¥)
function injectFontStyle(fontName, fontData) {
    let styleTag = document.getElementById('custom-font-style');
    if (!styleTag) {
        styleTag = document.createElement('style');
        styleTag.id = 'custom-font-style';
        document.head.appendChild(styleTag);
    }

    const uniqueFamily = 'UserFont_' + Date.now();

    // ç›´æ¥ç”Ÿæˆ CSSï¼Œä¸é™åˆ¶ formatï¼Œæ”¯æŒæ‰€æœ‰æ ¼å¼çš„é“¾æ¥
    styleTag.innerHTML = `
        @font-face {
            font-family: '${uniqueFamily}';
            src: url('${fontData}'); 
            font-display: swap; /* ä¸‹è½½æœŸé—´æ˜¾ç¤ºé»˜è®¤å­—ä½“ï¼Œä¸‹è½½å®Œè‡ªåŠ¨æ›¿æ¢ */
        }
        
        /* æš´åŠ›è¦†ç›–æ‰€æœ‰å…ƒç´ çš„å­—ä½“ */
        :root, body, button, input, textarea, select, 
        .msg-bubble, .moment-content, .nav-title, h3, p, div, span, b, i,
        .wallet-num, .item-text, .app-name, .zone-username {
            font-family: '${uniqueFamily}', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
        }
    `;
    
    console.log(`å·²æ³¨å…¥ CSSï¼Œç­‰å¾…æµè§ˆå™¨ä¸‹è½½å­—ä½“: ${fontData}`);
}

// 6. åˆ é™¤å­—ä½“
async function deleteSavedFont(id) {
    if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­—ä½“å—ï¼Ÿ")) return;

    let fonts = await DB.get('custom_fonts') || [];
    fonts = fonts.filter(f => f.id != id);
    await DB.set('custom_fonts', fonts);

    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ­£åœ¨ç”¨çš„ï¼Œæ¢å¤é»˜è®¤
    if (localStorage.getItem('app_current_font_id') === id) {
        resetFont();
    } else {
        renderSavedFonts();
    }
}

// 7. æ¢å¤ç³»ç»Ÿé»˜è®¤
function resetFont() {
    const styleTag = document.getElementById('custom-font-style');
    if (styleTag) styleTag.innerHTML = ''; // æ¸…ç©ºæ ·å¼
    localStorage.removeItem('app_current_font_id');
    renderSavedFonts(); // åˆ·æ–°åˆ—è¡¨ï¼Œå»æ‰â€œä½¿ç”¨ä¸­â€æ ‡è®°
    alert("å·²æ¢å¤ç³»ç»Ÿé»˜è®¤å­—ä½“");
}

// 8. åˆå§‹åŒ–åŠ è½½ (ä¸ä»…æ¢å¤å¤§å°ï¼Œè¿˜è¦ä»DBæ¢å¤å­—ä½“)
// ================= ğŸš€ åˆå§‹åŒ–ç¾åŒ–è®¾ç½® (ä¿®å¤ç‰ˆï¼šè‡ªåŠ¨æ¢å¤å­—ä½“) =================
async function initBeautifySettings() {
    console.log("æ­£åœ¨æ¢å¤ç¾åŒ–è®¾ç½®...");

    // 1. æ¢å¤ç•Œé¢å­—ä½“å¤§å°
    const savedSize = localStorage.getItem('app_global_ui_size');
    if (savedSize) {
        changeGlobalFontSize(savedSize);
        // å¦‚æœå½“å‰åœ¨ç¾åŒ–é¡µé¢ï¼Œæ›´æ–°æ»‘å—æ˜¾ç¤º
        const slider = document.getElementById('global-font-size-slider');
        if(slider) slider.value = savedSize;
    }

    // 2. â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šæ¢å¤ä¸Šæ¬¡ä½¿ç”¨çš„å­—ä½“ â˜…â˜…â˜…
    const savedFontId = localStorage.getItem('app_current_font_id');
    
    if (savedFontId) {
        // ä»æ•°æ®åº“é‡Œæ‰¾è¿™ä¸ªå­—ä½“çš„ä¿¡æ¯
        const fonts = await DB.get('custom_fonts') || [];
        const targetFont = fonts.find(f => f.id == savedFontId);
        
        if (targetFont) {
            console.log(`æ­£åœ¨åº”ç”¨ä¿å­˜çš„å­—ä½“: ${targetFont.name}`);
            // å†æ¬¡è°ƒç”¨æ³¨å…¥å‡½æ•°
            injectFontStyle(targetFont.name, targetFont.data);
        } else {
            console.log("æœªæ‰¾åˆ°ä¸Šæ¬¡ä¿å­˜çš„å­—ä½“ï¼Œå¯èƒ½å·²è¢«åˆ é™¤");
            localStorage.removeItem('app_current_font_id'); // æ¸…ç†æ— æ•ˆè®°å½•
        }
    }
}
// æ‰“å¼€æ‹ç…§æè¿°å¼¹çª—
function openPhotoSimModal() {
    closeToolPanel(); // å…³é—­åº•éƒ¨é¢æ¿
    document.getElementById('photo-sim-input').value = ''; // æ¸…ç©º
    openModal('modal-photo-sim');
    // è‡ªåŠ¨èšç„¦
    setTimeout(() => document.getElementById('photo-sim-input').focus(), 100);
}

// å‘é€æ„å¿µç…§ç‰‡
async function sendSimulatedPhoto() {
    const text = document.getElementById('photo-sim-input').value.trim();
    if (!text) return alert("ç”»é¢æè¿°ä¸èƒ½ä¸ºç©ºå“¦");

    // æ„é€ ç‰¹æ®Šæ ¼å¼çš„æ¶ˆæ¯ï¼š(sim_img:æè¿°)
    // è¿™ç§æ ¼å¼ AI å®¹æ˜“è¯†åˆ«ï¼Œæˆ‘ä»¬æ¸²æŸ“æ—¶ä¹Ÿæ–¹ä¾¿æ­£åˆ™åŒ¹é…
    const content = `(sim_img:${text})`;

    // è°ƒç”¨é€šç”¨çš„å‘é€é€»è¾‘ï¼ˆæˆ‘ä»¬è¿™é‡Œæ¨¡æ‹Ÿç”¨æˆ·å‘é€æ–‡æœ¬ï¼Œä½†å†…å®¹æ˜¯ç‰¹æ®Šçš„ï¼‰
    const inputEl = document.getElementById('msg-input');
    inputEl.value = content; 
    
    await sendUserMsg(); // å¤ç”¨å·²æœ‰çš„å‘é€å‡½æ•°
    
    closeModal('modal-photo-sim');
}
/* ================= ğŸ™ï¸ è¯­éŸ³æ¶ˆæ¯ & è½¬æ–‡å­—æ ¸å¿ƒé€»è¾‘ (çœŸå®APIç‰ˆ) ================= */

let mediaRecorder;
let audioChunks = [];
let voiceStream;
let recognition; // è¯­éŸ³è¯†åˆ«å¯¹è±¡
let isRecording = false;
let startRecordTime = 0;
let finalTranscript = ""; // æœ€ç»ˆè¯†åˆ«çš„æ–‡å­—

// åˆå§‹åŒ–è¯­éŸ³åŠŸèƒ½
function initVoiceFeatures() {
    // ç»‘å®šåŠåœ†æŒ‰é’®çš„è§¦æ‘¸äº‹ä»¶
    const btn = document.getElementById('btn-voice-record');
    if(!btn) return;

    btn.addEventListener('touchstart', startVoiceRecord, {passive: false});
    btn.addEventListener('touchmove', handleVoiceMove, {passive: false});
    btn.addEventListener('touchend', endVoiceRecord);
    
    // å…¼å®¹PCé¼ æ ‡è°ƒè¯•
    btn.addEventListener('mousedown', startVoiceRecord);
    window.addEventListener('mousemove', handleVoiceMove); // ç»‘åœ¨windowä¸Šé˜²æ­¢ç§»å‡ºåŒºåŸŸå¤±æ•ˆ
    window.addEventListener('mouseup', endVoiceRecord);
}

// 1. æ‰“å¼€è¯­éŸ³é¢æ¿
function openVoicePanel() {
    closeToolPanel(); // å…³é—­åº•éƒ¨å…¶ä»–é¢æ¿
    document.getElementById('voice-overlay').classList.add('show');
    initVoiceFeatures(); // ç¡®ä¿ç»‘å®š
}

// 2. å¼€å§‹å½•éŸ³ (æŒ‰ä¸‹)
async function startVoiceRecord(e) {
    if(e.cancelable) e.preventDefault();
    isRecording = true;
    startRecordTime = Date.now();
    finalTranscript = "";
    audioChunks = [];

    // UI æ›´æ–°
    document.getElementById('voice-wave-box').classList.add('recording');
    document.getElementById('voice-status-text').innerText = "æ¾å¼€ å‘é€";
    document.getElementById('voice-realtime-text').innerText = "æ­£åœ¨è†å¬...";
    document.getElementById('btn-voice-record').classList.add('active');

    try {
        // A. å¯åŠ¨éº¦å…‹é£å½•éŸ³
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        voiceStream = stream;
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
        };
        mediaRecorder.start();

        // B. å¯åŠ¨è¯­éŸ³è¯†åˆ« (Web Speech API)
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN'; // è®¾ç½®ä¸­æ–‡
            recognition.continuous = true;
            recognition.interimResults = true; // å®æ—¶æ˜¾ç¤ºç»“æœ

            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                // å®æ—¶æ›´æ–°UIä¸Šçš„æ–‡å­—
                document.getElementById('voice-realtime-text').innerText = finalTranscript + interimTranscript;
            };

            recognition.start();
        } else {
            document.getElementById('voice-realtime-text').innerText = "å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå®æ—¶è½¬æ–‡å­—";
        }

    } catch (err) {
        console.error("éº¦å…‹é£å¯åŠ¨å¤±è´¥:", err);
        alert("æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™ã€‚");
        closeVoicePanel();
    }
}

// 3. å¤„ç†æ»‘åŠ¨ (æ‰‹æŒ‡ç§»åŠ¨)
let currentAction = 'send'; // send | cancel | trans

function handleVoiceMove(e) {
    if(!isRecording) return;
    
    // è·å–æ‰‹æŒ‡åæ ‡
    let clientX, clientY;
    if (e.touches && e.touches.length > 0) {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
    } else {
        clientX = e.clientX;
        clientY = e.clientY;
    }

    // æ£€æµ‹æ˜¯å¦æ»‘åˆ°äº†â€œå–æ¶ˆâ€æˆ–â€œè½¬æ–‡å­—â€åŒºåŸŸ
    const cancelBtn = document.getElementById('btn-voice-cancel');
    const transBtn = document.getElementById('btn-voice-trans');
    const cancelRect = cancelBtn.getBoundingClientRect();
    const transRect = transBtn.getBoundingClientRect();

    // ç®€å•çš„ç¢°æ’æ£€æµ‹ (æ‰©å¤§ä¸€ç‚¹åˆ¤å®šèŒƒå›´)
    const hitTest = (rect, x, y) => {
        return x >= rect.left - 20 && x <= rect.right + 20 && y >= rect.top - 20 && y <= rect.bottom + 20;
    };

    if (hitTest(cancelRect, clientX, clientY)) {
        currentAction = 'cancel';
        cancelBtn.classList.add('hover');
        transBtn.classList.remove('hover');
        document.getElementById('voice-status-text').innerText = "æ¾å¼€ å–æ¶ˆ";
        document.getElementById('voice-wave-box').style.background = "#ff3b30"; // å˜çº¢
    } else if (hitTest(transRect, clientX, clientY)) {
        currentAction = 'trans';
        transBtn.classList.add('hover');
        cancelBtn.classList.remove('hover');
        document.getElementById('voice-status-text').innerText = "æ¾å¼€ è½¬æ–‡å­—";
        document.getElementById('voice-wave-box').style.background = "#fff"; // å˜ç™½
    } else {
        currentAction = 'send';
        cancelBtn.classList.remove('hover');
        transBtn.classList.remove('hover');
        document.getElementById('voice-status-text').innerText = "æ¾å¼€ å‘é€";
        document.getElementById('voice-wave-box').style.background = "#59f059"; // æ¢å¤ç»¿
    }
}

// 4. ç»“æŸå½•éŸ³ (æ¾æ‰‹)
function endVoiceRecord(e) {
    if(!isRecording) return;
    isRecording = false;
    
    // åœæ­¢å½•éŸ³å’Œè¯†åˆ«
    if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
    if(voiceStream) voiceStream.getTracks().forEach(track => track.stop());
    if(recognition) recognition.stop();

    // å»¶è¿Ÿä¸€ç‚¹å¤„ç†ï¼Œç¡®ä¿ ondataavailable è·‘å®Œ
    setTimeout(() => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const duration = Math.round((Date.now() - startRecordTime) / 1000) || 1;
        
        if (currentAction === 'cancel') {
            // å–æ¶ˆï¼šå•¥ä¹Ÿä¸åš
            console.log("å½•éŸ³å·²å–æ¶ˆ");
        } else if (currentAction === 'trans') {
            // è½¬æ–‡å­—ï¼šå¡«å…¥è¾“å…¥æ¡†ï¼Œä¸ç«‹å³å‘é€
            const input = document.getElementById('msg-input');
            input.value = finalTranscript || "æœªè¯†åˆ«åˆ°è¯­éŸ³";
            input.focus();
        } else {
            // å‘é€ï¼šç›´æ¥å‘è¯­éŸ³æ°”æ³¡
            sendVoiceMsg(audioBlob, duration, finalTranscript);
        }

        closeVoicePanel();
    }, 200);
}

// å…³é—­é¢æ¿å¹¶é‡ç½®
function closeVoicePanel() {
    document.getElementById('voice-overlay').classList.remove('show');
    document.getElementById('voice-wave-box').classList.remove('recording');
    document.getElementById('btn-voice-record').classList.remove('active');
    document.getElementById('voice-wave-box').style.background = "#59f059"; 
    document.getElementById('btn-voice-cancel').classList.remove('hover');
    document.getElementById('btn-voice-trans').classList.remove('hover');
    isRecording = false;
}

// 5. å‘é€è¯­éŸ³æ¶ˆæ¯ (å­˜å…¥DB)
async function sendVoiceMsg(blob, duration, text) {
    if(duration < 1) return alert("å½•éŸ³æ—¶é—´å¤ªçŸ­å•¦");

    // å°† Blob è½¬ä¸º Base64 æ–¹ä¾¿å­˜å…¥ IndexedDB
    const reader = new FileReader();
    reader.readAsDataURL(blob);
    reader.onloadend = async function() {
        const base64Audio = reader.result;

        const userPersonas = await DB.get('user_personas');
        const curPid = localStorage.getItem('cur_pid') || (userPersonas[0] && userPersonas[0].id);
        const t = Date.now();

        const msgObj = {
            role: 'user',
            type: 'voice', // æ ‡è®°ä¸ºè¯­éŸ³
            content: '[è¯­éŸ³æ¶ˆæ¯]', 
            voiceData: base64Audio,
            duration: duration,
            transcription: text || "æœªèƒ½è¯†åˆ«å‡ºæ–‡å­—", // å­˜å…¥è¯†åˆ«ç»“æœ
            personaId: curPid,
            t: t
        };

        const list = await DB.get('sessions');
        const idx = list.findIndex(x => x.id == currentChatId);
        if (idx !== -1) {
            list[idx].msgs.push(msgObj);
            await DB.set('sessions', list);
            
            // åˆ·æ–°ç•Œé¢
            const box = document.getElementById('chat-msg-container');
            await tryAppendTimestamp(box, t);
            box.insertAdjacentHTML('beforeend', await createMsgHtmlWithVoice(msgObj, userPersonas, await DB.get('characters')));
            box.scrollTop = box.scrollHeight;
        }
    }
}

// 6. æ’­æ”¾è¯­éŸ³
function playVoice(id, base64) {
    const audio = new Audio(base64);
    audio.play();
    
    // ç®€å•çš„æ’­æ”¾åŠ¨ç”»æ•ˆæœ
    const icon = document.getElementById('voice-icon-' + id);
    const originalText = icon.innerText;
    icon.innerText = "ğŸ”Š"; // æ’­æ”¾ä¸­
    audio.onended = () => {
        icon.innerText = "ğŸ“¶"; // æ¢å¤ WiFi å›¾æ ‡æ¨¡æ‹Ÿå£°æ³¢
    };
}

// 7. åˆ‡æ¢æ˜¾ç¤ºè½¬æ–‡å­—ç»“æœ
function toggleVoiceTextResult(id) {
    const box = document.getElementById('voice-trans-' + id);
    if(box.style.display === 'block') {
        box.style.display = 'none';
    } else {
        box.style.display = 'block';
    }
}

/* ================= ğŸ’‰ æ³¨å…¥åˆ° createMsgHtml çš„è¡¥ä¸ ================= */
// ä½ éœ€è¦æŠŠåŸæ¥çš„ createMsgHtml å‡½æ•°é‡ŒåŠ ä¸Šå¯¹ type: 'voice' çš„åˆ¤æ–­
// ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘è¿™é‡Œå†™ä¸€ä¸ªæ–°çš„ helperï¼Œè¯·åœ¨åŸæ¥çš„ createMsgHtml é‡Œè°ƒç”¨æˆ–è€…æ•´åˆè¿›å»

// è¯·åœ¨åŸæ¥çš„ createMsgHtml å‡½æ•°ä¸­çš„ if/else é“¾æ¡ä¸­åŠ å…¥ä¸‹é¢è¿™æ®µé€»è¾‘ï¼š
/*
    else if (m.type === 'voice') {
        bubbleClass = 'msg-bubble is-voice';
        // ç»¿è‰²æ°”æ³¡ (me)
        if (me) bubbleClass += ' me'; 
        
        contentHtml = `
            <div class="voice-content-row" onclick="playVoice('${m.t}', '${m.voiceData}')">
                <span id="voice-icon-${m.t}" class="voice-icon">ğŸ“¶</span> 
                <span class="voice-duration">${m.duration}"</span>
                <span class="voice-to-text-btn" onclick="event.stopPropagation(); toggleVoiceTextResult('${m.t}')">è½¬æ–‡å­—</span>
            </div>
            <!-- è½¬æ–‡å­—çš„ç™½è‰²æµ®çª— -->
            <div id="voice-trans-${m.t}" class="voice-trans-result">
                ${m.transcription}
            </div>
        `;
    }
*/

// ä¸ºäº†è®©ä½ ç›´æ¥èƒ½ç”¨ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´çš„é’ˆå¯¹è¯­éŸ³æ¶ˆæ¯çš„ HTML ç”ŸæˆåŒ…è£…å‡½æ•°ï¼Œ
// ä½ å¯ä»¥æŠŠè¿™æ®µä»£ç å¤åˆ¶åˆ°åŸæ¥çš„ createMsgHtml å‡½æ•°ä¸Šæ–¹ï¼Œ
// ç„¶ååœ¨ createMsgHtml é‡Œè°ƒç”¨å®ƒã€‚
async function createMsgHtmlWithVoice(m, userPersonas, characters) {
    // è¿™é‡Œç®€å•å¤åˆ»åŸæ¥çš„é€»è¾‘å¹¶æ’å…¥ voice åˆ¤æ–­
    // æ³¨æ„ï¼šè¿™æ˜¯ä¸ºäº†æ¼”ç¤ºæ•´åˆï¼Œä½ æœ€å¥½ç›´æ¥ä¿®æ”¹ä½ åŸæœ¬çš„ createMsgHtml
    
    // å¦‚æœæ˜¯è¯­éŸ³æ¶ˆæ¯ï¼Œèµ°ç‰¹æ®Šæ¸²æŸ“
    if (m.type === 'voice') {
        const p = userPersonas.find(x => x.id == m.personaId);
        const ava = p ? (p.avatar || DEFAULT_AVATAR) : DEFAULT_AVATAR;
        
        return `
            <div class="msg-row me" id="msg-${m.t}">
                <div class="msg-checkbox"></div>
                <img src="${ava}" class="msg-avatar">
                <div class="msg-bubble is-voice" style="background:#95ec69; border-radius:6px;">
                    <div class="voice-content-row" onclick="playVoice('${m.t}', '${m.voiceData}')">
                        <span id="voice-icon-${m.t}" class="voice-icon" style="transform: rotate(90deg); display:inline-block;">(((</span> 
                        <span class="voice-duration">${m.duration}"</span>
                        <span class="voice-to-text-btn" onclick="event.stopPropagation(); toggleVoiceTextResult('${m.t}')">è½¬æ–‡å­—</span>
                    </div>
                    <div id="voice-trans-${m.t}" class="voice-trans-result">
                        ${m.transcription}
                    </div>
                </div>
            </div>`;
    } 
    
    // å¦‚æœä¸æ˜¯è¯­éŸ³ï¼Œè°ƒç”¨ä½ åŸæ¥çš„å‡½æ•° (å‡è®¾ä½ åŸæ¥çš„å‡½æ•°å« createMsgHtml)
    return createMsgHtml(m, userPersonas, characters);
}
</script>
</body>
</html>